<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="plone">

<body>

<div metal:fill-slot="main">
    <tal:main-macro metal:define-macro="main">

      <h1 class="documentFirstHeading">Edit crop</h1>
      <div class="discreet">Click and drag to select crop area</div>

<script type="text/javascript" src="jquery-imgareaselect.js"></script>

<script type="text/javascript">
    var originalwidth;
    var originalheight;

    var width_ratio;
    var height_ratio;

    function setCoodinates(img, selection) {
	    jq('#x1').val(selection.x1 * height_ratio | 0);
	    jq('#y1').val(selection.y1 * width_ratio | 0);
	    jq('#x2').val(selection.x2 * height_ratio | 0);
	    jq('#y2').val(selection.y2 * width_ratio | 0);
	    jq('#cropScale').val(originalwidth / selection.width / width_ratio );
    }

    jq(window).load(function () {
        originalwidth = document.getElementById('x2').value;
        originalheight = document.getElementById('y2').value;

        width_ratio = document.getElementById('width_ratio').value;
        height_ratio = document.getElementById('height_ratio').value;

        jq('img#thumbnail').imgAreaSelect({
            onSelectChange: setCoodinates,
            show: true,
            outerColor: 'black',
            aspectRatio: originalwidth+':'+originalheight
        });
    });

</script>

      <form action="do-crop"
            tal:attributes="action string:${here_url}/do-crop">

          <div class="field"
              tal:define="field python:here.getField('image');
                          crop_id request/crop|nothing;
                          wh_ratio python:field.cropEditRatio(here);
                          ui_crop_scale python:field.ui_crop_scale"
              tal:condition="crop_id">

              <img tal:replace="structure python:field.tag(here, ui_crop_scale)" />


          <input type="hidden"
                 name="width_ratio" id="width_ratio"
                 tal:attributes="value python:wh_ratio[0];" />

          <input type="hidden"
                 name="height_ratio" id="height_ratio"
                 tal:attributes="value python:wh_ratio[1];" />

          <input type="hidden"
                name="crop"
                tal:attributes="value request/crop;"/>

            <input type="hidden"
                  name="x1" id="x1"
                  value="0"/>
            <input type="hidden"
                  name="x2" id="x2"
                  tal:attributes="value request/width"/>
            <input type="hidden"
                  name="y1" id="y1"
                  value="0"/>
            <input type="hidden"
                  name="y2" id="y2"
                  tal:attributes="value request/height"/>

            <input type="hidden"
                   name="cropScale" id="cropScale"
                   tal:attributes="value request/cropScale|python:1"/>

            <input type="hidden"
                   name="last_referer"
                   tal:attributes="value request/HTTP_REFERER" />

          </div>

          <div class="formControls">
            <input class="context" type="submit" name="recrop" value="Crop"/>
          </div>

      </form>

    </tal:main-macro>
</div>

</body>

</html>

