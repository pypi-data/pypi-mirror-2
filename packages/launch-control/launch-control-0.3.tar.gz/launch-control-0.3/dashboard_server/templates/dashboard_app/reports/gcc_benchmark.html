{% extends "layouts/fullscreen.html" %}
{% load markup %}
{% load i18n %}


{% block title %}
{{ block.super }} | {% trans "GCC Benchmark Report" %} | {{ report.config.name }}
{% endblock %}


{% block extrahead %}
{{ block.super }}

<link href='http://fonts.googleapis.com/css?family=Ubuntu:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="{{ STATIC_URL }}assets/css/smoothness/jquery-ui-1.8.9.custom.css" type="text/css">
<script type="text/javascript" src="{{ STATIC_URL }}assets/scripts/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}assets/scripts/jquery-ui-1.8.9.custom.min.js"></script>
<!--[if IE]><script language="javascript" type="text/javascript" src="{{ STATIC_URL }}/assets/scripts/excanvas.min.js"></script><![endif]-->
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}assets/scripts/jquery.flot.min.js"></script>
<script language="javascript" type="text/javascript" src="{{ STATIC_URL }}assets/scripts/jquery.flot.navigate.min.js"></script>

<style type="text/css">
  #fullscreen {
    min-width: 600px;
  }

  #toolbar {
    font-size: 8pt;
    padding: 4px 8px;
    text-align: center;
  }

  #legend {
    height: 2em;
  }

  #toolbar button {
    margin: 0 2px;
  }

  #back_button {
    float: left;
  }

  #pan_n, #pan_e, #pan_w, #pan_s, #zoom_in, #zoom_out {
    margin: 0 !important;
  }

  #pan_s {
    margin-right: 1em !important;
  }

  #reconfigure_button, #metadata_button, #sign_in, #file_a_bug, #delete_button {
    float: right;
  }

  #placeholder {
    display: none;
    overflow: hidden !important;
    width: 600px;
    height: 300px;
    min-width: 600px;
    min-height: 300px;
  }

  #placeholder canvas {
    overflow: hidden !important;
  }

  #loading { 
    font-size: 32pt;
    color: #444;
  }
</style>
<script type="text/javascript">
  $(function() {
    $("#back_button").button({ icons: { primary: "ui-icon-arrowthick-1-w" } });
    $("#pan_n").button({ text: false, icons: { primary: "ui-icon-circle-triangle-n" }, label: "{% trans "Pan up" %}", disabled: true });
    $("#pan_e").button({ text: false, icons: { primary: "ui-icon-circle-triangle-e" }, label: "{% trans "Pan right" %}", disabled: true });
    $("#pan_w").button({ text: false, icons: { primary: "ui-icon-circle-triangle-w" }, label: "{% trans "Pan left" %}", disabled: true });
    $("#pan_s").button({ text: false, icons: { primary: "ui-icon-circle-triangle-s" }, label: "{% trans "Pan down" %}", disabled: true });
    $("#zoom_in").button({ text: false, icons: { primary: "ui-icon-zoomin" }, label: "{% trans "Zoom in" %}", disabled: true });
    $("#zoom_out").button({ text: false, icons: { primary: "ui-icon-zoomout" }, label: "{% trans "Zoom out" %}", disabled: true });

    var options = {
      colors: ["#F00", "#0F0", "#00F", "#F48D3E", "#EDC06B"],
      legend: {
        container: $("#legend")
      },
      xaxis: {
        mode: "time",
        axisLabel: "Compiler commit time",
        autoscaleMargin: 0.2
      },
      yaxis: {
        axisLabel: "{{ test_case.units }}",
        autoscaleMargin: 0.2
      },
      grid: {
        hoverable: true,
        clickable: true,
        color: "#111",
        backgroundColor: "#FFF",
        canvasText: { show: false, font: "sans 9px" },
        show: true, 
        borderWidth: 1,
        labelMargin: 10,
      },
      series: {
        shadowSize: 0
      },
      zoom: { interactive: true },
      pan: { interactive: true }
    };
    var series = null;
    var plot = null;
    var resize_commit_timer = null;
    var placeholder = $("#placeholder");

    function resize_placeholder() {
      placeholder.height($(window).height() - $("#toolbar-container").outerHeight(true) - 6);
      placeholder.width($(window).width() - 6);
      if (window && window.console) {
        window.console.log("Resizing placeholder to %dx%d", placeholder.width(), placeholder.height());
      }
    }

    function initialize() {
      if (window && window.console) {
        window.console.log("Initializing chart");
      }
      $("#loading").fadeToggle("slow", function() {
          placeholder.show();
          placeholder.css("opacity", "0");
          resize_placeholder();
          plot = $.plot("#placeholder", series, options);
          placeholder.animate({opacity: 1}, "slow");
          $("#pan_n").button("enable");
          $("#pan_e").button("enable");
          $("#pan_w").button("enable");
          $("#pan_s").button("enable");
          $("#zoom_in").button("enable");
          $("#zoom_out").button("enable");
      });
      $("#placeholder").bind("plotclick", function (event, pos, item) {
        if (item) {
          location.href = "{% url dashboard_app.views.test_result_detail 1 %}".replace("1", item.series.data[item.dataIndex][2]);
        }
      });
    }

    function resize_commit() {
      if (window && window.console) {
        window.console.log("Re-sizing placeholder and re-plotting canvas");
      }
      resize_placeholder();
      plot = $.plot("#placeholder", series, options);
      plot.setupGrid();
      plot.draw();
      $("#placeholder").animate({opacity: 1}, "fast", function() {
          resize_commit_timer = null;
          if (window && window.console) {
            window.console.log("Placeholder faded in");
          }
      });
    }

    /* Resize plot on window resize */
    $(window).resize(function() {
        if (resize_commit_timer) {
          if (window && window.console) {
            window.console.log("Extending resize commit timeout");
          }
          clearTimeout(resize_commit_timer);
        } else {
          $("#placeholder").animate({opacity: 0}, "fast");
          if (window && window.console) {
            window.console.log("Starting resize timeout, placeholder fades away");
          }
        }
        resize_commit_timer = setTimeout(resize_commit, 300);
    });

    function find_best_data(data) {
      var best_data = new Array();
      var best_index = 0;
      var last_timestamp = data[best_index][0];
      var best_measurement = data[best_index][1];
      for (var i=1; i<data.length; ++i) {
        var timestamp = data[i][0];
        var measurement = data[i][1];
        if (timestamp != last_timestamp) {
          best_data.push(data[best_index]);
          best_index = i;
          best_measurement = measurement;
          last_timestamp = timestamp;
        } else {
          if (measurement < best_measurement) {
            best_index = i;
            best_measurement = measurement;
          }
        }
      }
      best_data.push(data[best_index]);
      return best_data;
    }

    /* Load data when document is ready */
    $(document).ready(function($) {
      /* When data is available refresh the display */
      $.getJSON("data/", function (d) {
        /* This is the global series variable */
        series = [
          { data: d.data, label: d.label, color: "#F00", points: { show: true } },
        ];
        if (d.data.length > 0) { 
          /* Compute best samples for secondary series */
          series[1] = { data: find_best_data(d.data), color: "#F00", lines: { lineWidth: 2, show: true, steps: false, clickable: false, hoverable: false } };
        }
        initialize();
      });
    });

    $("#back_button").click(function() { location.href = "{% url  django_reports.views.report_list %}"; });
    $("#pan_n").click(function(e) { e.preventDefault(); plot.pan({top: -100}); });
    $("#pan_e").click(function(e) { e.preventDefault(); plot.pan({left: 100}); });
    $("#pan_w").click(function(e) { e.preventDefault(); plot.pan({left: -100}); });
    $("#pan_s").click(function(e) { e.preventDefault(); plot.pan({top: 100}); });
    $("#zoom_out").click(function(e) { e.preventDefault(); plot.zoomOut(); });
    $("#zoom_in").click(function(e) { e.preventDefault(); plot.zoom(); });

  });
</script>
{% endblock %}


{% block toolbar %}
<div id="toolbar" class="ui-widget-header">
  <button id="back_button">{% trans "Reports" %}</button>
  <button id="pan_n">N</button>
  <button id="pan_w">W</button>
  <button id="pan_e">E</button>
  <button id="pan_s">S</button>
  <button id="zoom_in">+</button>
  <button id="zoom_out">-</button>
  {% if request.user.is_authenticated %}
    {% if request.user = report.config.owner %}
      <button id="reconfigure_button">{% trans "Reconfigure data source" %}</button>
      <button id="metadata_button">{% trans "Edit meta-data" %}</button>
      <button id="delete_button">{% trans "Delete" %}</button>
      <script type="text/javascript">
        $("#reconfigure_button").button();
        $("#metadata_button").button()
        $("#delete_button").button({ icons: { primary: "ui-icon-trash" } });
        $("#reconfigure_button").click(function() {
          location.href = "{% url django_reports.views.update_report_settings report.config.id %}";
        });
        $("#metadata_button").click(function() {
          location.href = "{% url django_reports.views.update_report_metadata report.config.id %}";
        });
        $("#delete_button").click(function() {
          location.href = "{% url django_reports.views.delete_report report.config.id %}";
        });
      </script>
    {% endif %}
  {% else %}
    <button id="sign_in">{% trans "Sign in" %}</button>
    <script type="text/javascript">
      $("#sign_in").button();
      $("#sign_in").click(function() { location.href = "{% url django.contrib.auth.views.login %}?next={% url django_reports.views.display_report report.config.id %}"; });
    </script>
  {% endif %}
  <button id="file_a_bug">{% trans "File a bug" %}</button>
  <script type="text/javascript">
    $("#file_a_bug").button({ icons: { primary: "ui-icon-alert" } });
    $("#file_a_bug").click(function() { location.href = "http://fracture.suxx.pl/projects/launch-control/issues/new?issue%5Bparent_issue_id%5D=4"; });
  </script>
</div>
<div id="legend"> </div>
{% endblock %}

{% block content %}
<div id="loading">{% trans "Loading data..." %}</div>
<div id="placeholder"></div>
{% endblock %}
