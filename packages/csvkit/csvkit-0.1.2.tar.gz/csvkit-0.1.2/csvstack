#!/usr/bin/env python

import argparse
import sys

from csvkit import init_common_parser, extract_csv_reader_kwargs
from csvkit.unicode import UnicodeCSVReader, UnicodeCSVWriter

def main(args):
    """
    Stack up the rows from multiple CSV files, optionally adding a grouping value.
    """
    if len(args.files) < 2:
        sys.exit('You must specify at least two files to stack.')

    if args.groups:
        groups = args.groups.split(',')

        if len(groups) != len(args.files):
            sys.exit('The number of grouping values must be equal to the number of CSV files being stacked.')
            
        group_name = args.group_name if args.group_name else 'group'

    output = UnicodeCSVWriter(sys.stdout)

    for i, f in enumerate(args.files):
        rows = UnicodeCSVReader(f, **extract_csv_reader_kwargs(args))
        headers = rows.next()

        if i == 0:
            if args.groups:
                headers.insert(0, group_name)
            
            output.writerow(headers)

        for row in rows:
            if args.groups:
                row.insert(0, groups[i])

            output.writerow(row)

if __name__ == '__main__':
    parser = init_common_parser(description='Stack up the rows from multiple CSV files, optionally adding a grouping value.', omitflags='f')

    parser.add_argument('files', metavar="FILES", nargs='+', type=argparse.FileType('r'))
    parser.add_argument('-g', '--groups', dest='groups',
                        help='A comma-seperated list of values to add as a "grouping factor", one for each CSV being stacked. These will be added to the stacked CSV as a new column. You may specify a name for the grouping column using the -')
    parser.add_argument('-n', '--group-name', dest='group_name',
                        help='A name for the grouping column, e.g. "year". Only used when also specifying -g.')

    main(parser.parse_args())
