<html xmlns="http://www.w3.org/1999/xhtml" tal:omit-tag=""
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal">
  <div class="object-widget"
       tal:attributes="class view/klass">
    <tal:block repeat="widget view/subform/widgets/values"
               define="form_context nocall:context">
      <tal:comment replace="nothing">
        Note to self: The following patterns is not nice, but it's TAL.
        I need to reach the original context of the form to be able to call
        @@ploneform-macros/field. Usually, I'd do this kind of climbing
        using recursion, but here I can't call my own macro, bacause I'm
        not able to reach the compiled version of this template because of
        the way z3c.form abstracts widget templates from view classes using ZCA.
      </tal:comment>
      <tal:subform-context condition="not:exists:form_context/@@ploneform-macros">
        <tal:upwards define="global form_context nocall:view/form/parentForm/context"/>
      </tal:subform-context>
      <tal:subform-context condition="not:exists:form_context/@@ploneform-macros">
        <tal:upwards define="global form_context nocall:view/form/parentForm/context"/>
      </tal:subform-context>
      <tal:subform-context condition="not:exists:form_context/@@ploneform-macros">
        <tal:upwards define="global form_context nocall:view/form/parentForm/context"/>
      </tal:subform-context>
      <tal:subform-context condition="not:exists:form_context/@@ploneform-macros">
        <tal:upwards define="global form_context nocall:view/form/parentForm/context"/>
      </tal:subform-context>
      <tal:subform-context condition="not:exists:form_context/@@ploneform-macros">
        <tal:upwards define="global form_context nocall:view/form/parentForm/context"/>
      </tal:subform-context>
      <tal:form-context condition="exists:form_context/@@ploneform-macros">
        <metal:use use-macro="form_context/@@ploneform-macros/field" />
      </tal:form-context>
    </tal:block>
    <input name="field-empty-marker" type="hidden" value="1"
           tal:attributes="name string:${view/name}-empty-marker" />
  </div>
</html>
