

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Hooks &mdash; mailman v3.0.0a6 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.0.0a6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="mailman v3.0.0a6 documentation" href="../../index.html" />
    <link rel="next" title="Application level list life cycle" href="lifecycle.html" />
    <link rel="prev" title="Chains" href="chains.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="lifecycle.html" title="Application level list life cycle"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="chains.html" title="Chains"
             accesskey="P">previous</a> |</li>
        <li><a href="../../docs/README.html">mailman v3.0.0a6 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="hooks">
<h1>Hooks<a class="headerlink" href="#hooks" title="Permalink to this headline">¶</a></h1>
<p>Mailman defines two initialization hooks, one which is run early in the
initialization process and the other run late in the initialization process.
Hooks name an importable callable so it must be accessible on <tt class="docutils literal"><span class="pre">sys.path</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mailman.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">config_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">config_directory</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">hook_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_directory</span><span class="p">,</span> <span class="s">&#39;hooks.py&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">hook_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">fp</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="gp">... </span><span class="s">counter = 1</span>
<span class="gp">... </span><span class="s">def pre_hook():</span>
<span class="gp">... </span><span class="s">    global counter</span>
<span class="gp">... </span><span class="s">    print &#39;pre-hook:&#39;, counter</span>
<span class="gp">... </span><span class="s">    counter += 1</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">def post_hook():</span>
<span class="gp">... </span><span class="s">    global counter</span>
<span class="gp">... </span><span class="s">    print &#39;post-hook:&#39;, counter</span>
<span class="gp">... </span><span class="s">    counter += 1</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<div class="section" id="pre-hook">
<h2>Pre-hook<a class="headerlink" href="#pre-hook" title="Permalink to this headline">¶</a></h2>
<p>We can set the pre-hook in the configuration file.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_directory</span><span class="p">,</span> <span class="s">&#39;hooks.cfg&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">fp</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="gp">... </span><span class="s">[meta]</span>
<span class="gp">... </span><span class="s">extends: test.cfg</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">[mailman]</span>
<span class="gp">... </span><span class="s">pre_hook: hooks.pre_hook</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>The hooks are run in the second and third steps of initialization.  However,
we can&#8217;t run those initialization steps in process, so call a command line
script that will produce no output to force the hooks to run.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mailman.testing.layers</span> <span class="kn">import</span> <span class="n">ConfigLayer</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">call</span><span class="p">():</span>
<span class="gp">... </span>    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
<span class="gp">... </span>        <span class="s">&#39;bin/mailman lists --domain ignore -q&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span>
<span class="gp">... </span>        <span class="n">cwd</span><span class="o">=</span><span class="n">ConfigLayer</span><span class="o">.</span><span class="n">root_directory</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">env</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">MAILMAN_CONFIG_FILE</span><span class="o">=</span><span class="n">config_path</span><span class="p">,</span>
<span class="gp">... </span>                 <span class="n">PYTHONPATH</span><span class="o">=</span><span class="n">config_directory</span><span class="p">),</span>
<span class="gp">... </span>        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stderr</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">stdout</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">call</span><span class="p">()</span>
<span class="go">pre-hook: 1</span>
<span class="go">&lt;BLANKLINE&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="post-hook">
<h2>Post-hook<a class="headerlink" href="#post-hook" title="Permalink to this headline">¶</a></h2>
<p>We can set the post-hook in the configuration file.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">fp</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="gp">... </span><span class="s">[meta]</span>
<span class="gp">... </span><span class="s">extends: test.cfg</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">[mailman]</span>
<span class="gp">... </span><span class="s">post_hook: hooks.post_hook</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">call</span><span class="p">()</span>
<span class="go">post-hook: 1</span>
<span class="go">&lt;BLANKLINE&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="running-both-hooks">
<h2>Running both hooks<a class="headerlink" href="#running-both-hooks" title="Permalink to this headline">¶</a></h2>
<p>We can set the pre- and post-hooks in the configuration file.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">fp</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="gp">... </span><span class="s">[meta]</span>
<span class="gp">... </span><span class="s">extends: test.cfg</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">[mailman]</span>
<span class="gp">... </span><span class="s">pre_hook: hooks.pre_hook</span>
<span class="gp">... </span><span class="s">post_hook: hooks.post_hook</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">call</span><span class="p">()</span>
<span class="go">pre-hook: 1</span>
<span class="go">post-hook: 2</span>
<span class="go">&lt;BLANKLINE&gt;</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../docs/README.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Hooks</a><ul>
<li><a class="reference internal" href="#pre-hook">Pre-hook</a></li>
<li><a class="reference internal" href="#post-hook">Post-hook</a></li>
<li><a class="reference internal" href="#running-both-hooks">Running both hooks</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="chains.html"
                        title="previous chapter">Chains</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="lifecycle.html"
                        title="next chapter">Application level list life cycle</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/app/docs/hooks.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="lifecycle.html" title="Application level list life cycle"
             >next</a> |</li>
        <li class="right" >
          <a href="chains.html" title="Chains"
             >previous</a> |</li>
        <li><a href="../../docs/README.html">mailman v3.0.0a6 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright The Mailman Developers.
      Last updated on Sep 20, 2010.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>
  </body>
</html>