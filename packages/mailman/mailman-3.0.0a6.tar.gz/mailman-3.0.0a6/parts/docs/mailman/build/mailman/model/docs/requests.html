

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Moderator requests &mdash; mailman v3.0.0a6 documentation</title>
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '3.0.0a6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="mailman v3.0.0a6 documentation" href="../../index.html" />
    <link rel="next" title="The user manager" href="usermanager.html" />
    <link rel="prev" title="Address registration" href="registration.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="usermanager.html" title="The user manager"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="registration.html" title="Address registration"
             accesskey="P">previous</a> |</li>
        <li><a href="../../docs/README.html">mailman v3.0.0a6 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="moderator-requests">
<h1>Moderator requests<a class="headerlink" href="#moderator-requests" title="Permalink to this headline">¶</a></h1>
<p>Various actions will be held for moderator approval, such as subscriptions to
closed lists, or postings by non-members.  The requests database is the low
level interface to these actions requiring approval.</p>
<p>Here is a helper function for printing out held requests.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">show_holds</span><span class="p">(</span><span class="n">requests</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">requests</span><span class="o">.</span><span class="n">held_requests</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">... </span>        <span class="k">print</span> <span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">request_type</span><span class="p">),</span> <span class="n">key</span>
<span class="gp">... </span>        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<span class="gp">... </span>            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="gp">... </span>                <span class="k">print</span> <span class="s">&#39;    {0}: {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</pre></div>
</div>
<p>And another helper for displaying messages in the virgin queue.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">virginq</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">switchboards</span><span class="p">[</span><span class="s">&#39;virgin&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">dequeue</span><span class="p">(</span><span class="n">whichq</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">expected_count</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">whichq</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<span class="gp">... </span>        <span class="n">whichq</span> <span class="o">=</span> <span class="n">virginq</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">whichq</span><span class="o">.</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected_count</span><span class="p">,</span> <span class="p">(</span>
<span class="gp">... </span>        <span class="s">&#39;Unexpected file count: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">whichq</span><span class="o">.</span><span class="n">files</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">filebase</span> <span class="o">=</span> <span class="n">whichq</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">... </span>    <span class="n">qmsg</span><span class="p">,</span> <span class="n">qdata</span> <span class="o">=</span> <span class="n">whichq</span><span class="o">.</span><span class="n">dequeue</span><span class="p">(</span><span class="n">filebase</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">whichq</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="n">filebase</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">qmsg</span><span class="p">,</span> <span class="n">qdata</span>
</pre></div>
</div>
<div class="section" id="mailing-list-centric">
<h2>Mailing list centric<a class="headerlink" href="#mailing-list-centric" title="Permalink to this headline">¶</a></h2>
<p>A set of requests are always related to a particular mailing list, so given a
mailing list you need to get its requests object.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mailman.interfaces.requests</span> <span class="kn">import</span> <span class="n">IListRequests</span><span class="p">,</span> <span class="n">IRequests</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.component</span> <span class="kn">import</span> <span class="n">getUtility</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.interface.verify</span> <span class="kn">import</span> <span class="n">verifyObject</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span> <span class="o">=</span> <span class="n">create_list</span><span class="p">(</span><span class="s">&#39;test@example.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span> <span class="o">=</span> <span class="n">getUtility</span><span class="p">(</span><span class="n">IRequests</span><span class="p">)</span><span class="o">.</span><span class="n">get_list_requests</span><span class="p">(</span><span class="n">mlist</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">verifyObject</span><span class="p">(</span><span class="n">IListRequests</span><span class="p">,</span> <span class="n">requests</span><span class="p">)</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">mailing_list</span>
<span class="go">&lt;mailing list &quot;test@example.com&quot; at ...&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="holding-requests">
<h2>Holding requests<a class="headerlink" href="#holding-requests" title="Permalink to this headline">¶</a></h2>
<p>The list&#8217;s requests database starts out empty.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">count</span>
<span class="go">0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">held_requests</span><span class="p">)</span>
<span class="go">[]</span>
</pre></div>
</div>
<p>At the lowest level, the requests database is very simple.  Holding a request
requires a request type (as an enum value), a key, and an optional dictionary
of associated data.  The request database assigns no semantics to the held
data, except for the request type.  Here we hold some simple bits of data.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mailman.interfaces.requests</span> <span class="kn">import</span> <span class="n">RequestType</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">id_1</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">hold_request</span><span class="p">(</span><span class="n">RequestType</span><span class="o">.</span><span class="n">held_message</span><span class="p">,</span>   <span class="s">&#39;hold_1&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">id_2</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">hold_request</span><span class="p">(</span><span class="n">RequestType</span><span class="o">.</span><span class="n">subscription</span><span class="p">,</span>   <span class="s">&#39;hold_2&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">id_3</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">hold_request</span><span class="p">(</span><span class="n">RequestType</span><span class="o">.</span><span class="n">unsubscription</span><span class="p">,</span> <span class="s">&#39;hold_3&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">id_4</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">hold_request</span><span class="p">(</span><span class="n">RequestType</span><span class="o">.</span><span class="n">held_message</span><span class="p">,</span>   <span class="s">&#39;hold_4&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">id_1</span><span class="p">,</span> <span class="n">id_2</span><span class="p">,</span> <span class="n">id_3</span><span class="p">,</span> <span class="n">id_4</span>
<span class="go">(1, 2, 3, 4)</span>
</pre></div>
</div>
<p>And of course, now we can see that there are four requests being held.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">count</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">count_of</span><span class="p">(</span><span class="n">RequestType</span><span class="o">.</span><span class="n">held_message</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">count_of</span><span class="p">(</span><span class="n">RequestType</span><span class="o">.</span><span class="n">subscription</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">count_of</span><span class="p">(</span><span class="n">RequestType</span><span class="o">.</span><span class="n">unsubscription</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">show_holds</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span>
<span class="go">1 RequestType.held_message hold_1</span>
<span class="go">2 RequestType.subscription hold_2</span>
<span class="go">3 RequestType.unsubscription hold_3</span>
<span class="go">4 RequestType.held_message hold_4</span>
</pre></div>
</div>
<p>If we try to hold a request with a bogus type, we get an exception.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">hold_request</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&#39;foo&#39;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="nc">TypeError</span>: <span class="n-Identifier">5</span>
</pre></div>
</div>
<p>We can hold requests with additional data.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">foo</span><span class="o">=</span><span class="s">&#39;yes&#39;</span><span class="p">,</span> <span class="n">bar</span><span class="o">=</span><span class="s">&#39;no&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">id_5</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">hold_request</span><span class="p">(</span><span class="n">RequestType</span><span class="o">.</span><span class="n">held_message</span><span class="p">,</span> <span class="s">&#39;hold_5&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">id_5</span>
<span class="go">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">count</span>
<span class="go">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">show_holds</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span>
<span class="go">1 RequestType.held_message hold_1</span>
<span class="go">2 RequestType.subscription hold_2</span>
<span class="go">3 RequestType.unsubscription hold_3</span>
<span class="go">4 RequestType.held_message hold_4</span>
<span class="go">5 RequestType.held_message hold_5</span>
<span class="go">    bar: no</span>
<span class="go">    foo: yes</span>
</pre></div>
</div>
</div>
<div class="section" id="getting-requests">
<h2>Getting requests<a class="headerlink" href="#getting-requests" title="Permalink to this headline">¶</a></h2>
<p>We can ask the requests database for a specific request, by providing the id
of the request data we want.  This returns a 2-tuple of the key and data we
originally held.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">key</span>
<span class="go">hold_2</span>
</pre></div>
</div>
<p>Because we did not store additional data with request 2, it comes back as None
now.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">data</span>
<span class="go">None</span>
</pre></div>
</div>
<p>However, if we ask for a request that had data, we&#8217;d get it back now.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">key</span>
<span class="go">hold_5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dump_msgdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="go">bar: no</span>
<span class="go">foo: yes</span>
</pre></div>
</div>
<p>If we ask for a request that is not in the database, we get None back.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="mi">801</span><span class="p">)</span>
<span class="go">None</span>
</pre></div>
</div>
</div>
<div class="section" id="iterating-over-requests">
<h2>Iterating over requests<a class="headerlink" href="#iterating-over-requests" title="Permalink to this headline">¶</a></h2>
<p>To make it easier to find specific requests, the list requests can be iterated
over by type.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">count_of</span><span class="p">(</span><span class="n">RequestType</span><span class="o">.</span><span class="n">held_message</span><span class="p">)</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">requests</span><span class="o">.</span><span class="n">of_type</span><span class="p">(</span><span class="n">RequestType</span><span class="o">.</span><span class="n">held_message</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="n">request</span><span class="o">.</span><span class="n">request_type</span> <span class="ow">is</span> <span class="n">RequestType</span><span class="o">.</span><span class="n">held_message</span>
<span class="gp">... </span>    <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">key</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="gp">... </span>            <span class="k">print</span> <span class="s">&#39;    {0}: {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
<span class="go">1 hold_1</span>
<span class="go">4 hold_4</span>
<span class="go">5 hold_5</span>
<span class="go">bar: no</span>
<span class="go">foo: yes</span>
</pre></div>
</div>
</div>
<div class="section" id="deleting-requests">
<h2>Deleting requests<a class="headerlink" href="#deleting-requests" title="Permalink to this headline">¶</a></h2>
<p>Once a specific request has been handled, it will be deleted from the requests
database.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">delete_request</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">count</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">show_holds</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span>
<span class="go">1 RequestType.held_message hold_1</span>
<span class="go">3 RequestType.unsubscription hold_3</span>
<span class="go">4 RequestType.held_message hold_4</span>
<span class="go">5 RequestType.held_message hold_5</span>
<span class="go">    bar: no</span>
<span class="go">    foo: yes</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">None</span>
</pre></div>
</div>
<p>We get an exception if we ask to delete a request that isn&#8217;t in the database.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">delete_request</span><span class="p">(</span><span class="mi">801</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="nc">KeyError</span>: <span class="n-Identifier">801</span>
</pre></div>
</div>
<p>For the next section, we first clean up all the current requests.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">requests</span><span class="o">.</span><span class="n">held_requests</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">requests</span><span class="o">.</span><span class="n">delete_request</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">count</span>
<span class="go">0</span>
</pre></div>
</div>
</div>
<div class="section" id="application-support">
<h2>Application support<a class="headerlink" href="#application-support" title="Permalink to this headline">¶</a></h2>
<p>There are several higher level interfaces available in the <tt class="docutils literal"><span class="pre">mailman.app</span></tt>
package which can be used to hold messages, subscription, and unsubscriptions.
There are also interfaces for disposing of these requests in an application
specific and consistent way.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mailman.app</span> <span class="kn">import</span> <span class="n">moderator</span>
</pre></div>
</div>
</div>
<div class="section" id="holding-messages">
<h2>Holding messages<a class="headerlink" href="#holding-messages" title="Permalink to this headline">¶</a></h2>
<p>For this section, we need a mailing list and at least one message.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span> <span class="o">=</span> <span class="n">create_list</span><span class="p">(</span><span class="s">&#39;alist@example.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span><span class="o">.</span><span class="n">preferred_language</span> <span class="o">=</span> <span class="s">&#39;en&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span><span class="o">.</span><span class="n">real_name</span> <span class="o">=</span> <span class="s">&#39;A Test List&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span> <span class="o">=</span> <span class="n">message_from_string</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="gp">... </span><span class="s">From: aperson@example.org</span>
<span class="gp">... </span><span class="s">To: alist@example.com</span>
<span class="gp">... </span><span class="s">Subject: Something important</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">Here&#39;s something important about our mailing list.</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Holding a message means keeping a copy of it that a moderator must approve
before the message is posted to the mailing list.  To hold the message, you
must supply the message, message metadata, and a text reason for the hold.  In
this case, we won&#8217;t include any additional metadata.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">id_1</span> <span class="o">=</span> <span class="n">moderator</span><span class="o">.</span><span class="n">hold_message</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="p">{},</span> <span class="s">&#39;Needs approval&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">id_1</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
<span class="go">True</span>
</pre></div>
</div>
<p>We can also hold a message with some additional metadata.</p>
<div class="highlight-python"><pre># Delete the Message-ID from the previous hold so we don't try to store
# collisions in the message storage.
&gt;&gt;&gt; del msg['message-id']
&gt;&gt;&gt; msgdata = dict(sender='aperson@example.com',
...                approved=True,
...                received_time=123.45)
&gt;&gt;&gt; id_2 = moderator.hold_message(mlist, msg, msgdata, 'Feeling ornery')
&gt;&gt;&gt; requests.get_request(id_2) is not None
True</pre>
</div>
<p>Once held, the moderator can select one of several dispositions.  The most
trivial is to simply defer a decision for now.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mailman.interfaces.action</span> <span class="kn">import</span> <span class="n">Action</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_message</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_1</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">defer</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">id_1</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
<span class="go">True</span>
</pre></div>
</div>
<p>The moderator can also discard the message.  This is often done with spam.
Bye bye message!</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_message</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_1</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">discard</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">id_1</span><span class="p">)</span>
<span class="go">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">virginq</span><span class="o">.</span><span class="n">files</span>
<span class="go">[]</span>
</pre></div>
</div>
<p>The message can be rejected, meaning it is bounced back to the sender.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_message</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_2</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">reject</span><span class="p">,</span> <span class="s">&#39;Off topic&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">id_2</span><span class="p">)</span>
<span class="go">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qmsg</span><span class="p">,</span> <span class="n">qdata</span> <span class="o">=</span> <span class="n">dequeue</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">qmsg</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
<span class="go">MIME-Version: 1.0</span>
<span class="go">Content-Type: text/plain; charset=&quot;us-ascii&quot;</span>
<span class="go">Content-Transfer-Encoding: 7bit</span>
<span class="go">Subject: Request to mailing list &quot;A Test List&quot; rejected</span>
<span class="go">From: alist-bounces@example.com</span>
<span class="go">To: aperson@example.org</span>
<span class="go">Message-ID: ...</span>
<span class="go">Date: ...</span>
<span class="go">Precedence: bulk</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">Your request to the alist@example.com mailing list</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">    Posting of your message titled &quot;Something important&quot;</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">has been rejected by the list moderator.  The moderator gave the</span>
<span class="go">following reason for rejecting your request:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">&quot;Off topic&quot;</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">Any questions or comments should be directed to the list administrator</span>
<span class="go">at:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">    alist-owner@example.com</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dump_msgdata</span><span class="p">(</span><span class="n">qdata</span><span class="p">)</span>
<span class="go">_parsemsg           : False</span>
<span class="go">listname            : alist@example.com</span>
<span class="go">nodecorate          : True</span>
<span class="go">recipients          : [u&#39;aperson@example.org&#39;]</span>
<span class="go">reduced_list_headers: True</span>
<span class="go">version             : 3</span>
</pre></div>
</div>
<p>Or the message can be approved.  This actually places the message back into
the incoming queue for further processing, however the message metadata
indicates that the message has been approved.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">id_3</span> <span class="o">=</span> <span class="n">moderator</span><span class="o">.</span><span class="n">hold_message</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msgdata</span><span class="p">,</span> <span class="s">&#39;Needs approval&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_message</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_3</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">inq</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">switchboards</span><span class="p">[</span><span class="s">&#39;in&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qmsg</span><span class="p">,</span> <span class="n">qdata</span> <span class="o">=</span> <span class="n">dequeue</span><span class="p">(</span><span class="n">inq</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">qmsg</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
<span class="go">From: aperson@example.org</span>
<span class="go">To: alist@example.com</span>
<span class="go">Subject: Something important</span>
<span class="go">Message-ID: ...</span>
<span class="go">X-Message-ID-Hash: ...</span>
<span class="go">X-Mailman-Approved-At: ...</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">Here&#39;s something important about our mailing list.</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dump_msgdata</span><span class="p">(</span><span class="n">qdata</span><span class="p">)</span>
<span class="go">_parsemsg         : False</span>
<span class="go">approved          : True</span>
<span class="go">moderator_approved: True</span>
<span class="go">sender            : aperson@example.com</span>
<span class="go">version           : 3</span>
</pre></div>
</div>
<p>In addition to any of the above dispositions, the message can also be
preserved for further study.  Ordinarily the message is removed from the
global message store after its disposition (though approved messages may be
re-added to the message store).  When handling a message, we can tell the
moderator interface to also preserve a copy, essentially telling it not to
delete the message from the storage.  First, without the switch, the message
is deleted.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">msg</span> <span class="o">=</span> <span class="n">message_from_string</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="gp">... </span><span class="s">From: aperson@example.org</span>
<span class="gp">... </span><span class="s">To: alist@example.com</span>
<span class="gp">... </span><span class="s">Subject: Something important</span>
<span class="gp">... </span><span class="s">Message-ID: &lt;12345&gt;</span>
<span class="gp">...</span><span class="s"></span>
<span class="gp">... </span><span class="s">Here&#39;s something important about our mailing list.</span>
<span class="gp">... </span><span class="s">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">id_4</span> <span class="o">=</span> <span class="n">moderator</span><span class="o">.</span><span class="n">hold_message</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="p">{},</span> <span class="s">&#39;Needs approval&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_message</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_4</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">discard</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mailman.interfaces.messages</span> <span class="kn">import</span> <span class="n">IMessageStore</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.component</span> <span class="kn">import</span> <span class="n">getUtility</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">message_store</span> <span class="o">=</span> <span class="n">getUtility</span><span class="p">(</span><span class="n">IMessageStore</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">message_store</span><span class="o">.</span><span class="n">get_message_by_id</span><span class="p">(</span><span class="s">&#39;&lt;12345&gt;&#39;</span><span class="p">)</span>
<span class="go">None</span>
</pre></div>
</div>
<p>But if we ask to preserve the message when we discard it, it will be held in
the message store after disposition.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">id_4</span> <span class="o">=</span> <span class="n">moderator</span><span class="o">.</span><span class="n">hold_message</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="p">{},</span> <span class="s">&#39;Needs approval&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_message</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_4</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">discard</span><span class="p">,</span> <span class="n">preserve</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stored_msg</span> <span class="o">=</span> <span class="n">message_store</span><span class="o">.</span><span class="n">get_message_by_id</span><span class="p">(</span><span class="s">&#39;&lt;12345&gt;&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">stored_msg</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
<span class="go">From: aperson@example.org</span>
<span class="go">To: alist@example.com</span>
<span class="go">Subject: Something important</span>
<span class="go">Message-ID: &lt;12345&gt;</span>
<span class="go">X-Message-ID-Hash: 4CF7EAU3SIXBPXBB5S6PEUMO62MWGQN6</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">Here&#39;s something important about our mailing list.</span>
<span class="go">&lt;BLANKLINE&gt;</span>
</pre></div>
</div>
<p>Orthogonal to preservation, the message can also be forwarded to another
address.  This is helpful for getting the message into the inbox of one of the
moderators.</p>
<div class="highlight-python"><pre># Set a new Message-ID from the previous hold so we don't try to store
# collisions in the message storage.
&gt;&gt;&gt; del msg['message-id']
&gt;&gt;&gt; msg['Message-ID'] = '&lt;abcde&gt;'
&gt;&gt;&gt; id_4 = moderator.hold_message(mlist, msg, {}, 'Needs approval')
&gt;&gt;&gt; moderator.handle_message(mlist, id_4, Action.discard,
...                          forward=['zperson@example.com'])
&gt;&gt;&gt; qmsg, qdata = dequeue()
&gt;&gt;&gt; print qmsg.as_string()
Subject: Forward of moderated message
From: alist-bounces@example.com
To: zperson@example.com
MIME-Version: 1.0
Content-Type: message/rfc822
Message-ID: ...
Date: ...
Precedence: bulk
&lt;BLANKLINE&gt;
From: aperson@example.org
To: alist@example.com
Subject: Something important
Message-ID: &lt;abcde&gt;
X-Message-ID-Hash: EN2R5UQFMOUTCL44FLNNPLSXBIZW62ER
&lt;BLANKLINE&gt;
Here's something important about our mailing list.
&lt;BLANKLINE&gt;
&gt;&gt;&gt; dump_msgdata(qdata)
_parsemsg           : False
listname            : alist@example.com
nodecorate          : True
recipients          : [u'zperson@example.com']
reduced_list_headers: True
version             : 3</pre>
</div>
</div>
<div class="section" id="holding-subscription-requests">
<h2>Holding subscription requests<a class="headerlink" href="#holding-subscription-requests" title="Permalink to this headline">¶</a></h2>
<p>For closed lists, subscription requests will also be held for moderator
approval.  In this case, several pieces of information related to the
subscription must be provided, including the subscriber&#8217;s address and real
name, their password (possibly hashed), what kind of delivery option they are
choosing and their preferred language.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mailman.interfaces.member</span> <span class="kn">import</span> <span class="n">DeliveryMode</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span><span class="o">.</span><span class="n">admin_immed_notify</span> <span class="o">=</span> <span class="bp">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">id_3</span> <span class="o">=</span> <span class="n">moderator</span><span class="o">.</span><span class="n">hold_subscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&#39;bperson@example.org&#39;</span><span class="p">,</span> <span class="s">&#39;Ben Person&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&#39;{NONE}abcxyz&#39;</span><span class="p">,</span> <span class="n">DeliveryMode</span><span class="o">.</span><span class="n">regular</span><span class="p">,</span> <span class="s">&#39;en&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">id_3</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
<span class="go">True</span>
</pre></div>
</div>
<p>In the above case the mailing list was not configured to send the list
moderators a notice about the hold, so no email message is in the virgin
queue.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">virginq</span><span class="o">.</span><span class="n">files</span>
<span class="go">[]</span>
</pre></div>
</div>
<p>But if we set the list up to notify the list moderators immediately when a
message is held for approval, there will be a message placed in the virgin
queue when the message is held.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span><span class="o">.</span><span class="n">admin_immed_notify</span> <span class="o">=</span> <span class="bp">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c"># XXX This will almost certainly change once we&#39;ve worked out the web</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c"># space layout for mailing lists now.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">id_4</span> <span class="o">=</span> <span class="n">moderator</span><span class="o">.</span><span class="n">hold_subscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&#39;cperson@example.org&#39;</span><span class="p">,</span> <span class="s">&#39;Claire Person&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&#39;{NONE}zyxcba&#39;</span><span class="p">,</span> <span class="n">DeliveryMode</span><span class="o">.</span><span class="n">regular</span><span class="p">,</span> <span class="s">&#39;en&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">id_4</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qmsg</span><span class="p">,</span> <span class="n">qdata</span> <span class="o">=</span> <span class="n">dequeue</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">qmsg</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
<span class="go">MIME-Version: 1.0</span>
<span class="go">Content-Type: text/plain; charset=&quot;us-ascii&quot;</span>
<span class="go">Content-Transfer-Encoding: 7bit</span>
<span class="go">Subject: New subscription request to list A Test List from</span>
<span class="go"> cperson@example.org</span>
<span class="go">From: alist-owner@example.com</span>
<span class="go">To: alist-owner@example.com</span>
<span class="go">Message-ID: ...</span>
<span class="go">Date: ...</span>
<span class="go">Precedence: bulk</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">Your authorization is required for a mailing list subscription request</span>
<span class="go">approval:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">    For:  cperson@example.org</span>
<span class="go">    List: alist@example.com</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">At your convenience, visit:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">    http://lists.example.com/admindb/alist@example.com</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">to process the request.</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dump_msgdata</span><span class="p">(</span><span class="n">qdata</span><span class="p">)</span>
<span class="go">_parsemsg           : False</span>
<span class="go">listname            : alist@example.com</span>
<span class="go">nodecorate          : True</span>
<span class="go">recipients          : [u&#39;alist-owner@example.com&#39;]</span>
<span class="go">reduced_list_headers: True</span>
<span class="go">tomoderators        : True</span>
<span class="go">version             : 3</span>
</pre></div>
</div>
<p>Once held, the moderator can select one of several dispositions.  The most
trivial is to simply defer a decision for now.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_subscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_3</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">defer</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">id_3</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
<span class="go">True</span>
</pre></div>
</div>
<p>The held subscription can also be discarded.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_subscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_3</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">discard</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">id_3</span><span class="p">)</span>
<span class="go">None</span>
</pre></div>
</div>
<p>The request can be rejected, in which case a message is sent to the
subscriber.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_subscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_4</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">reject</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&#39;This is a closed list&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">id_4</span><span class="p">)</span>
<span class="go">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qmsg</span><span class="p">,</span> <span class="n">qdata</span> <span class="o">=</span> <span class="n">dequeue</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">qmsg</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
<span class="go">MIME-Version: 1.0</span>
<span class="go">Content-Type: text/plain; charset=&quot;us-ascii&quot;</span>
<span class="go">Content-Transfer-Encoding: 7bit</span>
<span class="go">Subject: Request to mailing list &quot;A Test List&quot; rejected</span>
<span class="go">From: alist-bounces@example.com</span>
<span class="go">To: cperson@example.org</span>
<span class="go">Message-ID: ...</span>
<span class="go">Date: ...</span>
<span class="go">Precedence: bulk</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">Your request to the alist@example.com mailing list</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">    Subscription request</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">has been rejected by the list moderator.  The moderator gave the</span>
<span class="go">following reason for rejecting your request:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">&quot;This is a closed list&quot;</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">Any questions or comments should be directed to the list administrator</span>
<span class="go">at:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">    alist-owner@example.com</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dump_msgdata</span><span class="p">(</span><span class="n">qdata</span><span class="p">)</span>
<span class="go">_parsemsg           : False</span>
<span class="go">listname            : alist@example.com</span>
<span class="go">nodecorate          : True</span>
<span class="go">recipients          : [u&#39;cperson@example.org&#39;]</span>
<span class="go">reduced_list_headers: True</span>
<span class="go">version             : 3</span>
</pre></div>
</div>
<p>The subscription can also be accepted.  This subscribes the address to the
mailing list.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span><span class="o">.</span><span class="n">send_welcome_msg</span> <span class="o">=</span> <span class="bp">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">id_4</span> <span class="o">=</span> <span class="n">moderator</span><span class="o">.</span><span class="n">hold_subscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&#39;fperson@example.org&#39;</span><span class="p">,</span> <span class="s">&#39;Frank Person&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&#39;{NONE}abcxyz&#39;</span><span class="p">,</span> <span class="n">DeliveryMode</span><span class="o">.</span><span class="n">regular</span><span class="p">,</span> <span class="s">&#39;en&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>A message will be sent to the moderators telling them about the held
subscription and the fact that they may need to approve it.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">qmsg</span><span class="p">,</span> <span class="n">qdata</span> <span class="o">=</span> <span class="n">dequeue</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">qmsg</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
<span class="go">MIME-Version: 1.0</span>
<span class="go">Content-Type: text/plain; charset=&quot;us-ascii&quot;</span>
<span class="go">Content-Transfer-Encoding: 7bit</span>
<span class="go">Subject: New subscription request to list A Test List from</span>
<span class="go"> fperson@example.org</span>
<span class="go">From: alist-owner@example.com</span>
<span class="go">To: alist-owner@example.com</span>
<span class="go">Message-ID: ...</span>
<span class="go">Date: ...</span>
<span class="go">Precedence: bulk</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">Your authorization is required for a mailing list subscription request</span>
<span class="go">approval:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">    For:  fperson@example.org</span>
<span class="go">    List: alist@example.com</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">At your convenience, visit:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">    http://lists.example.com/admindb/alist@example.com</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">to process the request.</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dump_msgdata</span><span class="p">(</span><span class="n">qdata</span><span class="p">)</span>
<span class="go">_parsemsg           : False</span>
<span class="go">listname            : alist@example.com</span>
<span class="go">nodecorate          : True</span>
<span class="go">recipients          : [u&#39;alist-owner@example.com&#39;]</span>
<span class="go">reduced_list_headers: True</span>
<span class="go">tomoderators        : True</span>
<span class="go">version             : 3</span>
</pre></div>
</div>
<p>Accept the subscription request.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span><span class="o">.</span><span class="n">admin_notify_mchanges</span> <span class="o">=</span> <span class="bp">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_subscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_4</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
</pre></div>
</div>
<p>There are now two messages in the virgin queue.  One is a welcome message
being sent to the user and the other is a subscription notification that is
sent to the moderators.  The only good way to tell which is which is to look
at the recipient list.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">qmsg_1</span><span class="p">,</span> <span class="n">qdata_1</span> <span class="o">=</span> <span class="n">dequeue</span><span class="p">(</span><span class="n">expected_count</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qmsg_2</span><span class="p">,</span> <span class="n">qdata_2</span> <span class="o">=</span> <span class="n">dequeue</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="s">&#39;fperson@example.org&#39;</span> <span class="ow">in</span> <span class="n">qdata_1</span><span class="p">[</span><span class="s">&#39;recipients&#39;</span><span class="p">]:</span>
<span class="gp">... </span>    <span class="c"># The first message is the welcome message</span>
<span class="gp">... </span>    <span class="n">welcome_qmsg</span> <span class="o">=</span> <span class="n">qmsg_1</span>
<span class="gp">... </span>    <span class="n">welcome_qdata</span> <span class="o">=</span> <span class="n">qdata_1</span>
<span class="gp">... </span>    <span class="n">admin_qmsg</span> <span class="o">=</span> <span class="n">qmsg_2</span>
<span class="gp">... </span>    <span class="n">admin_qdata</span> <span class="o">=</span> <span class="n">qdata_2</span>
<span class="gp">... </span><span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">welcome_qmsg</span> <span class="o">=</span> <span class="n">qmsg_2</span>
<span class="gp">... </span>    <span class="n">welcome_qdata</span> <span class="o">=</span> <span class="n">qdata_2</span>
<span class="gp">... </span>    <span class="n">admin_qmsg</span> <span class="o">=</span> <span class="n">qmsg_1</span>
<span class="gp">... </span>    <span class="n">admin_qdata</span> <span class="o">=</span> <span class="n">qdata_1</span>
</pre></div>
</div>
<p>The welcome message is sent to the person who just subscribed.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">welcome_qmsg</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
<span class="go">MIME-Version: 1.0</span>
<span class="go">Content-Type: text/plain; charset=&quot;us-ascii&quot;</span>
<span class="go">Content-Transfer-Encoding: 7bit</span>
<span class="go">Subject: Welcome to the &quot;A Test List&quot; mailing list</span>
<span class="go">From: alist-request@example.com</span>
<span class="go">To: fperson@example.org</span>
<span class="go">X-No-Archive: yes</span>
<span class="go">Message-ID: ...</span>
<span class="go">Date: ...</span>
<span class="go">Precedence: bulk</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">Welcome to the &quot;A Test List&quot; mailing list!</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">To post to this list, send your email to:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">  alist@example.com</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">General information about the mailing list is at:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">  http://lists.example.com/listinfo/alist@example.com</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">If you ever want to unsubscribe or change your options (eg, switch to</span>
<span class="go">or from digest mode, change your password, etc.), visit your</span>
<span class="go">subscription page at:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">  http://example.com/fperson@example.org</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">You can also make such adjustments via email by sending a message to:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">  alist-request@example.com</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">with the word &#39;help&#39; in the subject or body (don&#39;t include the</span>
<span class="go">quotes), and you will get back a message with instructions.  You will</span>
<span class="go">need your password to change your options, but for security purposes,</span>
<span class="go">this email is not included here.  There is also a button on your</span>
<span class="go">options page that will send your current password to you.</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dump_msgdata</span><span class="p">(</span><span class="n">welcome_qdata</span><span class="p">)</span>
<span class="go">_parsemsg           : False</span>
<span class="go">listname            : alist@example.com</span>
<span class="go">nodecorate          : True</span>
<span class="go">recipients          : [u&#39;fperson@example.org&#39;]</span>
<span class="go">reduced_list_headers: True</span>
<span class="go">verp                : False</span>
<span class="go">version             : 3</span>
</pre></div>
</div>
<p>The admin message is sent to the moderators.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">admin_qmsg</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
<span class="go">MIME-Version: 1.0</span>
<span class="go">Content-Type: text/plain; charset=&quot;us-ascii&quot;</span>
<span class="go">Content-Transfer-Encoding: 7bit</span>
<span class="go">Subject: A Test List subscription notification</span>
<span class="go">From: changeme@example.com</span>
<span class="go">To: alist-owner@example.com</span>
<span class="go">Message-ID: ...</span>
<span class="go">Date: ...</span>
<span class="go">Precedence: bulk</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">Frank Person &lt;fperson@example.org&gt; has been successfully subscribed to</span>
<span class="go">A Test List.</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dump_msgdata</span><span class="p">(</span><span class="n">admin_qdata</span><span class="p">)</span>
<span class="go">_parsemsg           : False</span>
<span class="go">envsender           : changeme@example.com</span>
<span class="go">listname            : alist@example.com</span>
<span class="go">nodecorate          : True</span>
<span class="go">recipients          : []</span>
<span class="go">reduced_list_headers: True</span>
<span class="go">version             : 3</span>
</pre></div>
</div>
<p>Frank Person is now a member of the mailing list.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">member</span> <span class="o">=</span> <span class="n">mlist</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">get_member</span><span class="p">(</span><span class="s">&#39;fperson@example.org&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">member</span>
<span class="go">&lt;Member: Frank Person &lt;fperson@example.org&gt;</span>
<span class="go">         on alist@example.com as MemberRole.member&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">member</span><span class="o">.</span><span class="n">preferred_language</span>
<span class="go">&lt;Language [en] English (USA)&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">member</span><span class="o">.</span><span class="n">delivery_mode</span>
<span class="go">DeliveryMode.regular</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mailman.interfaces.usermanager</span> <span class="kn">import</span> <span class="n">IUserManager</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.component</span> <span class="kn">import</span> <span class="n">getUtility</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user_manager</span> <span class="o">=</span> <span class="n">getUtility</span><span class="p">(</span><span class="n">IUserManager</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">get_user</span><span class="p">(</span><span class="n">member</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">real_name</span>
<span class="go">Frank Person</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
<span class="go">{NONE}abcxyz</span>
</pre></div>
</div>
</div>
<div class="section" id="holding-unsubscription-requests">
<h2>Holding unsubscription requests<a class="headerlink" href="#holding-unsubscription-requests" title="Permalink to this headline">¶</a></h2>
<p>Some lists, though it is rare, require moderator approval for unsubscriptions.
In this case, only the unsubscribing address is required.  Like subscriptions,
unsubscription holds can send the list&#8217;s moderators an immediate
notification.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span><span class="o">.</span><span class="n">admin_immed_notify</span> <span class="o">=</span> <span class="bp">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">mailman.interfaces.member</span> <span class="kn">import</span> <span class="n">MemberRole</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user_1</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;gperson@example.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">address_1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">user_1</span><span class="o">.</span><span class="n">addresses</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">address_1</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">MemberRole</span><span class="o">.</span><span class="n">member</span><span class="p">)</span>
<span class="go">&lt;Member: gperson@example.com on alist@example.com as MemberRole.member&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">user_2</span> <span class="o">=</span> <span class="n">user_manager</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;hperson@example.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">address_2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">user_2</span><span class="o">.</span><span class="n">addresses</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">address_2</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">MemberRole</span><span class="o">.</span><span class="n">member</span><span class="p">)</span>
<span class="go">&lt;Member: hperson@example.com on alist@example.com as MemberRole.member&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">id_5</span> <span class="o">=</span> <span class="n">moderator</span><span class="o">.</span><span class="n">hold_unsubscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="s">&#39;gperson@example.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">id_5</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">virginq</span><span class="o">.</span><span class="n">files</span>
<span class="go">[]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span><span class="o">.</span><span class="n">admin_immed_notify</span> <span class="o">=</span> <span class="bp">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">id_6</span> <span class="o">=</span> <span class="n">moderator</span><span class="o">.</span><span class="n">hold_unsubscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="s">&#39;hperson@example.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qmsg</span><span class="p">,</span> <span class="n">qdata</span> <span class="o">=</span> <span class="n">dequeue</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">qmsg</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
<span class="go">MIME-Version: 1.0</span>
<span class="go">Content-Type: text/plain; charset=&quot;us-ascii&quot;</span>
<span class="go">Content-Transfer-Encoding: 7bit</span>
<span class="go">Subject: New unsubscription request from A Test List by hperson@example.com</span>
<span class="go">From: alist-owner@example.com</span>
<span class="go">To: alist-owner@example.com</span>
<span class="go">Message-ID: ...</span>
<span class="go">Date: ...</span>
<span class="go">Precedence: bulk</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">Your authorization is required for a mailing list unsubscription</span>
<span class="go">request approval:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">    By:   hperson@example.com</span>
<span class="go">    From: alist@example.com</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">At your convenience, visit:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">    http://lists.example.com/admindb/alist@example.com</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">to process the request.</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dump_msgdata</span><span class="p">(</span><span class="n">qdata</span><span class="p">)</span>
<span class="go">_parsemsg           : False</span>
<span class="go">listname            : alist@example.com</span>
<span class="go">nodecorate          : True</span>
<span class="go">recipients          : [u&#39;alist-owner@example.com&#39;]</span>
<span class="go">reduced_list_headers: True</span>
<span class="go">tomoderators        : True</span>
<span class="go">version             : 3</span>
</pre></div>
</div>
<p>There are now two addresses with held unsubscription requests.  As above, one
of the actions we can take is to defer to the decision.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_unsubscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_5</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">defer</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">id_5</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
<span class="go">True</span>
</pre></div>
</div>
<p>The held unsubscription can also be discarded, and the member will remain
subscribed.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_unsubscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_5</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">discard</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">id_5</span><span class="p">)</span>
<span class="go">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">get_member</span><span class="p">(</span><span class="s">&#39;gperson@example.com&#39;</span><span class="p">)</span>
<span class="go">&lt;Member: gperson@example.com on alist@example.com as MemberRole.member&gt;</span>
</pre></div>
</div>
<p>The request can be rejected, in which case a message is sent to the member,
and the person remains a member of the mailing list.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_unsubscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_6</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">reject</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s">&#39;This list is a prison.&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">requests</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">id_6</span><span class="p">)</span>
<span class="go">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qmsg</span><span class="p">,</span> <span class="n">qdata</span> <span class="o">=</span> <span class="n">dequeue</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">qmsg</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
<span class="go">MIME-Version: 1.0</span>
<span class="go">Content-Type: text/plain; charset=&quot;us-ascii&quot;</span>
<span class="go">Content-Transfer-Encoding: 7bit</span>
<span class="go">Subject: Request to mailing list &quot;A Test List&quot; rejected</span>
<span class="go">From: alist-bounces@example.com</span>
<span class="go">To: hperson@example.com</span>
<span class="go">Message-ID: ...</span>
<span class="go">Date: ...</span>
<span class="go">Precedence: bulk</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">Your request to the alist@example.com mailing list</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">    Unsubscription request</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">has been rejected by the list moderator.  The moderator gave the</span>
<span class="go">following reason for rejecting your request:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">&quot;This list is a prison.&quot;</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">Any questions or comments should be directed to the list administrator</span>
<span class="go">at:</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">    alist-owner@example.com</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dump_msgdata</span><span class="p">(</span><span class="n">qdata</span><span class="p">)</span>
<span class="go">_parsemsg           : False</span>
<span class="go">listname            : alist@example.com</span>
<span class="go">nodecorate          : True</span>
<span class="go">recipients          : [u&#39;hperson@example.com&#39;]</span>
<span class="go">reduced_list_headers: True</span>
<span class="go">version             : 3</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">get_member</span><span class="p">(</span><span class="s">&#39;hperson@example.com&#39;</span><span class="p">)</span>
<span class="go">&lt;Member: hperson@example.com on alist@example.com as MemberRole.member&gt;</span>
</pre></div>
</div>
<p>The unsubscription request can also be accepted.  This removes the member from
the mailing list.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span><span class="o">.</span><span class="n">send_goodbye_msg</span> <span class="o">=</span> <span class="bp">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span><span class="o">.</span><span class="n">goodbye_msg</span> <span class="o">=</span> <span class="s">&#39;So long!&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">mlist</span><span class="o">.</span><span class="n">admin_immed_notify</span> <span class="o">=</span> <span class="bp">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">id_7</span> <span class="o">=</span> <span class="n">moderator</span><span class="o">.</span><span class="n">hold_unsubscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="s">&#39;gperson@example.com&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">moderator</span><span class="o">.</span><span class="n">handle_unsubscription</span><span class="p">(</span><span class="n">mlist</span><span class="p">,</span> <span class="n">id_7</span><span class="p">,</span> <span class="n">Action</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">mlist</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">get_member</span><span class="p">(</span><span class="s">&#39;gperson@example.com&#39;</span><span class="p">)</span>
<span class="go">None</span>
</pre></div>
</div>
<p>There are now two messages in the virgin queue, one to the member who was just
unsubscribed and another to the moderators informing them of this membership
change.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">qmsg_1</span><span class="p">,</span> <span class="n">qdata_1</span> <span class="o">=</span> <span class="n">dequeue</span><span class="p">(</span><span class="n">expected_count</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qmsg_2</span><span class="p">,</span> <span class="n">qdata_2</span> <span class="o">=</span> <span class="n">dequeue</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="s">&#39;gperson@example.com&#39;</span> <span class="ow">in</span> <span class="n">qdata_1</span><span class="p">[</span><span class="s">&#39;recipients&#39;</span><span class="p">]:</span>
<span class="gp">... </span>    <span class="c"># The first message is the goodbye message</span>
<span class="gp">... </span>    <span class="n">goodbye_qmsg</span> <span class="o">=</span> <span class="n">qmsg_1</span>
<span class="gp">... </span>    <span class="n">goodbye_qdata</span> <span class="o">=</span> <span class="n">qdata_1</span>
<span class="gp">... </span>    <span class="n">admin_qmsg</span> <span class="o">=</span> <span class="n">qmsg_2</span>
<span class="gp">... </span>    <span class="n">admin_qdata</span> <span class="o">=</span> <span class="n">qdata_2</span>
<span class="gp">... </span><span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">goodbye_qmsg</span> <span class="o">=</span> <span class="n">qmsg_2</span>
<span class="gp">... </span>    <span class="n">goodbye_qdata</span> <span class="o">=</span> <span class="n">qdata_2</span>
<span class="gp">... </span>    <span class="n">admin_qmsg</span> <span class="o">=</span> <span class="n">qmsg_1</span>
<span class="gp">... </span>    <span class="n">admin_qdata</span> <span class="o">=</span> <span class="n">qdata_1</span>
</pre></div>
</div>
<p>The goodbye message...</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">goodbye_qmsg</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
<span class="go">MIME-Version: 1.0</span>
<span class="go">Content-Type: text/plain; charset=&quot;us-ascii&quot;</span>
<span class="go">Content-Transfer-Encoding: 7bit</span>
<span class="go">Subject: You have been unsubscribed from the A Test List mailing list</span>
<span class="go">From: alist-bounces@example.com</span>
<span class="go">To: gperson@example.com</span>
<span class="go">Message-ID: ...</span>
<span class="go">Date: ...</span>
<span class="go">Precedence: bulk</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">So long!</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dump_msgdata</span><span class="p">(</span><span class="n">goodbye_qdata</span><span class="p">)</span>
<span class="go">_parsemsg           : False</span>
<span class="go">listname            : alist@example.com</span>
<span class="go">nodecorate          : True</span>
<span class="go">recipients          : [u&#39;gperson@example.com&#39;]</span>
<span class="go">reduced_list_headers: True</span>
<span class="go">verp                : False</span>
<span class="go">version             : 3</span>
</pre></div>
</div>
<p>...and the admin message.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">admin_qmsg</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
<span class="go">MIME-Version: 1.0</span>
<span class="go">Content-Type: text/plain; charset=&quot;us-ascii&quot;</span>
<span class="go">Content-Transfer-Encoding: 7bit</span>
<span class="go">Subject: A Test List unsubscription notification</span>
<span class="go">From: changeme@example.com</span>
<span class="go">To: alist-owner@example.com</span>
<span class="go">Message-ID: ...</span>
<span class="go">Date: ...</span>
<span class="go">Precedence: bulk</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">gperson@example.com has been removed from A Test List.</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dump_msgdata</span><span class="p">(</span><span class="n">admin_qdata</span><span class="p">)</span>
<span class="go">_parsemsg           : False</span>
<span class="go">envsender           : changeme@example.com</span>
<span class="go">listname            : alist@example.com</span>
<span class="go">nodecorate          : True</span>
<span class="go">recipients          : []</span>
<span class="go">reduced_list_headers: True</span>
<span class="go">version             : 3</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../docs/README.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Moderator requests</a><ul>
<li><a class="reference internal" href="#mailing-list-centric">Mailing list centric</a></li>
<li><a class="reference internal" href="#holding-requests">Holding requests</a></li>
<li><a class="reference internal" href="#getting-requests">Getting requests</a></li>
<li><a class="reference internal" href="#iterating-over-requests">Iterating over requests</a></li>
<li><a class="reference internal" href="#deleting-requests">Deleting requests</a></li>
<li><a class="reference internal" href="#application-support">Application support</a></li>
<li><a class="reference internal" href="#holding-messages">Holding messages</a></li>
<li><a class="reference internal" href="#holding-subscription-requests">Holding subscription requests</a></li>
<li><a class="reference internal" href="#holding-unsubscription-requests">Holding unsubscription requests</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="registration.html"
                        title="previous chapter">Address registration</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="usermanager.html"
                        title="next chapter">The user manager</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/model/docs/requests.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="usermanager.html" title="The user manager"
             >next</a> |</li>
        <li class="right" >
          <a href="registration.html" title="Address registration"
             >previous</a> |</li>
        <li><a href="../../docs/README.html">mailman v3.0.0a6 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright The Mailman Developers.
      Last updated on Sep 20, 2010.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.4.
    </div>
  </body>
</html>