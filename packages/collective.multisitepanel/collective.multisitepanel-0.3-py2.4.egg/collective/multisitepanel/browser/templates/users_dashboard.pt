<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="here/prefs_main_template/macros/master"
      i18n:domain="collective.multisitepanel">

<body>
<div metal:fill-slot="prefs_configlet_main"
	tal:define="allSites view/listAllSites;
				portal_roles view/role_order;
				searchstring view/searchstring;
				userid view/userid;">
	
	<h1 class="documentFirstHeading">
		<span i18n:translate="msp_title">Multisite panel</span>:
		<span tal:omit-tag="" i18n:domain="plone" i18n:translate="">Users and Groups</span>
	</h1>
	
      <a href="#" i18n:domain="plone" i18n:translate=""
         class="link-parent"
         tal:define="link view/back_link | nothing"
         tal:condition="link"
         tal:content="link/label"
         tal:attributes="href link/url">
        Up to Site Setup
      </a>
	
    <form action=""
            class="enableAutoFocus"
            name="users_search"
            method="post"
            tal:attributes="action string:${context/absolute_url}/${view/__name__}">
    <fieldset>
        <br />
        <span tal:omit-tag="" i18n:translate="label_user_search">New user search</span>:
        <input class="quickSearch"
            type="text"
            name="searchstring"
            value=""
            tal:attributes="value searchstring;"
        />
        <input type="hidden" name="submitted" value="True" />
        
        <input type="submit"
            class="searchButton"
            name="form.button.Search"
            value="Search"
            i18n:attributes="value label_search;"
        />
	</fieldset>
    </form>
	
		<p tal:condition="userid" class="documentDescription">
			User: <span tal:content="userid">userid</span>
		</p>
		<table tal:condition="userid" class="listing">
			<tr>
				<th>site</th>
				<th>user</th>
				<th>roles</th>
				<th>groups</th>
			</tr>
			<tal:row repeat="this_site allSites">
				<tr tal:define="oddrow repeat/this_site/odd;
								siteName python:this_site[0];
								siteApp python:this_site[1];
								member python:view.multisite_getMemberById(siteApp,userid);
								mq python:modules['ZTUtils'].make_query;
								userquery python:mq(userid=userid);"
					tal:attributes="class python: oddrow is True and 'odd' or 'even'"
					tal:condition="member">
					
					<td >
						<a tal:attributes="href python:siteApp.absolute_url()"
							title="Go to site home">
							<img tal:attributes="src string:${siteApp/absolute_url}/favicon.ico" alt="" />
							<span tal:content="python:siteName">nome del sito</span>
						</a>
					</td>
					<td>
						<a href="prefs_user_details"
							tal:attributes="href string:${siteApp/absolute_url}/prefs_user_details?${userquery}">
							<tal:block replace="structure portal/user.gif"/>&nbsp;<span tal:replace="userid">username</span>
							(<span tal:replace="python:member.getProperty('fullname')">Full Name</span>)
						</a>
					</td>
					<td tal:define="roles python:member.getRoles()">
						<ul>
							<tal:roles repeat="role roles">
								<li tal:content="role"
                                    tal:condition="python: 'Authenticated' not in role">
                                    role
								</li>
							</tal:roles>
						</ul>
					</td>
					<td tal:define="groups python:member.getGroups()">
						<ul>
							<tal:groups repeat="group groups">
							<li tal:condition="python: 'Authenticated' not in group">
								<a href="prefs_user_details"
									tal:define="groupquery python:mq(groupname=group);"
									tal:attributes="href string:${siteApp/absolute_url}/prefs_group_members?${groupquery}">
									<tal:block replace="structure portal/group.gif"/>&nbsp;<span tal:content="group">group name</span>
								</a>
							</li>
							</tal:groups>
						</ul>
					</td>
				</tr>
			</tal:row>
		</table>
</div>
</body>
</html>