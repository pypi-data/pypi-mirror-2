from subprocess import Popen, call
import sys, os
from signal import SIGTERM

if len(sys.argv) != 2:
    print "please run with  %s start|stop|purge|status|fg" % __file__
    sys.exit()

PID_FILE = '$options.pidfile'
SOLR_DIR = '$options.solrdir'
SOLR_LOG = '$options.logfile'
START_CMD = $options.startcmd

def start(daemonize=True):
    logfp = None
    if daemonize:
        logfp = file(SOLR_LOG, 'a+')
    pid = Popen(START_CMD, cwd=SOLR_DIR,
                stdout=logfp, stderr=logfp).pid
    if not(daemonize):
        return os.waitpid(pid, 0)
    else:
        f = open(PID_FILE, 'wb')
        f.write(str(pid))
        f.close()
        print 'Solr started with pid %s' % (pid,)

def stop():
    try:
        f = open(PID_FILE)
        pid = f.read().strip()
        f.close()
        # SIGHUP here didn't quite do the job, so using TERM instead
        os.kill(int(pid), SIGTERM)
        os.unlink(PID_FILE)
        print "Solr stopped successfully."
    except (IOError, OSError):
        print "Error occured: Solr probably not stopped ..."

def purge():
    if status() > 0:
        postdir = os.path.join(SOLR_DIR, 'exampledocs')
        call(['java', '-Ddata=args' ,'-jar', 'post.jar', '<delete><query>*:*</query></delete>'], cwd=postdir)
    else:
        print "Solr not running. Index can't be purged."

def status():
    try:
        f = open(PID_FILE)
        pid = f.read().strip()
        f.close()
        return pid
    except (IOError, OSError):
        return -1

if sys.argv[1] == 'start':
    start(True)
    sys.exit()
if sys.argv[1] == 'fg':
    start(False)
elif sys.argv[1] == 'stop':
    stop()
elif sys.argv[1] == 'restart':
    if status() > 0:
        stop()
    start(True)
    sys.exit()
elif sys.argv[1] == 'purge':
    purge()
elif sys.argv[1] == 'status':
    pid = status()
    if pid > 0:
        print "Solr running with PID: ", pid
    else:
        print "Solr not running."
else:
    print ("illegal option: please run with "
           "%s start|stop|restart|status|purge|fg" % __file__)
