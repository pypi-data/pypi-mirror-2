<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <title>monkeypatch</title>
    <meta content="text/html;charset=ISO-8859-1" name="Content-Type"/>
    <link href="../../style.css" media="screen" rel="stylesheet" type="text/css"/></head>
  <body>
    <div id="navspace">
      <div><a href="http://pylib.org"><img alt="py lib" height="57" id="pyimg" src="http://codespeak.net/img/pylib.png" width="77"/></a></div>
      <div id="menubar">
        <div>
          <div><a class="menu" href="../../announce/release-1.3.0.html">1.3.0 ANN</a></div></div>
        <div>
          <div><a class="menu" href="../../install.html">INSTALL</a></div></div>
        <div>
          <div><a class="menu" href="../../contact.html">CONTACT</a></div></div>
        <div>
          <div><a class="menu" href="../../changelog.html">CHANGELOG</a></div></div>
        <div>
          <div><a class="menu" href="../../faq.html">FAQ</a></div></div>
        <div>
          <div>
            <h3>py.test:</h3>
            <div><a class="menu" href="../index.html">Index</a></div>
            <div><a class="menu" href="../quickstart.html">Quickstart</a></div>
            <div><a class="menu" href="../features.html">Features</a></div>
            <div><a class="menu" href="../funcargs.html">Funcargs</a></div>
            <div><a class="menu" href="index.html">Plugins</a></div>
            <div><a class="menu" href="../customize.html">Customize</a></div>
            <div><a class="menu" href="../talks.html">Tutorials</a></div><a class="menu" href="http://hudson.testrun.org">hudson-tests</a></div></div>
        <div>
          <div>
            <h3>supporting APIs:</h3>
            <div><a class="menu" href="../../index.html">Index</a></div>
            <div><a class="menu" href="../../path.html">py.path</a></div>
            <div><a class="menu" href="../../code.html">py.code</a></div></div></div></div></div>
    <div id="contentspace">


<div class="section" id="safely-patch-object-attributes-dicts-and-environment-variables">
<h1>safely patch object attributes, dicts and environment variables.</h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#usage" id="id1">Usage</a></li>
<li><a class="reference internal" href="#prepending-to-path-or-other-environment-variables" id="id2">prepending to PATH or other environment variables</a></li>
<li><a class="reference internal" href="#calling-undo-finalization-explicitely" id="id3">calling &quot;undo&quot; finalization explicitely</a></li>
<li><a class="reference internal" href="#the-monkeypatch-test-function-argument" id="id4">the 'monkeypatch' test function argument</a></li>
</ul>
</div>
<div class="section" id="usage">
<h2><a class="toc-backref" href="#id1">Usage</a></h2>
<p>Use the <a class="reference internal" href="#monkeypatch-funcarg">monkeypatch funcarg</a> to tweak your global test environment
for running a particular test.  You can safely set/del an attribute,
dictionary item or environment variable by respective methods
on the monkeypatch funcarg.  If you want e.g. to set an ENV1 variable
and have os.path.expanduser return a particular directory, you can
write it down like this:</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_mytest</span>(monkeypatch):
    monkeypatch<span style="color: #666666">.</span>setenv(<span style="color: #BA2121">&#39;ENV1&#39;</span>, <span style="color: #BA2121">&#39;myval&#39;</span>)
    monkeypatch<span style="color: #666666">.</span>setattr(os<span style="color: #666666">.</span>path, <span style="color: #BA2121">&#39;expanduser&#39;</span>, <span style="color: #008000; font-weight: bold">lambda</span> x: <span style="color: #BA2121">&#39;/tmp/xyz&#39;</span>)
    <span style="color: #666666">...</span> <span style="color: #408080; font-style: italic"># your test code that uses those patched values implicitely</span>
</pre></div>
<p>After the test function finished all modifications will be undone,
because the <tt class="docutils literal">monkeypatch.undo()</tt> method is registered as a finalizer.</p>
<p><tt class="docutils literal">monkeypatch.setattr/delattr/delitem/delenv()</tt> all
by default raise an Exception if the target does not exist.
Pass <tt class="docutils literal">raising=False</tt> if you want to skip this check.</p>
</div>
<div class="section" id="prepending-to-path-or-other-environment-variables">
<h2><a class="toc-backref" href="#id2">prepending to PATH or other environment variables</a></h2>
<p>To prepend a value to an already existing environment parameter:</p>
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_mypath_finding</span>(monkeypatch):
    monkeypatch<span style="color: #666666">.</span>setenv(<span style="color: #BA2121">&#39;PATH&#39;</span>, <span style="color: #BA2121">&#39;x/y&#39;</span>, prepend<span style="color: #666666">=</span><span style="color: #BA2121">&quot;:&quot;</span>)
    <span style="color: #408080; font-style: italic"># in bash language: export PATH=x/y:$PATH</span>
</pre></div>
</div>
<div class="section" id="calling-undo-finalization-explicitely">
<h2><a class="toc-backref" href="#id3">calling &quot;undo&quot; finalization explicitely</a></h2>
<p>At the end of function execution py.test invokes
a teardown hook which undoes all monkeypatch changes.
If you do not want to wait that long you can call
finalization explicitely:</p>
<pre class="literal-block">
monkeypatch.undo()
</pre>
<p>This will undo previous changes.  This call consumes the
undo stack.  Calling it a second time has no effect unless
you  start monkeypatching after the undo call.</p>
</div>
<div class="section" id="the-monkeypatch-test-function-argument">
<span id="monkeypatch-funcarg"></span><h2><a class="toc-backref" href="#id4">the 'monkeypatch' test function argument</a></h2>
<p>The returned <tt class="docutils literal">monkeypatch</tt> funcarg provides these
helper methods to modify objects, dictionaries or os.environ:</p>
<pre class="literal-block">
monkeypatch.setattr(obj, name, value, raising=True)
monkeypatch.delattr(obj, name, raising=True)
monkeypatch.setitem(mapping, name, value)
monkeypatch.delitem(obj, name, raising=True)
monkeypatch.setenv(name, value, prepend=False)
monkeypatch.delenv(name, value, raising=True)
monkeypatch.syspath_prepend(path)
</pre>
<p>All modifications will be undone when the requesting
test function finished its execution.  The <tt class="docutils literal">raising</tt>
parameter determines if a KeyError or AttributeError
will be raised if the set/deletion operation has no target.</p>
</div>
</div>
<div class="section" id="start-improving-this-plugin-in-30-seconds">
<h1>Start improving this plugin in 30 seconds</h1>
<ol class="arabic simple">
<li>Download <a class="reference external" href="http://bitbucket.org/hpk42/py-trunk/raw/1.3.0/py/_plugin/pytest_monkeypatch.py">pytest_monkeypatch.py</a> plugin source code</li>
<li>put it somewhere as <tt class="docutils literal">pytest_monkeypatch.py</tt> into your import path</li>
<li>a subsequent <tt class="docutils literal">py.test</tt> run will use your local version</li>
</ol>
<p>Checkout <a class="reference external" href="../customize.html">customize</a>, other <a class="reference external" href="index.html">plugins</a> or <a class="reference external" href="../../contact.html">get in contact</a>.</p>
</div>
</div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-7597274-3");
pageTracker._trackPageview();
} catch(err) {}</script>
</body></html>