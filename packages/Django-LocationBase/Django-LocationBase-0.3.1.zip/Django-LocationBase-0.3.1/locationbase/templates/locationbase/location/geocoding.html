<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<title>Locationbase - geocoding</title>
<link href="http://code.google.com/apis/maps/documentation/javascript/examples/standard.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
  var geocoder;
  var map;
  function initialize() {
    geocoder = new google.maps.Geocoder();
    var latlng = new google.maps.LatLng(-34.397, 150.644);
    var myOptions = {
      zoom: 8,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      draggable: true
    }
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
  }

  function codeAddress() {
    var address = document.getElementById("address").value;
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.setCenter(results[0].geometry.location);
        var marker = new google.maps.Marker({
            map: map, 
            position: results[0].geometry.location
        });
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  }

  function newLocation() {
    var address = document.getElementById("address").value;
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.setCenter(results[0].geometry.location);
        var ans = prompt("What`s the short name of the location you want to create?");

        result=results[0].address_components;
        var info=[];
        var city;
        var state;
        var country;
        var state;
        var street_address;
        var street_number;
        var postal_code;
        for(var i=0;i<result.length;++i)
        {
            if(result[i].types[0]=="administrative_area_level_1"){state = result[i].long_name;}
            if(result[i].types[0]=="locality"){city = result[i].long_name;}
            if(result[i].types[0]=="country"){country = result[i].long_name;}
            if(result[i].types[0]=="street_address"){street_address = result[i].long_name;}
            if(result[i].types[0]=="street_number"){street_number = result[i].long_name;}
            if(result[i].types[0]=="postal_code"){postal_code = result[i].long_name;}
        }

        $.post("{% url location_from_geocoding %}", {
             params: JSON.stringify(results[0].geometry.location),
             name : ans,
             city : city,
             state : state,
             country : country,
             street_address : street_address,
             street_number : street_number,
             postal_code : postal_code,
             'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            function(data) {
                alert(data);
            }
        );
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });
  }

</script>
</head>
<body onload="initialize()">
  <div>
    <input id="address" type="textbox" value="Sydney, NSW">

    <input type="button" value="Geocode" onclick="codeAddress()">
    <input type="button" value="Use this data to create new location" onclick="newLocation()">
     <a href="{% url admin:index %}">Back to locations</a>
  </div>
<div id="map_canvas" style="height:90%"></div>
</body>
</html>
