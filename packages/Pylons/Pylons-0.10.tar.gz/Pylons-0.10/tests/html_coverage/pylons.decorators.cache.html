<html>
<head>
<title>pylons.decorators.cache</title>
</head>
<body>
pylons.decorators.cache
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 138 lines<br/>
Missed: 0 lines<br/>
Skipped 27 lines<br/>
Percent: 100 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>  1</pre></span><pre>&quot;&quot;&quot;Caching decorator&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>  2</pre></span><pre>import inspect</pre></div>
<div class="cov"><span class="num"><pre>  3</pre></span><pre>import logging</pre></div>
<div class="cov"><span class="num"><pre>  4</pre></span><pre>import time</pre></div>
<div class="skip"><span class="num"><pre>  5</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  6</pre></span><pre>from decorator import decorator</pre></div>
<div class="cov"><span class="num"><pre>  7</pre></span><pre>from paste.deploy.converters import asbool</pre></div>
<div class="skip"><span class="num"><pre>  8</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  9</pre></span><pre>from pylons.decorators.util import get_pylons</pre></div>
<div class="skip"><span class="num"><pre> 10</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 11</pre></span><pre>log = logging.getLogger(__name__)</pre></div>
<div class="skip"><span class="num"><pre> 12</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 13</pre></span><pre>def beaker_cache(key=&quot;cache_default&quot;, expire=&quot;never&quot;, type=None,</pre></div>
<div class="cov"><span class="num"><pre> 14</pre></span><pre>                 query_args=False,</pre></div>
<div class="cov"><span class="num"><pre> 15</pre></span><pre>                 cache_headers=('content-type', 'content-length'),</pre></div>
<div class="cov"><span class="num"><pre> 16</pre></span><pre>                 invalidate_on_startup=False, </pre></div>
<div class="cov"><span class="num"><pre> 17</pre></span><pre>                 cache_response=True, **b_kwargs):</pre></div>
<div class="cov"><span class="num"><pre> 18</pre></span><pre>    &quot;&quot;&quot;Cache decorator utilizing Beaker. Caches action or other</pre></div>
<div class="cov"><span class="num"><pre> 19</pre></span><pre>    function that returns a pickle-able object as a result.</pre></div>
<div class="skip"><span class="num"><pre> 20</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 21</pre></span><pre>    Optional arguments:</pre></div>
<div class="skip"><span class="num"><pre> 22</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 23</pre></span><pre>    ``key``</pre></div>
<div class="cov"><span class="num"><pre> 24</pre></span><pre>        None - No variable key, uses function name as key</pre></div>
<div class="cov"><span class="num"><pre> 25</pre></span><pre>        &quot;cache_default&quot; - Uses all function arguments as the key</pre></div>
<div class="cov"><span class="num"><pre> 26</pre></span><pre>        string - Use kwargs[key] as key</pre></div>
<div class="cov"><span class="num"><pre> 27</pre></span><pre>        list - Use [kwargs[k] for k in list] as key</pre></div>
<div class="cov"><span class="num"><pre> 28</pre></span><pre>    ``expire``</pre></div>
<div class="cov"><span class="num"><pre> 29</pre></span><pre>        Time in seconds before cache expires, or the string &quot;never&quot;. </pre></div>
<div class="cov"><span class="num"><pre> 30</pre></span><pre>        Defaults to &quot;never&quot;</pre></div>
<div class="cov"><span class="num"><pre> 31</pre></span><pre>    ``type``</pre></div>
<div class="cov"><span class="num"><pre> 32</pre></span><pre>        Type of cache to use: dbm, memory, file, memcached, or None for</pre></div>
<div class="cov"><span class="num"><pre> 33</pre></span><pre>        Beaker's default</pre></div>
<div class="cov"><span class="num"><pre> 34</pre></span><pre>    ``query_args``</pre></div>
<div class="cov"><span class="num"><pre> 35</pre></span><pre>        Uses the query arguments as the key, defaults to False</pre></div>
<div class="cov"><span class="num"><pre> 36</pre></span><pre>    ``cache_headers``</pre></div>
<div class="cov"><span class="num"><pre> 37</pre></span><pre>        A tuple of header names indicating response headers that</pre></div>
<div class="cov"><span class="num"><pre> 38</pre></span><pre>        will also be cached.</pre></div>
<div class="cov"><span class="num"><pre> 39</pre></span><pre>    ``invalidate_on_startup``</pre></div>
<div class="cov"><span class="num"><pre> 40</pre></span><pre>        If True, the cache will be invalidated each time the application</pre></div>
<div class="cov"><span class="num"><pre> 41</pre></span><pre>        starts or is restarted.</pre></div>
<div class="cov"><span class="num"><pre> 42</pre></span><pre>    ``cache_response``</pre></div>
<div class="cov"><span class="num"><pre> 43</pre></span><pre>        Determines whether the response at the time beaker_cache is used</pre></div>
<div class="cov"><span class="num"><pre> 44</pre></span><pre>        should be cached or not, defaults to True.</pre></div>
<div class="skip"><span class="num"><pre> 45</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 46</pre></span><pre>        .. note::</pre></div>
<div class="cov"><span class="num"><pre> 47</pre></span><pre>            When cache_response is set to False, the cache_headers</pre></div>
<div class="cov"><span class="num"><pre> 48</pre></span><pre>            argument is ignored as none of the response is cached.</pre></div>
<div class="skip"><span class="num"><pre> 49</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 50</pre></span><pre>    If cache_enabled is set to False in the .ini file, then cache is</pre></div>
<div class="cov"><span class="num"><pre> 51</pre></span><pre>    disabled globally.</pre></div>
<div class="skip"><span class="num"><pre> 52</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 53</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 54</pre></span><pre>    if invalidate_on_startup:</pre></div>
<div class="cov"><span class="num"><pre> 55</pre></span><pre>        starttime = time.time()</pre></div>
<div class="cov"><span class="num"><pre> 56</pre></span><pre>    else:</pre></div>
<div class="cov"><span class="num"><pre> 57</pre></span><pre>        starttime = None</pre></div>
<div class="cov"><span class="num"><pre> 58</pre></span><pre>    cache_headers = set(cache_headers)</pre></div>
<div class="skip"><span class="num"><pre> 59</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 60</pre></span><pre>    def wrapper(func, *args, **kwargs):</pre></div>
<div class="cov"><span class="num"><pre> 61</pre></span><pre>        &quot;&quot;&quot;Decorator wrapper&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 62</pre></span><pre>        pylons = get_pylons(args)</pre></div>
<div class="cov"><span class="num"><pre> 63</pre></span><pre>        log.debug(&quot;Wrapped with key: %s, expire: %s, type: %s, query_args: %s&quot;,</pre></div>
<div class="cov"><span class="num"><pre> 64</pre></span><pre>                  key, expire, type, query_args)</pre></div>
<div class="cov"><span class="num"><pre> 65</pre></span><pre>        enabled = pylons.config.get(&quot;cache_enabled&quot;, &quot;True&quot;)</pre></div>
<div class="cov"><span class="num"><pre> 66</pre></span><pre>        if not asbool(enabled):</pre></div>
<div class="cov"><span class="num"><pre> 67</pre></span><pre>            log.debug(&quot;Caching disabled, skipping cache lookup&quot;)</pre></div>
<div class="cov"><span class="num"><pre> 68</pre></span><pre>            return func(*args, **kwargs)</pre></div>
<div class="skip"><span class="num"><pre> 69</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 70</pre></span><pre>        if key:</pre></div>
<div class="cov"><span class="num"><pre> 71</pre></span><pre>            key_dict = kwargs.copy()</pre></div>
<div class="cov"><span class="num"><pre> 72</pre></span><pre>            key_dict.update(_make_dict_from_args(func, args))</pre></div>
<div class="cov"><span class="num"><pre> 73</pre></span><pre>            if query_args:</pre></div>
<div class="cov"><span class="num"><pre> 74</pre></span><pre>                key_dict.update(pylons.request.GET.mixed())</pre></div>
<div class="skip"><span class="num"><pre> 75</pre></span><pre>            </pre></div>
<div class="cov"><span class="num"><pre> 76</pre></span><pre>            if key != &quot;cache_default&quot;:</pre></div>
<div class="cov"><span class="num"><pre> 77</pre></span><pre>                if isinstance(key, list):</pre></div>
<div class="cov"><span class="num"><pre> 78</pre></span><pre>                    key_dict = dict((k, key_dict[k]) for k in key)</pre></div>
<div class="cov"><span class="num"><pre> 79</pre></span><pre>                else:</pre></div>
<div class="cov"><span class="num"><pre> 80</pre></span><pre>                    key_dict = {key: key_dict[key]}</pre></div>
<div class="cov"><span class="num"><pre> 81</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre> 82</pre></span><pre>            key_dict = None</pre></div>
<div class="skip"><span class="num"><pre> 83</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 84</pre></span><pre>        self = None</pre></div>
<div class="cov"><span class="num"><pre> 85</pre></span><pre>        if args:</pre></div>
<div class="cov"><span class="num"><pre> 86</pre></span><pre>            self = args[0]</pre></div>
<div class="cov"><span class="num"><pre> 87</pre></span><pre>        namespace, cache_key = create_cache_key(func, key_dict, self)</pre></div>
<div class="skip"><span class="num"><pre> 88</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 89</pre></span><pre>        if type:</pre></div>
<div class="cov"><span class="num"><pre> 90</pre></span><pre>            b_kwargs['type'] = type</pre></div>
<div class="skip"><span class="num"><pre> 91</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 92</pre></span><pre>        cache_obj = getattr(pylons.app_globals, 'cache', None)</pre></div>
<div class="cov"><span class="num"><pre> 93</pre></span><pre>        if not cache_obj:</pre></div>
<div class="cov"><span class="num"><pre> 94</pre></span><pre>            cache_obj = getattr(pylons, 'cache', None)</pre></div>
<div class="cov"><span class="num"><pre> 95</pre></span><pre>        if not cache_obj:</pre></div>
<div class="cov"><span class="num"><pre> 96</pre></span><pre>            raise Exception('No CacheMiddleware or cache object on '</pre></div>
<div class="cov"><span class="num"><pre> 97</pre></span><pre>                            ' app_globals was found')</pre></div>
<div class="skip"><span class="num"><pre> 98</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 99</pre></span><pre>        my_cache = cache_obj.get_cache(namespace, **b_kwargs)</pre></div>
<div class="skip"><span class="num"><pre>100</pre></span><pre>            </pre></div>
<div class="cov"><span class="num"><pre>101</pre></span><pre>        if expire == &quot;never&quot;:</pre></div>
<div class="cov"><span class="num"><pre>102</pre></span><pre>            cache_expire = None</pre></div>
<div class="cov"><span class="num"><pre>103</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre>104</pre></span><pre>            cache_expire = expire</pre></div>
<div class="skip"><span class="num"><pre>105</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>106</pre></span><pre>        def create_func():</pre></div>
<div class="cov"><span class="num"><pre>107</pre></span><pre>            log.debug(&quot;Creating new cache copy with key: %s, type: %s&quot;,</pre></div>
<div class="cov"><span class="num"><pre>108</pre></span><pre>                      cache_key, type)</pre></div>
<div class="cov"><span class="num"><pre>109</pre></span><pre>            result = func(*args, **kwargs)</pre></div>
<div class="cov"><span class="num"><pre>110</pre></span><pre>            glob_response = pylons.response</pre></div>
<div class="cov"><span class="num"><pre>111</pre></span><pre>            headers = glob_response.headerlist</pre></div>
<div class="cov"><span class="num"><pre>112</pre></span><pre>            status = glob_response.status</pre></div>
<div class="cov"><span class="num"><pre>113</pre></span><pre>            full_response = dict(headers=headers, status=status,</pre></div>
<div class="cov"><span class="num"><pre>114</pre></span><pre>                                 cookies=None, content=result)</pre></div>
<div class="cov"><span class="num"><pre>115</pre></span><pre>            return full_response</pre></div>
<div class="skip"><span class="num"><pre>116</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>117</pre></span><pre>        response = my_cache.get_value(cache_key, createfunc=create_func,</pre></div>
<div class="cov"><span class="num"><pre>118</pre></span><pre>                                      expiretime=cache_expire,</pre></div>
<div class="cov"><span class="num"><pre>119</pre></span><pre>                                      starttime=starttime)</pre></div>
<div class="cov"><span class="num"><pre>120</pre></span><pre>        if cache_response:</pre></div>
<div class="cov"><span class="num"><pre>121</pre></span><pre>            glob_response = pylons.response</pre></div>
<div class="cov"><span class="num"><pre>122</pre></span><pre>            glob_response.headerlist = [header for header in response['headers']</pre></div>
<div class="cov"><span class="num"><pre>123</pre></span><pre>                                        if header[0].lower() in cache_headers]</pre></div>
<div class="cov"><span class="num"><pre>124</pre></span><pre>            glob_response.status = response['status']</pre></div>
<div class="skip"><span class="num"><pre>125</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>126</pre></span><pre>        return response['content']</pre></div>
<div class="cov"><span class="num"><pre>127</pre></span><pre>    return decorator(wrapper)</pre></div>
<div class="skip"><span class="num"><pre>128</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>129</pre></span><pre>def create_cache_key(func, key_dict=None, self=None):</pre></div>
<div class="cov"><span class="num"><pre>130</pre></span><pre>    &quot;&quot;&quot;Get a cache namespace and key used by the beaker_cache decorator.</pre></div>
<div class="skip"><span class="num"><pre>131</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>132</pre></span><pre>    Example::</pre></div>
<div class="cov"><span class="num"><pre>133</pre></span><pre>        from pylons import cache</pre></div>
<div class="cov"><span class="num"><pre>134</pre></span><pre>        from pylons.decorators.cache import create_cache_key</pre></div>
<div class="cov"><span class="num"><pre>135</pre></span><pre>        namespace, key = create_cache_key(MyController.some_method)</pre></div>
<div class="cov"><span class="num"><pre>136</pre></span><pre>        cache.get_cache(namespace).remove(key)</pre></div>
<div class="skip"><span class="num"><pre>137</pre></span><pre>            </pre></div>
<div class="cov"><span class="num"><pre>138</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>139</pre></span><pre>    kls = None</pre></div>
<div class="cov"><span class="num"><pre>140</pre></span><pre>    if hasattr(func, 'im_func'):</pre></div>
<div class="cov"><span class="num"><pre>141</pre></span><pre>        kls = func.im_class</pre></div>
<div class="cov"><span class="num"><pre>142</pre></span><pre>        func = func.im_func</pre></div>
<div class="cov"><span class="num"><pre>143</pre></span><pre>        cache_key = func.__name__</pre></div>
<div class="cov"><span class="num"><pre>144</pre></span><pre>    else:</pre></div>
<div class="cov"><span class="num"><pre>145</pre></span><pre>        cache_key = func.__name__</pre></div>
<div class="cov"><span class="num"><pre>146</pre></span><pre>    if key_dict:</pre></div>
<div class="cov"><span class="num"><pre>147</pre></span><pre>        cache_key += &quot; &quot; + &quot; &quot;.join(&quot;%s=%s&quot; % (k, v)</pre></div>
<div class="cov"><span class="num"><pre>148</pre></span><pre>                                    for k, v in key_dict.iteritems())</pre></div>
<div class="skip"><span class="num"><pre>149</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>150</pre></span><pre>    if not kls and self:</pre></div>
<div class="cov"><span class="num"><pre>151</pre></span><pre>        kls = getattr(self, '__class__', None)</pre></div>
<div class="skip"><span class="num"><pre>152</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>153</pre></span><pre>    if kls:</pre></div>
<div class="cov"><span class="num"><pre>154</pre></span><pre>        return '%s.%s' % (kls.__module__, kls.__name__), cache_key</pre></div>
<div class="cov"><span class="num"><pre>155</pre></span><pre>    else:</pre></div>
<div class="cov"><span class="num"><pre>156</pre></span><pre>        return func.__module__, cache_key</pre></div>
<div class="skip"><span class="num"><pre>157</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>158</pre></span><pre>def _make_dict_from_args(func, args):</pre></div>
<div class="cov"><span class="num"><pre>159</pre></span><pre>    &quot;&quot;&quot;Inspects function for name of args&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>160</pre></span><pre>    args_keys = {}</pre></div>
<div class="cov"><span class="num"><pre>161</pre></span><pre>    for i, arg in enumerate(inspect.getargspec(func)[0]):</pre></div>
<div class="cov"><span class="num"><pre>162</pre></span><pre>        if arg != &quot;self&quot;:</pre></div>
<div class="cov"><span class="num"><pre>163</pre></span><pre>            args_keys[arg] = args[i]</pre></div>
<div class="cov"><span class="num"><pre>164</pre></span><pre>    return args_keys</pre></div>
<div class="skip"><span class="num"><pre>165</pre></span><pre></pre></div>
</div>
</body>
</html>
