<html>
<head>
<title>pylons.wsgiapp</title>
</head>
<body>
pylons.wsgiapp
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 216 lines<br/>
Missed: 30 lines<br/>
Skipped 84 lines<br/>
Percent: 87 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>  1</pre></span><pre>&quot;&quot;&quot;WSGI App Creator</pre></div>
<div class="skip"><span class="num"><pre>  2</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  3</pre></span><pre>This module is responsible for creating the basic Pylons WSGI</pre></div>
<div class="cov"><span class="num"><pre>  4</pre></span><pre>application (PylonsApp). It's generally assumed that it will be called</pre></div>
<div class="cov"><span class="num"><pre>  5</pre></span><pre>by Paste, though any WSGI server could create and call the WSGI app as</pre></div>
<div class="cov"><span class="num"><pre>  6</pre></span><pre>well.</pre></div>
<div class="skip"><span class="num"><pre>  7</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  8</pre></span><pre>&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>  9</pre></span><pre>import logging</pre></div>
<div class="cov"><span class="num"><pre> 10</pre></span><pre>import sys</pre></div>
<div class="skip"><span class="num"><pre> 11</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 12</pre></span><pre>import paste.registry</pre></div>
<div class="cov"><span class="num"><pre> 13</pre></span><pre>import pkg_resources</pre></div>
<div class="cov"><span class="num"><pre> 14</pre></span><pre>from webob.exc import HTTPFound, HTTPNotFound</pre></div>
<div class="skip"><span class="num"><pre> 15</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 16</pre></span><pre>import pylons</pre></div>
<div class="cov"><span class="num"><pre> 17</pre></span><pre>import pylons.templating</pre></div>
<div class="cov"><span class="num"><pre> 18</pre></span><pre>from pylons.controllers.util import Request, Response</pre></div>
<div class="cov"><span class="num"><pre> 19</pre></span><pre>from pylons.i18n.translation import _get_translator</pre></div>
<div class="cov"><span class="num"><pre> 20</pre></span><pre>from pylons.util import (AttribSafeContextObj, ContextObj, PylonsContext,</pre></div>
<div class="cov"><span class="num"><pre> 21</pre></span><pre>                         class_name_from_module_name)</pre></div>
<div class="skip"><span class="num"><pre> 22</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 23</pre></span><pre>__all__ = ['PylonsApp']</pre></div>
<div class="skip"><span class="num"><pre> 24</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 25</pre></span><pre>log = logging.getLogger(__name__)</pre></div>
<div class="skip"><span class="num"><pre> 26</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 27</pre></span><pre>class PylonsApp(object):</pre></div>
<div class="cov"><span class="num"><pre> 28</pre></span><pre>    &quot;&quot;&quot;Pylons WSGI Application</pre></div>
<div class="skip"><span class="num"><pre> 29</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 30</pre></span><pre>    This basic WSGI app is provided should a web developer want to</pre></div>
<div class="cov"><span class="num"><pre> 31</pre></span><pre>    get access to the most basic Pylons web application environment</pre></div>
<div class="cov"><span class="num"><pre> 32</pre></span><pre>    available. By itself, this Pylons web application does little more</pre></div>
<div class="cov"><span class="num"><pre> 33</pre></span><pre>    than dispatch to a controller and setup the context object, the</pre></div>
<div class="cov"><span class="num"><pre> 34</pre></span><pre>    request object, and the globals object.</pre></div>
<div class="skip"><span class="num"><pre> 35</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 36</pre></span><pre>    Additional functionality like sessions, and caching can be setup by</pre></div>
<div class="cov"><span class="num"><pre> 37</pre></span><pre>    altering the ``environ['pylons.environ_config']`` setting to</pre></div>
<div class="cov"><span class="num"><pre> 38</pre></span><pre>    indicate what key the ``session`` and ``cache`` functionality</pre></div>
<div class="cov"><span class="num"><pre> 39</pre></span><pre>    should come from.</pre></div>
<div class="skip"><span class="num"><pre> 40</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 41</pre></span><pre>    Resolving the URL and dispatching can be customized by sub-classing</pre></div>
<div class="cov"><span class="num"><pre> 42</pre></span><pre>    or &quot;monkey-patching&quot; this class. Subclassing is the preferred</pre></div>
<div class="cov"><span class="num"><pre> 43</pre></span><pre>    approach.</pre></div>
<div class="skip"><span class="num"><pre> 44</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 45</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 46</pre></span><pre>    def __init__(self, config=None, **kwargs):</pre></div>
<div class="cov"><span class="num"><pre> 47</pre></span><pre>        &quot;&quot;&quot;Initialize a base Pylons WSGI application</pre></div>
<div class="skip"><span class="num"><pre> 48</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 49</pre></span><pre>        The base Pylons WSGI application requires several keywords, the</pre></div>
<div class="cov"><span class="num"><pre> 50</pre></span><pre>        package name, and the globals object. If no helpers object is</pre></div>
<div class="cov"><span class="num"><pre> 51</pre></span><pre>        provided then h will be None.</pre></div>
<div class="skip"><span class="num"><pre> 52</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 53</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 54</pre></span><pre>        self.config = config = config or pylons.config._current_obj()</pre></div>
<div class="cov"><span class="num"><pre> 55</pre></span><pre>        package_name = config['pylons.package']</pre></div>
<div class="cov"><span class="num"><pre> 56</pre></span><pre>        self.helpers = config['pylons.h']</pre></div>
<div class="cov"><span class="num"><pre> 57</pre></span><pre>        self.globals = config.get('pylons.app_globals')</pre></div>
<div class="cov"><span class="num"><pre> 58</pre></span><pre>        self.environ_config = config['pylons.environ_config']</pre></div>
<div class="cov"><span class="num"><pre> 59</pre></span><pre>        self.package_name = package_name</pre></div>
<div class="cov"><span class="num"><pre> 60</pre></span><pre>        self.request_options = config['pylons.request_options']</pre></div>
<div class="cov"><span class="num"><pre> 61</pre></span><pre>        self.response_options = config['pylons.response_options']</pre></div>
<div class="cov"><span class="num"><pre> 62</pre></span><pre>        self.controller_classes = {}</pre></div>
<div class="cov"><span class="num"><pre> 63</pre></span><pre>        self.log_debug = False</pre></div>
<div class="cov"><span class="num"><pre> 64</pre></span><pre>        self.config.setdefault('lang', None)</pre></div>
<div class="skip"><span class="num"><pre> 65</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre> 66</pre></span><pre>        # Create the redirect function we'll use and save it</pre></div>
<div class="cov"><span class="num"><pre> 67</pre></span><pre>        def redirect_to(url):</pre></div>
<div class="nocov"><span class="num"><pre> 68</pre></span><pre>            log.debug(&quot;Raising redirect to %s&quot;, url)</pre></div>
<div class="nocov"><span class="num"><pre> 69</pre></span><pre>            raise HTTPFound(location=url)</pre></div>
<div class="cov"><span class="num"><pre> 70</pre></span><pre>        self.redirect_to = redirect_to</pre></div>
<div class="skip"><span class="num"><pre> 71</pre></span><pre>                </pre></div>
<div class="skip"><span class="num"><pre> 72</pre></span><pre>        # Cache some options for use during requests</pre></div>
<div class="cov"><span class="num"><pre> 73</pre></span><pre>        self._session_key = self.environ_config.get('session', 'beaker.session')</pre></div>
<div class="cov"><span class="num"><pre> 74</pre></span><pre>        self._cache_key = self.environ_config.get('cache', 'beaker.cache')</pre></div>
<div class="skip"><span class="num"><pre> 75</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 76</pre></span><pre>    def __call__(self, environ, start_response):</pre></div>
<div class="cov"><span class="num"><pre> 77</pre></span><pre>        &quot;&quot;&quot;Setup and handle a web request</pre></div>
<div class="skip"><span class="num"><pre> 78</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 79</pre></span><pre>        PylonsApp splits its functionality into several methods to</pre></div>
<div class="cov"><span class="num"><pre> 80</pre></span><pre>        make it easier to subclass and customize core functionality.</pre></div>
<div class="skip"><span class="num"><pre> 81</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 82</pre></span><pre>        The methods are called in the following order:</pre></div>
<div class="skip"><span class="num"><pre> 83</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 84</pre></span><pre>        1. :meth:`~PylonsApp.setup_app_env`</pre></div>
<div class="cov"><span class="num"><pre> 85</pre></span><pre>        2. :meth:`~PylonsApp.load_test_env` (Only if operating in</pre></div>
<div class="cov"><span class="num"><pre> 86</pre></span><pre>           testing mode)</pre></div>
<div class="cov"><span class="num"><pre> 87</pre></span><pre>        3. :meth:`~PylonsApp.resolve`</pre></div>
<div class="cov"><span class="num"><pre> 88</pre></span><pre>        4. :meth:`~PylonsApp.dispatch`</pre></div>
<div class="skip"><span class="num"><pre> 89</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 90</pre></span><pre>        The response from :meth:`~PylonsApp.dispatch` is expected to be</pre></div>
<div class="cov"><span class="num"><pre> 91</pre></span><pre>        an iterable (valid :pep:`333` WSGI response), which is then</pre></div>
<div class="cov"><span class="num"><pre> 92</pre></span><pre>        sent back as the response.</pre></div>
<div class="skip"><span class="num"><pre> 93</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre> 94</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre> 95</pre></span><pre>        # Cache the logging level for the request</pre></div>
<div class="cov"><span class="num"><pre> 96</pre></span><pre>        log_debug = self.log_debug = logging.DEBUG &gt;= log.getEffectiveLevel()</pre></div>
<div class="skip"><span class="num"><pre> 97</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 98</pre></span><pre>        self.setup_app_env(environ, start_response)</pre></div>
<div class="cov"><span class="num"><pre> 99</pre></span><pre>        if 'paste.testing_variables' in environ:</pre></div>
<div class="cov"><span class="num"><pre>100</pre></span><pre>            self.load_test_env(environ)</pre></div>
<div class="cov"><span class="num"><pre>101</pre></span><pre>            if environ['PATH_INFO'] == '/_test_vars':</pre></div>
<div class="nocov"><span class="num"><pre>102</pre></span><pre>                paste.registry.restorer.save_registry_state(environ)</pre></div>
<div class="nocov"><span class="num"><pre>103</pre></span><pre>                start_response('200 OK', [('Content-type', 'text/plain')])</pre></div>
<div class="nocov"><span class="num"><pre>104</pre></span><pre>                return ['%s' % paste.registry.restorer.get_request_id(environ)]</pre></div>
<div class="skip"><span class="num"><pre>105</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>106</pre></span><pre>        controller = self.resolve(environ, start_response)</pre></div>
<div class="cov"><span class="num"><pre>107</pre></span><pre>        response = self.dispatch(controller, environ, start_response)</pre></div>
<div class="skip"><span class="num"><pre>108</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>109</pre></span><pre>        if 'paste.testing_variables' in environ and hasattr(response,</pre></div>
<div class="cov"><span class="num"><pre>110</pre></span><pre>                                                            'wsgi_response'):</pre></div>
<div class="nocov"><span class="num"><pre>111</pre></span><pre>            environ['paste.testing_variables']['response'] = response</pre></div>
<div class="skip"><span class="num"><pre>112</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>113</pre></span><pre>        try:</pre></div>
<div class="cov"><span class="num"><pre>114</pre></span><pre>            if hasattr(response, 'wsgi_response'):</pre></div>
<div class="skip"><span class="num"><pre>115</pre></span><pre>                # Transform Response objects from legacy Controller</pre></div>
<div class="nocov"><span class="num"><pre>116</pre></span><pre>                if log_debug:</pre></div>
<div class="nocov"><span class="num"><pre>117</pre></span><pre>                    log.debug(&quot;Transforming legacy Response object into WSGI &quot;</pre></div>
<div class="nocov"><span class="num"><pre>118</pre></span><pre>                              &quot;response&quot;)</pre></div>
<div class="nocov"><span class="num"><pre>119</pre></span><pre>                return response(environ, start_response)</pre></div>
<div class="cov"><span class="num"><pre>120</pre></span><pre>            elif response is not None:</pre></div>
<div class="cov"><span class="num"><pre>121</pre></span><pre>                return response</pre></div>
<div class="skip"><span class="num"><pre>122</pre></span><pre>        </pre></div>
<div class="nocov"><span class="num"><pre>123</pre></span><pre>            raise Exception(&quot;No content returned by controller (Did you &quot;</pre></div>
<div class="nocov"><span class="num"><pre>124</pre></span><pre>                            &quot;remember to 'return' it?) in: %r&quot; %</pre></div>
<div class="nocov"><span class="num"><pre>125</pre></span><pre>                            controller.__name__)</pre></div>
<div class="nocov"><span class="num"><pre>126</pre></span><pre>        finally:</pre></div>
<div class="skip"><span class="num"><pre>127</pre></span><pre>            # Help Python collect ram a bit faster by removing the reference </pre></div>
<div class="skip"><span class="num"><pre>128</pre></span><pre>            # cycle that the pylons object causes</pre></div>
<div class="cov"><span class="num"><pre>129</pre></span><pre>            if 'pylons.pylons' in environ:</pre></div>
<div class="cov"><span class="num"><pre>130</pre></span><pre>                del environ['pylons.pylons']</pre></div>
<div class="skip"><span class="num"><pre>131</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>132</pre></span><pre>    def register_globals(self, environ):</pre></div>
<div class="cov"><span class="num"><pre>133</pre></span><pre>        &quot;&quot;&quot;Registers globals in the environment, called from</pre></div>
<div class="cov"><span class="num"><pre>134</pre></span><pre>        :meth:`~PylonsApp.setup_app_env`</pre></div>
<div class="skip"><span class="num"><pre>135</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>136</pre></span><pre>        Override this to control how the Pylons API is setup. Note that</pre></div>
<div class="cov"><span class="num"><pre>137</pre></span><pre>        a custom render function will need to be used if the </pre></div>
<div class="cov"><span class="num"><pre>138</pre></span><pre>        ``pylons.app_globals`` global is not available.</pre></div>
<div class="skip"><span class="num"><pre>139</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>140</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>141</pre></span><pre>        pylons_obj = environ['pylons.pylons']</pre></div>
<div class="skip"><span class="num"><pre>142</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>143</pre></span><pre>        registry = environ['paste.registry']</pre></div>
<div class="cov"><span class="num"><pre>144</pre></span><pre>        registry.register(pylons.response, pylons_obj.response)</pre></div>
<div class="cov"><span class="num"><pre>145</pre></span><pre>        registry.register(pylons.request, pylons_obj.request)</pre></div>
<div class="skip"><span class="num"><pre>146</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>147</pre></span><pre>        registry.register(pylons.app_globals, self.globals)</pre></div>
<div class="cov"><span class="num"><pre>148</pre></span><pre>        registry.register(pylons.config, self.config)</pre></div>
<div class="cov"><span class="num"><pre>149</pre></span><pre>        registry.register(pylons.tmpl_context, pylons_obj.tmpl_context)</pre></div>
<div class="cov"><span class="num"><pre>150</pre></span><pre>        registry.register(pylons.translator, pylons_obj.translator)</pre></div>
<div class="skip"><span class="num"><pre>151</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>152</pre></span><pre>        if 'session' in pylons_obj.__dict__:</pre></div>
<div class="cov"><span class="num"><pre>153</pre></span><pre>            registry.register(pylons.session, pylons_obj.session)</pre></div>
<div class="cov"><span class="num"><pre>154</pre></span><pre>        if 'cache' in pylons_obj.__dict__:</pre></div>
<div class="nocov"><span class="num"><pre>155</pre></span><pre>            registry.register(pylons.cache, pylons_obj.cache)</pre></div>
<div class="cov"><span class="num"><pre>156</pre></span><pre>        elif 'cache' in pylons_obj.app_globals.__dict__:</pre></div>
<div class="nocov"><span class="num"><pre>157</pre></span><pre>            registry.register(pylons.cache, pylons_obj.app_globals.cache)</pre></div>
<div class="skip"><span class="num"><pre>158</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>159</pre></span><pre>        if 'routes.url' in environ:</pre></div>
<div class="cov"><span class="num"><pre>160</pre></span><pre>            registry.register(pylons.url, environ['routes.url'])</pre></div>
<div class="skip"><span class="num"><pre>161</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>162</pre></span><pre>    def setup_app_env(self, environ, start_response):</pre></div>
<div class="cov"><span class="num"><pre>163</pre></span><pre>        &quot;&quot;&quot;Setup and register all the Pylons objects with the registry</pre></div>
<div class="skip"><span class="num"><pre>164</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>165</pre></span><pre>        After creating all the global objects for use in the request,</pre></div>
<div class="cov"><span class="num"><pre>166</pre></span><pre>        :meth:`~PylonsApp.register_globals` is called to register them</pre></div>
<div class="cov"><span class="num"><pre>167</pre></span><pre>        in the environment.</pre></div>
<div class="skip"><span class="num"><pre>168</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>169</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>170</pre></span><pre>        if self.log_debug:</pre></div>
<div class="cov"><span class="num"><pre>171</pre></span><pre>            log.debug(&quot;Setting up Pylons stacked object globals&quot;)</pre></div>
<div class="skip"><span class="num"><pre>172</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre>173</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre>174</pre></span><pre>        # Setup the basic pylons global objects</pre></div>
<div class="cov"><span class="num"><pre>175</pre></span><pre>        req_options = self.request_options</pre></div>
<div class="cov"><span class="num"><pre>176</pre></span><pre>        req = Request(environ, charset=req_options['charset'],</pre></div>
<div class="cov"><span class="num"><pre>177</pre></span><pre>                      unicode_errors=req_options['errors'],</pre></div>
<div class="cov"><span class="num"><pre>178</pre></span><pre>                      decode_param_names=req_options['decode_param_names'])</pre></div>
<div class="cov"><span class="num"><pre>179</pre></span><pre>        req.language = req_options['language']</pre></div>
<div class="skip"><span class="num"><pre>180</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>181</pre></span><pre>        response = Response(</pre></div>
<div class="cov"><span class="num"><pre>182</pre></span><pre>            content_type=self.response_options['content_type'],</pre></div>
<div class="cov"><span class="num"><pre>183</pre></span><pre>            charset=self.response_options['charset'])</pre></div>
<div class="cov"><span class="num"><pre>184</pre></span><pre>        response.headers.update(self.response_options['headers'])</pre></div>
<div class="skip"><span class="num"><pre>185</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre>186</pre></span><pre>        # Store a copy of the request/response in environ for faster access</pre></div>
<div class="cov"><span class="num"><pre>187</pre></span><pre>        pylons_obj = PylonsContext()</pre></div>
<div class="cov"><span class="num"><pre>188</pre></span><pre>        pylons_obj.config = self.config</pre></div>
<div class="cov"><span class="num"><pre>189</pre></span><pre>        pylons_obj.request = req</pre></div>
<div class="cov"><span class="num"><pre>190</pre></span><pre>        pylons_obj.response = response</pre></div>
<div class="cov"><span class="num"><pre>191</pre></span><pre>        pylons_obj.app_globals = self.globals</pre></div>
<div class="cov"><span class="num"><pre>192</pre></span><pre>        pylons_obj.h = self.helpers</pre></div>
<div class="skip"><span class="num"><pre>193</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>194</pre></span><pre>        if 'routes.url' in environ:</pre></div>
<div class="cov"><span class="num"><pre>195</pre></span><pre>            pylons_obj.url = environ['routes.url']</pre></div>
<div class="skip"><span class="num"><pre>196</pre></span><pre>                </pre></div>
<div class="cov"><span class="num"><pre>197</pre></span><pre>        environ['pylons.pylons'] = pylons_obj</pre></div>
<div class="skip"><span class="num"><pre>198</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>199</pre></span><pre>        environ['pylons.environ_config'] = self.environ_config</pre></div>
<div class="skip"><span class="num"><pre>200</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre>201</pre></span><pre>        # Setup the translator object</pre></div>
<div class="cov"><span class="num"><pre>202</pre></span><pre>        lang = self.config['lang']</pre></div>
<div class="cov"><span class="num"><pre>203</pre></span><pre>        pylons_obj.translator = _get_translator(lang, pylons_config=self.config)</pre></div>
<div class="skip"><span class="num"><pre>204</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>205</pre></span><pre>        if self.config['pylons.strict_tmpl_context']:</pre></div>
<div class="cov"><span class="num"><pre>206</pre></span><pre>            tmpl_context = ContextObj()</pre></div>
<div class="nocov"><span class="num"><pre>207</pre></span><pre>        else:</pre></div>
<div class="nocov"><span class="num"><pre>208</pre></span><pre>            tmpl_context = AttribSafeContextObj()</pre></div>
<div class="cov"><span class="num"><pre>209</pre></span><pre>        pylons_obj.tmpl_context = tmpl_context</pre></div>
<div class="skip"><span class="num"><pre>210</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>211</pre></span><pre>        econf = self.config['pylons.environ_config']</pre></div>
<div class="cov"><span class="num"><pre>212</pre></span><pre>        if self._session_key in environ:</pre></div>
<div class="cov"><span class="num"><pre>213</pre></span><pre>            pylons_obj.session = environ[self._session_key]</pre></div>
<div class="cov"><span class="num"><pre>214</pre></span><pre>        if self._cache_key in environ:</pre></div>
<div class="nocov"><span class="num"><pre>215</pre></span><pre>            pylons_obj.cache = environ[self._cache_key]</pre></div>
<div class="skip"><span class="num"><pre>216</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre>217</pre></span><pre>        # Load the globals with the registry if around</pre></div>
<div class="cov"><span class="num"><pre>218</pre></span><pre>        if 'paste.registry' in environ:</pre></div>
<div class="cov"><span class="num"><pre>219</pre></span><pre>            self.register_globals(environ)</pre></div>
<div class="skip"><span class="num"><pre>220</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>221</pre></span><pre>    def resolve(self, environ, start_response):</pre></div>
<div class="cov"><span class="num"><pre>222</pre></span><pre>        &quot;&quot;&quot;Uses dispatching information found in </pre></div>
<div class="cov"><span class="num"><pre>223</pre></span><pre>        ``environ['wsgiorg.routing_args']`` to retrieve a controller</pre></div>
<div class="cov"><span class="num"><pre>224</pre></span><pre>        name and return the controller instance from the appropriate</pre></div>
<div class="cov"><span class="num"><pre>225</pre></span><pre>        controller module.</pre></div>
<div class="skip"><span class="num"><pre>226</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>227</pre></span><pre>        Override this to change how the controller name is found and</pre></div>
<div class="cov"><span class="num"><pre>228</pre></span><pre>        returned.</pre></div>
<div class="skip"><span class="num"><pre>229</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>230</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>231</pre></span><pre>        match = environ['wsgiorg.routing_args'][1]</pre></div>
<div class="cov"><span class="num"><pre>232</pre></span><pre>        environ['pylons.routes_dict'] = match</pre></div>
<div class="cov"><span class="num"><pre>233</pre></span><pre>        controller = match.get('controller')</pre></div>
<div class="cov"><span class="num"><pre>234</pre></span><pre>        if not controller:</pre></div>
<div class="nocov"><span class="num"><pre>235</pre></span><pre>            return</pre></div>
<div class="skip"><span class="num"><pre>236</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>237</pre></span><pre>        if self.log_debug:</pre></div>
<div class="cov"><span class="num"><pre>238</pre></span><pre>            log.debug(&quot;Resolved URL to controller: %r&quot;, controller)</pre></div>
<div class="cov"><span class="num"><pre>239</pre></span><pre>        return self.find_controller(controller)</pre></div>
<div class="skip"><span class="num"><pre>240</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>241</pre></span><pre>    def find_controller(self, controller):</pre></div>
<div class="cov"><span class="num"><pre>242</pre></span><pre>        &quot;&quot;&quot;Locates a controller by attempting to import it then grab</pre></div>
<div class="cov"><span class="num"><pre>243</pre></span><pre>        the SomeController instance from the imported module.</pre></div>
<div class="skip"><span class="num"><pre>244</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>245</pre></span><pre>        Controller name is assumed to be a module in the controllers</pre></div>
<div class="cov"><span class="num"><pre>246</pre></span><pre>        directory unless it contains a '.' or ':' which is then assumed</pre></div>
<div class="cov"><span class="num"><pre>247</pre></span><pre>        to be a dotted path to the module and name of the controller</pre></div>
<div class="cov"><span class="num"><pre>248</pre></span><pre>        object.</pre></div>
<div class="skip"><span class="num"><pre>249</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>250</pre></span><pre>        Override this to change how the controller object is found once</pre></div>
<div class="cov"><span class="num"><pre>251</pre></span><pre>        the URL has been resolved.</pre></div>
<div class="skip"><span class="num"><pre>252</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>253</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre>254</pre></span><pre>        # Check to see if we've cached the class instance for this name</pre></div>
<div class="cov"><span class="num"><pre>255</pre></span><pre>        if controller in self.controller_classes:</pre></div>
<div class="cov"><span class="num"><pre>256</pre></span><pre>            return self.controller_classes[controller]</pre></div>
<div class="skip"><span class="num"><pre>257</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre>258</pre></span><pre>        # Check to see if its a dotted name</pre></div>
<div class="cov"><span class="num"><pre>259</pre></span><pre>        if '.' in controller or ':' in controller:</pre></div>
<div class="nocov"><span class="num"><pre>260</pre></span><pre>            mycontroller = pkg_resources.EntryPoint.parse(</pre></div>
<div class="nocov"><span class="num"><pre>261</pre></span><pre>                'x=%s' % controller).load(False)</pre></div>
<div class="nocov"><span class="num"><pre>262</pre></span><pre>            self.controller_classes[controller] = mycontroller</pre></div>
<div class="nocov"><span class="num"><pre>263</pre></span><pre>            return mycontroller</pre></div>
<div class="skip"><span class="num"><pre>264</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre>265</pre></span><pre>        # Pull the controllers class name, import controller</pre></div>
<div class="cov"><span class="num"><pre>266</pre></span><pre>        full_module_name = self.package_name + '.controllers.' \</pre></div>
<div class="cov"><span class="num"><pre>267</pre></span><pre>            + controller.replace('/', '.')</pre></div>
<div class="skip"><span class="num"><pre>268</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre>269</pre></span><pre>        # Hide the traceback here if the import fails (bad syntax and such)</pre></div>
<div class="cov"><span class="num"><pre>270</pre></span><pre>        __traceback_hide__ = 'before_and_this'</pre></div>
<div class="skip"><span class="num"><pre>271</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>272</pre></span><pre>        __import__(full_module_name)</pre></div>
<div class="cov"><span class="num"><pre>273</pre></span><pre>        if hasattr(sys.modules[full_module_name], '__controller__'):</pre></div>
<div class="nocov"><span class="num"><pre>274</pre></span><pre>            mycontroller = getattr(sys.modules[full_module_name],</pre></div>
<div class="nocov"><span class="num"><pre>275</pre></span><pre>                sys.modules[full_module_name].__controller__)</pre></div>
<div class="cov"><span class="num"><pre>276</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre>277</pre></span><pre>            module_name = controller.split('/')[-1]</pre></div>
<div class="cov"><span class="num"><pre>278</pre></span><pre>            class_name = class_name_from_module_name(module_name) + 'Controller'</pre></div>
<div class="cov"><span class="num"><pre>279</pre></span><pre>            if self.log_debug:</pre></div>
<div class="cov"><span class="num"><pre>280</pre></span><pre>                log.debug(&quot;Found controller, module: '%s', class: '%s'&quot;,</pre></div>
<div class="cov"><span class="num"><pre>281</pre></span><pre>                          full_module_name, class_name)</pre></div>
<div class="cov"><span class="num"><pre>282</pre></span><pre>            mycontroller = getattr(sys.modules[full_module_name], class_name)</pre></div>
<div class="cov"><span class="num"><pre>283</pre></span><pre>        self.controller_classes[controller] = mycontroller</pre></div>
<div class="cov"><span class="num"><pre>284</pre></span><pre>        return mycontroller</pre></div>
<div class="skip"><span class="num"><pre>285</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>286</pre></span><pre>    def dispatch(self, controller, environ, start_response):</pre></div>
<div class="cov"><span class="num"><pre>287</pre></span><pre>        &quot;&quot;&quot;Dispatches to a controller, will instantiate the controller</pre></div>
<div class="cov"><span class="num"><pre>288</pre></span><pre>        if necessary.</pre></div>
<div class="skip"><span class="num"><pre>289</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>290</pre></span><pre>        Override this to change how the controller dispatch is handled.</pre></div>
<div class="skip"><span class="num"><pre>291</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>292</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>293</pre></span><pre>        log_debug = self.log_debug</pre></div>
<div class="cov"><span class="num"><pre>294</pre></span><pre>        if not controller:</pre></div>
<div class="nocov"><span class="num"><pre>295</pre></span><pre>            if log_debug:</pre></div>
<div class="nocov"><span class="num"><pre>296</pre></span><pre>                log.debug(&quot;No controller found, returning 404 HTTP Not Found&quot;)</pre></div>
<div class="nocov"><span class="num"><pre>297</pre></span><pre>            return HTTPNotFound()(environ, start_response)</pre></div>
<div class="skip"><span class="num"><pre>298</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>299</pre></span><pre>        # If it's a class, instantiate it</pre></div>
<div class="cov"><span class="num"><pre>300</pre></span><pre>        if hasattr(controller, '__bases__'):</pre></div>
<div class="cov"><span class="num"><pre>301</pre></span><pre>            if log_debug:</pre></div>
<div class="cov"><span class="num"><pre>302</pre></span><pre>                log.debug(&quot;Controller appears to be a class, instantiating&quot;)</pre></div>
<div class="cov"><span class="num"><pre>303</pre></span><pre>            controller = controller()</pre></div>
<div class="cov"><span class="num"><pre>304</pre></span><pre>            controller._pylons_log_debug = log_debug</pre></div>
<div class="skip"><span class="num"><pre>305</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre>306</pre></span><pre>        # Add a reference to the controller app located</pre></div>
<div class="cov"><span class="num"><pre>307</pre></span><pre>        environ['pylons.controller'] = controller</pre></div>
<div class="skip"><span class="num"><pre>308</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre>309</pre></span><pre>        # Controller is assumed to handle a WSGI call</pre></div>
<div class="cov"><span class="num"><pre>310</pre></span><pre>        if log_debug:</pre></div>
<div class="cov"><span class="num"><pre>311</pre></span><pre>            log.debug(&quot;Calling controller class with WSGI interface&quot;)</pre></div>
<div class="cov"><span class="num"><pre>312</pre></span><pre>        return controller(environ, start_response)</pre></div>
<div class="skip"><span class="num"><pre>313</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>314</pre></span><pre>    def load_test_env(self, environ):</pre></div>
<div class="cov"><span class="num"><pre>315</pre></span><pre>        &quot;&quot;&quot;Sets up our Paste testing environment&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>316</pre></span><pre>        if self.log_debug:</pre></div>
<div class="cov"><span class="num"><pre>317</pre></span><pre>            log.debug(&quot;Setting up paste testing environment variables&quot;)</pre></div>
<div class="cov"><span class="num"><pre>318</pre></span><pre>        testenv = environ['paste.testing_variables']</pre></div>
<div class="cov"><span class="num"><pre>319</pre></span><pre>        pylons_obj = environ['pylons.pylons']</pre></div>
<div class="cov"><span class="num"><pre>320</pre></span><pre>        testenv['req'] = pylons_obj.request</pre></div>
<div class="cov"><span class="num"><pre>321</pre></span><pre>        testenv['response'] = pylons_obj.response</pre></div>
<div class="cov"><span class="num"><pre>322</pre></span><pre>        testenv['tmpl_context'] = pylons_obj.tmpl_context</pre></div>
<div class="cov"><span class="num"><pre>323</pre></span><pre>        testenv['app_globals'] = testenv['g'] = pylons_obj.app_globals</pre></div>
<div class="cov"><span class="num"><pre>324</pre></span><pre>        testenv['h'] = self.config['pylons.h']</pre></div>
<div class="cov"><span class="num"><pre>325</pre></span><pre>        testenv['config'] = self.config</pre></div>
<div class="cov"><span class="num"><pre>326</pre></span><pre>        if hasattr(pylons_obj, 'session'):</pre></div>
<div class="cov"><span class="num"><pre>327</pre></span><pre>            testenv['session'] = pylons_obj.session</pre></div>
<div class="cov"><span class="num"><pre>328</pre></span><pre>        if hasattr(pylons_obj, 'cache'):</pre></div>
<div class="nocov"><span class="num"><pre>329</pre></span><pre>            testenv['cache'] = pylons_obj.cache</pre></div>
<div class="skip"><span class="num"><pre>330</pre></span><pre></pre></div>
</div>
</body>
</html>
