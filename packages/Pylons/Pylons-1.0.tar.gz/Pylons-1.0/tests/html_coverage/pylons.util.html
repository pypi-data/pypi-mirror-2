<html>
<head>
<title>pylons.util</title>
</head>
<body>
pylons.util
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 106 lines<br/>
Missed: 60 lines<br/>
Skipped 43 lines<br/>
Percent: 63 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>  1</pre></span><pre>&quot;&quot;&quot;Paste Template and Pylons utility functions</pre></div>
<div class="skip"><span class="num"><pre>  2</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  3</pre></span><pre>PylonsTemplate is a Paste Template sub-class that configures the source</pre></div>
<div class="cov"><span class="num"><pre>  4</pre></span><pre>directory and default plug-ins for a new Pylons project. The minimal</pre></div>
<div class="cov"><span class="num"><pre>  5</pre></span><pre>template a more minimal template with less additional directories and</pre></div>
<div class="cov"><span class="num"><pre>  6</pre></span><pre>layout.</pre></div>
<div class="skip"><span class="num"><pre>  7</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  8</pre></span><pre>&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>  9</pre></span><pre>import logging</pre></div>
<div class="cov"><span class="num"><pre> 10</pre></span><pre>import sys</pre></div>
<div class="skip"><span class="num"><pre> 11</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 12</pre></span><pre>import pkg_resources</pre></div>
<div class="cov"><span class="num"><pre> 13</pre></span><pre>from paste.deploy.converters import asbool</pre></div>
<div class="cov"><span class="num"><pre> 14</pre></span><pre>from paste.script.appinstall import Installer</pre></div>
<div class="cov"><span class="num"><pre> 15</pre></span><pre>from paste.script.templates import Template, var</pre></div>
<div class="cov"><span class="num"><pre> 16</pre></span><pre>from tempita import paste_script_template_renderer</pre></div>
<div class="skip"><span class="num"><pre> 17</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 18</pre></span><pre>import pylons</pre></div>
<div class="cov"><span class="num"><pre> 19</pre></span><pre>import pylons.configuration</pre></div>
<div class="cov"><span class="num"><pre> 20</pre></span><pre>import pylons.i18n</pre></div>
<div class="skip"><span class="num"><pre> 21</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 22</pre></span><pre>__all__ = ['AttribSafeContextObj', 'ContextObj', 'PylonsContext',</pre></div>
<div class="cov"><span class="num"><pre> 23</pre></span><pre>           'class_name_from_module_name', 'call_wsgi_application']</pre></div>
<div class="skip"><span class="num"><pre> 24</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 25</pre></span><pre>log = logging.getLogger(__name__)</pre></div>
<div class="skip"><span class="num"><pre> 26</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 27</pre></span><pre>def call_wsgi_application(application, environ, catch_exc_info=False):</pre></div>
<div class="cov"><span class="num"><pre> 28</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 29</pre></span><pre>    Call the given WSGI application, returning ``(status_string,</pre></div>
<div class="cov"><span class="num"><pre> 30</pre></span><pre>    headerlist, app_iter)``</pre></div>
<div class="skip"><span class="num"><pre> 31</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 32</pre></span><pre>    Be sure to call ``app_iter.close()`` if it's there.</pre></div>
<div class="skip"><span class="num"><pre> 33</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 34</pre></span><pre>    If catch_exc_info is true, then returns ``(status_string,</pre></div>
<div class="cov"><span class="num"><pre> 35</pre></span><pre>    headerlist, app_iter, exc_info)``, where the fourth item may</pre></div>
<div class="cov"><span class="num"><pre> 36</pre></span><pre>    be None, but won't be if there was an exception.  If you don't</pre></div>
<div class="cov"><span class="num"><pre> 37</pre></span><pre>    do this and there was an exception, the exception will be</pre></div>
<div class="cov"><span class="num"><pre> 38</pre></span><pre>    raised directly.</pre></div>
<div class="skip"><span class="num"><pre> 39</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 40</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 41</pre></span><pre>    captured = []</pre></div>
<div class="cov"><span class="num"><pre> 42</pre></span><pre>    output = []</pre></div>
<div class="cov"><span class="num"><pre> 43</pre></span><pre>    def start_response(status, headers, exc_info=None):</pre></div>
<div class="cov"><span class="num"><pre> 44</pre></span><pre>        if exc_info is not None and not catch_exc_info:</pre></div>
<div class="nocov"><span class="num"><pre> 45</pre></span><pre>            raise exc_info[0], exc_info[1], exc_info[2]</pre></div>
<div class="cov"><span class="num"><pre> 46</pre></span><pre>        captured[:] = [status, headers, exc_info]</pre></div>
<div class="cov"><span class="num"><pre> 47</pre></span><pre>        return output.append</pre></div>
<div class="cov"><span class="num"><pre> 48</pre></span><pre>    app_iter = application(environ, start_response)</pre></div>
<div class="cov"><span class="num"><pre> 49</pre></span><pre>    if not captured or output:</pre></div>
<div class="nocov"><span class="num"><pre> 50</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 51</pre></span><pre>            output.extend(app_iter)</pre></div>
<div class="nocov"><span class="num"><pre> 52</pre></span><pre>        finally:</pre></div>
<div class="nocov"><span class="num"><pre> 53</pre></span><pre>            if hasattr(app_iter, 'close'):</pre></div>
<div class="nocov"><span class="num"><pre> 54</pre></span><pre>                app_iter.close()</pre></div>
<div class="nocov"><span class="num"><pre> 55</pre></span><pre>        app_iter = output</pre></div>
<div class="cov"><span class="num"><pre> 56</pre></span><pre>    if catch_exc_info:</pre></div>
<div class="cov"><span class="num"><pre> 57</pre></span><pre>        return (captured[0], captured[1], app_iter, captured[2])</pre></div>
<div class="nocov"><span class="num"><pre> 58</pre></span><pre>    else:</pre></div>
<div class="nocov"><span class="num"><pre> 59</pre></span><pre>        return (captured[0], captured[1], app_iter)</pre></div>
<div class="skip"><span class="num"><pre> 60</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 61</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 62</pre></span><pre>def class_name_from_module_name(module_name):</pre></div>
<div class="cov"><span class="num"><pre> 63</pre></span><pre>    &quot;&quot;&quot;Takes a module name and returns the name of the class it</pre></div>
<div class="cov"><span class="num"><pre> 64</pre></span><pre>    defines.</pre></div>
<div class="skip"><span class="num"><pre> 65</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 66</pre></span><pre>    If the module name contains dashes, they are replaced with</pre></div>
<div class="cov"><span class="num"><pre> 67</pre></span><pre>    underscores.</pre></div>
<div class="skip"><span class="num"><pre> 68</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 69</pre></span><pre>    Example::</pre></div>
<div class="skip"><span class="num"><pre> 70</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 71</pre></span><pre>        &gt;&gt;&gt; class_name_from_module_name('with-dashes')</pre></div>
<div class="cov"><span class="num"><pre> 72</pre></span><pre>        'WithDashes'</pre></div>
<div class="cov"><span class="num"><pre> 73</pre></span><pre>        &gt;&gt;&gt; class_name_from_module_name('with_underscores')</pre></div>
<div class="cov"><span class="num"><pre> 74</pre></span><pre>        'WithUnderscores'</pre></div>
<div class="cov"><span class="num"><pre> 75</pre></span><pre>        &gt;&gt;&gt; class_name_from_module_name('oneword')</pre></div>
<div class="cov"><span class="num"><pre> 76</pre></span><pre>        'Oneword'</pre></div>
<div class="skip"><span class="num"><pre> 77</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 78</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 79</pre></span><pre>    words = module_name.replace('-', '_').split('_')</pre></div>
<div class="cov"><span class="num"><pre> 80</pre></span><pre>    return ''.join(w.title() for w in words)</pre></div>
<div class="skip"><span class="num"><pre> 81</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 82</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 83</pre></span><pre>class PylonsContext(object):</pre></div>
<div class="cov"><span class="num"><pre> 84</pre></span><pre>    &quot;&quot;&quot;Pylons context object</pre></div>
<div class="skip"><span class="num"><pre> 85</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 86</pre></span><pre>    All the Pylons Stacked Object Proxies are also stored here, for use</pre></div>
<div class="cov"><span class="num"><pre> 87</pre></span><pre>    in generators and async based operation where the globals can't be</pre></div>
<div class="cov"><span class="num"><pre> 88</pre></span><pre>    used.</pre></div>
<div class="skip"><span class="num"><pre> 89</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 90</pre></span><pre>    This object is attached in</pre></div>
<div class="cov"><span class="num"><pre> 91</pre></span><pre>    :class:`~pylons.controllers.core.WSGIController` instances as</pre></div>
<div class="cov"><span class="num"><pre> 92</pre></span><pre>    :attr:`~WSGIController._py_object`. For example::</pre></div>
<div class="skip"><span class="num"><pre> 93</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 94</pre></span><pre>        class MyController(WSGIController):</pre></div>
<div class="cov"><span class="num"><pre> 95</pre></span><pre>            def index(self):</pre></div>
<div class="cov"><span class="num"><pre> 96</pre></span><pre>                pyobj = self._py_object</pre></div>
<div class="cov"><span class="num"><pre> 97</pre></span><pre>                return &quot;Environ is %s&quot; % pyobj.request.environ</pre></div>
<div class="skip"><span class="num"><pre> 98</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 99</pre></span><pre>    &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>100</pre></span><pre>    pass</pre></div>
<div class="skip"><span class="num"><pre>101</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>102</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>103</pre></span><pre>class ContextObj(object):</pre></div>
<div class="cov"><span class="num"><pre>104</pre></span><pre>    &quot;&quot;&quot;The :term:`tmpl_context` object, with strict attribute access</pre></div>
<div class="cov"><span class="num"><pre>105</pre></span><pre>    (raises an Exception when the attribute does not exist)&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>106</pre></span><pre>    def __repr__(self):</pre></div>
<div class="nocov"><span class="num"><pre>107</pre></span><pre>        attrs = sorted((name, value)</pre></div>
<div class="nocov"><span class="num"><pre>108</pre></span><pre>                       for name, value in self.__dict__.iteritems()</pre></div>
<div class="nocov"><span class="num"><pre>109</pre></span><pre>                       if not name.startswith('_'))</pre></div>
<div class="nocov"><span class="num"><pre>110</pre></span><pre>        parts = []</pre></div>
<div class="nocov"><span class="num"><pre>111</pre></span><pre>        for name, value in attrs:</pre></div>
<div class="nocov"><span class="num"><pre>112</pre></span><pre>            value_repr = repr(value)</pre></div>
<div class="nocov"><span class="num"><pre>113</pre></span><pre>            if len(value_repr) &gt; 70:</pre></div>
<div class="nocov"><span class="num"><pre>114</pre></span><pre>                value_repr = value_repr[:60] + '...' + value_repr[-5:]</pre></div>
<div class="nocov"><span class="num"><pre>115</pre></span><pre>            parts.append(' %s=%s' % (name, value_repr))</pre></div>
<div class="nocov"><span class="num"><pre>116</pre></span><pre>        return '&lt;%s.%s at %s%s&gt;' % (</pre></div>
<div class="nocov"><span class="num"><pre>117</pre></span><pre>            self.__class__.__module__,</pre></div>
<div class="nocov"><span class="num"><pre>118</pre></span><pre>            self.__class__.__name__,</pre></div>
<div class="nocov"><span class="num"><pre>119</pre></span><pre>            hex(id(self)),</pre></div>
<div class="nocov"><span class="num"><pre>120</pre></span><pre>            ','.join(parts))</pre></div>
<div class="skip"><span class="num"><pre>121</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>122</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>123</pre></span><pre>class AttribSafeContextObj(ContextObj):</pre></div>
<div class="cov"><span class="num"><pre>124</pre></span><pre>    &quot;&quot;&quot;The :term:`tmpl_context` object, with lax attribute access (</pre></div>
<div class="cov"><span class="num"><pre>125</pre></span><pre>    returns '' when the attribute does not exist)&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>126</pre></span><pre>    def __getattr__(self, name):</pre></div>
<div class="nocov"><span class="num"><pre>127</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre>128</pre></span><pre>            return object.__getattribute__(self, name)</pre></div>
<div class="nocov"><span class="num"><pre>129</pre></span><pre>        except AttributeError:</pre></div>
<div class="nocov"><span class="num"><pre>130</pre></span><pre>            log.debug(&quot;No attribute called %s found on c object, returning &quot;</pre></div>
<div class="nocov"><span class="num"><pre>131</pre></span><pre>                      &quot;empty string&quot;, name)</pre></div>
<div class="nocov"><span class="num"><pre>132</pre></span><pre>            return ''</pre></div>
<div class="skip"><span class="num"><pre>133</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>134</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>135</pre></span><pre>class PylonsTemplate(Template):</pre></div>
<div class="cov"><span class="num"><pre>136</pre></span><pre>    _template_dir = ('pylons', 'templates/default_project')</pre></div>
<div class="cov"><span class="num"><pre>137</pre></span><pre>    template_renderer = staticmethod(paste_script_template_renderer)</pre></div>
<div class="cov"><span class="num"><pre>138</pre></span><pre>    summary = 'Pylons application template'</pre></div>
<div class="cov"><span class="num"><pre>139</pre></span><pre>    egg_plugins = ['PasteScript', 'Pylons']</pre></div>
<div class="cov"><span class="num"><pre>140</pre></span><pre>    vars = [</pre></div>
<div class="cov"><span class="num"><pre>141</pre></span><pre>        var('template_engine', 'mako/genshi/jinja2/etc: Template language', </pre></div>
<div class="cov"><span class="num"><pre>142</pre></span><pre>            default='mako'),</pre></div>
<div class="cov"><span class="num"><pre>143</pre></span><pre>        var('sqlalchemy', 'True/False: Include SQLAlchemy 0.5 configuration',</pre></div>
<div class="cov"><span class="num"><pre>144</pre></span><pre>            default=False),</pre></div>
<div class="cov"><span class="num"><pre>145</pre></span><pre>    ]</pre></div>
<div class="cov"><span class="num"><pre>146</pre></span><pre>    ensure_names = ['description', 'author', 'author_email', 'url']</pre></div>
<div class="skip"><span class="num"><pre>147</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>148</pre></span><pre>    def pre(self, command, output_dir, vars):</pre></div>
<div class="cov"><span class="num"><pre>149</pre></span><pre>        &quot;&quot;&quot;Called before template is applied.&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>150</pre></span><pre>        package_logger = vars['package']</pre></div>
<div class="nocov"><span class="num"><pre>151</pre></span><pre>        if package_logger == 'root':</pre></div>
<div class="skip"><span class="num"><pre>152</pre></span><pre>            # Rename the app logger in the rare case a project is named 'root'</pre></div>
<div class="nocov"><span class="num"><pre>153</pre></span><pre>            package_logger = 'app'</pre></div>
<div class="nocov"><span class="num"><pre>154</pre></span><pre>        vars['package_logger'] = package_logger</pre></div>
<div class="skip"><span class="num"><pre>155</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>156</pre></span><pre>        template_engine = \</pre></div>
<div class="nocov"><span class="num"><pre>157</pre></span><pre>            vars.setdefault('template_engine',</pre></div>
<div class="nocov"><span class="num"><pre>158</pre></span><pre>                            pylons.configuration.default_template_engine)</pre></div>
<div class="skip"><span class="num"><pre>159</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>160</pre></span><pre>        if template_engine == 'mako':</pre></div>
<div class="skip"><span class="num"><pre>161</pre></span><pre>            # Support a Babel extractor default for Mako</pre></div>
<div class="nocov"><span class="num"><pre>162</pre></span><pre>            vars['babel_templates_extractor'] = \</pre></div>
<div class="nocov"><span class="num"><pre>163</pre></span><pre>                (&quot;('templates/**.mako', 'mako', {'input_encoding': 'utf-8'})&quot;</pre></div>
<div class="nocov"><span class="num"><pre>164</pre></span><pre>                 &quot;,\n%s#%s&quot; % (' ' * 4, ' ' * 8))</pre></div>
<div class="nocov"><span class="num"><pre>165</pre></span><pre>        else:</pre></div>
<div class="nocov"><span class="num"><pre>166</pre></span><pre>            vars['babel_templates_extractor'] = ''</pre></div>
<div class="skip"><span class="num"><pre>167</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>168</pre></span><pre>        # Ensure these exist in the namespace</pre></div>
<div class="nocov"><span class="num"><pre>169</pre></span><pre>        for name in self.ensure_names:</pre></div>
<div class="nocov"><span class="num"><pre>170</pre></span><pre>            vars.setdefault(name, '')</pre></div>
<div class="skip"><span class="num"><pre>171</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>172</pre></span><pre>        vars['version'] = vars.get('version', '0.1')</pre></div>
<div class="nocov"><span class="num"><pre>173</pre></span><pre>        vars['zip_safe'] = asbool(vars.get('zip_safe', 'false'))</pre></div>
<div class="nocov"><span class="num"><pre>174</pre></span><pre>        vars['sqlalchemy'] = asbool(vars.get('sqlalchemy', 'false'))</pre></div>
<div class="skip"><span class="num"><pre>175</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>176</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>177</pre></span><pre>class MinimalPylonsTemplate(PylonsTemplate):</pre></div>
<div class="cov"><span class="num"><pre>178</pre></span><pre>    _template_dir = ('pylons', 'templates/minimal_project')</pre></div>
<div class="cov"><span class="num"><pre>179</pre></span><pre>    summary = 'Pylons minimal application template'</pre></div>
<div class="cov"><span class="num"><pre>180</pre></span><pre>    vars = [</pre></div>
<div class="cov"><span class="num"><pre>181</pre></span><pre>        var('template_engine', 'mako/genshi/jinja2/etc: Template language', </pre></div>
<div class="cov"><span class="num"><pre>182</pre></span><pre>            default='mako'),</pre></div>
<div class="cov"><span class="num"><pre>183</pre></span><pre>    ]</pre></div>
<div class="skip"><span class="num"><pre>184</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>185</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>186</pre></span><pre>class PylonsInstaller(Installer):</pre></div>
<div class="cov"><span class="num"><pre>187</pre></span><pre>    use_cheetah = False</pre></div>
<div class="cov"><span class="num"><pre>188</pre></span><pre>    config_file = 'config/deployment.ini_tmpl'</pre></div>
<div class="skip"><span class="num"><pre>189</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>190</pre></span><pre>    def config_content(self, command, vars):</pre></div>
<div class="cov"><span class="num"><pre>191</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>192</pre></span><pre>        Called by ``self.write_config``, this returns the text content</pre></div>
<div class="cov"><span class="num"><pre>193</pre></span><pre>        for the config file, given the provided variables.</pre></div>
<div class="cov"><span class="num"><pre>194</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>195</pre></span><pre>        modules = [line.strip()</pre></div>
<div class="nocov"><span class="num"><pre>196</pre></span><pre>                    for line in self.dist.get_metadata_lines('top_level.txt')</pre></div>
<div class="nocov"><span class="num"><pre>197</pre></span><pre>                    if line.strip() and not line.strip().startswith('#')]</pre></div>
<div class="nocov"><span class="num"><pre>198</pre></span><pre>        if not modules:</pre></div>
<div class="nocov"><span class="num"><pre>199</pre></span><pre>            print &gt;&gt; sys.stderr, 'No modules are listed in top_level.txt'</pre></div>
<div class="nocov"><span class="num"><pre>200</pre></span><pre>            print &gt;&gt; sys.stderr, \</pre></div>
<div class="nocov"><span class="num"><pre>201</pre></span><pre>                'Try running python setup.py egg_info to regenerate that file'</pre></div>
<div class="nocov"><span class="num"><pre>202</pre></span><pre>        for module in modules:</pre></div>
<div class="nocov"><span class="num"><pre>203</pre></span><pre>            if pkg_resources.resource_exists(module, self.config_file):</pre></div>
<div class="nocov"><span class="num"><pre>204</pre></span><pre>                return self.template_renderer(</pre></div>
<div class="nocov"><span class="num"><pre>205</pre></span><pre>                    pkg_resources.resource_string(module, self.config_file),</pre></div>
<div class="nocov"><span class="num"><pre>206</pre></span><pre>                    vars, filename=self.config_file)</pre></div>
<div class="skip"><span class="num"><pre>207</pre></span><pre>        # Legacy support for the old location in egg-info</pre></div>
<div class="nocov"><span class="num"><pre>208</pre></span><pre>        return super(PylonsInstaller, self).config_content(command, vars)</pre></div>
<div class="skip"><span class="num"><pre>209</pre></span><pre></pre></div>
</div>
</body>
</html>
