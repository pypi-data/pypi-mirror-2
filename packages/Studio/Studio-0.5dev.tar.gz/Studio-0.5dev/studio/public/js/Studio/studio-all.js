// This file is generated, do not edit!

Ext.ux.ColorPicker=function(config){Ext.ux.ColorPicker.superclass.constructor.call(this,config);this.addEvents('select');if(!this.value){this.value=this.defaultValue;}
if(this.handler){this.on("select",this.handler,this.scope,true);}};Ext.extend(Ext.ux.ColorPicker,Ext.Component,{itemCls:"x-color-picker",value:null,ctype:"Ext.ux.ColorPicker",rgbPicker:null,rgbTarget:null,huePicker:null,hueTarget:null,HSV:{h:0,s:0,v:0},defaultValue:'#FFFFFF',onRender:function(container,position){var el=document.createElement("div");el.id=this.getId();el.className=this.itemCls;container.dom.insertBefore(el,position);this.createRgbPicker(el);this.createHuePicker(el);this.el=Ext.get(el);},afterRender:function(){Ext.ux.ColorPicker.superclass.afterRender.call(this);if(this.value){var s=this.value;this.value=null;this.setColor(s);}},setColor:function(hex){var hsv=this.rgbToHsv(this.hexToRgb(hex));this.HSV={h:hsv[0],s:hsv[1],v:hsv[2]}
this.updateColor();},createRgbPicker:function(el){this.rgbPicker=Ext.DomHelper.append(el,{cls:'x-cp-rgbpicker',cn:{'cls':'x-cp-rgbpicker-inner',cn:{cls:'x-cp-rgbpicker-thumb'}}},true);this.rgbInnerEl=this.rgbPicker.first();this.rgbThumb=this.rgbInnerEl.first();this.halfRgbThumb=this.rgbThumb.getWidth()/2;this.rgbInnerEl.on('mousedown',this.rgbOnMouseDown,this);this.rgbThumb.moveTo(this.rgbPicker.getLeft()-this.halfRgbThumb,this.rgbPicker.getTop()-this.halfRgbThumb);},createHuePicker:function(el){this.huePicker=Ext.DomHelper.append(el,{cls:'x-cp-huepicker',cn:{'cls':'x-cp-huepicker-inner',cn:{cls:'x-cp-huepicker-thumb'}}},true);this.hueInnerEl=this.huePicker.first();this.hueThumb=this.hueInnerEl.first();this.halfHueThumb=this.hueThumb.getWidth()/2;this.hueInnerEl.on('mousedown',this.hueOnMouseDown,this);this.hueThumb.moveTo(this.huePicker.getLeft()-this.halfHueThumb,this.huePicker.getTop()-this.halfHueThumb);},rgbOnMouseDown:function(e){if(e.target!=this.rgbThumb.dom){var el=this.rgbInnerEl;var local=el.translatePoints(e.getXY());this.HSV.s=local.left/el.getWidth();var height=el.getHeight();this.HSV.v=(height-local.top)/height;this.updateColor();}},hueOnMouseDown:function(e){if(e.target!=this.hueThumb.dom){var el=this.hueInnerEl;var local=el.translatePoints(e.getXY());var height=el.getHeight();this.HSV.h=Math.round(360/height*(height-local.top));this.updateColor();}},updateColor:function(){var rgb=this.hsvToRgb(this.HSV.h,this.HSV.s,this.HSV.v);this.updateHuePosition();this.updateRgbPosition();this.updateRgbPickerBgColor();this.fireEvent('select',this,'#'+this.rgbToHex(rgb));},updateRgbPosition:function(x,y){var el=this.rgbInnerEl;var x=this.HSV.s*el.getWidth();var height=el.getHeight();var y=height-(this.HSV.v*height);this.rgbThumb.moveTo(this.rgbPicker.getLeft()+x-this.halfRgbThumb,this.rgbPicker.getTop()+y-this.halfRgbThumb,(this.animateMove||true));},updateHuePosition:function(){var el=this.hueInnerEl;var height=el.getHeight();var y=height-this.HSV.h*height/360;this.hueThumb.moveTo(this.hueThumb.getLeft(),this.huePicker.getTop()+y-this.halfHueThumb,(this.animateMove||true));},updateRgbPickerBgColor:function(color){this.rgbInnerEl.setStyle({'background-color':this.rgbToHex(this.hsvToRgb(this.HSV.h,1,1))});},hsvToRgb:function(h,s,v){if(h instanceof Array){return this.hsvToRgb.call(this,h[0],h[1],h[2]);}
var r,g,b,i,f,p,q,t;i=Math.floor((h/60)%6);f=(h/60)-i;p=v*(1-s);q=v*(1-f*s);t=v*(1-(1-f)*s);switch(i){case 0:r=v;g=t;b=p;break;case 1:r=q;g=v;b=p;break;case 2:r=p;g=v;b=t;break;case 3:r=p;g=q;b=v;break;case 4:r=t;g=p;b=v;break;case 5:r=v;g=p;b=q;break;}
return[this.realToDec(r),this.realToDec(g),this.realToDec(b)];},rgbToHex:function(r,g,b){if(r instanceof Array){return this.rgbToHex.call(this,r[0],r[1],r[2]);}
var chars='0123456789ABCDEF';return(chars.charAt(parseInt(r/16))+chars.charAt(parseInt(r%16))+
chars.charAt(parseInt(g/16))+chars.charAt(parseInt(g%16))+
chars.charAt(parseInt(b/16))+chars.charAt(parseInt(b%16)));},rgbToHsv:function(r,g,b){if(r instanceof Array){return this.rgbToHsv.call(this,r[0],r[1],r[2]);}
r=r/255;g=g/255;b=b/255;var min,max,delta,h,s,v;min=Math.min(Math.min(r,g),b);max=Math.max(Math.max(r,g),b);delta=max-min;switch(max){case min:h=0;break;case r:h=60*(g-b)/delta;if(g<b){h+=360;}
break;case g:h=(60*(b-r)/delta)+120;break;case b:h=(60*(r-g)/delta)+240;break;}
s=(max===0)?0:1-(min/max);return[Math.round(h),s,max];},realToDec:function(n){return Math.min(255,Math.round(n*256));},hexToRgb:function(hex){var h2d=function(d){return parseInt(d,16);}
var rgb=[h2d(hex.slice(1,3)),h2d(hex.slice(3,5)),h2d(hex.slice(5))];return rgb;}});Ext.reg('colorpicker',Ext.ux.ColorPicker);Ext.namespace('Ext.ux');Ext.ux.ColorPickerField=function(config){Ext.ux.ColorPickerField.superclass.constructor.call(this,config);this.on({'change':this.setStyle,'valid':this.setStyle,scope:this});};Ext.extend(Ext.ux.ColorPickerField,Ext.form.TriggerField,{triggerClass:'x-form-color-trigger',regex:/^#[0-9a-f]{6}$/i,regexText:'This is not a valid color',cssColors:{aqua:"#00FFFF",black:"#000000",blue:"#0000FF",fuchsia:"#FF00FF",gray:"#808080",green:"#008000",lime:"#00FF00",maroon:"#800000",navy:"#000080",olive:"#808000",purple:"#800080",red:"#FF0000",silver:"#C0C0C0",teal:"#008080",white:"#FFFFFF",yellow:"#FFFF00"},isDark:function(hex){var dark=false;if(hex){var r=parseInt(hex.substring(1,3),16)/255;var g=parseInt(hex.substring(3,5),16)/255;var b=parseInt(hex.substring(5,7),16)/255;var brightness=(r*0.299)+(g*0.587)+(b*0.144);dark=brightness<0.5;}
return dark;},setStyle:function(){var color=this.getValue();var hex=this.colorToHex(color)||"#ffffff";this.getEl().setStyle({"background":hex,"color":this.isDark(hex)?"#ffffff":"#000000"});},getHexValue:function(){return this.colorToHex(this.getValue());},colorToHex:function(color){var hex;if(color.match(this.regex)){hex=color;}else{hex=this.cssColors[color.toLowerCase()]||null;}
return hex;},menuListeners:{select:function(m,d){this.setValue(d);this.fireEvent('select',m,d);},show:function(){this.onFocus();},hide:function(){this.focus.defer(10,this);var ml=this.menuListeners;this.menu.un("select",ml.select,this);this.menu.un("show",ml.show,this);this.menu.un("hide",ml.hide,this);}},onRender:function(ct,position){Ext.ux.ColorPickerField.superclass.onRender.call(this,ct,position);this.fireEvent('change',this,this.getValue());},onTriggerClick:function(){if(this.disabled){return;}
var value=this.isValid()?this.getValue():'#FFFFFF';if(this.menu==null){this.menu=new Ext.ux.ColorPickerMenu({hideOnClick:false,value:value});}else{this.menu.picker.setColor(value);}
this.menu.on(Ext.apply({},this.menuListeners,{scope:this}));this.menu.show(this.el);}});Ext.reg('ext.ux.colorpicker',Ext.ux.ColorPickerField);Ext.ux.ColorPickerMenu=function(config){Ext.ux.ColorPickerMenu.superclass.constructor.call(this,config);this.plain=true;var ci=new Ext.ux.ColorItem(config);this.add(ci);this.picker=ci.picker;this.relayEvents(ci,["select"]);};Ext.extend(Ext.ux.ColorPickerMenu,Ext.menu.Menu,{beforeDestroy:function(){this.picker.destroy();}});Ext.ux.ColorItem=function(config){Ext.ux.ColorItem.superclass.constructor.call(this,new Ext.ux.ColorPicker(config),config);this.picker=this.component;this.relayEvents(this.picker,["select"]);if(this.selectHandler){this.on('select',this.selectHandler,this.scope);}};Ext.extend(Ext.ux.ColorItem,Ext.menu.Adapter);Ext.namespace("Ext.ux.form");Ext.ux.form.Spinner=function(config){Ext.ux.form.Spinner.superclass.constructor.call(this,config);this.addEvents({'spin':true,'spinup':true,'spindown':true});};Ext.extend(Ext.ux.form.Spinner,Ext.form.TriggerField,{triggerClass:'x-form-spinner-trigger',splitterClass:'x-form-spinner-splitter',alternateKey:Ext.EventObject.shiftKey,strategy:undefined,onRender:function(ct,position){Ext.ux.form.Spinner.superclass.onRender.call(this,ct,position);this.splitter=this.wrap.createChild({tag:'div',cls:this.splitterClass,style:'width:13px; height:2px;'});this.splitter.show().setRight((Ext.isIE)?1:2);this.splitter.show().setTop(10);this.proxy=this.trigger.createProxy('',this.splitter,true);this.proxy.addClass("x-form-spinner-proxy");this.proxy.setStyle('left','0px');this.proxy.setSize(14,1);this.proxy.hide();this.dd=new Ext.dd.DDProxy(this.splitter.dom.id,"SpinnerDrag",{dragElId:this.proxy.id});this.initSpinner();},initTrigger:function(){this.trigger.addClassOnOver('x-form-trigger-over');this.trigger.addClassOnClick('x-form-trigger-click');},initSpinner:function(){this.keyNav=new Ext.KeyNav(this.el,{"up":function(e){e.preventDefault();this.onSpinUp();},"down":function(e){e.preventDefault();this.onSpinDown();},"pageUp":function(e){e.preventDefault();this.onSpinUpAlternate();},"pageDown":function(e){e.preventDefault();this.onSpinDownAlternate();},scope:this});this.repeater=new Ext.util.ClickRepeater(this.trigger);this.repeater.on("click",this.onTriggerClick,this,{preventDefault:true});this.trigger.on("mouseover",this.onMouseOver,this,{preventDefault:true});this.trigger.on("mouseout",this.onMouseOut,this,{preventDefault:true});this.trigger.on("mousemove",this.onMouseMove,this,{preventDefault:true});this.trigger.on("mousedown",this.onMouseDown,this,{preventDefault:true});this.trigger.on("mouseup",this.onMouseUp,this,{preventDefault:true});this.wrap.on("mousewheel",this.handleMouseWheel,this);this.dd.setXConstraint(0,0,10);this.dd.setYConstraint(1500,1500,10);this.dd.endDrag=this.endDrag.createDelegate(this);this.dd.startDrag=this.startDrag.createDelegate(this);this.dd.onDrag=this.onDrag.createDelegate(this);if('object'==typeof this.strategy&&this.strategy.xtype){switch(this.strategy.xtype){case'number':this.strategy=new Ext.ux.form.Spinner.NumberStrategy(this.strategy);break;case'date':this.strategy=new Ext.ux.form.Spinner.DateStrategy(this.strategy);break;case'time':this.strategy=new Ext.ux.form.Spinner.TimeStrategy(this.strategy);break;default:delete(this.strategy);break;}
delete(this.strategy.xtype);}
if(this.strategy==undefined){this.strategy=new Ext.ux.form.Spinner.NumberStrategy();}},onMouseOver:function(){if(this.disabled){return;}
var middle=this.getMiddle();this.__tmphcls=(Ext.EventObject.getPageY()<middle)?'x-form-spinner-overup':'x-form-spinner-overdown';this.trigger.addClass(this.__tmphcls);},onMouseOut:function(){this.trigger.removeClass(this.__tmphcls);},onMouseMove:function(){if(this.disabled){return;}
var middle=this.getMiddle();if(((Ext.EventObject.getPageY()>middle)&&this.__tmphcls=="x-form-spinner-overup")||((Ext.EventObject.getPageY()<middle)&&this.__tmphcls=="x-form-spinner-overdown")){}},onMouseDown:function(){if(this.disabled){return;}
var middle=this.getMiddle();this.__tmpccls=(Ext.EventObject.getPageY()<middle)?'x-form-spinner-clickup':'x-form-spinner-clickdown';this.trigger.addClass(this.__tmpccls);},onMouseUp:function(){this.trigger.removeClass(this.__tmpccls);},onTriggerClick:function(){if(this.disabled||this.getEl().dom.readOnly){return;}
var middle=this.getMiddle();var ud=(Ext.EventObject.getPageY()<middle)?'Up':'Down';this['onSpin'+ud]();},getMiddle:function(){var t=this.trigger.getTop();var h=this.trigger.getHeight();var middle=t+(h/2);return middle;},isSpinnable:function(){if(this.disabled||this.getEl().dom.readOnly){Ext.EventObject.preventDefault();return false;}
return true;},handleMouseWheel:function(e){if(this.wrap.hasClass('x-trigger-wrap-focus')==false){return;}
var delta=e.getWheelDelta();if(delta>0){this.onSpinUp();e.stopEvent();}else if(delta<0){this.onSpinDown();e.stopEvent();}},startDrag:function(){this.proxy.show();this._previousY=Ext.fly(this.dd.getDragEl()).getTop();},endDrag:function(){this.proxy.hide();},onDrag:function(){if(this.disabled){return;}
var y=Ext.fly(this.dd.getDragEl()).getTop();var ud='';if(this._previousY>y){ud='Up';}
if(this._previousY<y){ud='Down';}
if(ud!=''){this['onSpin'+ud]();}
this._previousY=y;},onSpinUp:function(){if(this.isSpinnable()==false){return;}
if(Ext.EventObject.shiftKey==true){this.onSpinUpAlternate();return;}else{this.strategy.onSpinUp(this);}
this.fireEvent("spin",this);this.fireEvent("spinup",this);},onSpinDown:function(){if(this.isSpinnable()==false){return;}
if(Ext.EventObject.shiftKey==true){this.onSpinDownAlternate();return;}else{this.strategy.onSpinDown(this);}
this.fireEvent("spin",this);this.fireEvent("spindown",this);},onSpinUpAlternate:function(){if(this.isSpinnable()==false){return;}
this.strategy.onSpinUpAlternate(this);this.fireEvent("spin",this);this.fireEvent("spinup",this);},onSpinDownAlternate:function(){if(this.isSpinnable()==false){return;}
this.strategy.onSpinDownAlternate(this);this.fireEvent("spin",this);this.fireEvent("spindown",this);}});Ext.reg('uxspinner',Ext.ux.form.Spinner);Ext.ux.form.Spinner.Strategy=function(config){Ext.apply(this,config);};Ext.extend(Ext.ux.form.Spinner.Strategy,Ext.util.Observable,{defaultValue:0,minValue:undefined,maxValue:undefined,incrementValue:1,alternateIncrementValue:5,validationTask:new Ext.util.DelayedTask(),onSpinUp:function(field){this.spin(field,false,false);},onSpinDown:function(field){this.spin(field,true,false);},onSpinUpAlternate:function(field){this.spin(field,false,true);},onSpinDownAlternate:function(field){this.spin(field,true,true);},spin:function(field,down,alternate){this.validationTask.delay(500,function(){field.validate();});},fixBoundries:function(value){return value;}});Ext.ux.form.Spinner.NumberStrategy=function(config){Ext.ux.form.Spinner.NumberStrategy.superclass.constructor.call(this,config);};Ext.extend(Ext.ux.form.Spinner.NumberStrategy,Ext.ux.form.Spinner.Strategy,{allowDecimals:true,decimalPrecision:2,spin:function(field,down,alternate){Ext.ux.form.Spinner.NumberStrategy.superclass.spin.call(this,field,down,alternate);var v=parseFloat(field.getValue());var incr=(alternate==true)?this.alternateIncrementValue:this.incrementValue;(down==true)?v-=incr:v+=incr;v=(isNaN(v))?this.defaultValue:v;v=this.fixBoundries(v);field.setRawValue(v);},fixBoundries:function(value){var v=value;if(this.minValue!=undefined&&v<this.minValue){v=this.minValue;}
if(this.maxValue!=undefined&&v>this.maxValue){v=this.maxValue;}
return this.fixPrecision(v);},fixPrecision:function(value){var nan=isNaN(value);if(!this.allowDecimals||this.decimalPrecision==-1||nan||!value){return nan?'':value;}
return parseFloat(parseFloat(value).toFixed(this.decimalPrecision));}});Ext.ux.form.Spinner.DateStrategy=function(config){Ext.ux.form.Spinner.DateStrategy.superclass.constructor.call(this,config);};Ext.extend(Ext.ux.form.Spinner.DateStrategy,Ext.ux.form.Spinner.Strategy,{defaultValue:new Date(),format:"Y-m-d",incrementValue:1,incrementConstant:Date.DAY,alternateIncrementValue:1,alternateIncrementConstant:Date.MONTH,spin:function(field,down,alternate){Ext.ux.form.Spinner.DateStrategy.superclass.spin.call(this);var v=field.getRawValue();v=Date.parseDate(v,this.format);var dir=(down==true)?-1:1;var incr=(alternate==true)?this.alternateIncrementValue:this.incrementValue;var dtconst=(alternate==true)?this.alternateIncrementConstant:this.incrementConstant;if(typeof this.defaultValue=='string'){this.defaultValue=Date.parseDate(this.defaultValue,this.format);}
v=(v)?v.add(dtconst,dir*incr):this.defaultValue;v=this.fixBoundries(v);field.setRawValue(Ext.util.Format.date(v,this.format));},fixBoundries:function(date){var dt=date;var min=(typeof this.minValue=='string')?Date.parseDate(this.minValue,this.format):this.minValue;var max=(typeof this.maxValue=='string')?Date.parseDate(this.maxValue,this.format):this.maxValue;if(this.minValue!=undefined&&dt<min){dt=min;}
if(this.maxValue!=undefined&&dt>max){dt=max;}
return dt;}});Ext.ux.form.Spinner.TimeStrategy=function(config){Ext.ux.form.Spinner.TimeStrategy.superclass.constructor.call(this,config);};Ext.extend(Ext.ux.form.Spinner.TimeStrategy,Ext.ux.form.Spinner.DateStrategy,{format:"H:i",incrementValue:1,incrementConstant:Date.MINUTE,alternateIncrementValue:1,alternateIncrementConstant:Date.HOUR});Ext.form.FileUploadField=Ext.extend(Ext.form.TextField,{buttonText:OpenLayers.i18n('Browse...'),buttonOnly:false,buttonOffset:3,readOnly:true,autoSize:Ext.emptyFn,initComponent:function(){Ext.form.FileUploadField.superclass.initComponent.call(this);this.addEvents('fileselected');},onRender:function(ct,position){Ext.form.FileUploadField.superclass.onRender.call(this,ct,position);this.wrap=this.el.wrap({cls:'x-form-field-wrap x-form-file-wrap'});this.el.addClass('x-form-file-text');this.el.dom.removeAttribute('name');this.fileInput=this.wrap.createChild({id:this.getFileInputId(),name:this.name||this.getId(),cls:'x-form-file',tag:'input',type:'file',size:1});var btnCfg=Ext.applyIf(this.buttonCfg||{},{text:this.buttonText});this.button=new Ext.Button(Ext.apply(btnCfg,{renderTo:this.wrap,cls:'x-form-file-btn'+(btnCfg.iconCls?' x-btn-icon':'')}));if(this.buttonOnly){this.el.hide();this.wrap.setWidth(this.button.getEl().getWidth());}
this.fileInput.on('change',function(){var v=this.fileInput.dom.value;this.setValue(v);this.fireEvent('fileselected',this,v);},this);},getFileInputId:function(){return this.id+'-file';},onResize:function(w,h){Ext.form.FileUploadField.superclass.onResize.call(this,w,h);this.wrap.setWidth(w);if(!this.buttonOnly){var w=this.wrap.getWidth()-this.button.getEl().getWidth()-this.buttonOffset;this.el.setWidth(w);}},preFocus:Ext.emptyFn,getResizeEl:function(){return this.wrap;},getPositionEl:function(){return this.wrap;},alignErrorIcon:function(){this.errorIcon.alignTo(this.wrap,'tl-tr',[2,0]);}});Ext.reg('fileuploadfield',Ext.form.FileUploadField);Ext.namespace("Styler");Styler.MultiSlider=Ext.extend(Ext.BoxComponent,{count:2,vertical:false,minValue:0,maxValue:100,increment:0,clickRange:[5,15],clickToChange:true,animate:true,dragging:false,initComponent:function(){if(this.values===undefined){this.values=new Array(this.count);this.values[0]=this.minValue;if(this.count>1){var delta=(this.maxValue-this.minValue)/(this.count-1);for(var i=1;i<this.count;++i){this.values[i]=this.minValue+(i*delta);}}}else{this.count=this.values.length;}
Styler.MultiSlider.superclass.initComponent.call(this);this.addEvents('beforechange','change','changecomplete','dragstart','drag','dragend');if(this.vertical){Ext.apply(this,Styler.MultiSlider.Vertical);}},onRender:function(){var autoThumbs=new Array(this.count);for(var i=0;i<this.count;++i){autoThumbs[i]={cls:"x-slider-thumb "+"x-slider-thumb"+i};}
this.autoEl={cls:'x-slider '+(this.vertical?'x-slider-vert':'x-slider-horz'),cn:{cls:'x-slider-end',cn:{cls:'x-slider-inner',cn:autoThumbs}}};Styler.MultiSlider.superclass.onRender.apply(this,arguments);this.endEl=this.el.first();this.innerEl=this.endEl.first();this.thumbs=new Array(this.count);for(var i=0;i<this.count;++i){this.thumbs[i]=new Ext.Element(this.innerEl.dom.childNodes[i]);}
this.halfThumb=(this.vertical?this.thumbs[0].getHeight():this.thumbs[0].getWidth())/2;this.initEvents();},initEvents:function(){for(var i=0,len=this.thumbs.length;i<len;++i){this.thumbs[i].addClassOnOver('x-slider-thumb-over');}
this.mon(this.el,'mousedown',this.onMouseDown,this);this.trackers=new Array(this.count);for(var i=0;i<this.count;++i){this.trackers[i]=this.initTracker(i);}},initTracker:function(index){var tracker=new Ext.dd.DragTracker({onBeforeStart:this.onBeforeDragStart.createDelegate(this,[index],true),onStart:this.onDragStart.createDelegate(this,[index],true),onDrag:this.onDrag.createDelegate(this,[index],true),onEnd:this.onDragEnd.createDelegate(this,[index],true),tolerance:3,autoStart:300});tracker.initEl(this.thumbs[index]);this.on('beforedestroy',tracker.destroy,tracker);return tracker;},onMouseDown:function(e){if(this.disabled||!this.clickToChange){return;}
var over=false;for(var i=0;i<this.count;++i){over=over||e.target==this.thumbs[i].dom;}
if(!over){var local=this.innerEl.translatePoints(e.getXY());this.onClickChange(local);}},onClickChange:function(local){if(local.top>this.clickRange[0]&&local.top<this.clickRange[1]){var target=Math.round(this.reverseValue(local.left));var index=this.getClosestIndex(target);var values=this.values.slice();values[index]=target;this.setValues(values,undefined,true);}},getClosestIndex:function(target){var index=0;var value=this.values[0];var minDiff=Math.abs(target-value);var diff;if(this.count>1&&(target>=value)){for(var i=1;i<this.count;++i){value=this.values[i];diff=Math.abs(target-value);if(diff<=minDiff){if(diff==minDiff){if(target>value){index=i;}}else{index=i;minDiff=diff;}}else{break;}}}
return index;},doSnap:function(value){if(!this.increment||this.increment==1||!value){return value;}
var newValue=value,inc=this.increment;var m=value%inc;if(m>0){if(m>(inc/2)){newValue=value+(inc-m);}else{newValue=value-m;}}
return newValue.constrain(this.minValue,this.maxValue);},afterRender:function(){Styler.MultiSlider.superclass.afterRender.apply(this,arguments);if(this.values!==undefined){var v,value,changed;var newValues=this.values.slice();for(var i=0;i<this.count;++i){value=newValues[i];v=this.normalizeValue(value);if(v!==value){newValues[i]=v;changed=true;}}
if(changed){this.setValues(newValues,false);}else{this.moveThumbs(this.translateValues(this.values),false);}}},getRatio:function(){var w=this.innerEl.getWidth();var v=this.maxValue-this.minValue;return v==0?w:(w/v);},normalizeValue:function(v){if(typeof v!='number'){v=parseInt(v);}
v=Math.round(v);v=this.doSnap(v);v=v.constrain(this.minValue,this.maxValue);return v;},setValues:function(values,animate,changeComplete){var changed=false;for(var i=0;i<this.count;++i){values[i]=this.normalizeValue(values[i]);if(values[i]!==this.values[i]){changed=true;}}
var changed=(values[this.count-1]!==this.values[this.count-1]);if(this.count>1){var next,current;for(var i=this.count-2;i>=0;--i){next=values[i+1];current=values[i];if(current>next){values[i]=next;}
changed=changed||(values[i]!==this.values);}}
if(changed&&this.fireEvent('beforechange',this,values,this.values)!==false){this.values=values;this.moveThumbs(this.translateValues(values),animate!==false);this.fireEvent('change',this,values);if(changeComplete){this.fireEvent('changecomplete',this,values);}}},translateValues:function(values){var ratio=this.getRatio();var len=values.length;var newValues=new Array(len);for(var i=0;i<len;++i){newValues[i]=(values[i]*ratio)-(this.minValue*ratio)-this.halfThumb;}
return newValues;},reverseValue:function(pos){var ratio=this.getRatio();return(pos+this.halfThumb+(this.minValue*ratio))/ratio;},moveThumbs:function(values,animate){if(!animate||this.animate===false){for(var i=0;i<this.count;++i){this.thumbs[i].setLeft(values[i]);}}else{for(var i=0;i<this.count;++i){this.thumbs[i].shift({left:values[i],stopFx:true,duration:.35});}}},onBeforeDragStart:function(e,index){return!this.disabled;},onDragStart:function(e,index){this.thumbs[index].addClass('x-slider-thumb-drag');this.dragging=true;this.dragStartValue=this.values[index];this.fireEvent('dragstart',this,index,e);},onDrag:function(e,index){var pos=this.innerEl.translatePoints(this.trackers[index].getXY());var newValues=this.values.slice();newValues[index]=Math.round(this.reverseValue(pos.left));this.setValues(newValues,false);this.fireEvent('drag',this,index,e);},onDragEnd:function(e,index){this.thumbs[index].removeClass('x-slider-thumb-drag');this.dragging=false;this.fireEvent('dragend',this,index,e);if(this.dragStartValue!=this.values[index]){this.fireEvent('changecomplete',this,this.values);}},onResize:function(w,h){try{this.innerEl.setWidth(w-(this.el.getPadding('l')+this.endEl.getPadding('r')));}catch(e){}
this.syncThumbs();},syncThumbs:function(){if(this.rendered){this.moveThumbs(this.translateValues(this.values));}},getValues:function(){return this.values;}});Ext.reg('gx_multislider',Styler.MultiSlider);Styler.MultiSlider.Vertical={onResize:function(w,h){this.innerEl.setHeight(h-(this.el.getPadding('t')+this.endEl.getPadding('b')));this.syncThumbs();},getRatio:function(){var h=this.innerEl.getHeight();var v=this.maxValue-this.minValue;return h/v;},moveThumbs:function(values,animate){if(!animate||this.animate===false){for(var i=0;i<this.count;++i){this.thumbs[i].setBottom(values[i]);}}else{for(var i=0;i<this.count;++i){this.thumbs[i].shift({bottom:values[i],stopFx:true,duration:.35});}}},onDrag:function(e,index){var pos=this.innerEl.translatePoints(this.trackers[index].getXY());var bottom=this.innerEl.getHeight()-pos.top;var newValues=this.values.slice();newValues[index]=Math.round(bottom/this.getRatio());this.setValues(newValues,false);this.fireEvent('drag',this,index,e);},onClickChange:function(local){if(local.left>this.clickRange[0]&&local.left<this.clickRange[1]){var bottom=this.innerEl.getHeight()-local.top;var target=Math.round(bottom/this.getRatio());var index=this.getClosestIndex(target);var values=this.values.slice();values[index]=target;this.setValues(values,undefined,true);}}};Ext.tree.RestTreeLoader=Ext.extend(Ext.tree.TreeLoader,{baseUrl:null,urlPostfix:null,preProcessNode:null,root:null,requestMethod:'GET',constructor:function(config){Ext.tree.RestTreeLoader.superclass.constructor.call(this,config);this.baseUrl=this.dataUrl||this.url;},requestData:function(node,callback){if(node.isRoot){this.url=this.baseUrl;}else{this.url=this.baseUrl+'/'+node.id;}
if(this.urlPostfix){this.url+=this.urlPostfix;}
Ext.tree.RestTreeLoader.superclass.requestData.apply(this,arguments);},processResponse:function(response,node,callback){if(this.root){var json=Ext.util.JSON.decode(response.responseText);response.responseText=Ext.util.JSON.encode(json[this.root]);}
return Ext.tree.RestTreeLoader.superclass.processResponse.apply(this,arguments);},createNode:function(attr){if(this.preProcessNode){if(!this.preProcessNode(attr)){return null;}}
return Ext.tree.RestTreeLoader.superclass.createNode.apply(this,arguments);}});Ext.tree.MapfileTreeLoader=Ext.extend(Ext.tree.RestTreeLoader,{createNode:function(attr){if(attr.name!==undefined){attr.text=attr.name;}
if(attr.layers!==undefined){attr.children=attr.layers;attr.role='record';for(var i=0,len=attr.children.length;i<len;i++){attr.children[i].leaf=true;attr.children[i].role='layer';}}
return Ext.tree.RestTreeLoader.superclass.createNode.apply(this,[attr]);}});var getFormValues=function(form){var result={};form.cascade(function(cur){if(cur.disabled!=true){if(cur.isXType('boxselect')){if(cur.getValue&&cur.getValue()){result[cur.getName()]=cur.getValue();}}else if(cur.isXType('combo')){if(cur.getValue&&cur.getValue()){result[cur.getName()]=cur.getValue();}}else if(cur.isXType('fieldset')){if(cur.checkbox){result[cur.checkboxName]=!cur.collapsed;}}else if(cur.isXType('radiogroup')){var first=cur.items.get(0);result[first.getName()]=first.getGroupValue();}else if(cur.isXType('checkbox')){result[cur.getName()]=cur.getValue();}else if(cur.getName){if(cur.getValue&&cur.getValue()!=""){result[cur.getName()]=cur.getValue();}}}
return true;});return result;};var randomString=function(){var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var string_length=8;var randomstring='';for(var i=0;i<string_length;i++){var rnum=Math.floor(Math.random()*chars.length);randomstring+=chars.substring(rnum,rnum+1);}
return randomstring;};var subString=function(str,config){for(var prop in config){str=str.replace(prop,config[prop]);}
return str;};var getFormPanel=function(element){if(!element.formPanel){element.formPanel=element.findParentBy(function(parent){return parent.isXType('studio.mm.mapfileform');});}
return element.formPanel;};var validateIntArray=function(v){if(!v.match(/^(\d+)(\s*\n*,\s*\n*(\d+))*$/)){return OpenLayers.i18n("Invalid format, must be a list of numbers separated by colons");}
return true;};var splitIntArray=function(txt){var valuesTxt=txt.split(/\s*\n*,\s*\n*/);var result=[];for(var i=0;i<valuesTxt.length;++i){result.push(parseFloat(valuesTxt[i]));}
return result;};Ext.namespace("Studio");Studio.ComboBoxWithEmpty=Ext.extend(Ext.form.ComboBox,{editable:false,typeAhead:false,mode:'local',triggerAction:'all',emptyText:OpenLayers.i18n('not specified'),initComponent:function(){if(this.store instanceof Array){if(this.store[0][0]!=''&&this.store[0][1]!=this.emptyText){this.store.unshift(['',this.emptyText]);}}else{if(this.store.getCount()>0){this.addEmptyData();}
this.store.on('load',this.addEmptyData,this);}
Studio.ComboBoxWithEmpty.superclass.initComponent.apply(this,arguments);},addEmptyData:function(){var store=this.initialConfig.store;if(!store){alert("null store");}
if(store.getCount()==0||store.getAt(0).get(this.valueField)!==''){var record={};record[this.valueField]='';record[this.displayField]=this.emptyText;store.insert(0,new store.recordType(record));}}});Ext.reg('studio.mm.comboempty',Studio.ComboBoxWithEmpty);Ext.namespace("Studio");Studio.UnitComboBox=Ext.extend(Studio.ComboBoxWithEmpty,{store:[['feet',OpenLayers.i18n('feet')],['inches',OpenLayers.i18n('inches')],['kilometers',OpenLayers.i18n('kilometers')],['meters',OpenLayers.i18n('meters')],['miles',OpenLayers.i18n('miles')],['dd',OpenLayers.i18n('dd')],['pixels',OpenLayers.i18n('pixels')],['percentages',OpenLayers.i18n('percentages')]]});Ext.reg('studio.unitcombo',Studio.UnitComboBox);Ext.namespace('Studio');Studio.Chooser=Ext.extend(Ext.Panel,{subPanelXType:null,allowDelete:true,allowExport:true,allowCreateNew:true,storeType:null,label:null,labels:null,textField:"name",treePanel:null,layout:"card",initComponent:function(){this.activeItem=this.getId()+'-chooser';Studio.Chooser.superclass.initComponent.call(this);this.on({activate:this.doLayout,render:function(){this.add({id:this.getId()+'-chooser',items:[this.createChooserPanel()]});},scope:this});},createChooserPanel:function(){var actions=[];if(this.allowExport){actions.push({action:"save",qtip:OpenLayers.i18n("export"+this.label)});}
if(this.allowDelete){actions.push({action:"delete",qtip:OpenLayers.i18n("delete"+this.label)});}
var ElemNodeUI=Ext.extend(Ext.tree.ActionsNodeUI,{actions:actions});var children=[];if(this.allowCreateNew){children.push({text:OpenLayers.i18n("createnew"+this.label),cls:"add-txt",iconCls:"add",leaf:true,role:'new-elem',listeners:{click:function(n){var s=this.storeType.getStore();var record=new s.recordType({id:null,url:null});record.set(this.textField,OpenLayers.i18n('DefaultName'));s.add(record);var newNode=treePanel.getRootNode().lastChild;this.loadRecord(record,newNode);},scope:this}});}
var treePanel=this.treePanel=new Ext.tree.TreePanel({rootVisible:true,width:300,border:false,root:new Ext.tree.AsyncTreeNode({text:this.labels,expanded:true,children:children}),loader:new Ext.tree.TreeLoader({uiProviders:{'elem':ElemNodeUI}})});treePanel.getSelectionModel().on({beforeselect:this.elemListTreeOnBeforeSelect,selectionchange:this.elemListTreeOnSelect,scope:this});treePanel.on('action',function(node,action,e){var recordInterface=node.attributes.record.getInterface();if(action=='delete'){Ext.Msg.confirm(OpenLayers.i18n("discard"+this.label),OpenLayers.i18n("Are you sure you want to discard this "+this.label+" ?"),function(a){if(a=="yes"){recordInterface["delete"]({failure:function(){Ext.Msg.alert('Error','An error occurred while discarding '+'the '+this.label+', please report the '+'problem.');},success:function(){this.storeType.store.reload();},scope:this});}},this);return false;}
if(action=="save"){recordInterface["download"]();return false;}},this);function addRecordsToTree(records,append){var root=treePanel.getRootNode();if(!append){var len=root.childNodes.length;for(var i=len-1;i>0;i--){var node=root.childNodes[i];if(node.attributes.role!='new-elem'){node.remove();}}}
Ext.each(records,function(item,index,records){var node={text:item.data[this.textField],id:item.data.id,uiProvider:"elem",qtip:OpenLayers.i18n('edit'+this.label),role:'elem',record:item,leaf:true};root.appendChild(node);},this);}
var store=this.storeType.getStore();store.on({load:function(store,records){addRecordsToTree.apply(this,[records]);},add:function(store,records){addRecordsToTree.apply(this,[records,true]);},scope:this});store.load();return treePanel;},elemListTreeOnBeforeSelect:function(sm,node){},elemListTreeOnSelect:function(sm,node){if(node&&node.attributes.role=='elem'){this.loadRecord(node.attributes.record,node);}},loadRecord:function(record,node){var recordInterface=record.getInterface();recordInterface.read({success:function(obj){var panel=this.add({id:this.getId()+'editing_panel',xtype:this.subPanelXType,record:obj,node:node,currentRecordInterface:recordInterface,listeners:{destroy:function(){this.treePanel.getSelectionModel().clearSelections();this.getLayout().setActiveItem(this.getId()+'-chooser');},scope:this}});this.getLayout().setActiveItem(this.getId()+'editing_panel');this.doLayout();panel.loadFromRecord();},failure:function(){alert("A problem occured, check your connection to the server.");},scope:this});}});Ext.reg('studio.chooser',Studio.Chooser);Ext.namespace("Studio");Studio.DatastoreCombo=Ext.extend(Ext.form.ComboBox,{fieldLabel:OpenLayers.i18n('DataStore'),emptyText:OpenLayers.i18n('Choose one store'),displayField:'text',valueField:'id',typeAhead:true,editable:false,mode:'local',forceSelection:true,triggerAction:'all',selectOnFocus:true,iconClsField:'icon',initComponent:function(){if(!this.store){this.store=Studio.datastoreStore.getStore();}
Studio.DatastoreCombo.superclass.initComponent.apply(this,arguments);}});Ext.reg('studio.datastorecombo',Studio.DatastoreCombo);Ext.namespace('Ext.ux');Ext.ux.IconCombo=function(config){Ext.ux.IconCombo.superclass.constructor.call(this,config);this.tpl=config.tpl||'<tpl for="."><div class="x-combo-list-item x-icon-combo-item {'
+this.iconClsField
+'}">{'
+this.displayField
+'}</div></tpl>';this.on({render:{scope:this,fn:function(){var wrap=this.el.up('div.x-form-field-wrap');this.wrap.applyStyles({position:'relative'});this.el.addClass('x-icon-combo-input');this.flag=Ext.DomHelper.append(wrap,{tag:'div',style:'position:absolute'});}}});};Ext.extend(Ext.ux.IconCombo,Ext.form.ComboBox,{setIconCls:function(){var rec=this.store.query(this.valueField,this.getValue()).itemAt(0);if(rec){this.flag.className='x-icon-combo-icon '+rec.get(this.iconClsField);}},setValue:function(value){Ext.ux.IconCombo.superclass.setValue.call(this,value);this.setIconCls();}});Ext.reg('iconcombo',Ext.ux.IconCombo);Ext.tree.ActionsNodeUI=Ext.extend(Ext.tree.TreeNodeUI,{actionsCls:'x-tree-node-actions',actionCls:'x-tree-node-action',renderElements:function(n,a,targetNode,bulkRender){this.indentMarkup=n.parentNode?n.parentNode.ui.getChildIndent():'';var cb=typeof a.checked=='boolean';var href=a.href?a.href:Ext.isGecko?"":"#";var bufArray=['<li class="x-tree-node"><div ext:tree-node-id="',n.id,'" class="x-tree-node-el x-tree-node-leaf x-unselectable ',a.cls,'" unselectable="on">'];bufArray=bufArray.concat(['<div class="',this.actionsCls,'">']);Ext.each(this.actions,function(item,index){bufArray=bufArray.concat(['<img id="'+n.id+'_'+item.action+'" ext:qtip="',item.qtip,'" src="',this.emptyIcon,'" class="',this.actionCls,' ',item.action,'" />']);},this);bufArray=bufArray.concat(['</div>']);bufArray=bufArray.concat(['<span class="x-tree-node-indent">',this.indentMarkup,"</span>",'<img src="',this.emptyIcon,'" class="x-tree-ec-icon x-tree-elbow" />','<img src="',a.icon||this.emptyIcon,'" class="x-tree-node-icon',(a.icon?" x-tree-node-inline-icon":""),(a.iconCls?" "+a.iconCls:""),'" unselectable="on" />',cb?('<input class="x-tree-node-cb" type="checkbox" '+(a.checked?'checked="checked" />':'/>')):'','<a hidefocus="on" class="x-tree-node-anchor" href="',href,'" tabIndex="1" ',a.hrefTarget?' target="'+a.hrefTarget+'"':"",'><span unselectable="on">',n.text,"</span></a>","</div>",'<ul class="x-tree-node-ct" style="display:none;"></ul>',"</li>"]);var buf=bufArray.join('');var nel;if(bulkRender!==true&&n.nextSibling&&(nel=n.nextSibling.ui.getEl())){this.wrap=Ext.DomHelper.insertHtml("beforeBegin",nel,buf);}else{this.wrap=Ext.DomHelper.insertHtml("beforeEnd",targetNode,buf);}
this.updateActions(n);this.elNode=this.wrap.childNodes[0];this.ctNode=this.wrap.childNodes[1];var cs=this.elNode.childNodes;this.indentNode=cs[1];this.ecNode=cs[2];this.iconNode=cs[3];var index=4;if(cb){this.checkbox=cs[4];this.checkbox.defaultChecked=this.checkbox.checked;index++;}
this.anchor=cs[index];this.textNode=cs[index].firstChild;},onClick:function(e){var t=e.getTarget('.'+this.actionCls);if(t){var action=t.className.replace(this.actionCls+' ','');if(this.fireEvent("action",this.node,action,e)===false){return;}}
Ext.tree.ActionsNodeUI.superclass.onClick.apply(this,arguments);},updateActions:function(n){Ext.each(this.actions,function(item,index){var el=Ext.get(n.id+'_'+item.action);if(!el)return;if(typeof item.hide=='function'&&item.hide.call(n)){el.setVisibilityMode(Ext.Element.DISPLAY);el.hide();}else{el.show();}},this);}});Ext.namespace('Studio','Studio.DataMgr');Studio.DataMgr.Panel=Ext.extend(Ext.Panel,{layout:"border",defaults:{border:false},currentRecordInterface:null,tree:null,loadFromRecord:function(){this.datastoreId=this.record.id;var dataSources=this.record.datasources;var newDsNode=this.tree.root.findChild('role','new-datasource');for(var i=0,len=dataSources.length;i<len;i++){if(this.tree.root.findChild('id',dataSources[i].id)==null){this.tree.root.insertBefore(dataSources[i],newDsNode);}}},initComponent:function(){this.items=[{region:'west',width:400,layout:'fit',split:true,items:[{layout:'border',border:false,defaults:{border:false},items:[this.getElementsTreePanel()]}]},this.getPropertiesPanel()];this.tbar=[{text:OpenLayers.i18n('<-- Back to datastores list'),handler:function(){this.destroy();},scope:this}];Studio.DataMgr.Panel.superclass.initComponent.call(this);},getElementsTreePanel:function(){var children=[];if(this.record.type==="directory"){children.push({text:OpenLayers.i18n('Add a new datasource ...'),cls:"add-txt",iconCls:"add",leaf:true,role:'new-datasource'});}
this.tree=new Ext.tree.TreePanel({region:'center',rootVisible:false,autoScroll:true,singleExpand:true,root:new Ext.tree.AsyncTreeNode({text:'invisible tree node',children:children})});this.tree.getSelectionModel().on('beforeselect',this.treeOnBeforeSelect,this);this.tree.getSelectionModel().on('selectionchange',this.treeOnSelect,this);return this.tree;},treeOnSelect:function(sm,node){if(node){var properties=node.attributes;if(properties.role&&properties.role=='new-datasource'){var win=new Studio.DataMgr.AddDatasourceWindow({datastoreId:this.datastoreId});win.on('fileuploaded',function(w){var store=Studio.getDatasourceStore(this.datastoreId).store;store.reload({callback:function(records,options,success){this.record.datasources=[];for(var i=0,len=records.length;i<len;i++){this.record.datasources.push(records[i].data);}
this.loadFromRecord();},scope:this});},this);win.show();this.tree.getSelectionModel().clearSelections();}}},treeOnBeforeSelect:function(sm,node){return true;},getPropertiesPanel:function(){return{title:OpenLayers.i18n('Parameters'),region:'center'};}});Ext.reg('studio.dm.panel',Studio.DataMgr.Panel);Ext.namespace('Studio','Studio.DataMgr');Studio.DataMgr.Chooser=Ext.extend(Studio.Chooser,{subPanelXType:"studio.dm.panel",allowDelete:false,allowExport:false,allowCreateNew:false,label:"datastore",labels:"datastores",textField:"text",initComponent:function(){this.storeType=Studio.datastoreStore;Studio.DataMgr.Chooser.superclass.initComponent.call(this);}});Ext.reg('studio.dm.chooser',Studio.DataMgr.Chooser);Ext.namespace('Studio','Studio.DataMgr');Studio.DataMgr.AddDatasourceWindow=Ext.extend(Ext.Window,{title:OpenLayers.i18n('Add a datasource'),layout:'form',modal:true,width:400,datastoreId:null,initComponent:function(){var form=new Ext.form.FormPanel({bodyStyle:'padding:5px',fileUpload:true,border:false,items:[{fieldLabel:OpenLayers.i18n('datasource'),labelWidth:120,xtype:'fileuploadfield',name:'datasources',listeners:{fileselected:function(fb,v){Ext.getCmp(this.id+'_add_button').setDisabled(false);},scope:this}}],buttons:[{text:OpenLayers.i18n('add'),id:this.id+'_add_button',disabled:true,handler:function(){form.getForm().submit({url:subString(Studio.datastoreStore.datasourceUrlScheme,{DATASTORE_ID:this.datastoreId}),waitMsg:OpenLayers.i18n('Uploading file...'),success:function(fp,o){this.fireEvent('fileuploaded');this.close();},scope:this});},scope:this},{text:OpenLayers.i18n('Cancel'),handler:function(){this.close();},scope:this}]});this.items=[form];Studio.DataMgr.AddDatasourceWindow.superclass.initComponent.apply(this,arguments);}});Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.ColorPickerField=Ext.extend(Ext.ux.ColorPickerField,{initComponent:function(){Studio.MapfileMgr.ColorPickerField.superclass.initComponent.call(this);},afterRender:function(){Studio.MapfileMgr.ColorPickerField.superclass.afterRender.call(this);this.on('valid',function(field){var f=getFormPanel(this);if(f){f.fireEvent('change',field,field.getValue(),null);}},this);}});Ext.reg('studio.mm.colorpickerfield',Studio.MapfileMgr.ColorPickerField);Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.NumberSpinner=Ext.extend(Ext.form.NumberField,{defaultValue:null,initComponent:function(){this.addSpinner();Studio.MapfileMgr.NumberSpinner.superclass.initComponent.apply(this,arguments);},addSpinner:function(){var spinner=new Ext.ux.form.Spinner({strategy:new Ext.ux.form.Spinner.NumberStrategy({minValue:this.minValue,maxValue:this.maxValue,allowDecimals:this.allowDecimals,decimalPrecision:this.decimalPrecision,defaultValue:this.defaultValue||0,incrementValue:this.incrementValue||1})});this.on('render',function(){spinner.applyToMarkup(this.getEl());spinner.splitter.hide();},this);spinner.on('spin',function(){this.fireEvent('change',this,null,null);},this);this.on('enable',spinner.enable,spinner);this.on('disable',spinner.disable,spinner);}});Ext.reg('studio.mm.numberspinner',Studio.MapfileMgr.NumberSpinner);Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.MapfilePanel=Ext.extend(Ext.Panel,{visitStyler:function(visitor){var subVisitor=visitor.beginPanel(this);if(subVisitor){Studio.MapfileMgr.MapfilePanel.visitItems(this,subVisitor);if(subVisitor.destroy)subVisitor.destroy();}
visitor.endPanel(this);}});Studio.MapfileMgr.MapfilePanel.visitItems=function(container,visitor){container.items.each(function(item){if(item.visitStyler){item.visitStyler(visitor);}else{var oldValue,newValue;if(item.isXType('combo')){if(item.getValue){oldValue=item.getValue();newValue=visitor.value(item,item.getName()||item.name,oldValue);if(oldValue!=newValue){item.setValue(newValue);}}}else if(item.isXType('fieldset')){if(item.checkbox&&item.checkboxName){oldValue=!item.collapsed;newValue=visitor.value(item,item.checkboxName,oldValue);if(oldValue!=newValue){if(newValue){item.expand(false);}else{item.collapse(false);}}}}else if(item.isXType('radiogroup')){var first=item.items.get(0);visitor.value(item,first.getName(),first.getGroupValue());alert("radiogroup not yet implemented");}else if(item.getName&&item.getValue){var name=item.getName()||item.name;if(name){oldValue=item.getValue();newValue=visitor.value(item,name,oldValue);if(oldValue!=newValue){item.setValue(newValue);}}}
if(item.isXType('container')&&item.items){Studio.MapfileMgr.MapfilePanel.visitItems(item,visitor);}}});};Ext.reg('studio.mm.mapfilepanel',Studio.MapfileMgr.MapfilePanel);Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.MapfileForm=Ext.extend(Ext.FormPanel,{properties:null,mapfileInterface:null,initComponent:function(){Studio.MapfileMgr.MapfileForm.superclass.initComponent.apply(this,arguments);this.addEvents('change','namechange');},visitStyler:function(visitor){var subVisitor=visitor.beginPanel(this);if(subVisitor){Studio.MapfileMgr.MapfilePanel.visitItems(this,subVisitor);if(subVisitor.destroy)subVisitor.destroy();}
visitor.endPanel(this);},loadData:function(){this.visitStyler(new Studio.MapfileMgr.MapfileToFormVisitor(this.properties,this.mapfileInterface));this.doLayout();this.doLayout();},getData:function(){this.visitStyler(new Studio.MapfileMgr.FormToMapfileVisitor(this.properties));return this.properties;}});Ext.reg('studio.mm.mapfileform',Studio.MapfileMgr.MapfileForm);Ext.override(Ext.form.Field,{afterRender:function(){Ext.form.Field.superclass.afterRender.call(this);this.initEvents();this.initValue();var event='change';if(this.isXType('radio')){event='check';}
this.on(event,function(field,v,startValue){var f=getFormPanel(field);if(f){f.fireEvent('change',field,v,startValue);}},this);}});var origCheckboxGroupOnRender=Ext.form.CheckboxGroup.prototype.onRender;Ext.override(Ext.form.CheckboxGroup,{onRender:function(ct,position){origCheckboxGroupOnRender.apply(this,arguments);if(this.items.each){this.items.each(function(item){item.ownerCt=this.ownerCt;},this);}else{for(var i=0;i<this.items.length;++i){this.items[i].ownerCt=this.ownerCt;}}}});Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.MapfileToFormVisitor=function(json,mapfileInterface){function createStylePanel(json,geometryType){var options={mapfileInterface:mapfileInterface,geometryType:geometryType};if(geometryType=='polygon'){if(json.outlinecolor){return new Studio.MapfileMgr.StrokeStylePanel(options);}else{return new Studio.MapfileMgr.FillStylePanel(options);}}else if(geometryType=='line'){return new Studio.MapfileMgr.StrokeStylePanel(options);}else{return new Studio.MapfileMgr.PointStylePanel(options);}}
function rebuildStylePanels(classPanel){classPanel.removeStylePanels();if(!json.styles)return;for(var i=0;i<json.styles.length;++i){var cur=json.styles[i];var stylePanel=createStylePanel(cur,classPanel.geometryType);classPanel.addStylePanel(stylePanel);stylePanel.visitStyler(new Studio.MapfileMgr.MapfileToFormVisitor.Simple(cur));}}
return{beginPanel:function(panel){var panelType=panel.getXType()||panel.xtype;if(panelType.match(/^studio\.mm\..*propertiespanel$/)){return this;}else if(panelType=='studio.mm.limitbyscale'){if(json.maxscaledenom||json.minscaledenom){panel.ownerCt.expand();return new Studio.MapfileMgr.MapfileToFormVisitor.Simple(json);}else{panel.ownerCt.collapse();return null;}}else if(panelType=='studio.mm.limitbycondition'){if(json.expression){panel.ownerCt.expand();return new Studio.MapfileMgr.MapfileToFormVisitor.LimitByCondition(json.expression);}else{panel.ownerCt.collapse();return null;}}else if(panelType=='studio.mm.labelstyle'){if(json.label){panel.ownerCt.expand();return new Studio.MapfileMgr.MapfileToFormVisitor.Simple(json.label);}else{panel.ownerCt.collapse();return null;}}else if(panelType=='studio.mm.bbox'){return new Studio.MapfileMgr.MapfileToFormVisitor.Simple(json[panel.jsonName]);}else if(panelType.match('style$')){return null;}else if(panelType=='studio.mm.wfsattributes'){if(json.metadata.gml_include_items){panel.ownerCt.expand();return new Studio.MapfileMgr.MapfileToFormVisitor.WfsAttributes(json.metadata);}else{panel.ownerCt.collapse();return null;}}else{alert('Un-supported xtype: '+panelType);return null;}},endPanel:function(panel){var panelType=panel.getXType();if(panelType=='studio.mm.classpropertiespanel'){rebuildStylePanels(panel);}},value:function(component,name,value){return Studio.MapfileMgr.MapfileToFormVisitor.getValue(json,component,name);}};};Studio.MapfileMgr.MapfileToFormVisitor.getValue=function(json,component,name){if(component.isXType('studio.mm.colorpickerfield')&&json[name]!=undefined){var rgb=json[name];function toHex(val){var result=parseInt(val).toString(16);if(result.length>1){return result;}else{return"0"+result;}}
return"#"+toHex(rgb[0])+toHex(rgb[1])+toHex(rgb[2]);}else{return json[name];}};Studio.MapfileMgr.MapfileToFormVisitor.Simple=function(json){return{beginPanel:function(panel){return this;},endPanel:function(panel){},value:function(component,name,value){return Studio.MapfileMgr.MapfileToFormVisitor.getValue(json,component,name);}};};Studio.MapfileMgr.MapfileToFormVisitor.LimitByCondition=function(expression){var regexpString=/^\(\s*"\[([^\]]+)\]"\s*([!=<>]*)\s*"([^"]*)"\s*\)$/;var regexpNumber=/^\(\s*\[([^\]]+)\]\s*([!=<>]*)\s*([0-9.e+-]+)\s*\)$/;var matches=regexpString.exec(expression);if(!matches)matches=regexpNumber.exec(expression);var exploded;if(!matches){alert("Cannot parse expression: "+expression);exploded={};}else{exploded={column:matches[1],operator:matches[2],value:matches[3]};}
return{beginPanel:function(panel){return this;},endPanel:function(panel){},value:function(component,name,value){return Studio.MapfileMgr.MapfileToFormVisitor.getValue(exploded,component,name);}};};Studio.MapfileMgr.MapfileToFormVisitor.WfsAttributes=function(json){return{beginPanel:function(panel){return this;},endPanel:function(panel){},value:function(component,name,value){return Studio.MapfileMgr.MapfileToFormVisitor.getValue(json,component,name);}};};Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.FormToMapfileVisitor=function(json){return{beginPanel:function(panel){var panelType=panel.getXType()||panel.xtype;if(panelType=='studio.mm.classpropertiespanel'){json.styles=[];return this;}else if(panelType.match(/^studio\.mm\..*propertiespanel/)){return this;}else if(panelType=='studio.mm.limitbyscale'){if(!panel.ownerCt.collapsed){return new Studio.MapfileMgr.FormToMapfileVisitor.Simple(json);}else{delete json.maxscaledenom;delete json.minscaledenom;return null;}}else if(panelType=='studio.mm.limitbycondition'){if(!panel.ownerCt.collapsed){return new Studio.MapfileMgr.FormToMapfileVisitor.LimitByCondition(json,panel.layer);}else{delete json.expression;return null;}}else if(panelType=='studio.mm.labelstyle'){if(!panel.ownerCt.collapsed){panel.ownerCt.expand();if(!json.label)json.label={};if(!json.label.type)json.label.type="truetype";return new Studio.MapfileMgr.FormToMapfileVisitor.Simple(json.label);}else{delete json.label;return null;}}else if(panelType=='studio.mm.bbox'){return new Studio.MapfileMgr.FormToMapfileVisitor.Simple(json[panel.jsonName]);}else if(panelType.match('style$')){var curStyle={};json.styles.push(curStyle);return new Studio.MapfileMgr.FormToMapfileVisitor.Simple(curStyle);}else if(panelType=='studio.mm.wfsattributes'){if(!panel.ownerCt.collapsed){json.dump=true;return new Studio.MapfileMgr.FormToMapfileVisitor.WfsAttributes(json);}else{delete json.dump;return null;}}else{alert('Un-supported xtype: '+panelType);return null;}},endPanel:function(panel){},value:function(component,name,value){return Studio.MapfileMgr.FormToMapfileVisitor.updateValue(json,component,name,value);}};};Studio.MapfileMgr.FormToMapfileVisitor.updateValue=function(json,component,name,value){if(value===""){delete json[name];}else if(component.isXType('studio.mm.colorpickerfield')){var hex=component.getHexValue();function toDec(val,pos){return parseInt(val.substring(pos,pos+2),16);}
json[name]=[toDec(hex,1),toDec(hex,3),toDec(hex,5)];}else{json[name]=value;}
return value;};Studio.MapfileMgr.FormToMapfileVisitor.Simple=function(json){return{beginPanel:function(panel){return this;},endPanel:function(panel){},value:function(component,name,value){return Studio.MapfileMgr.FormToMapfileVisitor.updateValue(json,component,name,value);}};};Studio.MapfileMgr.FormToMapfileVisitor.LimitByCondition=function(json,layer){var exploded={};return{beginPanel:function(panel){return this;},endPanel:function(panel){},value:function(component,name,value){return Studio.MapfileMgr.FormToMapfileVisitor.updateValue(exploded,component,name,value);},destroy:function(){if(exploded.column!==""&&exploded.operator){var columnType=Studio.getColumnType(layer,exploded.column);if(columnType=="string"){json.expression='("['+exploded.column+']"'+exploded.operator+'"'+exploded.value+'")';}else{json.expression='(['+exploded.column+']'+exploded.operator+exploded.value+')';}}else{delete json.expression;}}};};Studio.MapfileMgr.FormToMapfileVisitor.WfsAttributes=function(json){var exploded={};return{beginPanel:function(panel){return this;},endPanel:function(panel){},value:function(component){exploded=component.getSelectedValues();},destroy:function(){if(!json.metadata){json.metadata={};}
Ext.apply(json.metadata,exploded);}};};Ext.grid.CheckColumn=function(config){Ext.apply(this,config);if(!this.id){this.id=Ext.id();}
this.renderer=this.renderer.createDelegate(this);};Ext.grid.CheckColumn.prototype={init:function(grid){this.grid=grid;this.grid.on('render',function(){var view=this.grid.getView();view.mainBody.on('mousedown',this.onMouseDown,this);},this);},onMouseDown:function(e,t){if(t.className&&t.className.indexOf('x-grid3-cc-'+this.id)!=-1){e.stopEvent();var index=this.grid.getView().findRowIndex(t);var record=this.grid.store.getAt(index);record.set(this.dataIndex,!record.data[this.dataIndex]);}},renderer:function(v,p,record){p.css+=' x-grid3-check-col-td';return'<div class="x-grid3-check-col'+(v?'-on':'')+' x-grid3-cc-'+this.id+'">&#160;</div>';}};Ext.namespace('Studio','Studio.data');Studio.data.Store=function(config){Ext.apply(this,config);};Studio.data.Store.prototype={url:null,store:null,root:null,recordClass:null,getStore:function(){if(this.store){return this.store;}
this.store=new Ext.data.JsonStore({proxy:new Ext.data.HttpProxy({url:this.url,method:'GET'}),root:this.root,fields:this.recordClass});return this.store;}};Ext.namespace('Studio','Studio.data');Studio.data.FilteredStoreClone=function(config){var fields=config.fields=[];config.mainStore.fields.each(function(cur){fields.push({name:cur.name,mapping:'data.'+cur.name});},this);config.root="items";Studio.data.FilteredStoreClone.superclass.constructor.call(this,config);this.sync();this.mainStore.on('load',this.sync,this);this.mainStore.on('add',this.sync,this);this.mainStore.on('remove',this.sync,this);this.mainStore.on('update',this.sync,this);};Ext.extend(Studio.data.FilteredStoreClone,Ext.data.JsonStore,{mainStore:null,sync:function(){var data=this.mainStore.queryBy(this.filterMethod,this);this.loadData(data,false);},filterMethod:null});Ext.namespace('Studio','Studio.data');Studio.data.MapfileRecord=Ext.data.Record.create([{name:'name'},{name:'id'},{name:'url',mapping:'href'},{name:'wmsurl'},{name:'wmsproxyurl'}]);Studio.data.MapfileRecord.prototype.getInterface=function(){if(!this.interface){this.interface=new Studio.interface.MapfileInterface(this);}
return this.interface;};Ext.namespace('Studio','Studio.data');Studio.data.LayertemplateRecord=Ext.data.Record.create([{name:'name'},{name:'comment'},{name:'id'},{name:'url',mapping:'href'}]);Studio.data.LayertemplateRecord.prototype.getInterface=function(){if(!this.interface){this.interface=new Studio.interface.RestInterface(this);}
return this.interface;};Ext.namespace('Studio','Studio.data');Studio.data.DatastoreRecord=Ext.data.Record.create([{name:'text'},{name:'id'},{name:'url',mapping:'href'},{name:'type'}]);Studio.data.DatastoreRecord.prototype.getInterface=function(){if(!this.interface){this.interface=new Studio.interface.RestInterface(this);}
return this.interface;};Ext.namespace('Studio','Studio.data');Studio.data.DatasourceRecord=Ext.data.Record.create([{name:'text'},{name:'id'},{name:'type'},{name:'url',mapping:'href'},{name:'leaf'}]);Studio.data.DatasourceRecord.prototype.getInterface=function(){if(!this.interface){this.interface=new Studio.interface.DatasourceInterface(this);}
return this.interface;};Ext.namespace('Studio','Studio.data');Studio.data.DatasourceColumnRecord=Ext.data.Record.create([{name:'name'},{name:'type'}]);Studio.data.DatasourceColumnRecord.prototype.getInterface=function(){if(!this.interface){this.interface=new Studio.interface.RestInterface(this);}
return this.interface;};Ext.namespace('Studio','Studio.interface');Studio.interface.RestInterface=function(record){this.record=record;};Studio.interface.RestInterface.prototype={record:null,getId:function(){return this.record.get("id");},getHref:function(){return this.record.get("url");},jsonToObj:function(json){return Ext.util.JSON.decode(json);},objToJson:function(obj){return Ext.util.JSON.encode(obj);},"create":function(config,obj){Ext.Ajax.request({url:this.record.store.proxy.conn.url,method:"POST",headers:{'Content-Type':"application/json; charset=UTF-8"},jsonData:this.objToJson(obj),callback:function(options,success,response){if(response.status==201){var obj=Ext.util.JSON.decode(response.responseText);this.record.data.id=obj.id;this.record.data.url=obj.href;if(config&&config.success){config.success.call(config.scope);}}else if(config&&config.failure){config.failure.call(config.scope);}}.createDelegate(this)});},"read":function(config){Ext.Ajax.request({url:this.getHref(),method:"GET",callback:function(options,success,response){if(response.status==200){var obj=this.jsonToObj(response.responseText);if(config&&config.success){config.success.call(config.scope,obj);}}else if(config&&config.failure){config.failure.call(config.scope);}}.createDelegate(this)});},"update":function(config,obj){Ext.Ajax.request({url:this.getHref(),method:"PUT",headers:{'Content-Type':"application/json; charset=UTF-8"},jsonData:this.objToJson(obj),callback:function(options,success,response){if(response.status==201){var obj;if(response.responseText){obj=this.jsonToObj(response.responseText);}
if(config&&config.success){config.success.call(config.scope,obj);}}else if(config&&config.failure){config.failure.call(config.scope);}}.createDelegate(this)});},"delete":function(config){if(this.getId()==null){if(config&&config.success){config.success.call(config.scope);}}else{Ext.Ajax.request({url:this.getHref(),method:"DELETE",callback:function(options,success,response){if(response.status==204){if(config&&config.success){config.success.call(config.scope);}}else if(config&&config.failure){config.failure.call(config.scope);}}.createDelegate(this)});}},"createOrUpdate":function(config,obj){if(this.getId()==null){this.create(config,obj);}else{this.update(config,obj);}}};Ext.namespace('Studio','Studio.interface');Studio.interface.MapfileInterface=Ext.extend(Studio.interface.RestInterface,{symbols:null,filteredSymbols:null,fonts:null,getHref:function(){return this.record.get("url")||Studio.mapfileStore.url+"/default";},getWMSProxy:function(){return this.record.get("wmsproxyurl");},getWMS:function(){return this.record.get("wmsurl");},jsonToObj:function(json){var obj=Ext.util.JSON.decode(json).map;obj.name=this.record.get("name");return obj;},getFontsStore:function(){if(this.fonts){return this.fonts;}else{this.fonts=new Ext.data.JsonStore({proxy:new Ext.data.HttpProxy({url:this.getHref()+'/fonts',method:'GET'}),root:'fonts',fields:['name','id']});this.fonts.load();return this.fonts;}},getSymbolsStore:function(filter){if(!this.symbols){this.symbols=new Ext.data.JsonStore({proxy:new Ext.data.HttpProxy({url:this.getHref()+'/symbols',method:'GET'}),root:'symbols',fields:['name','id','isPoint','isStroke','isFill']});this.symbols.load();this.filteredSymbols={};}
if(filter){if(!this.filteredSymbols[filter]){this.filteredSymbols[filter]=new Studio.data.FilteredStoreClone({mainStore:this.symbols,filterMethod:function(record,id){var value=record.get(filter);return value===null||value;}});}
return this.filteredSymbols[filter];}else{return this.symbols;}},"create":function(config,obj){Ext.Ajax.request({url:this.record.store.proxy.conn.url,method:"POST",jsonData:this.objToJson(obj),callback:function(options,success,response){if(response.status==201){var obj=Ext.util.JSON.decode(response.responseText);this.record.data.id=obj.id;this.record.data.url=obj.href;this.record.data.wmsproxyurl=obj.wmsproxyurl;this.record.data.wmsurl=obj.wmsurl;if(config&&config.success){config.success.call(config.scope);}}else if(config&&config.failure){config.failure.call(config.scope);}}.createDelegate(this)});},"download":function(){window.location.href=this.getHref()+'/download';}});Ext.namespace('Studio','Studio.interface');Studio.interface.DatasourceInterface=Ext.extend(Studio.interface.RestInterface,{getMapfileHref:function(){return this.getHref()+"/mapfile";},"get_mapfile":function(config){Ext.Ajax.request({url:this.getMapfileHref(),method:"GET",callback:function(options,success,response){if(response.status==200){var obj=this.jsonToObj(response.responseText);if(config&&config.success){config.success.call(config.scope,obj);}}else if(config&&config.failure){config.failure.call(config.scope);}}.createDelegate(this)});}});Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.Chooser=Ext.extend(Studio.Chooser,{subPanelXType:"studio.mm.panel",label:OpenLayers.i18n("labelmapfile"),labels:OpenLayers.i18n("labelmapfiles"),initComponent:function(){this.storeType=Studio.mapfileStore;Studio.MapfileMgr.Chooser.superclass.initComponent.call(this);}});Ext.reg('studio.mm.chooser',Studio.MapfileMgr.Chooser);Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.Panel=Ext.extend(Ext.Panel,{layout:'border',defaults:{border:false},currentRecordInterface:null,node:null,tree:null,currentPanelProperties:null,map:null,mapfileLayer:null,dirty:false,record:null,initComponent:function(){this.buildMapfileTree();this.items=[{region:'west',width:400,layout:'fit',split:true,items:[{layout:'border',border:false,defaults:{border:false},items:[this.tree,this.getMapViewerPanel()]}]},this.getPropertiesPanel()];this.tbar=[{text:OpenLayers.i18n('<-- Back to mapfiles list'),handler:function(){var backToMapfilesList=function(){if(this.map){this.map.destroy();this.map=null;}
this.destroy();};if(this.dirty){Ext.Msg.confirm(OpenLayers.i18n('Attention'),OpenLayers.i18n('There are unsaved changes !<br /> Are you sure you want to switch to another mapfile ?<br /> '),function(btn){if(btn=='yes'){backToMapfilesList.call(this);}},this);}else{backToMapfilesList.call(this);}},scope:this},'-',{id:this.getId()+'_save_button',text:OpenLayers.i18n('Save mapfile'),iconCls:'save',disabled:true,handler:this.saveMapfile,scope:this}];Studio.MapfileMgr.Panel.superclass.initComponent.call(this);},loadFromRecord:function(){this.tree.getLoader().doPreload(this.tree.getRootNode());this.populateMapfileTree(this.record);if(this.record.layers.length>0){this.createMap();}
Ext.getCmp(this.getId()+'_save_button').disable();this.dirty=false;},updateMapLayers:function(){if(!this.map){this.createMap();}
var mapfileLayers=this.getLayersList();if(!this.mapfileLayer&&mapfileLayers.length>0){var layer=new OpenLayers.Layer.WMS("baselayer",this.currentRecordInterface.getWMSProxy(),{layers:mapfileLayers,format:'image/png'},{singleTile:true,ratio:1,transitionEffect:'resize'});this.map.addLayer(layer);this.mapfileLayer=layer;this.map.zoomToMaxExtent();}},getMapViewerPanel:function(){return{title:OpenLayers.i18n('Map Viewer'),id:this.getId()+'_viewerContainer',region:'south',height:300,layout:'fit',split:true,disabled:true,tools:[{id:'refresh',scope:this,qtip:OpenLayers.i18n('Save mapfile and refresh map'),handler:function(event,toolEl,panel){this.saveMapfile();}},{id:'maximize',scope:this,qtip:OpenLayers.i18n('Show a bigger map'),handler:function(event,toolEl,panel){toolEl.hide();panel.tools['minimize'].show();this.setMapViewSize(700,500);}},{id:'minimize',scope:this,hidden:true,qtip:OpenLayers.i18n('Show a smaller map'),handler:function(event,toolEl,panel){toolEl.hide();panel.tools['maximize'].show();this.setMapViewSize(400,300);}}],bbar:[new Ext.form.Checkbox({id:this.getId()+'display_selected_only',checked:false,boxLabel:'<span style="color:#EEEEF0;">'+OpenLayers.i18n('Display selected layer')+'<span>',listeners:{check:this.refreshMap,scope:this}})]};},createMap:function(){if(!this.map){this.map=new OpenLayers.Map();this.map.addControl(new OpenLayers.Control.Scale());}
if(!Ext.getCmp(this.getId()+'map_viewer_panel')){var vC=Ext.getCmp(this.getId()+'_viewerContainer');vC.add({xtype:"gx_mappanel",id:this.getId()+'map_viewer_panel',map:this.map});vC.ownerCt.doLayout();}else{Ext.getCmp(this.getId()+'map_viewer_panel').map=this.map;}
this.updateMapLayers();Ext.getCmp(this.getId()+'_viewerContainer').enable();},buildMapfileTree:function(){var LayerNodeUI=Ext.extend(Ext.tree.ActionsNodeUI,{actions:[{action:'layertemplate',qtip:OpenLayers.i18n('Save as layer template')},{action:'classify',qtip:OpenLayers.i18n('classify using wizard'),hide:function(){return this.attributes.properties.type=='raster';}},{action:'addStyle',qtip:OpenLayers.i18n('add a style to all classes'),hide:function(){return this.attributes.properties.type=='raster';}},{action:'move-up',qtip:OpenLayers.i18n('move up this layer'),hide:function(){return this.isFirst();}},{action:'move-down',qtip:OpenLayers.i18n('move down this layer'),hide:function(){var parent=this.parentNode;return parent.indexOf(this)==parent.indexOf(parent.findChild('role','new-layer'))-1;}},{action:'delete',qtip:OpenLayers.i18n('delete layer')}]});var ClassNodeUI=Ext.extend(Ext.tree.ActionsNodeUI,{actions:[{action:'move-up',qtip:OpenLayers.i18n('move up class'),hide:function(){return this.isFirst();}},{action:'move-down',qtip:OpenLayers.i18n('move down class'),hide:function(){var parent=this.parentNode;return parent.indexOf(this)==parent.indexOf(parent.findChild('role','new-class'))-1;}},{action:'delete',qtip:OpenLayers.i18n('delete class')}]});var newLayerNode={text:OpenLayers.i18n('create new layer ...'),cls:"add-txt",iconCls:"add",leaf:true,getLayerName:function(){return null;},role:'new-layer'};var mapfileProp={};for(var property in this.record){if(property!='layers'){mapfileProp[property]=this.record[property];}}
this.tree=new Ext.tree.TreePanel({id:'mapfile-tree',region:'center',rootVisible:false,autoScroll:true,singleExpand:true,root:new Ext.tree.AsyncTreeNode({text:'invisible root node',role:'mapfile-root',children:[{text:OpenLayers.i18n('global properties'),leaf:true,getLayerName:function(){return null;},role:'record',properties:mapfileProp},{text:OpenLayers.i18n('layers'),getLayerName:function(){return null;},role:"layers-root",expanded:true,children:[newLayerNode]}]}),loader:new Ext.tree.TreeLoader({preloadChildren:true,uiProviders:{'layer':LayerNodeUI,'class':ClassNodeUI}})});this.tree.getSelectionModel().on('beforeselect',this.mapfileTreeOnBeforeSelect,this);this.tree.getSelectionModel().on('selectionchange',this.mapfileTreeOnSelect,this);this.tree.on('action',this.treeOnAction,this);this.tree.on('movenode',this.onPropertyChange,this);this.tree.on('remove',this.onPropertyChange,this);},populateMapfileTree:function(mapfile){var lenI=mapfile.layers.length;for(var i=0;i<lenI;i++){var l=mapfile.layers[i];this.addLayer(l);}},addLayer:function(properties){var layerProp={};for(var property in properties){if(property!='classes'){layerProp[property]=properties[property];}}
var globalPropertiesNode=this.tree.root.findChild('role','record');if((!globalPropertiesNode.attributes.properties.projection)&&layerProp.projection){globalPropertiesNode.attributes.properties.projection=layerProp.projection;}
var layersRootNode=this.tree.root.findChild('role','layers-root');var node=layersRootNode.findChild('role','new-layer');var isRaster=properties.type=='raster';var layerNode=layersRootNode.insertBefore({text:properties.name,leaf:isRaster,getLayerName:function(){return this.attributes.properties.name;},role:'layer',properties:layerProp,uiProvider:'layer'},node);if(!isRaster){var classes=properties.classes||[];this.addClasses(layerNode,classes,false);layerNode.loaded=true;}
if(!layerNode.isFirst()){layerNode.previousSibling.ui.updateActions(layerNode.previousSibling);}
return layerNode;},addClass:function(layerNode,properties){var node=layerNode.findChild('role','new-class');var newNode=layerNode.insertBefore({text:properties.name,leaf:true,getLayerName:function(){return this.parentNode.attributes.properties.name;},role:'class',properties:properties,uiProvider:'class'},node);if(!newNode.isFirst()){newNode.previousSibling.ui.updateActions(newNode.previousSibling);}
return newNode;},addClasses:function(layerNode,classes,append){if(append==null){append=true;}
if(!append){while(layerNode.item(0)){layerNode.item(0).remove();}
layerNode.appendChild({text:OpenLayers.i18n('create new class ...'),cls:"add-txt",iconCls:"add",leaf:true,getLayerName:function(){return this.parentNode.attributes.properties.name;},role:'new-class'});}
Ext.each(classes,function(clazz,index){clazz.name=clazz.name||"class "+index;this.addClass(layerNode,clazz);},this);},mapfileTreeOnSelect:function(sm,node){this.propertiesPanel.removeAll();if(!node)return;this.refreshMap(false);var properties=node.attributes;this.currentPanelProperties=null;switch(properties.roles){case'record':case'layers-root':case'layer':case'class':this.refreshMap();break;}
switch(properties.role){case'record':this.currentPanelProperties=new Studio.MapfileMgr.MapPropertiesPanel({mapfileInterface:this.currentRecordInterface,properties:properties.properties});this.propertiesPanel.add(this.currentPanelProperties);this.propertiesPanel.doLayout();this.currentPanelProperties.loadData();break;case'layers-root':break;case'layer':this.currentPanelProperties=new Studio.MapfileMgr.LayerPropertiesPanel({mapfileInterface:this.currentRecordInterface,properties:properties.properties,map:this.map});this.propertiesPanel.add(this.currentPanelProperties);this.propertiesPanel.doLayout();this.currentPanelProperties.loadData();break;case'new-layer':var win=new Studio.MapfileMgr.AddLayerWindow({layers:this.record.layers});win.on('layercreated',function(obj){this.addLayer(obj);this.saveMapfile();},this);win.show();this.tree.getSelectionModel().clearSelections();break;case'class':this.currentPanelProperties=new Studio.MapfileMgr.ClassPropertiesPanel({mapfileInterface:this.currentRecordInterface,layer:node.parentNode.attributes.properties,properties:properties.properties,map:this.map});this.propertiesPanel.add(this.currentPanelProperties);this.propertiesPanel.doLayout();this.currentPanelProperties.loadData();break;case'new-class':var newNode=this.addClass(node.parentNode,{name:OpenLayers.i18n('New class')});newNode.select();break;default:alert('error: unsupported node type: '+properties.role);break;}
if(this.currentPanelProperties){this.currentPanelProperties.on({'change':function(field,newValue,oldValue){this.onPropertyChange();},namechange:function(field,value){sm=this.tree.getSelectionModel();node=sm.getSelectedNode();node.setText(value);},scope:this});}},mapfileTreeOnBeforeSelect:function(sm,newSelNode,oldSelNode){this.pushPropertiesToTree();},pushPropertiesToTree:function(){var sm=this.tree.getSelectionModel();var node=sm.getSelectedNode();if((this.currentPanelProperties!=null)&&(node!=null)){node.attributes.properties=this.currentPanelProperties.getData();}},treeOnAction:function(node,action,e){var properties=node.attributes;var parentNode=node.parentNode;switch(properties.role){case'layer':switch(action){case'delete':Ext.MessageBox.confirm(OpenLayers.i18n('Delete confirmation'),OpenLayers.i18n('Are you sure that you want to delete this layer ?'),function(btn){if(btn=='yes'){var updateNode=null;if(parentNode.indexOf(node)===(parentNode.indexOf(parentNode.findChild('role','new-layer'))-1)){updateNode=node.previousSibling;}
else if(node.isFirst()){updateNode=node.nextSibling;}
node.remove();if(updateNode!==null){updateNode.ui.updateActions(updateNode);}}
else{return false;}});break;case'move-up':if(!node.isFirst()){parentNode.insertBefore(node,node.previousSibling);node.ui.updateActions(node);node.nextSibling.ui.updateActions(node.nextSibling);}
break;case'move-down':if(parentNode.indexOf(node)<parentNode.indexOf(parentNode.findChild('role','new-layer'))-1){parentNode.insertBefore(node,node.nextSibling.nextSibling);node.ui.updateActions(node);node.previousSibling.ui.updateActions(node.previousSibling);}
break;case'classify':var win=new Studio.MapfileMgr.ClassificationWizard({layer:node});win.show();win.on('classificationready',function(win,layer,classes){this.addClasses(layer,classes,false);this.onPropertyChange();win.close();},this);break;case'addStyle':var win=new Studio.MapfileMgr.StyleWizard({layer:node,mapfileInterface:this.currentRecordInterface});win.show();win.on('styleready',function(win,layer){this.onPropertyChange();win.close();},this);break;case'layertemplate':var layer_properties=this.parseMapfileTree(node);var win=new Studio.MapfileMgr.SaveLayertemplateWindow({layer:layer_properties});win.show();break;}
break;case'class':switch(action){case'delete':var updateNode=null;if(parentNode.indexOf(node)===(parentNode.indexOf(parentNode.findChild('role','new-class'))-1)){updateNode=node.previousSibling;}
else if(node.isFirst()){updateNode=node.nextSibling;}
node.remove();if(updateNode!==null){updateNode.ui.updateActions(updateNode);}
break;case'move-up':if(!node.isFirst()){parentNode.insertBefore(node,node.previousSibling);node.ui.updateActions(node);node.nextSibling.ui.updateActions(node.nextSibling);}
break;case'move-down':var parent=node.parentNode;if(parent.indexOf(node)<parent.indexOf(parent.findChild('role','new-class'))-1){parentNode.insertBefore(node,node.nextSibling.nextSibling);node.ui.updateActions(node);node.previousSibling.ui.updateActions(node.previousSibling);}
break;}
break;}},getPropertiesPanel:function(){this.propertiesPanel=new Ext.Panel({region:'center',layout:'fit',defaults:{border:false,bodyStyle:"padding: 5px"}});return this.propertiesPanel;},parseMapfileTree:function(rootNode){var parseNode=function(node){var process_next_sibling=true;var properties=node.attributes.properties;var next;switch(node.attributes.role){case'mapfile-root':next=node.firstChild;if(next!=null){parseNode.call(this,next);}
break;case'record':for(property in properties){this[property]=properties[property];}
break;case'layers-root':next=node.firstChild;if(next!=null){this.layers=new Array();parseNode.call(this.layers,next);}
break;case'layer':next=node.firstChild;if(Ext.isArray(this)){var l=this.push(properties)-1;if(next!=null){this[l].classes=new Array();parseNode.call(this[l].classes,next);}}
else{for(var property in properties){this[property]=properties[property];}
if(next!=null){this.classes=new Array();parseNode.call(this.classes,next);}
process_next_sibling=false;}
break;case'class':if(Ext.isArray(this)){this.push(properties);}
else{for(property in properties){this[property]=properties[property];}
process_next_sibling=false;}
break;}
if(process_next_sibling){next=node.nextSibling;if(next!=null){parseNode.call(this,next);}}};var result={};if(!rootNode){rootNode=this.tree.getRootNode();}
parseNode.call(result,rootNode);return result;},onPropertyChange:function(){Ext.getCmp(this.getId()+'_save_button').enable();this.dirty=true;},saveMapfile:function(){this.pushPropertiesToTree();var button=Ext.getCmp(this.getId()+'_save_button');button.disable();button.setText(OpenLayers.i18n('Saving ...'));var content=this.parseMapfileTree();this.currentRecordInterface.createOrUpdate({success:function(){button.setText(OpenLayers.i18n('Save mapfile'));this.refreshMap(true);this.dirty=false;Studio.mapfileStore.store.reload();},failure:function(){button.enable();button.setText(OpenLayers.i18n('Save mapfile'));var txt=["An error occured while saving,","please report the problem."].join(" ");Ext.MessageBox.alert("Error",txt);},scope:this},content);},getLayersList:function(){var layers=[];this.tree.getRootNode().cascade(function(node){if(node.attributes.role=='layer'){layers.push(node.attributes.getLayerName.call(node));}});return layers.join(',');},refreshMap:function(forceReload){this.updateMapLayers();if(!this.mapfileLayer)return;var node=this.tree.getSelectionModel().getSelectedNode();var layerName=node?node.attributes.getLayerName.call(node):null;if(layerName!=null&&Ext.getCmp(this.getId()+'display_selected_only').checked){this.mapfileLayer.params.LAYERS=layerName;}else{this.mapfileLayer.params.LAYERS=this.getLayersList();}
this.mapfileLayer.redraw(forceReload);},setMapViewSize:function(width,height){Ext.getCmp(this.getId()+'_viewerContainer').ownerCt.ownerCt.setWidth(width);Ext.getCmp(this.getId()+'_viewerContainer').setHeight(height);this.doLayout();}});Ext.reg('studio.mm.panel',Studio.MapfileMgr.Panel);var prevExtFormComboBoxSetValue=Ext.form.ComboBox.prototype.setValue;Ext.form.ComboBox.prototype.setValue=function(v){if(this.store.getCount()==0){this.store.on('load',function(){if(this.store){prevExtFormComboBoxSetValue.call(this,v);this.fireEvent('selectpvi',this,v);}},this,{single:true});}else{prevExtFormComboBoxSetValue.call(this,v);this.fireEvent('selectpvi',this,v);}};var prevExtFormComboBoxInitComponent=Ext.form.ComboBox.prototype.initComponent;Ext.form.ComboBox.prototype.initComponent=function(){prevExtFormComboBoxInitComponent.apply(this,arguments);this.addEvents('selectpvi');};Ext.namespace('Studio','MapfileMgr');Studio.MapfileMgr.MapPropertiesPanel=Ext.extend(Studio.MapfileMgr.MapfileForm,{title:OpenLayers.i18n('MAP object properties'),autoScroll:true,initComponent:function(){this.items=[{xtype:'textfield',fieldLabel:OpenLayers.i18n('Name'),name:'name'},{xtype:'textfield',fieldLabel:OpenLayers.i18n('Projection'),name:'projection'},{xtype:'numberfield',fieldLabel:OpenLayers.i18n('Maxsize'),name:'maxsize',minValue:1},{xtype:'studio.unitcombo',fieldLabel:OpenLayers.i18n('Units'),name:'units'},{xtype:'numberfield',fieldLabel:OpenLayers.i18n('Resolution'),name:'resolution'},{xtype:'numberfield',fieldLabel:OpenLayers.i18n('Height'),name:'height',minValue:1},{xtype:'numberfield',fieldLabel:OpenLayers.i18n('Width'),name:'width',minValue:1},{xtype:'studio.mm.colorpickerfield',fieldLabel:OpenLayers.i18n('Image color'),name:'imagecolor'},{xtype:'fieldset',title:OpenLayers.i18n('extent'),autoHeight:true,items:{xtype:'studio.mm.bbox',jsonName:'extent'}}];Studio.MapfileMgr.MapPropertiesPanel.superclass.initComponent.apply(this,arguments);}});Ext.reg('studio.mm.mappropertiespanel',Studio.MapfileMgr.MapPropertiesPanel);Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.LayerPropertiesPanel=Ext.extend(Studio.MapfileMgr.MapfileForm,{title:OpenLayers.i18n('LAYER object properties'),autoScroll:true,map:null,initComponent:function(){this.items=[{xtype:'textfield',id:this.getId()+'_name',fieldLabel:OpenLayers.i18n('Name'),allowBlank:false,name:'name',listeners:{valid:function(field){var f=getFormPanel(this);if(f){f.fireEvent('namechange',this,this.getValue());}}}},{xtype:'studio.mm.numberspinner',fieldLabel:OpenLayers.i18n('Opacity'),name:'opacity',width:40,minValue:0,maxValue:100,defaultValue:100,incrementValue:10}];if(this.properties.type!="raster"){this.items.push({xtype:'studio.mm.columncombo',layer:this.properties,fieldLabel:OpenLayers.i18n('Label item'),width:100,name:'labelitem'});}
this.items.push({xtype:'fieldset',title:OpenLayers.i18n('Limit by scale'),collapsed:true,checkboxToggle:true,height:120,items:[{xtype:'studio.mm.limitbyscale',map:this.map}],listeners:{scope:this,expand:function(p){this.fireEvent('change');},collapse:function(p){this.fireEvent('change');}}});if(this.properties.type!="raster"){this.items.push({xtype:'fieldset',title:OpenLayers.i18n('WFS attributes'),collapsed:true,checkboxToggle:true,autoHeight:true,defaults:{border:false},items:[{xtype:'studio.mm.wfsattributes',layer:this.properties,width:500,autoHeight:true},{html:"<p class='info'>"+OpenLayers.i18n('Check the attributes you would want to see in a GetFeature WFS request response.')+"</p>"}],listeners:{scope:this,expand:function(p){this.fireEvent('change');},collapse:function(p){this.fireEvent('change');}}});}
Studio.MapfileMgr.LayerPropertiesPanel.superclass.initComponent.apply(this,arguments);}});Ext.reg('studio.mm.layerpropertiespanel',Studio.MapfileMgr.LayerPropertiesPanel);Studio.MapfileMgr.WfsAttributesPanel=function(config){var metadata=config.layer.metadata;if(metadata&&metadata.datasourceid&&metadata.datastoreid){var columnsStore=Studio.getDatasourceColumnStore(metadata.datastoreid,metadata.datasourceid).getStore();}
var itemsToInclude=metadata.gml_include_items||"";this.store=new Ext.data.SimpleStore({fields:['name','alias','selected']});var checkColumn=new Ext.grid.CheckColumn({dataIndex:'selected',width:40});this.cm=new Ext.grid.ColumnModel([checkColumn,{id:'name',width:180,header:OpenLayers.i18n('Data attribute'),dataIndex:'name'},{header:OpenLayers.i18n('Alias (click to edit)'),width:180,dataIndex:'alias',editor:new Ext.form.TextField({allowBlank:false})}]);this.plugins=checkColumn;Studio.MapfileMgr.WfsAttributesPanel.superclass.constructor.call(this,config);var attributes=[];var loadData=function(columns){columns.each(function(record){var name=record.get('name');var alias=metadata['gml_'+name+'_alias']||name;var selected=itemsToInclude.indexOf(record.get('name'))!=-1;var attribute=[name,alias,selected];attributes.push(attribute);},this);this.store.loadData(attributes);};if(columnsStore.getCount()>0){loadData.call(this,columnsStore);}else{columnsStore.on('load',loadData,this);}
this.store.on('update',function(){var f=getFormPanel(this);if(f){f.fireEvent('change',this,null);}},this);};Ext.extend(Studio.MapfileMgr.WfsAttributesPanel,Ext.grid.EditorGridPanel,{autoScroll:true,clicksToEdit:1,enableHdMenu:false,visitStyler:function(visitor){var subVisitor=visitor.beginPanel(this);if(subVisitor){subVisitor.value(this);if(subVisitor.destroy)subVisitor.destroy();}
visitor.endPanel(this);},getSelectedValues:function(){var v={};var itemsToInclude=[];this.store.each(function(record){var alias,name;alias=record.get('alias');name=record.get('name');if(record.get('selected')===true){itemsToInclude.push(name);}
v['gml_'+name+'_alias']=alias;});v.gml_include_items=itemsToInclude.join(',');return v;}});Ext.reg('studio.mm.wfsattributes',Studio.MapfileMgr.WfsAttributesPanel);Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.BboxPanel=Ext.extend(Studio.MapfileMgr.MapfilePanel,{jsonName:null,width:'100%',border:false,layout:'table',cls:'studioBboxTable',initComponent:function(){var config={layoutConfig:{columns:3},defaults:{border:false,bodyStyle:'padding: 0 5px 0 5px',width:'100%'}};Ext.applyIf(this,config);var id=this.getId();this.items=[{},{xtype:'numberfield',id:id+'_maxy',validator:function(v){if(parseFloat(v)<=parseFloat(Ext.getCmp(id+'_miny').getValue())){return OpenLayers.i18n('MaxValueBiggerThanMin');}
return true;},allowBlank:false,value:90,name:'maxy',listeners:{change:this.onChange,scope:this}},{},{xtype:'numberfield',id:id+'_minx',allowBlank:false,value:-180,validator:function(v){if(parseFloat(v)>=parseFloat(Ext.getCmp(id+'_maxx').getValue())){return OpenLayers.i18n('MaxValueBiggerThanMin');}
return true;},name:'minx',listeners:{change:this.onChange,scope:this}},{},{xtype:'numberfield',id:id+'_maxx',allowBlank:false,validator:function(v){if(parseFloat(v)<=parseFloat(Ext.getCmp(id+'_minx').getValue())){return OpenLayers.i18n('MaxValueBiggerThanMin');}
return true;},value:180,name:'maxx',listeners:{change:this.onChange,scope:this}},{},{xtype:'numberfield',id:this.getId()+'_miny',allowBlank:false,name:'miny',value:-90,validator:function(v){if(parseFloat(v)>=parseFloat(Ext.getCmp(id+'_maxy').getValue())){return OpenLayers.i18n('MaxValueBiggerThanMin');}
return true;},listeners:{change:this.onChange,scope:this}}];Studio.MapfileMgr.BboxPanel.superclass.initComponent.apply(this,arguments);},onChange:function(){this.fireEvent('change',this);}});Ext.reg('studio.mm.bbox',Studio.MapfileMgr.BboxPanel);Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.AddLayerWindow=Ext.extend(Ext.Window,{title:OpenLayers.i18n('Add a LAYER'),layout:'form',modal:true,width:625,layers:null,initComponent:function(){var datastore_store=Studio.datastoreStore.getStore();var layertemplate_store=Studio.layertemplateStore.getStore();layertemplate_store.load();var ltTpl=new Ext.XTemplate('<tpl for="."><div class="x-combo-list-item x-combo-list-lt-item">','<h3>{name}</h3>','{comment}','</div></tpl>');var form=new Ext.form.FormPanel({bodyStyle:'padding:5px',border:false,items:[{xtype:'fieldset',id:this.getId()+"_fieldsetDS",checkboxToggle:true,collapsed:false,title:OpenLayers.i18n('From a datasource'),autoHeight:true,labelWidth:150,defaults:{width:400},listeners:{expand:function(fieldset){Ext.getCmp(this.getId()+"_fieldsettpl").collapse();},scope:this},items:[{xtype:'studio.datastorecombo',id:this.id+'_datastore_combo',name:'datastore',fieldLabel:OpenLayers.i18n('Data store'),emptyText:OpenLayers.i18n('Choose one store'),store:datastore_store,displayField:'text',valueField:'id',typeAhead:true,editable:false,mode:'local',forceSelection:true,triggerAction:'all',selectOnFocus:true,iconClsField:'icon',listeners:{select:function(combo,record,index){var datasource_combo=Ext.getCmp(this.id+'_datasource_combo');datasource_combo.store=Studio.getDatasourceStore(combo.getValue()).getStore();datasource_combo.setDisabled(false);datasource_combo.reset();var layertemplate_combo=Ext.getCmp(this.id+'_layertemplate_combo');layertemplate_combo.reset();var ok_button=Ext.getCmp(this.id+'_ok_button');ok_button.setDisabled(true);},scope:this}},{xtype:'combo',id:this.id+'_datasource_combo',name:'datasource',fieldLabel:OpenLayers.i18n('Data source'),emptyText:OpenLayers.i18n('Choose one source'),disabled:true,store:null,displayField:'text',valueField:'id',typeAhead:true,editable:false,mode:'local',forceSelection:true,triggerAction:'all',selectOnFocus:true,listeners:{select:function(combo,record,index){var ok_button=Ext.getCmp(this.id+'_ok_button');ok_button.setDisabled(false);},scope:this}}]},{xtype:'fieldset',id:this.getId()+"_fieldsettpl",checkboxToggle:true,collapsed:true,title:OpenLayers.i18n('Using an existing template'),autoHeight:true,labelWidth:150,defaults:{width:400},listeners:{expand:function(fieldset){Ext.getCmp(this.getId()+"_fieldsetDS").collapse();},scope:this},items:[{xtype:'combo',id:this.id+'_layertemplate_combo',name:'layertemplate',tpl:ltTpl,fieldLabel:OpenLayers.i18n('Layer template'),emptyText:OpenLayers.i18n('Choose one template'),disabled:false,store:layertemplate_store,displayField:'name',valueField:'id',typeAhead:true,editable:false,mode:'local',forceSelection:true,triggerAction:'all',selectOnFocus:true,listeners:{select:function(combo,record,index){var datastore_combo=Ext.getCmp(this.id+'_datastore_combo');datastore_combo.reset();var datasource_combo=Ext.getCmp(this.id+'_datasource_combo');if(datasource_combo.store!=null){datasource_combo.reset();datasource_combo.setDisabled(true);}
var ok_button=Ext.getCmp(this.id+'_ok_button');ok_button.setDisabled(false);},scope:this}}]}],buttons:[{id:this.id+'_ok_button',text:'OK',disabled:true,handler:function(){var values=getFormValues(form);var record;if((values.datastore!=null)&&(values.datasource!=null)){var datasource_store=Ext.getCmp(this.id+'_datasource_combo').store;record=datasource_store.getAt(datasource_store.find('id',values.datasource));var ds_interface=record.getInterface();ds_interface.get_mapfile({success:function(obj){obj.name=getUniqueLayerName(this.layers,obj.name);this.layers.push(obj);this.fireEvent('layercreated',obj);this.close();},failure:function(){Ext.MessageBox.alert("Error","An error occured while creating the layer. "+"Please report the problem.");},scope:this});}
else if(values.layertemplate!=null){record=layertemplate_store.getAt(layertemplate_store.find('id',values.layertemplate));var lt_interface=record.getInterface();lt_interface.read({success:function(obj){this.fireEvent('layercreated',obj.json);this.close();},failure:function(){Ext.MessageBox.alert("Error","An error occured while creating the layer from layer template. "+"Please report the problem.");},scope:this});}},scope:this},{text:OpenLayers.i18n('Cancel'),handler:function(){this.close();},scope:this}]});this.items=[form];var getUniqueLayerName=function(layers,currentLayername){for(var i=0;i<layers.length;i++){if(layers[i].name==currentLayername){currentLayername=currentLayername+randomString();}}
return currentLayername;};Studio.MapfileMgr.AddLayerWindow.superclass.initComponent.apply(this,arguments);}});Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.SaveLayertemplateWindow=Ext.extend(Ext.Window,{layer:null,title:OpenLayers.i18n('Save as layertemplate'),layout:'form',modal:true,width:340,initComponent:function(){var form=new Ext.form.FormPanel({monitorValid:true,bodyStyle:'padding:5px',border:false,items:[{xtype:'textfield',id:this.getId()+'_name_field',width:200,fieldLabel:OpenLayers.i18n('Name'),name:'name',allowBlank:false},{xtype:'textarea',id:this.getId()+'_comment_field',width:200,fieldLabel:OpenLayers.i18n('Comment'),name:'comment',allowBlank:false}],buttons:[{id:this.getId()+'_ok_button',text:'OK',formBind:true,handler:function(){var values=getFormValues(form);var lt_store=Studio.layertemplateStore.getStore();var lt=new lt_store.recordType({name:values.name,comment:values.comment,id:null,url:null});lt_store.add(lt);var ltInterface=lt.getInterface();var obj={name:values.name,comment:values.comment,json:this.layer};ltInterface.create({success:function(){this.close();},failure:function(){Ext.MessageBox.alert("Error","An error occured while saving this layer as a template. "+"Please report the problem.");},scope:this},obj);},scope:this},{id:this.getId()+'_cancel_button',text:OpenLayers.i18n('Cancel'),handler:function(){this.close();},scope:this}]});this.items=[form];Studio.MapfileMgr.SaveLayertemplateWindow.superclass.initComponent.apply(this,arguments);}});Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.ClassificationWizard=Ext.extend(Ext.Window,{layer:null,classification:null,methodsStore:new Ext.data.SimpleStore({fields:['text','value'],data:[[OpenLayers.i18n('Unique values'),'unique'],[OpenLayers.i18n('Quantiles'),'quantile']],autoLoad:true}),themesStore:new Ext.data.SimpleStore({fields:['value','colors']}),interpolationsStore:new Ext.data.SimpleStore({fields:['value'],data:[['RGB'],['HSV']],autoLoad:true}),classTemplate:new Ext.XTemplate('<div>','<div style="float:left;margin-right:3px;width:20px;height:15px;','background-color:rgb(','<tpl for="styles">','{color}','</tpl>',');"','</div>','<div class="x-form-item">','{name}','</div>','</div>'),loadingMask:null,title:OpenLayers.i18n('Classification Wizard'),layout:'fit',modal:true,border:false,width:600,height:400,initComponent:function(){this.addEvents({classificationready:true});this.bbar=['->',{id:this.getId()+'_apply_button',text:OpenLayers.i18n('Apply'),disabled:true,handler:function(){this.fireEvent('classificationready',this,this.layer,this.classification.classes);},scope:this},{text:OpenLayers.i18n('Cancel'),handler:function(){this.close();},scope:this}];var palettesRaw=[[[141,211,199],[255,255,179],[190,186,218],[251,128,114],[128,177,211],[253,180,98],[179,222,105],[252,205,229],[217,217,217],[188,128,189],[204,235,197],[255,237,111]],[[166,206,227],[31,120,180],[178,223,138],[51,160,44],[251,154,153],[227,26,28],[253,191,111],[255,127,0],[202,178,214],[106,61,154],[255,255,153]],[[251,180,174],[179,205,227],[204,235,197],[222,203,228],[254,217,166],[255,255,204],[229,216,189],[253,218,236],[242,242,242]],[[228,26,28],[55,126,184],[77,175,74],[152,78,163],[255,127,0],[255,255,51],[166,86,40],[247,129,191],[153,153,153]],[[179,226,205],[253,205,172],[203,213,232],[244,202,228],[230,245,201],[255,242,174],[241,226,204],[204,204,204]],[[102,194,165],[252,194,165],[141,160,203],[231,138,195],[166,216,84],[255,217,47],[229,196,148],[179,179,179]],[[27,158,119],[217,95,2],[117,112,179],[231,41,138],[102,166,30],[230,171,2],[166,118,29],[102,102,102]],[[127,201,127],[190,174,212],[253,192,134],[255,255,153],[56,108,176],[240,2,127],[191,91,23],[102,102,102]]];var palettes=[];Ext.each(palettesRaw,function(palette,index){palettes[index]=[];palettes[index].push(index);var colors=[];Ext.each(palette,function(color){colors.push('rgb('+color.join(',')+')');});palettes[index].push(colors);});this.themesStore.loadData(palettes);this.items=new Ext.form.FormPanel({id:this.getId()+'_formpanel',border:false,labelAlign:'top',layout:'border',defaults:{bodyStyle:"padding:5px;",border:false},items:[{region:'north',height:50,layout:'column',defaults:{layout:'form',columnWidth:0.5,border:false},items:[{items:[{xtype:'studio.mm.columncombo',id:this.getId()+'_column',fieldLabel:OpenLayers.i18n('Choose attribute'),layer:this.layer.attributes.properties,name:'attribute',listeners:{selectpvi:this.attributeChosen,scope:this}}]},{items:[{xtype:'combo',id:this.getId()+'_method',fieldLabel:OpenLayers.i18n('Choose method'),store:this.methodsStore,displayField:'text',valueField:'value',hidden:true,hiddenName:'classification',typeAhead:true,editable:false,mode:'local',forceSelection:true,triggerAction:'all',emptyText:OpenLayers.i18n('Select a method...'),selectOnFocus:true,listeners:{selectpvi:this.methodChosen,scope:this}}]}]},{region:'west',width:250,layout:'form',items:[{xtype:'hidden',id:this.getId()+'_colortype',name:'colortype'},{xtype:'studio.mm.numberspinner',id:this.getId()+'_numclasses',fieldLabel:OpenLayers.i18n('Number of classes'),hidden:true,name:'intervals',hideMode:"display",allowNegative:false,allowDecimals:false,width:40,value:5,minValue:2,maxValue:20},{xtype:'studio.mm.colorpickerfield',id:this.getId()+'_startcolor',fieldLabel:OpenLayers.i18n('First color'),hidden:true,name:'startcolor',value:'#FFFFFF'},{xtype:'studio.mm.colorpickerfield',id:this.getId()+'_endcolor',fieldLabel:OpenLayers.i18n('Last color'),hidden:true,name:'endcolor',value:'#497BD1'},{xtype:'combo',id:this.getId()+'_interpolation',fieldLabel:OpenLayers.i18n('Choose interpolation'),store:this.interpolationsStore,displayField:'value',valueField:'value',hidden:true,name:'interpolation',typeAhead:true,editable:false,mode:'local',forceSelection:true,triggerAction:'all',selectOnFocus:true,width:100,value:'RGB'},{xtype:'palettecombo',id:this.getId()+'_theme',fieldLabel:OpenLayers.i18n('Choose a predefined palette'),store:this.themesStore,valueField:'value',hidden:true,hiddenName:'theme',typeAhead:true,editable:false,mode:'local',forceSelection:true,triggerAction:'all',value:0,selectOnFocus:true,listeners:{selectpvi:this.themeChosen,scope:this}}],buttons:[{id:this.getId()+'_classify_button',text:OpenLayers.i18n('Classify'),disabled:true,handler:this.classify,scope:this}]},{id:this.getId()+'_classes',region:'center',autoScroll:true}]});Studio.MapfileMgr.ClassificationWizard.superclass.initComponent.apply(this,arguments);},attributeChosen:function(combo,v){this.methodsStore.clearFilter();var value=combo.getValue();var type=Studio.getColumnType(this.layer.attributes.properties,value);Ext.getCmp(this.getId()+'_method').show();Ext.getCmp(this.getId()+'_method').doQuery(null);switch(type){case'numeric':break;case'string':this.methodsStore.filter('value','unique');Ext.getCmp(this.getId()+'_method').setValue('unique');break;default:break;}},methodChosen:function(combo,v){var value=combo.getValue();Ext.getCmp(this.getId()+'_colortype').show();switch(value){case'quantile':Ext.getCmp(this.getId()+'_theme').hide();Ext.getCmp(this.getId()+'_theme').disable();Ext.getCmp(this.getId()+'_numclasses').show();Ext.getCmp(this.getId()+'_numclasses').enable();Ext.getCmp(this.getId()+'_interpolation').show();Ext.getCmp(this.getId()+'_interpolation').enable();Ext.getCmp(this.getId()+'_startcolor').show();Ext.getCmp(this.getId()+'_startcolor').enable();Ext.getCmp(this.getId()+'_endcolor').show();Ext.getCmp(this.getId()+'_endcolor').enable();Ext.getCmp(this.getId()+'_colortype').setValue('ramp');break;case'unique':Ext.getCmp(this.getId()+'_numclasses').hide();Ext.getCmp(this.getId()+'_numclasses').disable();Ext.getCmp(this.getId()+'_startcolor').hide();Ext.getCmp(this.getId()+'_startcolor').disable();Ext.getCmp(this.getId()+'_endcolor').hide();Ext.getCmp(this.getId()+'_endcolor').disable();Ext.getCmp(this.getId()+'_interpolation').hide();Ext.getCmp(this.getId()+'_interpolation').disable();Ext.getCmp(this.getId()+'_theme').show();Ext.getCmp(this.getId()+'_theme').enable();Ext.getCmp(this.getId()+'_colortype').setValue('qualitative');break;}
Ext.getCmp(this.getId()+'_classify_button').enable();},themeChosen:function(combo,v){},classify:function(){if(!this.loadingMask){this.loadingMask=new Ext.LoadMask(Ext.getCmp(this.getId()+'_classes').body,{msg:'Loading'});}
this.loadingMask.show();var form=Ext.getCmp(this.getId()+'_formpanel').getForm();var url=subString(Studio.datastoreStore.datasourceMapfileUrlScheme,{"DATASTORE_ID":this.layer.attributes.properties.metadata.datastoreid,"DATASOURCE_ID":this.layer.attributes.properties.metadata.datasourceid});Ext.Ajax.request({url:url,method:"GET",timeout:300000,params:form.getValues(),success:function(response){var el=Ext.getCmp(this.getId()+'_classes').body;Ext.getDom(el).innerHTML='';this.classification=Ext.util.JSON.decode(response.responseText);Ext.each(this.classification.classes,function(clazz){this.classTemplate.append(el,clazz);},this);this.loadingMask.hide();Ext.getCmp(this.getId()+'_apply_button').enable();},failure:function(response){this.loadingMask.hide();Ext.MessageBox.alert(OpenLayers.i18n('Error'),OpenLayers.i18n("Classification didn't succed, probably due to a timeout. Status text: ")+response.statusText+". "+OpenLayers.i18n('Status code')+": "+response.status);},scope:this});}});Ext.override(Ext.layout.FormLayout,{renderItem:function(c,position,target){if(c&&!c.rendered&&c.isFormField&&c.inputType!='hidden'){var args=[c.id,c.fieldLabel,c.labelStyle||this.labelStyle||'',this.elementStyle||'',typeof c.labelSeparator=='undefined'?this.labelSeparator:c.labelSeparator,(c.itemCls||this.container.itemCls||'')+(c.hideLabel?' x-hide-label':''),c.clearCls||'x-form-clear-left'];if(typeof position=='number'){position=target.dom.childNodes[position]||null;}
if(position){c.formItem=this.fieldTpl.insertBefore(position,args,true);}else{c.formItem=this.fieldTpl.append(target,args,true);}
if(c.hideMode=='display'){c.formItem.setVisibilityMode(Ext.Element.DISPLAY);}
c.on('destroy',c.formItem.remove,c.formItem,{single:true});c.on('hide',c.formItem.hide,c.formItem,{single:false});c.on('show',c.formItem.show,c.formItem,{single:false});c.render('x-form-el-'+c.id);}else{Ext.layout.FormLayout.superclass.renderItem.apply(this,arguments);}}});Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.StyleWizard=Ext.extend(Ext.Window,{layer:null,mapfileInterface:null,properties:null,title:OpenLayers.i18n('Style Wizard'),layout:'fit',modal:true,border:false,width:800,height:600,initComponent:function(){this.addEvents({styleready:true});this.bbar=['->',{id:this.getId()+'_apply_button',text:OpenLayers.i18n('Apply'),disabled:false,handler:function(){this.addStyleToAllClasses(this.layer);this.fireEvent('styleready',this,this.layer);},scope:this},{text:OpenLayers.i18n('Cancel'),handler:function(){this.close();},scope:this}];this.items=new Ext.form.FormPanel({id:this.getId()+'_formpanel',defaults:{bodyStyle:"padding:5px;",border:false,layout:'form'},items:[{id:this.getId()+'_classes',region:'center',items:[{xtype:'combo',fieldLabel:OpenLayers.i18n('Update mode: '),labelWidth:300,width:300,editable:false,typeAhead:false,emptyText:OpenLayers.i18n('Select an update mode'),mode:'local',triggerAction:'all',forceSelection:true,listeners:{select:this.selectMode,scope:this},store:[['Update',OpenLayers.i18n('Update existing classes')],['Add',OpenLayers.i18n('Add new classes')]]},{xtype:'fieldset',id:this.getId()+"_label_panel_fieldset",title:OpenLayers.i18n('Label'),hidden:true,autoHeight:true,items:[{xtype:'studio.mm.labelstyle',mapfileInterface:this.mapfileInterface,id:this.getId()+"_label_panel"}]},{xtype:'fieldset',id:this.getId()+"_stroke_panel_fieldset",title:OpenLayers.i18n('Stroke'),hidden:true,autoHeight:true,items:[{xtype:'studio.mm.strokestyle',mapfileInterface:this.mapfileInterface,id:this.getId()+"_stroke_panel"}]},{xtype:'fieldset',id:this.getId()+"_point_panel_fieldset",title:OpenLayers.i18n('Point'),hidden:true,autoHeight:true,items:[{xtype:'studio.mm.pointstyle',mapfileInterface:this.mapfileInterface,id:this.getId()+"_point_panel"}]},{xtype:'fieldset',id:this.getId()+"_fill_panel_fieldset",title:OpenLayers.i18n('Fill'),hidden:true,autoHeight:true,items:[{xtype:'studio.mm.fillstyle',mapfileInterface:this.mapfileInterface,id:this.getId()+"_fill_panel"}]}]}]});Studio.MapfileMgr.StyleWizard.superclass.initComponent.apply(this,arguments);},selectMode:function(combo,record,index){var strokePanelFieldset=Ext.getCmp(this.getId()+"_stroke_panel_fieldset");var labelPanelFieldset=Ext.getCmp(this.getId()+"_label_panel_fieldset");var pointPanelFieldset=Ext.getCmp(this.getId()+"_point_panel_fieldset");var fillPanelFieldset=Ext.getCmp(this.getId()+"_fill_panel_fieldset");labelPanelFieldset.show();if(this.layer.attributes.properties.type=='line'||this.layer.attributes.properties.type=='polygon'){strokePanelFieldset.show();}
if(this.layer.attributes.properties.type=='polygon'){fillPanelFieldset.show();}
if(this.layer.attributes.properties.type=='point'||this.layer.attributes.properties.type=='annotation'){pointPanelFieldset.show();}
this.doLayout();this.doLayout();},getClasses:function(layerNode){var classList='';var i=0;for(i=0;i<layerNode.childNodes.length;i++){var childnode=layerNode.childNodes[i];if(childnode.attributes.role=='class'){classList=classList+'"'+childnode.attributes.properties.name+'" ';}}
return classList;},getStyleCount:function(layerNode,className){var i=0;for(i=0;i<layerNode.childNodes.length;i++){var childnode=layerNode.childNodes[i];if(childnode.attributes.role=='class'){if(childnode.attributes.properties.name==className){return childnode.attributes.properties.styles.length;}}}},addStyleToAllClasses:function(layerNode){var i=0;var style={color:[122,122,122],size:3};for(i=0;i<layerNode.childNodes.length;i++){var childnode=layerNode.childNodes[i];if(childnode.attributes.role!='class'){}else{childnode.attributes.properties.styles.push(style);}}}});Ext.namespace('Studio','Studio.MapfileMgr');Studio.MapfileMgr.ClassPropertiesPanel=Ext.extend(Studio.MapfileMgr.MapfileForm,{title:OpenLayers.i18n('CLASS object properties'),autoScroll:true,map:null,geometryType:null,layer:null,createAddButton:function(clazz,opts){return OpenLayers.Util.extend({handler:function(){var style=new clazz({mapfileInterface:this.mapfileInterface,geometryType:this.geometryType});var panel=this.addStylePanel(style);this.doLayout();this.doLayout();panel.getEl().scrollIntoView(this.body);style.getEl().fadeIn({duration:1});panel.getEl().highlight();},scope:this},opts);},initComponent:function(){this.geometryType=this.layer.type;var labelWidth=60;var bbarItems=[];if(this.geometryType=='line'||this.geometryType=='polygon'){bbarItems.push(this.createAddButton(Studio.MapfileMgr.StrokeStylePanel,{text:OpenLayers.i18n('Add Stroke'),iconCls:'add',tooltip:OpenLayers.i18n('Add a Stroke style')}));}
if(this.geometryType=='polygon'){bbarItems.push(this.createAddButton(Studio.MapfileMgr.FillStylePanel,{text:OpenLayers.i18n('Add Fill'),iconCls:'add',tooltip:OpenLayers.i18n('Add a Fill style')}));}
if(this.geometryType=='point'||this.geometryType=='annotation'){bbarItems.push(this.createAddButton(Studio.MapfileMgr.PointStylePanel,{text:OpenLayers.i18n('Add Point'),iconCls:'add',tooltip:OpenLayers.i18n('Add a Point style')}));}
this.bbar=new Ext.Toolbar({items:bbarItems});this.items=[{layout:'table',id:this.getId()+"_table",border:false,layoutConfig:{columns:2},cls:"studioMaxTable",defaults:{columnWidth:.5,labelWidth:labelWidth},items:[{layout:'form',colspan:2,border:false,items:[{xtype:'textfield',id:this.getId()+'_name',fieldLabel:OpenLayers.i18n('Name'),name:'name',listeners:{valid:function(field){var f=getFormPanel(this);if(f){f.fireEvent('namechange',this,this.getValue());}}}}]},{xtype:'fieldset',title:OpenLayers.i18n('Limit by scale'),collapsed:true,checkboxToggle:true,height:120,items:[{xtype:'studio.mm.limitbyscale',map:this.map}],listeners:{scope:this,expand:function(p){this.fireEvent('change');},collapse:function(p){this.fireEvent('change');}}},{xtype:'fieldset',title:OpenLayers.i18n('Limit by condition'),collapsed:true,checkboxToggle:true,height:120,items:[{xtype:'studio.mm.limitbycondition',layer:this.layer}],listeners:{scope:this,expand:function(p){this.fireEvent('change');},collapse:function(p){this.fireEvent('change');}}},{xtype:'fieldset',title:OpenLayers.i18n('Labels'),collapsed:true,checkboxToggle:true,autoHeight:true,colspan:2,items:[{border:false,xtype:'studio.mm.labelstyle',mapfileInterface:this.mapfileInterface,geometryType:this.geometryType}],listeners:{scope:this,expand:function(p){this.fireEvent('change');},collapse:function(p){this.fireEvent('change');}}},{layout:'anchor',id:this.getId()+"_styles",border:false,colspan:2,defaults:{anchor:'100%'},items:[]}]}];this.on("resize",function(self){self.doLayout();});Studio.MapfileMgr.ClassPropertiesPanel.superclass.initComponent.apply(this,arguments);},addStylePanel:function(stylePanel){var styles=this.getStyles();var selfId=this.getId();var styleId=stylePanel.getId();var buttons=['<a id="'+styleId+'_moveUp" href="javascript:Studio.MapfileMgr.ClassPropertiesPanel.doStyleAction(\''+selfId+'\', \''+styleId+'\', \'moveUp\')"><img class="col-move-bottom" src="'+Ext.BLANK_IMAGE_URL+'" /></a>','<a id="'+styleId+'_moveDown" href="javascript:Studio.MapfileMgr.ClassPropertiesPanel.doStyleAction(\''+selfId+'\', \''+styleId+'\', \'moveDown\')"><img class="col-move-top" src="'+Ext.BLANK_IMAGE_URL+'" /></a>','<a id="'+styleId+'_delete" href="javascript:Studio.MapfileMgr.ClassPropertiesPanel.doStyleAction(\''+selfId+'\', \''+styleId+'\', \'delete\')"><img src="images/panel-close.gif" /></a>'];var result=styles.add({xtype:'fieldset',id:styleId+'_fieldset',title:'<span class="studioStyleButtons">'+buttons.join('')+'</span>'+stylePanel.kind,autoHeight:true,items:[stylePanel]});stylePanel.on('render',this.updateStyleButtons,this);return result;},updateStyleButtons:function(){var styles=this.getStyles();var lastI=styles.items.getCount()-1;for(var i=0;i<=lastI;++i){var styleId=styles.items.get(i).getId().replace('_fieldset','');var moveUp=Ext.get(styleId+'_moveUp');var moveDown=Ext.get(styleId+'_moveDown');if(moveUp){moveUp.setDisplayed(i!=0);}
if(moveDown){moveDown.setDisplayed(i!=lastI);}}},removeStylePanels:function(){this.getStyles().removeAll();},moveUpStyle:function(styleFieldSet){var styles=this.getStyles();var pos=styles.items.indexOf(styleFieldSet);if(pos<1)return;var previous=styles.items.get(pos-1);styles.items.removeAt(pos);styles.items.insert(pos-1,styleFieldSet);styleFieldSet.getEl().insertBefore(previous.getEl());this.updateStyleButtons();this.doLayout();styleFieldSet.getEl().scrollIntoView(this.body);styleFieldSet.getEl().highlight();this.fireEvent('change');},moveDownStyle:function(styleFieldSet){var styles=this.getStyles();var pos=styles.items.indexOf(styleFieldSet);if(pos+1>=styles.items.getCount())return;var next=styles.items.get(pos+1);styles.items.removeAt(pos);styles.items.insert(pos+1,styleFieldSet);styleFieldSet.getEl().insertAfter(next.getEl());this.updateStyleButtons();this.doLayout();styleFieldSet.getEl().scrollIntoView(this.body);styleFieldSet.getEl().highlight();this.fireEvent('change');},deleteStyle:function(styleFieldSet){styleFieldSet.getEl().fadeOut({callback:function(){this.getStyles().remove(styleFieldSet);this.updateStyleButtons();this.doLayout();},scope:this});this.fireEvent('change');},getStyles:function(){if(!this.styles){this.styles=Ext.getCmp(this.getId()+"_styles");}
return this.styles;}});Studio.MapfileMgr.ClassPropertiesPanel.doStyleAction=function(classId,styleId,actionName){var clazz=Ext.getCmp(classId);var styleFieldSet=Ext.getCmp(styleId+'_fieldset');clazz[actionName+'Style'].call(clazz,styleFieldSet);};Ext.reg('studio.mm.classpropertiespanel',Studio.MapfileMgr.ClassPropertiesPanel);Studio.MapfileMgr.LimitByScalePanel=Ext.extend(Studio.MapfileMgr.MapfilePanel,{minScale:0,maxScale:500*1000*1000,increment:1000,ignoreChangeEvents:false,map:null,initComponent:function(){var config={width:'100%',border:false,layout:'form',defaults:{width:'100%'}};Ext.applyIf(this,config);var self=this;this.items=[{layout:'table',border:false,layoutConfig:{columns:4},defaults:{border:false,labelWidth:60,width:'100%'},items:[{layout:'form',cellCls:'studioRightPadding',items:[{xtype:'numberfield',id:this.getId()+"_minScale",fieldLabel:OpenLayers.i18n('Min scale'),name:'minscaledenom',width:"100%",minValue:this.minScale,maxValue:this.maxScale,validator:function(value){Ext.getCmp(self.getId()+"_maxScale").validate();return true;},listeners:{valid:this.updateSlider,scope:this}}]},{xtype:'button',cellCls:'studioMaxTableButton',id:this.getId()+"_minScaleButton",text:OpenLayers.i18n('Get from map'),handler:function(){this.minScale=Math.round(this.map.getScale());Ext.getCmp(self.getId()+"_minScale").setValue(this.minScale);},scope:this},{layout:'form',items:[{xtype:'numberfield',id:this.getId()+"_maxScale",fieldLabel:OpenLayers.i18n('Max scale'),name:'maxscaledenom',width:"100%",minValue:this.minScale,maxValue:this.maxScale,validator:function(value){var minScaleTxt=Ext.getCmp(self.getId()+"_minScale").getValue();if(minScaleTxt==="")return true;var minScale=parseInt(minScaleTxt);if(parseInt(value)<=minScale){return OpenLayers.i18n("Must be bigger than Min Scale (")+minScale+")";}else{return true;}},listeners:{valid:this.updateSlider,scope:this}}]},{xtype:'button',cellCls:'studioMaxTableButton',id:this.getId()+"_maxScaleButton",text:OpenLayers.i18n('Get from map'),handler:function(){this.maxScale=Math.round(this.map.getScale());Ext.getCmp(self.getId()+"_maxScale").setValue(this.maxScale);},scope:this},{colspan:4,xtype:'gx_multislider',cellCls:'studioRightPadding',id:this.getId()+"_slider",width:'100%',minValue:0,maxValue:10000000,values:[this.minScale,this.maxScale],increment:this.increment,listeners:{change:this.updateValues,changecomplete:this.updateValuesComplete,render:this.updateSlider,scope:this}}]}];Studio.MapfileMgr.LimitByScalePanel.superclass.initComponent.apply(this,arguments);},updateValues:function(slider,values){if(this.ignoreChangeEvents)return;this.ignoreChangeEvents=true;var minScale=Ext.getCmp(this.getId()+"_minScale");if(values[0]>this.minScale){minScale.setValue(values[0]);}else{minScale.setValue("");}
var maxScale=Ext.getCmp(this.getId()+"_maxScale");if(values[1]<this.maxScale){maxScale.setValue(values[1]);}else{maxScale.setValue("");}
this.ignoreChangeEvents=false;},updateValuesComplete:function(slider){var minScale=Ext.getCmp(this.getId()+"_minScale");minScale.fireEvent('change',minScale,null,null);},updateSlider:function(){if(this.ignoreChangeEvents)return;this.ignoreChangeEvents=true;var slider=Ext.getCmp(this.getId()+"_slider");var minScaleTxt=Ext.getCmp(this.getId()+"_minScale").getValue();var maxScaleTxt=Ext.getCmp(this.getId()+"_maxScale").getValue();var minScale=minScaleTxt===""?this.minScale:parseInt(minScaleTxt);var maxScale=maxScaleTxt===""?this.maxScale:parseInt(maxScaleTxt);slider.setValues([minScale,maxScale]);this.ignoreChangeEvents=false;}});Ext.reg('studio.mm.limitbyscale',Studio.MapfileMgr.LimitByScalePanel);Studio.MapfileMgr.LimitByConditionPanel=Ext.extend(Studio.MapfileMgr.MapfilePanel,{layer:null,curColType:'string',initComponent:function(){var config={width:'100%',border:false,layout:'form',defaults:{width:'100%'}};Ext.applyIf(this,config);this.items=[{xtype:'studio.mm.columncombo',id:this.getId()+'_column',fieldLabel:OpenLayers.i18n('Column'),layer:this.layer,name:'column',listeners:{selectpvi:function(combo,v){this.columnChanged.defer(100,this,[combo]);},scope:this}},{xtype:'studio.mm.operatorcombo',width:25,fieldLabel:OpenLayers.i18n('Operator'),name:'operator'},{xtype:'textfield',id:this.getId()+'_value',fieldLabel:OpenLayers.i18n('Value'),name:'value'}];Studio.MapfileMgr.LimitByConditionPanel.superclass.initComponent.apply(this,arguments);},columnChanged:function(column){var value=column.getValue();var type=Studio.getColumnType(this.layer,value);if(type!=this.curColType){var prevCmp=Ext.getCmp(this.getId()+'_value');var prevValue=prevCmp.getValue();var label=prevCmp.getEl().findParent("div.x-form-item",10,true);this.remove(prevCmp);label.remove();var newValue={id:this.getId()+'_value',fieldLabel:OpenLayers.i18n('Value'),name:'value',value:prevValue};switch(type){case'numeric':Ext.applyIf(newValue,{xtype:'numberfield'});break;default:Ext.applyIf(newValue,{xtype:'textfield'});break;}
this.add(newValue);this.doLayout();this.curColType=type;}}});Ext.reg('studio.mm.limitbycondition',Studio.MapfileMgr.LimitByConditionPanel);Studio.MapfileMgr.RadioNumberSpinner=function(config){var items=config.items=[];var i=0;for(var key in config.choices){items.push({xtype:'radio',name:config.name+'_type',boxLabel:config.choices[key],inputValue:key,checked:i++==0});}
items.push({xtype:'radio',name:config.name+'_type',boxLabel:'',inputValue:'__',listeners:{'check':function(radio,checked){var textField=Ext.getCmp(config.id+'_value');textField.setDisabled(!checked);if(checked&&textField.getValue()===''){textField.setValue("0");}else if(!checked){textField.setValue("");}}}});items.push({xtype:'studio.mm.numberspinner',id:config.id+'_value',name:config.name+'_value',disabled:true,width:40,defaultValue:0,minValue:-180,maxValue:360,incrementValue:45,listeners:{'render':function(field){var el=field.getEl().parent();el.setWidth(60);}}});Studio.MapfileMgr.RadioNumberSpinner.superclass.constructor.apply(this,arguments);};Ext.extend(Studio.MapfileMgr.RadioNumberSpinner,Ext.form.RadioGroup,{choices:null,name:null,initComponent:function(){Studio.MapfileMgr.RadioNumberSpinner.superclass.initComponent.apply(this,arguments);},visitStyler:function(visitor){var valueField=Ext.getCmp(this.getId()+'_value');var first=this.items.get(0);var oldValue=first.getGroupValue();if(oldValue=='__'){oldValue=valueField.getValue();}
var newValue=visitor.value(this,this.name,oldValue);if(oldValue!=newValue){if(this.choices[newValue]){valueField.setValue('');first.setValue(newValue);}else{valueField.setValue(newValue);first.setValue('__');}}}});Ext.reg('studio.mm.radionumberspinner',Studio.MapfileMgr.RadioNumberSpinner);Studio.MapfileMgr.LabelStylePanel=Ext.extend(Studio.MapfileMgr.MapfilePanel,{mapfileInterface:null,geometryType:null,initComponent:function(){var config={width:'100%',border:false,defaults:{border:false}};Ext.applyIf(this,config);var angle;if(this.geometryType=="line"){angle={xtype:'studio.mm.radionumberspinner',id:this.getId()+"_angle",fieldLabel:OpenLayers.i18n('Angle'),name:'angle',choices:{auto:OpenLayers.i18n('auto'),follow:OpenLayers.i18n('follow')},width:'100%'};}else{angle={xtype:'studio.mm.numberspinner',fieldLabel:OpenLayers.i18n('Angle'),name:'angle',width:40,defaultValue:0,minValue:-180,maxValue:360,incrementValue:45};}
this.items=[{layout:'column',defaults:{layout:'form',labelWidth:100,border:false,columnWidth:0.5,defaults:{width:100,listWidth:100}},items:[{bodyStyle:"padding: 0 5px 0 0",items:[{xtype:'studio.mm.fontcombo',fieldLabel:OpenLayers.i18n('Font'),name:'font',store:this.mapfileInterface.getFontsStore(),value:'default'},{xtype:'studio.mm.numberspinner',fieldLabel:OpenLayers.i18n('Size'),name:'size',width:40,minValue:1,value:8},{xtype:'studio.mm.numberspinner',fieldLabel:OpenLayers.i18n('Priority'),width:40,name:'priority',minValue:1,maxValue:10},{xtype:'studio.mm.numberspinner',fieldLabel:OpenLayers.i18n('Buffer'),width:40,name:'buffer',minValue:0}]},{bodyStyle:"padding: 0 0 0 5px",items:[{xtype:'studio.mm.colorpickerfield',fieldLabel:OpenLayers.i18n('Color'),name:'color',value:'#000000'},{xtype:'studio.mm.colorpickerfield',fieldLabel:OpenLayers.i18n('Outline color'),name:'outlinecolor'},{xtype:'studio.mm.positioncombo',fieldLabel:OpenLayers.i18n('Position'),name:'position'},angle]}]},{html:"<p class='info'>"+OpenLayers.i18n("Don't forget to set a value for labelitem at the layer level")+"</p>"}];Studio.MapfileMgr.LabelStylePanel.superclass.initComponent.apply(this,arguments);}});Ext.reg('studio.mm.labelstyle',Studio.MapfileMgr.LabelStylePanel);Studio.MapfileMgr.StrokeStylePanel=Ext.extend(Studio.MapfileMgr.MapfilePanel,{kind:OpenLayers.i18n('Stroke style'),mapfileInterface:null,geometryType:null,initComponent:function(){var config={width:'100%',border:false,layout:'column',defaults:{layout:'form',labelWidth:100,border:false,columnWidth:.5,defaults:{width:100,listWidth:100}}};Ext.applyIf(this,config);var isLine=this.geometryType=='line';this.items=[{bodyStyle:"padding: 0 5px 0 0",items:[{xtype:'studio.mm.colorpickerfield',fieldLabel:isLine?OpenLayers.i18n('Color'):OpenLayers.i18n('Outline color'),name:isLine?"color":"outlinecolor"},{xtype:'studio.mm.symbolcombo',fieldLabel:OpenLayers.i18n('Symbol'),name:'symbol',store:this.mapfileInterface.getSymbolsStore('isStroke')}]},{bodyStyle:"padding: 0 0 0 5px",items:[{xtype:'studio.mm.numberspinner',fieldLabel:OpenLayers.i18n('Width'),name:'width',width:40,minValue:1}]}];Studio.MapfileMgr.StrokeStylePanel.superclass.initComponent.apply(this,arguments);}});Ext.reg('studio.mm.strokestyle',Studio.MapfileMgr.StrokeStylePanel);Studio.MapfileMgr.FillStylePanel=Ext.extend(Studio.MapfileMgr.MapfilePanel,{kind:OpenLayers.i18n('Fill style'),mapfileInterface:null,initComponent:function(){var config={width:'100%',border:false,layout:'column',defaults:{layout:'form',labelWidth:100,border:false,columnWidth:.5,defaults:{width:100,listWidth:100}}};Ext.applyIf(this,config);this.items=[{bodyStyle:"padding: 0 5px 0 0",items:[{xtype:'studio.mm.colorpickerfield',fieldLabel:OpenLayers.i18n('Color'),name:'color'},{xtype:'studio.mm.numberspinner',fieldLabel:OpenLayers.i18n('Opacity'),name:'opacity',width:40,minValue:0,maxValue:100,defaultValue:100,incrementValue:10},{xtype:'studio.mm.numberspinner',fieldLabel:OpenLayers.i18n('Angle'),name:'angle',width:40,defaultValue:0,minValue:-180,maxValue:360,incrementValue:45}]},{bodyStyle:"padding: 0 0 0 5px",items:[{xtype:'studio.mm.symbolcombo',fieldLabel:OpenLayers.i18n('Symbol'),name:'symbol',store:this.mapfileInterface.getSymbolsStore('isFill'),listeners:{selectpvi:this.symbolChanged,scope:this}},{id:this.getId()+"_size",xtype:'studio.mm.numberspinner',fieldLabel:OpenLayers.i18n('Symbol size'),name:'size',width:40,minValue:1},{xtype:'studio.mm.numberspinner',id:this.getId()+"_width",fieldLabel:OpenLayers.i18n('Width'),name:'width',width:40,minValue:1}]}];Studio.MapfileMgr.FillStylePanel.superclass.initComponent.apply(this,arguments);},symbolChanged:function(combo,v){var empty=(v==null||v==="");Ext.getCmp(this.getId()+"_size").setDisabled(empty);Ext.getCmp(this.getId()+"_width").setDisabled(empty);}});Ext.reg('studio.mm.fillstyle',Studio.MapfileMgr.FillStylePanel);Studio.MapfileMgr.PointStylePanel=Ext.extend(Studio.MapfileMgr.MapfilePanel,{kind:'Point style',mapfileInterface:null,initComponent:function(){var config={width:'100%',border:false,layout:'column',defaults:{layout:'form',labelWidth:100,border:false,columnWidth:.5,defaults:{width:100,listWidth:100}}};Ext.applyIf(this,config);this.items=[{bodyStyle:"padding: 0 5px 0 0",items:[{xtype:'studio.mm.colorpickerfield',fieldLabel:OpenLayers.i18n('Color'),name:"color"},{xtype:'studio.mm.colorpickerfield',fieldLabel:OpenLayers.i18n('Outline color'),name:"outlinecolor"}]},{bodyStyle:"padding: 0 0 0 5px",items:[{xtype:'studio.mm.numberspinner',fieldLabel:OpenLayers.i18n('Size'),name:'size',width:40,minValue:1},{xtype:'studio.mm.symbolcombo',fieldLabel:OpenLayers.i18n('Symbol'),name:'symbol',store:this.mapfileInterface.getSymbolsStore('isPoint')},{xtype:'studio.mm.numberspinner',fieldLabel:OpenLayers.i18n('Angle'),name:'angle',width:40,defaultValue:0,minValue:-180,maxValue:360,incrementValue:45}]}];Studio.MapfileMgr.PointStylePanel.superclass.initComponent.apply(this,arguments);}});Ext.reg('studio.mm.pointstyle',Studio.MapfileMgr.PointStylePanel);Studio.MapfileMgr.FontComboBox=Ext.extend(Ext.form.ComboBox,{valueField:'id',displayField:'name'});Ext.reg('studio.mm.fontcombo',Studio.MapfileMgr.FontComboBox);Studio.MapfileMgr.ColumnComboBox=Ext.extend(Ext.form.ComboBox,{layer:null,editable:false,mode:'local',typeAhead:false,triggerAction:'all',forceSelection:true,emptyText:OpenLayers.i18n('not specified'),store:null,valueField:'name',displayField:'name',initComponent:function(){if(this.layer.metadata&&this.layer.metadata.datasourceid&&this.layer.metadata.datastoreid){this.store=Studio.getDatasourceColumnStore(this.layer.metadata.datastoreid,this.layer.metadata.datasourceid).getStore();}
Studio.MapfileMgr.ColumnComboBox.superclass.initComponent.apply(this,arguments);}});Ext.reg('studio.mm.columncombo',Studio.MapfileMgr.ColumnComboBox);Studio.MapfileMgr.OperatorComboBox=Ext.extend(Ext.form.ComboBox,{editable:false,typeAhead:false,mode:'local',triggerAction:'all',forceSelection:true,emptyText:OpenLayers.i18n('not specified'),store:[['<','<'],['>','>'],['<=','<='],['>=','>='],['==','=='],['!=','!=']]});Ext.reg('studio.mm.operatorcombo',Studio.MapfileMgr.OperatorComboBox);Studio.MapfileMgr.PositionComboBox=Ext.extend(Ext.form.ComboBox,{initComponent:function(){var config={editable:false,typeAhead:false,mode:'local',triggerAction:'all',store:[['auto',OpenLayers.i18n('auto')],['ul',OpenLayers.i18n('upper left')],['uc',OpenLayers.i18n('upper center')],['ur',OpenLayers.i18n('upper right')],['cl',OpenLayers.i18n('center left')],['cc',OpenLayers.i18n('center center')],['cr',OpenLayers.i18n('center right')],['ll',OpenLayers.i18n('lower left')],['lc',OpenLayers.i18n('lower center')],['lr',OpenLayers.i18n('lower right')]]};Ext.apply(this,config);Studio.MapfileMgr.PositionComboBox.superclass.initComponent.apply(this,arguments);}});Ext.reg('studio.mm.positioncombo',Studio.MapfileMgr.PositionComboBox);Studio.MapfileMgr.SymbolComboBox=Ext.extend(Studio.ComboBoxWithEmpty,{valueField:'id',displayField:'name'});Ext.reg('studio.mm.symbolcombo',Studio.MapfileMgr.SymbolComboBox);Ext.namespace("Studio");Studio.PaletteComboBox=Ext.extend(Ext.form.ComboBox,{cls:'x-combo-palette',initComponent:function(){var paletteTpl='<div class="x-combo-palette">'
+'<tpl for="colors">'
+'<div><span style="background-color:{.}" unselectable="on">&#160;</span></div>'
+'</tpl>'
+'</div>';Ext.apply(this,{paletteTpl:paletteTpl,tpl:'<tpl for=".">'
+'<div class="x-combo-list-item x-combo-palette-item">'
+paletteTpl
+'</div></tpl>'});Studio.PaletteComboBox.superclass.initComponent.call(this);},onRender:function(ct,position){Studio.PaletteComboBox.superclass.onRender.call(this,ct,position);this.wrap.applyStyles({position:'relative'});this.el.addClass('ux-icon-combo-input');var el=Ext.DomHelper.append(this.el.up('div.x-form-field-wrap'),{tag:'div',cls:'x-combo-palette-input-value',style:'width:'+this.el.getWidth(true)+'px'});this.icon=Ext.DomHelper.append(el,{tag:'div',style:'width:500px'});},setIconCls:function(){var rec=this.store.query(this.valueField,this.getValue()).itemAt(0);if(rec){var t=new Ext.XTemplate(this.paletteTpl);var palette={colors:rec.get('colors')};t.overwrite(this.icon,palette);}},setValue:function(value){Ext.ux.IconCombo.superclass.setValue.call(this,value);this.setIconCls();this.el.dom.value="";}});Ext.reg('palettecombo',Studio.PaletteComboBox);Studio.datastoreStore=new Studio.data.Store({url:null,root:'datastores',recordClass:Studio.data.DatastoreRecord});Studio.mapfileStore=new Studio.data.Store({url:null,root:'maps',recordClass:Studio.data.MapfileRecord});Studio.layertemplateStore=new Studio.data.Store({url:null,root:'layertemplates',recordClass:Studio.data.LayertemplateRecord});Studio.datasourcesStores={};Studio.getDatasourceStore=function(datastore_id){if(Studio.datasourcesStores[datastore_id]){return Studio.datasourcesStores[datastore_id];}
Studio.datasourcesStores[datastore_id]=new Studio.data.Store({url:subString(Studio.datastoreStore.datasourceUrlScheme,{"DATASTORE_ID":datastore_id}),root:'datasources',recordClass:Studio.data.DatasourceRecord});Studio.datasourcesStores[datastore_id].getStore().load();return Studio.datasourcesStores[datastore_id];};Studio.getDatasourceColumnStore=function(datastore_id,datasource_id){var datasource_store=Studio.getDatasourceStore(datastore_id);if(!datasource_store.datasourcesColumnsStores){datasource_store.datasourcesColumnsStores={};}
if(datasource_store.datasourcesColumnsStores[datasource_id]){return datasource_store.datasourcesColumnsStores[datasource_id];}
datasource_store.datasourcesColumnsStores[datasource_id]=new Studio.data.Store({url:subString(Studio.datastoreStore.datasourceColumnsUrlScheme,{"DATASTORE_ID":datastore_id,"DATASOURCE_ID":datasource_id}),root:'columns',recordClass:Studio.data.DatasourceColumnRecord});datasource_store.datasourcesColumnsStores[datasource_id].getStore().load();return datasource_store.datasourcesColumnsStores[datasource_id];};Studio.getColumnType=function(layer,columnName){if(!(layer.metadata&&layer.metadata.datasourceid&&layer.metadata.datastoreid)){return null;}
var store=Studio.getDatasourceColumnStore(layer.metadata.datastoreid,layer.metadata.datasourceid).getStore();var pos=store.find('name',columnName);if(pos<0){return null;}
var record=store.getAt(pos);return record.get("type");};