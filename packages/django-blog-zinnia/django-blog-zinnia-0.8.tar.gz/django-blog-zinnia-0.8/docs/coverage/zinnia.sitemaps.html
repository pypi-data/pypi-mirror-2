<html>
<head>
<title>zinnia.sitemaps</title>
</head>
<body>
zinnia.sitemaps
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 91 lines<br/>
Missed: 0 lines<br/>
Skipped 25 lines<br/>
Percent: 100 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>  1</pre></span><pre>&quot;&quot;&quot;Sitemaps for Zinnia&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>  2</pre></span><pre>from django.contrib.sitemaps import Sitemap</pre></div>
<div class="cov"><span class="num"><pre>  3</pre></span><pre>from django.core.urlresolvers import reverse</pre></div>
<div class="skip"><span class="num"><pre>  4</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  5</pre></span><pre>from tagging.models import TaggedItem</pre></div>
<div class="skip"><span class="num"><pre>  6</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  7</pre></span><pre>from zinnia.models import Entry</pre></div>
<div class="cov"><span class="num"><pre>  8</pre></span><pre>from zinnia.models import Author</pre></div>
<div class="cov"><span class="num"><pre>  9</pre></span><pre>from zinnia.models import Category</pre></div>
<div class="cov"><span class="num"><pre> 10</pre></span><pre>from zinnia.managers import tags_published</pre></div>
<div class="cov"><span class="num"><pre> 11</pre></span><pre>from zinnia.managers import entries_published</pre></div>
<div class="skip"><span class="num"><pre> 12</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 13</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 14</pre></span><pre>class EntrySitemap(Sitemap):</pre></div>
<div class="cov"><span class="num"><pre> 15</pre></span><pre>    &quot;&quot;&quot;Sitemap for entries&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 16</pre></span><pre>    priority = 0.5</pre></div>
<div class="cov"><span class="num"><pre> 17</pre></span><pre>    changefreq = 'never'</pre></div>
<div class="skip"><span class="num"><pre> 18</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 19</pre></span><pre>    def items(self):</pre></div>
<div class="cov"><span class="num"><pre> 20</pre></span><pre>        &quot;&quot;&quot;Return published entries&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 21</pre></span><pre>        return Entry.published.all()</pre></div>
<div class="skip"><span class="num"><pre> 22</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 23</pre></span><pre>    def lastmod(self, obj):</pre></div>
<div class="cov"><span class="num"><pre> 24</pre></span><pre>        &quot;&quot;&quot;Return last modification of an entry&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 25</pre></span><pre>        return obj.last_update</pre></div>
<div class="skip"><span class="num"><pre> 26</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 27</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 28</pre></span><pre>class CategorySitemap(Sitemap):</pre></div>
<div class="cov"><span class="num"><pre> 29</pre></span><pre>    &quot;&quot;&quot;Sitemap for categories&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 30</pre></span><pre>    changefreq = 'monthly'</pre></div>
<div class="skip"><span class="num"><pre> 31</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 32</pre></span><pre>    def cache(self, categories):</pre></div>
<div class="cov"><span class="num"><pre> 33</pre></span><pre>        &quot;&quot;&quot;Cache categorie's entries percent on total entries&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 34</pre></span><pre>        len_entries = float(Entry.published.count())</pre></div>
<div class="cov"><span class="num"><pre> 35</pre></span><pre>        self.cache_categories = {}</pre></div>
<div class="cov"><span class="num"><pre> 36</pre></span><pre>        for cat in categories:</pre></div>
<div class="cov"><span class="num"><pre> 37</pre></span><pre>            self.cache_categories[cat.pk] = cat.entries_published_set(</pre></div>
<div class="cov"><span class="num"><pre> 38</pre></span><pre>                ).count() / len_entries</pre></div>
<div class="skip"><span class="num"><pre> 39</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 40</pre></span><pre>    def items(self):</pre></div>
<div class="cov"><span class="num"><pre> 41</pre></span><pre>        &quot;&quot;&quot;Return all categories with coeff&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 42</pre></span><pre>        categories = Category.objects.all()</pre></div>
<div class="cov"><span class="num"><pre> 43</pre></span><pre>        self.cache(categories)</pre></div>
<div class="cov"><span class="num"><pre> 44</pre></span><pre>        return categories</pre></div>
<div class="skip"><span class="num"><pre> 45</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 46</pre></span><pre>    def lastmod(self, obj):</pre></div>
<div class="cov"><span class="num"><pre> 47</pre></span><pre>        &quot;&quot;&quot;Return last modification of a category&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 48</pre></span><pre>        entries = entries_published(obj.entry_set)</pre></div>
<div class="cov"><span class="num"><pre> 49</pre></span><pre>        if not entries:</pre></div>
<div class="cov"><span class="num"><pre> 50</pre></span><pre>            return None</pre></div>
<div class="cov"><span class="num"><pre> 51</pre></span><pre>        return entries[0].creation_date</pre></div>
<div class="skip"><span class="num"><pre> 52</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 53</pre></span><pre>    def priority(self, obj):</pre></div>
<div class="cov"><span class="num"><pre> 54</pre></span><pre>        &quot;&quot;&quot;Compute priority with cached coeffs&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 55</pre></span><pre>        priority = 0.5 + self.cache_categories[obj.pk]</pre></div>
<div class="cov"><span class="num"><pre> 56</pre></span><pre>        if priority &gt; 1.0:</pre></div>
<div class="cov"><span class="num"><pre> 57</pre></span><pre>            priority = 1.0</pre></div>
<div class="cov"><span class="num"><pre> 58</pre></span><pre>        return '%.1f' % priority</pre></div>
<div class="skip"><span class="num"><pre> 59</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 60</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 61</pre></span><pre>class AuthorSitemap(Sitemap):</pre></div>
<div class="cov"><span class="num"><pre> 62</pre></span><pre>    &quot;&quot;&quot;Sitemap for authors&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 63</pre></span><pre>    priority = 0.5</pre></div>
<div class="cov"><span class="num"><pre> 64</pre></span><pre>    changefreq = 'monthly'</pre></div>
<div class="skip"><span class="num"><pre> 65</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 66</pre></span><pre>    def items(self):</pre></div>
<div class="cov"><span class="num"><pre> 67</pre></span><pre>        &quot;&quot;&quot;Return published authors&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 68</pre></span><pre>        return Author.published.all()</pre></div>
<div class="skip"><span class="num"><pre> 69</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 70</pre></span><pre>    def lastmod(self, obj):</pre></div>
<div class="cov"><span class="num"><pre> 71</pre></span><pre>        &quot;&quot;&quot;Return last modification of an author&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 72</pre></span><pre>        entries = entries_published(obj.entry_set)</pre></div>
<div class="cov"><span class="num"><pre> 73</pre></span><pre>        if not entries:</pre></div>
<div class="cov"><span class="num"><pre> 74</pre></span><pre>            return None</pre></div>
<div class="cov"><span class="num"><pre> 75</pre></span><pre>        return entries[0].creation_date</pre></div>
<div class="skip"><span class="num"><pre> 76</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 77</pre></span><pre>    def location(self, obj):</pre></div>
<div class="cov"><span class="num"><pre> 78</pre></span><pre>        &quot;&quot;&quot;Return url of an author&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 79</pre></span><pre>        return reverse('zinnia_author_detail', args=[obj.username])</pre></div>
<div class="skip"><span class="num"><pre> 80</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 81</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 82</pre></span><pre>class TagSitemap(Sitemap):</pre></div>
<div class="cov"><span class="num"><pre> 83</pre></span><pre>    &quot;&quot;&quot;Sitemap for tags&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 84</pre></span><pre>    changefreq = 'monthly'</pre></div>
<div class="skip"><span class="num"><pre> 85</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 86</pre></span><pre>    def cache(self, tags):</pre></div>
<div class="cov"><span class="num"><pre> 87</pre></span><pre>        &quot;&quot;&quot;Cache tag's entries percent on total entries&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 88</pre></span><pre>        len_entries = float(Entry.published.count())</pre></div>
<div class="cov"><span class="num"><pre> 89</pre></span><pre>        self.cache_tags = {}</pre></div>
<div class="cov"><span class="num"><pre> 90</pre></span><pre>        for tag in tags:</pre></div>
<div class="cov"><span class="num"><pre> 91</pre></span><pre>            entries = TaggedItem.objects.get_by_model(</pre></div>
<div class="cov"><span class="num"><pre> 92</pre></span><pre>                Entry.published.all(), tag)</pre></div>
<div class="cov"><span class="num"><pre> 93</pre></span><pre>            self.cache_tags[tag.pk] = (entries, entries.count() / len_entries)</pre></div>
<div class="skip"><span class="num"><pre> 94</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 95</pre></span><pre>    def items(self):</pre></div>
<div class="cov"><span class="num"><pre> 96</pre></span><pre>        &quot;&quot;&quot;Return all tags with coeff&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 97</pre></span><pre>        tags = tags_published()</pre></div>
<div class="cov"><span class="num"><pre> 98</pre></span><pre>        self.cache(tags)</pre></div>
<div class="cov"><span class="num"><pre> 99</pre></span><pre>        return tags</pre></div>
<div class="skip"><span class="num"><pre>100</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>101</pre></span><pre>    def lastmod(self, obj):</pre></div>
<div class="cov"><span class="num"><pre>102</pre></span><pre>        &quot;&quot;&quot;Return last modification of a tag&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>103</pre></span><pre>        entries = self.cache_tags[obj.pk][0]</pre></div>
<div class="cov"><span class="num"><pre>104</pre></span><pre>        return entries[0].creation_date</pre></div>
<div class="skip"><span class="num"><pre>105</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>106</pre></span><pre>    def priority(self, obj):</pre></div>
<div class="cov"><span class="num"><pre>107</pre></span><pre>        &quot;&quot;&quot;Compute priority with cached coeffs&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>108</pre></span><pre>        priority = 0.5 + self.cache_tags[obj.pk][1]</pre></div>
<div class="cov"><span class="num"><pre>109</pre></span><pre>        if priority &gt; 1.0:</pre></div>
<div class="cov"><span class="num"><pre>110</pre></span><pre>            priority = 1.0</pre></div>
<div class="cov"><span class="num"><pre>111</pre></span><pre>        return '%.1f' % priority</pre></div>
<div class="skip"><span class="num"><pre>112</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>113</pre></span><pre>    def location(self, obj):</pre></div>
<div class="cov"><span class="num"><pre>114</pre></span><pre>        &quot;&quot;&quot;Return url of a tag&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>115</pre></span><pre>        return reverse('zinnia_tag_detail', args=[obj.name])</pre></div>
<div class="skip"><span class="num"><pre>116</pre></span><pre></pre></div>
</div>
</body>
</html>
