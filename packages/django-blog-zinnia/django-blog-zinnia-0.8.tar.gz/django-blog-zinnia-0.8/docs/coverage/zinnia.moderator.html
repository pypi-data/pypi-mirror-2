<html>
<head>
<title>zinnia.moderator</title>
</head>
<body>
zinnia.moderator
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 52 lines<br/>
Missed: 32 lines<br/>
Skipped 13 lines<br/>
Percent: 61 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre> 1</pre></span><pre>&quot;&quot;&quot;Moderator of Zinnia comments</pre></div>
<div class="cov"><span class="num"><pre> 2</pre></span><pre>   Based on Akismet for checking spams.&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 3</pre></span><pre>from django.conf import settings</pre></div>
<div class="cov"><span class="num"><pre> 4</pre></span><pre>from django.template import Context</pre></div>
<div class="cov"><span class="num"><pre> 5</pre></span><pre>from django.template import loader</pre></div>
<div class="cov"><span class="num"><pre> 6</pre></span><pre>from django.core.mail import send_mail</pre></div>
<div class="cov"><span class="num"><pre> 7</pre></span><pre>from django.utils.encoding import smart_str</pre></div>
<div class="cov"><span class="num"><pre> 8</pre></span><pre>from django.contrib.sites.models import Site</pre></div>
<div class="cov"><span class="num"><pre> 9</pre></span><pre>from django.utils.translation import ugettext_lazy as _</pre></div>
<div class="cov"><span class="num"><pre>10</pre></span><pre>from django.contrib.comments.moderation import CommentModerator</pre></div>
<div class="skip"><span class="num"><pre>11</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>12</pre></span><pre>from zinnia.settings import PROTOCOL</pre></div>
<div class="cov"><span class="num"><pre>13</pre></span><pre>from zinnia.settings import MAIL_COMMENT</pre></div>
<div class="cov"><span class="num"><pre>14</pre></span><pre>from zinnia.settings import MAIL_COMMENT_REPLY</pre></div>
<div class="cov"><span class="num"><pre>15</pre></span><pre>from zinnia.settings import AKISMET_COMMENT</pre></div>
<div class="skip"><span class="num"><pre>16</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>17</pre></span><pre>AKISMET_API_KEY = getattr(settings, 'AKISMET_SECRET_API_KEY', '')</pre></div>
<div class="skip"><span class="num"><pre>18</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>19</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>20</pre></span><pre>class EntryCommentModerator(CommentModerator):</pre></div>
<div class="cov"><span class="num"><pre>21</pre></span><pre>    &quot;&quot;&quot;Moderate the comment of Entry&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>22</pre></span><pre>    email_notification = MAIL_COMMENT</pre></div>
<div class="cov"><span class="num"><pre>23</pre></span><pre>    email_notification_reply = MAIL_COMMENT_REPLY</pre></div>
<div class="cov"><span class="num"><pre>24</pre></span><pre>    enable_field = 'comment_enabled'</pre></div>
<div class="skip"><span class="num"><pre>25</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>26</pre></span><pre>    def email(self, comment, content_object, request):</pre></div>
<div class="cov"><span class="num"><pre>27</pre></span><pre>        if comment.is_public:</pre></div>
<div class="cov"><span class="num"><pre>28</pre></span><pre>            super(EntryCommentModerator, self).email(comment, content_object,</pre></div>
<div class="cov"><span class="num"><pre>29</pre></span><pre>                                                     request)</pre></div>
<div class="cov"><span class="num"><pre>30</pre></span><pre>            self.email_reply(comment, content_object, request)</pre></div>
<div class="skip"><span class="num"><pre>31</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>32</pre></span><pre>    def email_reply(self, comment, content_object, request):</pre></div>
<div class="cov"><span class="num"><pre>33</pre></span><pre>        &quot;&quot;&quot;Send email notification of a new comment to site staff when email</pre></div>
<div class="cov"><span class="num"><pre>34</pre></span><pre>        notifications have been requested.&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>35</pre></span><pre>        if not self.email_notification_reply:</pre></div>
<div class="cov"><span class="num"><pre>36</pre></span><pre>            return</pre></div>
<div class="skip"><span class="num"><pre>37</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>38</pre></span><pre>        if comment.flags.count():</pre></div>
<div class="cov"><span class="num"><pre>39</pre></span><pre>            return</pre></div>
<div class="skip"><span class="num"><pre>40</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>41</pre></span><pre>        exclude_list = [manager_tuple[1] for manager_tuple</pre></div>
<div class="cov"><span class="num"><pre>42</pre></span><pre>                        in settings.MANAGERS] + [comment.userinfo['email']]</pre></div>
<div class="cov"><span class="num"><pre>43</pre></span><pre>        recipient_list = set([comment.userinfo['email']</pre></div>
<div class="cov"><span class="num"><pre>44</pre></span><pre>                              for comment in content_object.comments</pre></div>
<div class="cov"><span class="num"><pre>45</pre></span><pre>                              if comment.userinfo['email']]) ^ \</pre></div>
<div class="cov"><span class="num"><pre>46</pre></span><pre>                              set(exclude_list)</pre></div>
<div class="skip"><span class="num"><pre>47</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>48</pre></span><pre>        if recipient_list:</pre></div>
<div class="cov"><span class="num"><pre>49</pre></span><pre>            site = Site.objects.get_current()</pre></div>
<div class="cov"><span class="num"><pre>50</pre></span><pre>            template = loader.get_template('comments/comment_reply_email.txt')</pre></div>
<div class="cov"><span class="num"><pre>51</pre></span><pre>            context = Context({'comment': comment, 'site': site,</pre></div>
<div class="cov"><span class="num"><pre>52</pre></span><pre>                               'protocol': PROTOCOL,</pre></div>
<div class="cov"><span class="num"><pre>53</pre></span><pre>                               'content_object': content_object})</pre></div>
<div class="cov"><span class="num"><pre>54</pre></span><pre>            subject = _('[%(site)s] New comment posted on &quot;%(title)s&quot;') % \</pre></div>
<div class="cov"><span class="num"><pre>55</pre></span><pre>                      {'site': site.name,</pre></div>
<div class="cov"><span class="num"><pre>56</pre></span><pre>                       'title': content_object.title}</pre></div>
<div class="cov"><span class="num"><pre>57</pre></span><pre>            message = template.render(context)</pre></div>
<div class="cov"><span class="num"><pre>58</pre></span><pre>            send_mail(subject, message, settings.DEFAULT_FROM_EMAIL,</pre></div>
<div class="cov"><span class="num"><pre>59</pre></span><pre>                      recipient_list, fail_silently=not settings.DEBUG)</pre></div>
<div class="skip"><span class="num"><pre>60</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>61</pre></span><pre>    def moderate(self, comment, content_object, request):</pre></div>
<div class="cov"><span class="num"><pre>62</pre></span><pre>        &quot;&quot;&quot;Need to pass Akismet test&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>63</pre></span><pre>        if not AKISMET_COMMENT or not AKISMET_API_KEY:</pre></div>
<div class="nocov"><span class="num"><pre>64</pre></span><pre>            return False</pre></div>
<div class="skip"><span class="num"><pre>65</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>66</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre>67</pre></span><pre>            from akismet import Akismet</pre></div>
<div class="nocov"><span class="num"><pre>68</pre></span><pre>            from akismet import APIKeyError</pre></div>
<div class="nocov"><span class="num"><pre>69</pre></span><pre>        except ImportError:</pre></div>
<div class="nocov"><span class="num"><pre>70</pre></span><pre>            return False</pre></div>
<div class="skip"><span class="num"><pre>71</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>72</pre></span><pre>        akismet = Akismet(key=AKISMET_API_KEY,</pre></div>
<div class="nocov"><span class="num"><pre>73</pre></span><pre>                          blog_url='%s://%s/' % (</pre></div>
<div class="nocov"><span class="num"><pre>74</pre></span><pre>                              PROTOCOL, Site.objects.get_current().domain))</pre></div>
<div class="nocov"><span class="num"><pre>75</pre></span><pre>        if akismet.verify_key():</pre></div>
<div class="nocov"><span class="num"><pre>76</pre></span><pre>            akismet_data = {</pre></div>
<div class="nocov"><span class="num"><pre>77</pre></span><pre>                'user_ip': request.META.get('REMOTE_ADDR', ''),</pre></div>
<div class="nocov"><span class="num"><pre>78</pre></span><pre>                'user_agent': request.META.get('HTTP_USER_AGENT', ''),</pre></div>
<div class="nocov"><span class="num"><pre>79</pre></span><pre>                'referrer': request.META.get('HTTP_REFERER', 'unknown'),</pre></div>
<div class="nocov"><span class="num"><pre>80</pre></span><pre>                'permalink': content_object.get_absolute_url(),</pre></div>
<div class="nocov"><span class="num"><pre>81</pre></span><pre>                'comment_type': 'comment',</pre></div>
<div class="nocov"><span class="num"><pre>82</pre></span><pre>                'comment_author': smart_str(comment.userinfo.get('name', '')),</pre></div>
<div class="nocov"><span class="num"><pre>83</pre></span><pre>                'comment_author_email': smart_str(comment.userinfo.get(</pre></div>
<div class="nocov"><span class="num"><pre>84</pre></span><pre>                    'email', '')),</pre></div>
<div class="nocov"><span class="num"><pre>85</pre></span><pre>                'comment_author_url': smart_str(comment.userinfo.get(</pre></div>
<div class="nocov"><span class="num"><pre>86</pre></span><pre>                    'url', '')),</pre></div>
<div class="nocov"><span class="num"><pre>87</pre></span><pre>            }</pre></div>
<div class="nocov"><span class="num"><pre>88</pre></span><pre>            is_spam = akismet.comment_check(smart_str(comment.comment),</pre></div>
<div class="nocov"><span class="num"><pre>89</pre></span><pre>                                            data=akismet_data,</pre></div>
<div class="nocov"><span class="num"><pre>90</pre></span><pre>                                            build_data=True)</pre></div>
<div class="nocov"><span class="num"><pre>91</pre></span><pre>            if is_spam:</pre></div>
<div class="nocov"><span class="num"><pre>92</pre></span><pre>                comment.save()</pre></div>
<div class="nocov"><span class="num"><pre>93</pre></span><pre>                user = comment.content_object.authors.all()[0]</pre></div>
<div class="nocov"><span class="num"><pre>94</pre></span><pre>                comment.flags.create(user=user, flag='spam')</pre></div>
<div class="nocov"><span class="num"><pre>95</pre></span><pre>            return is_spam</pre></div>
<div class="nocov"><span class="num"><pre>96</pre></span><pre>        raise APIKeyError('Your Akismet API key is invalid.')</pre></div>
<div class="skip"><span class="num"><pre>97</pre></span><pre></pre></div>
</div>
</body>
</html>
