<html>
<head>
<title>zinnia.xmlrpc.pingback</title>
</head>
<body>
zinnia.xmlrpc.pingback
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 106 lines<br/>
Missed: 0 lines<br/>
Skipped 30 lines<br/>
Percent: 100 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>  1</pre></span><pre>&quot;&quot;&quot;XML-RPC methods of Zinnia Pingback&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>  2</pre></span><pre>from urllib2 import urlopen</pre></div>
<div class="cov"><span class="num"><pre>  3</pre></span><pre>from urllib2 import URLError</pre></div>
<div class="cov"><span class="num"><pre>  4</pre></span><pre>from urllib2 import HTTPError</pre></div>
<div class="cov"><span class="num"><pre>  5</pre></span><pre>from urlparse import urlsplit</pre></div>
<div class="skip"><span class="num"><pre>  6</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  7</pre></span><pre>from django.utils.html import strip_tags</pre></div>
<div class="cov"><span class="num"><pre>  8</pre></span><pre>from django.contrib.sites.models import Site</pre></div>
<div class="cov"><span class="num"><pre>  9</pre></span><pre>from django.core.urlresolvers import Resolver404</pre></div>
<div class="cov"><span class="num"><pre> 10</pre></span><pre>from django.core.urlresolvers import get_resolver</pre></div>
<div class="cov"><span class="num"><pre> 11</pre></span><pre>from django.contrib.comments.models import Comment</pre></div>
<div class="cov"><span class="num"><pre> 12</pre></span><pre>from django.utils.translation import ugettext as _</pre></div>
<div class="cov"><span class="num"><pre> 13</pre></span><pre>from django.contrib.contenttypes.models import ContentType</pre></div>
<div class="skip"><span class="num"><pre> 14</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 15</pre></span><pre>from zinnia.models import Entry</pre></div>
<div class="cov"><span class="num"><pre> 16</pre></span><pre>from zinnia.settings import PINGBACK_CONTENT_LENGTH</pre></div>
<div class="cov"><span class="num"><pre> 17</pre></span><pre>from BeautifulSoup import BeautifulSoup</pre></div>
<div class="cov"><span class="num"><pre> 18</pre></span><pre>from django_xmlrpc.decorators import xmlrpc_func</pre></div>
<div class="skip"><span class="num"><pre> 19</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 20</pre></span><pre>UNDEFINED_ERROR = 0</pre></div>
<div class="cov"><span class="num"><pre> 21</pre></span><pre>SOURCE_DOES_NOT_EXIST = 16</pre></div>
<div class="cov"><span class="num"><pre> 22</pre></span><pre>SOURCE_DOES_NOT_LINK = 17</pre></div>
<div class="cov"><span class="num"><pre> 23</pre></span><pre>TARGET_DOES_NOT_EXIST = 32</pre></div>
<div class="cov"><span class="num"><pre> 24</pre></span><pre>TARGET_IS_NOT_PINGABLE = 33</pre></div>
<div class="cov"><span class="num"><pre> 25</pre></span><pre>PINGBACK_ALREADY_REGISTERED = 48</pre></div>
<div class="skip"><span class="num"><pre> 26</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 27</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 28</pre></span><pre>def generate_pingback_content(soup, target, max_length, trunc_char='...'):</pre></div>
<div class="cov"><span class="num"><pre> 29</pre></span><pre>    &quot;&quot;&quot;Generate a description text for the pingback&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 30</pre></span><pre>    link = soup.find('a', href=target)</pre></div>
<div class="skip"><span class="num"><pre> 31</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 32</pre></span><pre>    content = strip_tags(unicode(link.findParent()))</pre></div>
<div class="cov"><span class="num"><pre> 33</pre></span><pre>    index = content.index(link.string)</pre></div>
<div class="skip"><span class="num"><pre> 34</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 35</pre></span><pre>    if len(content) &gt; max_length:</pre></div>
<div class="cov"><span class="num"><pre> 36</pre></span><pre>        middle = max_length / 2</pre></div>
<div class="cov"><span class="num"><pre> 37</pre></span><pre>        start = index - middle</pre></div>
<div class="cov"><span class="num"><pre> 38</pre></span><pre>        end = index + middle</pre></div>
<div class="skip"><span class="num"><pre> 39</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 40</pre></span><pre>        if start &lt;= 0:</pre></div>
<div class="cov"><span class="num"><pre> 41</pre></span><pre>            end -= start</pre></div>
<div class="cov"><span class="num"><pre> 42</pre></span><pre>            extract = content[0:end]</pre></div>
<div class="cov"><span class="num"><pre> 43</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre> 44</pre></span><pre>            extract = '%s%s' % (trunc_char, content[start:end])</pre></div>
<div class="skip"><span class="num"><pre> 45</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 46</pre></span><pre>        if end &lt; len(content):</pre></div>
<div class="cov"><span class="num"><pre> 47</pre></span><pre>            extract += trunc_char</pre></div>
<div class="cov"><span class="num"><pre> 48</pre></span><pre>        return extract</pre></div>
<div class="skip"><span class="num"><pre> 49</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 50</pre></span><pre>    return content</pre></div>
<div class="skip"><span class="num"><pre> 51</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 52</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 53</pre></span><pre>@xmlrpc_func(returns='string', args=['string', 'string'])</pre></div>
<div class="cov"><span class="num"><pre> 54</pre></span><pre>def pingback_ping(source, target):</pre></div>
<div class="cov"><span class="num"><pre> 55</pre></span><pre>    &quot;&quot;&quot;pingback.ping(sourceURI, targetURI) =&gt; 'Pingback message'</pre></div>
<div class="skip"><span class="num"><pre> 56</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 57</pre></span><pre>    Notifies the server that a link has been added to sourceURI, pointing to targetURI.</pre></div>
<div class="skip"><span class="num"><pre> 58</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 59</pre></span><pre>    See: http://hixie.ch/specs/pingback/pingback-1.0&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 60</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre> 61</pre></span><pre>        if source == target:</pre></div>
<div class="cov"><span class="num"><pre> 62</pre></span><pre>            return UNDEFINED_ERROR</pre></div>
<div class="skip"><span class="num"><pre> 63</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 64</pre></span><pre>        site = Site.objects.get_current()</pre></div>
<div class="cov"><span class="num"><pre> 65</pre></span><pre>        try:</pre></div>
<div class="cov"><span class="num"><pre> 66</pre></span><pre>            document = ''.join(urlopen(source).readlines())</pre></div>
<div class="cov"><span class="num"><pre> 67</pre></span><pre>        except (HTTPError, URLError):</pre></div>
<div class="cov"><span class="num"><pre> 68</pre></span><pre>            return SOURCE_DOES_NOT_EXIST</pre></div>
<div class="skip"><span class="num"><pre> 69</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 70</pre></span><pre>        if not target in document:</pre></div>
<div class="cov"><span class="num"><pre> 71</pre></span><pre>            return SOURCE_DOES_NOT_LINK</pre></div>
<div class="skip"><span class="num"><pre> 72</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 73</pre></span><pre>        scheme, netloc, path, query, fragment = urlsplit(target)</pre></div>
<div class="cov"><span class="num"><pre> 74</pre></span><pre>        if netloc != site.domain:</pre></div>
<div class="cov"><span class="num"><pre> 75</pre></span><pre>            return TARGET_DOES_NOT_EXIST</pre></div>
<div class="skip"><span class="num"><pre> 76</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 77</pre></span><pre>        resolver = get_resolver(None)</pre></div>
<div class="cov"><span class="num"><pre> 78</pre></span><pre>        try:</pre></div>
<div class="cov"><span class="num"><pre> 79</pre></span><pre>            resolver.resolve(path)</pre></div>
<div class="cov"><span class="num"><pre> 80</pre></span><pre>        except Resolver404:</pre></div>
<div class="cov"><span class="num"><pre> 81</pre></span><pre>            return TARGET_DOES_NOT_EXIST</pre></div>
<div class="skip"><span class="num"><pre> 82</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 83</pre></span><pre>        try:</pre></div>
<div class="cov"><span class="num"><pre> 84</pre></span><pre>            entry_slug = [bit for bit in path.split('/') if bit][-1]</pre></div>
<div class="cov"><span class="num"><pre> 85</pre></span><pre>            entry = Entry.published.get(slug=entry_slug)</pre></div>
<div class="cov"><span class="num"><pre> 86</pre></span><pre>            if not entry.pingback_enabled:</pre></div>
<div class="cov"><span class="num"><pre> 87</pre></span><pre>                return TARGET_IS_NOT_PINGABLE</pre></div>
<div class="cov"><span class="num"><pre> 88</pre></span><pre>        except (Entry.DoesNotExist, IndexError):</pre></div>
<div class="cov"><span class="num"><pre> 89</pre></span><pre>            return TARGET_IS_NOT_PINGABLE</pre></div>
<div class="skip"><span class="num"><pre> 90</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 91</pre></span><pre>        soup = BeautifulSoup(document)</pre></div>
<div class="cov"><span class="num"><pre> 92</pre></span><pre>        title = soup.find('title')</pre></div>
<div class="cov"><span class="num"><pre> 93</pre></span><pre>        title = title and strip_tags(title) or _('No title')</pre></div>
<div class="cov"><span class="num"><pre> 94</pre></span><pre>        description = generate_pingback_content(soup, target,</pre></div>
<div class="cov"><span class="num"><pre> 95</pre></span><pre>                                                PINGBACK_CONTENT_LENGTH)</pre></div>
<div class="skip"><span class="num"><pre> 96</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 97</pre></span><pre>        comment, created = Comment.objects.get_or_create(</pre></div>
<div class="cov"><span class="num"><pre> 98</pre></span><pre>            content_type=ContentType.objects.get_for_model(Entry),</pre></div>
<div class="cov"><span class="num"><pre> 99</pre></span><pre>            object_pk=entry.pk, user_url=source, site=site,</pre></div>
<div class="cov"><span class="num"><pre>100</pre></span><pre>            defaults={'comment': description, 'user_name': title})</pre></div>
<div class="cov"><span class="num"><pre>101</pre></span><pre>        if created:</pre></div>
<div class="cov"><span class="num"><pre>102</pre></span><pre>            user = entry.authors.all()[0]</pre></div>
<div class="cov"><span class="num"><pre>103</pre></span><pre>            comment.flags.create(user=user, flag='pingback')</pre></div>
<div class="cov"><span class="num"><pre>104</pre></span><pre>            return 'Pingback from %s to %s registered.' % (source, target)</pre></div>
<div class="cov"><span class="num"><pre>105</pre></span><pre>        return PINGBACK_ALREADY_REGISTERED</pre></div>
<div class="cov"><span class="num"><pre>106</pre></span><pre>    except:</pre></div>
<div class="cov"><span class="num"><pre>107</pre></span><pre>        return UNDEFINED_ERROR</pre></div>
<div class="skip"><span class="num"><pre>108</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>109</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>110</pre></span><pre>@xmlrpc_func(returns='string[]', args=['string'])</pre></div>
<div class="cov"><span class="num"><pre>111</pre></span><pre>def pingback_extensions_get_pingbacks(target):</pre></div>
<div class="cov"><span class="num"><pre>112</pre></span><pre>    &quot;&quot;&quot;pingback.extensions.getPingbacks(url) =&gt; '[url, url, ...]'</pre></div>
<div class="skip"><span class="num"><pre>113</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>114</pre></span><pre>    Returns an array of URLs that link to the specified url.</pre></div>
<div class="skip"><span class="num"><pre>115</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>116</pre></span><pre>    See: http://www.aquarionics.com/misc/archives/blogite/0198.html&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>117</pre></span><pre>    site = Site.objects.get_current()</pre></div>
<div class="skip"><span class="num"><pre>118</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>119</pre></span><pre>    scheme, netloc, path, query, fragment = urlsplit(target)</pre></div>
<div class="cov"><span class="num"><pre>120</pre></span><pre>    if netloc != site.domain:</pre></div>
<div class="cov"><span class="num"><pre>121</pre></span><pre>        return TARGET_DOES_NOT_EXIST</pre></div>
<div class="skip"><span class="num"><pre>122</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>123</pre></span><pre>    resolver = get_resolver(None)</pre></div>
<div class="cov"><span class="num"><pre>124</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>125</pre></span><pre>        resolver.resolve(path)</pre></div>
<div class="cov"><span class="num"><pre>126</pre></span><pre>    except Resolver404:</pre></div>
<div class="cov"><span class="num"><pre>127</pre></span><pre>        return TARGET_DOES_NOT_EXIST</pre></div>
<div class="skip"><span class="num"><pre>128</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>129</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>130</pre></span><pre>        entry_slug = [bit for bit in path.split('/') if bit][-1]</pre></div>
<div class="cov"><span class="num"><pre>131</pre></span><pre>        entry = Entry.published.get(slug=entry_slug)</pre></div>
<div class="cov"><span class="num"><pre>132</pre></span><pre>    except (Entry.DoesNotExist, IndexError):</pre></div>
<div class="cov"><span class="num"><pre>133</pre></span><pre>        return TARGET_IS_NOT_PINGABLE</pre></div>
<div class="skip"><span class="num"><pre>134</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>135</pre></span><pre>    return [pingback.user_url for pingback in entry.pingbacks]</pre></div>
<div class="skip"><span class="num"><pre>136</pre></span><pre></pre></div>
</div>
</body>
</html>
