<html>
<head>
<title>zinnia.managers</title>
</head>
<body>
zinnia.managers
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 62 lines<br/>
Missed: 2 lines<br/>
Skipped 19 lines<br/>
Percent: 96 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre> 1</pre></span><pre>&quot;&quot;&quot;Managers of Zinnia&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 2</pre></span><pre>from datetime import datetime</pre></div>
<div class="skip"><span class="num"><pre> 3</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 4</pre></span><pre>from django.db import models</pre></div>
<div class="cov"><span class="num"><pre> 5</pre></span><pre>from django.contrib.sites.models import Site</pre></div>
<div class="skip"><span class="num"><pre> 6</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 7</pre></span><pre>DRAFT = 0</pre></div>
<div class="cov"><span class="num"><pre> 8</pre></span><pre>HIDDEN = 1</pre></div>
<div class="cov"><span class="num"><pre> 9</pre></span><pre>PUBLISHED = 2</pre></div>
<div class="skip"><span class="num"><pre>10</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>11</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>12</pre></span><pre>def tags_published():</pre></div>
<div class="cov"><span class="num"><pre>13</pre></span><pre>    &quot;&quot;&quot;Return the published tags&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>14</pre></span><pre>    from tagging.models import Tag</pre></div>
<div class="cov"><span class="num"><pre>15</pre></span><pre>    from zinnia.models import Entry</pre></div>
<div class="cov"><span class="num"><pre>16</pre></span><pre>    tags_entry_published = Tag.objects.usage_for_queryset(</pre></div>
<div class="cov"><span class="num"><pre>17</pre></span><pre>        Entry.published.all())</pre></div>
<div class="skip"><span class="num"><pre>18</pre></span><pre>    # Need to do that until the issue #44 of django-tagging is fixed</pre></div>
<div class="cov"><span class="num"><pre>19</pre></span><pre>    return Tag.objects.filter(name__in=[t.name for t in tags_entry_published])</pre></div>
<div class="skip"><span class="num"><pre>20</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>21</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>22</pre></span><pre>class AuthorPublishedManager(models.Manager):</pre></div>
<div class="cov"><span class="num"><pre>23</pre></span><pre>    &quot;&quot;&quot;Manager to retrieve published authors&quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre>24</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>25</pre></span><pre>    def get_query_set(self):</pre></div>
<div class="cov"><span class="num"><pre>26</pre></span><pre>        &quot;&quot;&quot;Return published authors&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>27</pre></span><pre>        now = datetime.now()</pre></div>
<div class="cov"><span class="num"><pre>28</pre></span><pre>        return super(AuthorPublishedManager, self).get_query_set().filter(</pre></div>
<div class="cov"><span class="num"><pre>29</pre></span><pre>            entry__status=PUBLISHED,</pre></div>
<div class="cov"><span class="num"><pre>30</pre></span><pre>            entry__start_publication__lte=now,</pre></div>
<div class="cov"><span class="num"><pre>31</pre></span><pre>            entry__end_publication__gt=now,</pre></div>
<div class="cov"><span class="num"><pre>32</pre></span><pre>            entry__sites=Site.objects.get_current()</pre></div>
<div class="cov"><span class="num"><pre>33</pre></span><pre>            ).distinct()</pre></div>
<div class="skip"><span class="num"><pre>34</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>35</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>36</pre></span><pre>def entries_published(queryset):</pre></div>
<div class="cov"><span class="num"><pre>37</pre></span><pre>    &quot;&quot;&quot;Return only the entries published&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>38</pre></span><pre>    now = datetime.now()</pre></div>
<div class="cov"><span class="num"><pre>39</pre></span><pre>    return queryset.filter(status=PUBLISHED,</pre></div>
<div class="cov"><span class="num"><pre>40</pre></span><pre>                           start_publication__lte=now,</pre></div>
<div class="cov"><span class="num"><pre>41</pre></span><pre>                           end_publication__gt=now,</pre></div>
<div class="cov"><span class="num"><pre>42</pre></span><pre>                           sites=Site.objects.get_current())</pre></div>
<div class="skip"><span class="num"><pre>43</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>44</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>45</pre></span><pre>class EntryPublishedManager(models.Manager):</pre></div>
<div class="cov"><span class="num"><pre>46</pre></span><pre>    &quot;&quot;&quot;Manager to retrieve published entries&quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre>47</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>48</pre></span><pre>    def get_query_set(self):</pre></div>
<div class="cov"><span class="num"><pre>49</pre></span><pre>        &quot;&quot;&quot;Return published entries&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>50</pre></span><pre>        return entries_published(</pre></div>
<div class="cov"><span class="num"><pre>51</pre></span><pre>            super(EntryPublishedManager, self).get_query_set())</pre></div>
<div class="skip"><span class="num"><pre>52</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>53</pre></span><pre>    def on_site(self):</pre></div>
<div class="cov"><span class="num"><pre>54</pre></span><pre>        &quot;&quot;&quot;Return entries published on current site&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>55</pre></span><pre>        return super(EntryPublishedManager, self).get_query_set(</pre></div>
<div class="cov"><span class="num"><pre>56</pre></span><pre>            ).filter(sites=Site.objects.get_current())</pre></div>
<div class="skip"><span class="num"><pre>57</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>58</pre></span><pre>    def search(self, pattern):</pre></div>
<div class="cov"><span class="num"><pre>59</pre></span><pre>        &quot;&quot;&quot;Top level search method on entries&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>60</pre></span><pre>        try:</pre></div>
<div class="cov"><span class="num"><pre>61</pre></span><pre>            return self.advanced_search(pattern)</pre></div>
<div class="nocov"><span class="num"><pre>62</pre></span><pre>        except:</pre></div>
<div class="nocov"><span class="num"><pre>63</pre></span><pre>            return self.basic_search(pattern)</pre></div>
<div class="skip"><span class="num"><pre>64</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>65</pre></span><pre>    def advanced_search(self, pattern):</pre></div>
<div class="cov"><span class="num"><pre>66</pre></span><pre>        &quot;&quot;&quot;Advanced search on entries&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>67</pre></span><pre>        from zinnia.search import advanced_search</pre></div>
<div class="cov"><span class="num"><pre>68</pre></span><pre>        return advanced_search(pattern)</pre></div>
<div class="skip"><span class="num"><pre>69</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>70</pre></span><pre>    def basic_search(self, pattern):</pre></div>
<div class="cov"><span class="num"><pre>71</pre></span><pre>        &quot;&quot;&quot;Basic search on entries&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>72</pre></span><pre>        lookup = None</pre></div>
<div class="cov"><span class="num"><pre>73</pre></span><pre>        for pattern in pattern.split():</pre></div>
<div class="cov"><span class="num"><pre>74</pre></span><pre>            query_part = models.Q(content__icontains=pattern) | \</pre></div>
<div class="cov"><span class="num"><pre>75</pre></span><pre>                         models.Q(excerpt__icontains=pattern) | \</pre></div>
<div class="cov"><span class="num"><pre>76</pre></span><pre>                         models.Q(title__icontains=pattern)</pre></div>
<div class="cov"><span class="num"><pre>77</pre></span><pre>            if lookup is None:</pre></div>
<div class="cov"><span class="num"><pre>78</pre></span><pre>                lookup = query_part</pre></div>
<div class="cov"><span class="num"><pre>79</pre></span><pre>            else:</pre></div>
<div class="cov"><span class="num"><pre>80</pre></span><pre>                lookup |= query_part</pre></div>
<div class="skip"><span class="num"><pre>81</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>82</pre></span><pre>        return self.get_query_set().filter(lookup)</pre></div>
<div class="skip"><span class="num"><pre>83</pre></span><pre></pre></div>
</div>
</body>
</html>
