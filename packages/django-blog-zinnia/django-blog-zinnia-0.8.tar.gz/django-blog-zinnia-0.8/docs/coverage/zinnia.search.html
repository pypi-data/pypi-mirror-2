<html>
<head>
<title>zinnia.search</title>
</head>
<body>
zinnia.search
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 109 lines<br/>
Missed: 0 lines<br/>
Skipped 19 lines<br/>
Percent: 100 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>  1</pre></span><pre>&quot;&quot;&quot;Search module with complex query parsing for Zinnia&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>  2</pre></span><pre>from pyparsing import Word</pre></div>
<div class="cov"><span class="num"><pre>  3</pre></span><pre>from pyparsing import alphas</pre></div>
<div class="cov"><span class="num"><pre>  4</pre></span><pre>from pyparsing import WordEnd</pre></div>
<div class="cov"><span class="num"><pre>  5</pre></span><pre>from pyparsing import Combine</pre></div>
<div class="cov"><span class="num"><pre>  6</pre></span><pre>from pyparsing import opAssoc</pre></div>
<div class="cov"><span class="num"><pre>  7</pre></span><pre>from pyparsing import Optional</pre></div>
<div class="cov"><span class="num"><pre>  8</pre></span><pre>from pyparsing import OneOrMore</pre></div>
<div class="cov"><span class="num"><pre>  9</pre></span><pre>from pyparsing import StringEnd</pre></div>
<div class="cov"><span class="num"><pre> 10</pre></span><pre>from pyparsing import printables</pre></div>
<div class="cov"><span class="num"><pre> 11</pre></span><pre>from pyparsing import quotedString</pre></div>
<div class="cov"><span class="num"><pre> 12</pre></span><pre>from pyparsing import removeQuotes</pre></div>
<div class="cov"><span class="num"><pre> 13</pre></span><pre>from pyparsing import ParseResults</pre></div>
<div class="cov"><span class="num"><pre> 14</pre></span><pre>from pyparsing import CaselessLiteral</pre></div>
<div class="cov"><span class="num"><pre> 15</pre></span><pre>from pyparsing import operatorPrecedence</pre></div>
<div class="skip"><span class="num"><pre> 16</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 17</pre></span><pre>from django.db.models import Q</pre></div>
<div class="skip"><span class="num"><pre> 18</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 19</pre></span><pre>from zinnia.models import Entry</pre></div>
<div class="skip"><span class="num"><pre> 20</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 21</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 22</pre></span><pre>def createQ(token):</pre></div>
<div class="cov"><span class="num"><pre> 23</pre></span><pre>    &quot;&quot;&quot;Creates the Q() object&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 24</pre></span><pre>    meta = getattr(token, 'meta', None)</pre></div>
<div class="cov"><span class="num"><pre> 25</pre></span><pre>    query = getattr(token, 'query', '')</pre></div>
<div class="cov"><span class="num"><pre> 26</pre></span><pre>    wildcards = None</pre></div>
<div class="skip"><span class="num"><pre> 27</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 28</pre></span><pre>    if isinstance(query, basestring):  # Unicode -&gt; Quoted string</pre></div>
<div class="cov"><span class="num"><pre> 29</pre></span><pre>        search = query</pre></div>
<div class="cov"><span class="num"><pre> 30</pre></span><pre>    else:  # List -&gt; No quoted string (possible wildcards)</pre></div>
<div class="cov"><span class="num"><pre> 31</pre></span><pre>        if len(query) == 1:</pre></div>
<div class="cov"><span class="num"><pre> 32</pre></span><pre>            search = query[0]</pre></div>
<div class="cov"><span class="num"><pre> 33</pre></span><pre>        elif len(query) == 3:</pre></div>
<div class="cov"><span class="num"><pre> 34</pre></span><pre>            wildcards = 'BOTH'</pre></div>
<div class="cov"><span class="num"><pre> 35</pre></span><pre>            search = query[1]</pre></div>
<div class="cov"><span class="num"><pre> 36</pre></span><pre>        elif len(query) == 2:</pre></div>
<div class="cov"><span class="num"><pre> 37</pre></span><pre>            if query[0] == '*':</pre></div>
<div class="cov"><span class="num"><pre> 38</pre></span><pre>                wildcards = 'START'</pre></div>
<div class="cov"><span class="num"><pre> 39</pre></span><pre>                search = query[1]</pre></div>
<div class="cov"><span class="num"><pre> 40</pre></span><pre>            else:</pre></div>
<div class="cov"><span class="num"><pre> 41</pre></span><pre>                wildcards = 'END'</pre></div>
<div class="cov"><span class="num"><pre> 42</pre></span><pre>                search = query[0]</pre></div>
<div class="skip"><span class="num"><pre> 43</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 44</pre></span><pre>    if not meta:</pre></div>
<div class="cov"><span class="num"><pre> 45</pre></span><pre>        return Q(content__icontains=search) | \</pre></div>
<div class="cov"><span class="num"><pre> 46</pre></span><pre>               Q(excerpt__icontains=search) | \</pre></div>
<div class="cov"><span class="num"><pre> 47</pre></span><pre>               Q(title__icontains=search)</pre></div>
<div class="skip"><span class="num"><pre> 48</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 49</pre></span><pre>    if meta == 'category':</pre></div>
<div class="cov"><span class="num"><pre> 50</pre></span><pre>        if wildcards == 'BOTH':</pre></div>
<div class="cov"><span class="num"><pre> 51</pre></span><pre>            return Q(categories__title__icontains=search) | \</pre></div>
<div class="cov"><span class="num"><pre> 52</pre></span><pre>                    Q(categories__slug__icontains=search)</pre></div>
<div class="cov"><span class="num"><pre> 53</pre></span><pre>        elif wildcards == 'START':</pre></div>
<div class="cov"><span class="num"><pre> 54</pre></span><pre>            return Q(categories__title__iendswith=search) | \</pre></div>
<div class="cov"><span class="num"><pre> 55</pre></span><pre>                    Q(categories__slug__iendswith=search)</pre></div>
<div class="cov"><span class="num"><pre> 56</pre></span><pre>        elif wildcards == 'END':</pre></div>
<div class="cov"><span class="num"><pre> 57</pre></span><pre>            return Q(categories__title__istartswith=search) | \</pre></div>
<div class="cov"><span class="num"><pre> 58</pre></span><pre>                    Q(categories__slug__istartswith=search)</pre></div>
<div class="cov"><span class="num"><pre> 59</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre> 60</pre></span><pre>            return Q(categories__title__iexact=search) | \</pre></div>
<div class="cov"><span class="num"><pre> 61</pre></span><pre>                    Q(categories__slug__iexact=search)</pre></div>
<div class="cov"><span class="num"><pre> 62</pre></span><pre>    elif meta == 'author':</pre></div>
<div class="cov"><span class="num"><pre> 63</pre></span><pre>        if wildcards == 'BOTH':</pre></div>
<div class="cov"><span class="num"><pre> 64</pre></span><pre>            return Q(authors__username__icontains=search)</pre></div>
<div class="cov"><span class="num"><pre> 65</pre></span><pre>        elif wildcards == 'START':</pre></div>
<div class="cov"><span class="num"><pre> 66</pre></span><pre>            return Q(authors__username__iendswith=search)</pre></div>
<div class="cov"><span class="num"><pre> 67</pre></span><pre>        elif wildcards == 'END':</pre></div>
<div class="cov"><span class="num"><pre> 68</pre></span><pre>            return Q(authors__username__istartswith=search)</pre></div>
<div class="cov"><span class="num"><pre> 69</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre> 70</pre></span><pre>            return Q(authors__username__iexact=search)</pre></div>
<div class="cov"><span class="num"><pre> 71</pre></span><pre>    elif meta == 'tag':  # TODO: tags ignore wildcards</pre></div>
<div class="cov"><span class="num"><pre> 72</pre></span><pre>        return Q(tags__icontains=search)</pre></div>
<div class="skip"><span class="num"><pre> 73</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 74</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 75</pre></span><pre>def unionQ(token):</pre></div>
<div class="cov"><span class="num"><pre> 76</pre></span><pre>    &quot;&quot;&quot;Appends all the Q() objects&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 77</pre></span><pre>    query = Q()</pre></div>
<div class="cov"><span class="num"><pre> 78</pre></span><pre>    operation = 'and'</pre></div>
<div class="cov"><span class="num"><pre> 79</pre></span><pre>    negation = False</pre></div>
<div class="skip"><span class="num"><pre> 80</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 81</pre></span><pre>    for t in token:</pre></div>
<div class="cov"><span class="num"><pre> 82</pre></span><pre>        if type(t) is ParseResults:  # See tokens recursively</pre></div>
<div class="cov"><span class="num"><pre> 83</pre></span><pre>            query &amp;= unionQ(t)</pre></div>
<div class="cov"><span class="num"><pre> 84</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre> 85</pre></span><pre>            if t in ('or', 'and'):  # Set the new op and go to next token</pre></div>
<div class="cov"><span class="num"><pre> 86</pre></span><pre>                operation = t</pre></div>
<div class="cov"><span class="num"><pre> 87</pre></span><pre>            elif t == '-':  # Next tokens needs to be negated</pre></div>
<div class="cov"><span class="num"><pre> 88</pre></span><pre>                negation = True</pre></div>
<div class="cov"><span class="num"><pre> 89</pre></span><pre>            else:  # Append to query the token</pre></div>
<div class="cov"><span class="num"><pre> 90</pre></span><pre>                if negation:</pre></div>
<div class="cov"><span class="num"><pre> 91</pre></span><pre>                    t = ~t</pre></div>
<div class="cov"><span class="num"><pre> 92</pre></span><pre>                if operation == 'or':</pre></div>
<div class="cov"><span class="num"><pre> 93</pre></span><pre>                    query |= t</pre></div>
<div class="cov"><span class="num"><pre> 94</pre></span><pre>                else:</pre></div>
<div class="cov"><span class="num"><pre> 95</pre></span><pre>                    query &amp;= t</pre></div>
<div class="cov"><span class="num"><pre> 96</pre></span><pre>    return query</pre></div>
<div class="skip"><span class="num"><pre> 97</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 98</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 99</pre></span><pre>NO_BRTS = printables.replace('(', '').replace(')', '')</pre></div>
<div class="cov"><span class="num"><pre>100</pre></span><pre>SINGLE = Word(NO_BRTS.replace('*', ''))</pre></div>
<div class="cov"><span class="num"><pre>101</pre></span><pre>WILDCARDS = Optional('*') + SINGLE + Optional('*') + WordEnd(wordChars=NO_BRTS)</pre></div>
<div class="cov"><span class="num"><pre>102</pre></span><pre>QUOTED = quotedString.setParseAction(removeQuotes)</pre></div>
<div class="skip"><span class="num"><pre>103</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>104</pre></span><pre>OPER_AND = CaselessLiteral('and')</pre></div>
<div class="cov"><span class="num"><pre>105</pre></span><pre>OPER_OR = CaselessLiteral('or')</pre></div>
<div class="cov"><span class="num"><pre>106</pre></span><pre>OPER_NOT = '-'</pre></div>
<div class="skip"><span class="num"><pre>107</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>108</pre></span><pre>TERM = Combine(Optional(Word(alphas).setResultsName('meta') + ':') +</pre></div>
<div class="cov"><span class="num"><pre>109</pre></span><pre>               (QUOTED.setResultsName('query') |</pre></div>
<div class="cov"><span class="num"><pre>110</pre></span><pre>                WILDCARDS.setResultsName('query')))</pre></div>
<div class="cov"><span class="num"><pre>111</pre></span><pre>TERM.setParseAction(createQ)</pre></div>
<div class="skip"><span class="num"><pre>112</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>113</pre></span><pre>EXPRESSION = operatorPrecedence(TERM, [</pre></div>
<div class="cov"><span class="num"><pre>114</pre></span><pre>    (OPER_NOT, 1, opAssoc.RIGHT),</pre></div>
<div class="cov"><span class="num"><pre>115</pre></span><pre>    (OPER_OR, 2, opAssoc.LEFT),</pre></div>
<div class="cov"><span class="num"><pre>116</pre></span><pre>    (Optional(OPER_AND, default='and'), 2, opAssoc.LEFT)])</pre></div>
<div class="cov"><span class="num"><pre>117</pre></span><pre>EXPRESSION.setParseAction(unionQ)</pre></div>
<div class="skip"><span class="num"><pre>118</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>119</pre></span><pre>QUERY = OneOrMore(EXPRESSION) + StringEnd()</pre></div>
<div class="cov"><span class="num"><pre>120</pre></span><pre>QUERY.setParseAction(unionQ)</pre></div>
<div class="skip"><span class="num"><pre>121</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>122</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>123</pre></span><pre>def advanced_search(pattern):</pre></div>
<div class="cov"><span class="num"><pre>124</pre></span><pre>    &quot;&quot;&quot;Parse the grammar of a pattern</pre></div>
<div class="cov"><span class="num"><pre>125</pre></span><pre>    and build a queryset with it&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>126</pre></span><pre>    query_parsed = QUERY.parseString(pattern)</pre></div>
<div class="cov"><span class="num"><pre>127</pre></span><pre>    return Entry.published.filter(query_parsed[0]).distinct()</pre></div>
<div class="skip"><span class="num"><pre>128</pre></span><pre></pre></div>
</div>
</body>
</html>
