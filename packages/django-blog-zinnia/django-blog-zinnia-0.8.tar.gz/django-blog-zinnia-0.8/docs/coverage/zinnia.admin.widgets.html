<html>
<head>
<title>zinnia.admin.widgets</title>
</head>
<body>
zinnia.admin.widgets
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 58 lines<br/>
Missed: 34 lines<br/>
Skipped 17 lines<br/>
Percent: 63 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>  1</pre></span><pre>&quot;&quot;&quot;Widgets for Zinnia admin&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>  2</pre></span><pre>from itertools import chain</pre></div>
<div class="skip"><span class="num"><pre>  3</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  4</pre></span><pre>from django import forms</pre></div>
<div class="cov"><span class="num"><pre>  5</pre></span><pre>from django.conf import settings</pre></div>
<div class="cov"><span class="num"><pre>  6</pre></span><pre>from django.contrib.admin import widgets</pre></div>
<div class="cov"><span class="num"><pre>  7</pre></span><pre>from django.utils.html import escape</pre></div>
<div class="cov"><span class="num"><pre>  8</pre></span><pre>from django.utils.html import conditional_escape</pre></div>
<div class="cov"><span class="num"><pre>  9</pre></span><pre>from django.utils.encoding import smart_unicode</pre></div>
<div class="cov"><span class="num"><pre> 10</pre></span><pre>from django.utils.encoding import force_unicode</pre></div>
<div class="skip"><span class="num"><pre> 11</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 12</pre></span><pre>from zinnia.settings import MEDIA_URL</pre></div>
<div class="skip"><span class="num"><pre> 13</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 14</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 15</pre></span><pre>class TreeNodeChoiceField(forms.ModelChoiceField):</pre></div>
<div class="cov"><span class="num"><pre> 16</pre></span><pre>    &quot;&quot;&quot;Duplicating the TreeNodeChoiceField bundled in django-mptt</pre></div>
<div class="cov"><span class="num"><pre> 17</pre></span><pre>    to avoid conflict with the TreeNodeChoiceField bundled in django-cms...&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 18</pre></span><pre>    def __init__(self, level_indicator=u'---', *args, **kwargs):</pre></div>
<div class="cov"><span class="num"><pre> 19</pre></span><pre>        self.level_indicator = level_indicator</pre></div>
<div class="cov"><span class="num"><pre> 20</pre></span><pre>        if kwargs.get('required', True) and not 'empty_label' in kwargs:</pre></div>
<div class="nocov"><span class="num"><pre> 21</pre></span><pre>            kwargs['empty_label'] = None</pre></div>
<div class="cov"><span class="num"><pre> 22</pre></span><pre>        super(TreeNodeChoiceField, self).__init__(*args, **kwargs)</pre></div>
<div class="skip"><span class="num"><pre> 23</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 24</pre></span><pre>    def label_from_instance(self, obj):</pre></div>
<div class="cov"><span class="num"><pre> 25</pre></span><pre>        &quot;&quot;&quot;Creates labels which represent the tree level of each node</pre></div>
<div class="cov"><span class="num"><pre> 26</pre></span><pre>        when generating option labels.&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 27</pre></span><pre>        return u'%s %s' % (self.level_indicator * getattr(obj,</pre></div>
<div class="nocov"><span class="num"><pre> 28</pre></span><pre>                                                          obj._meta.level_attr),</pre></div>
<div class="nocov"><span class="num"><pre> 29</pre></span><pre>                           smart_unicode(obj))</pre></div>
<div class="skip"><span class="num"><pre> 30</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 31</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 32</pre></span><pre>class MPTTModelChoiceIterator(forms.models.ModelChoiceIterator):</pre></div>
<div class="cov"><span class="num"><pre> 33</pre></span><pre>    &quot;&quot;&quot;MPTT version of ModelChoiceIterator&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 34</pre></span><pre>    def choice(self, obj):</pre></div>
<div class="cov"><span class="num"><pre> 35</pre></span><pre>        &quot;&quot;&quot;Overriding choice method&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 36</pre></span><pre>        tree_id = getattr(obj, getattr(self.queryset.model._meta,</pre></div>
<div class="nocov"><span class="num"><pre> 37</pre></span><pre>                                       'tree_id_atrr', 'tree_id'), 0)</pre></div>
<div class="nocov"><span class="num"><pre> 38</pre></span><pre>        left = getattr(obj, getattr(self.queryset.model._meta,</pre></div>
<div class="nocov"><span class="num"><pre> 39</pre></span><pre>                                    'left_atrr', 'lft'), 0)</pre></div>
<div class="nocov"><span class="num"><pre> 40</pre></span><pre>        return super(MPTTModelChoiceIterator,</pre></div>
<div class="nocov"><span class="num"><pre> 41</pre></span><pre>                     self).choice(obj) + ((tree_id, left),)</pre></div>
<div class="skip"><span class="num"><pre> 42</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 43</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 44</pre></span><pre>class MPTTModelMultipleChoiceField(forms.ModelMultipleChoiceField):</pre></div>
<div class="cov"><span class="num"><pre> 45</pre></span><pre>    &quot;&quot;&quot;MPTT version of ModelMultipleChoiceField&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 46</pre></span><pre>    def label_from_instance(self, obj):</pre></div>
<div class="cov"><span class="num"><pre> 47</pre></span><pre>        &quot;&quot;&quot;Overriding label_from_instance&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 48</pre></span><pre>        level = getattr(obj, getattr(self.queryset.model._meta,</pre></div>
<div class="nocov"><span class="num"><pre> 49</pre></span><pre>                                     'level_attr', 'level'), 0)</pre></div>
<div class="nocov"><span class="num"><pre> 50</pre></span><pre>        return u'%s %s' % ('-' * level, smart_unicode(obj))</pre></div>
<div class="skip"><span class="num"><pre> 51</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 52</pre></span><pre>    def _get_choices(self):</pre></div>
<div class="cov"><span class="num"><pre> 53</pre></span><pre>        &quot;&quot;&quot;Overriding _get_choices&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 54</pre></span><pre>        if hasattr(self, '_choices'):</pre></div>
<div class="nocov"><span class="num"><pre> 55</pre></span><pre>            return self._choices</pre></div>
<div class="cov"><span class="num"><pre> 56</pre></span><pre>        return MPTTModelChoiceIterator(self)</pre></div>
<div class="skip"><span class="num"><pre> 57</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 58</pre></span><pre>    choices = property(_get_choices, forms.ChoiceField._set_choices)</pre></div>
<div class="skip"><span class="num"><pre> 59</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 60</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 61</pre></span><pre>class MPTTFilteredSelectMultiple(widgets.FilteredSelectMultiple):</pre></div>
<div class="cov"><span class="num"><pre> 62</pre></span><pre>    &quot;&quot;&quot;MPTT version of FilteredSelectMultiple&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 63</pre></span><pre>    def __init__(self, verbose_name, is_stacked, attrs=None, choices=()):</pre></div>
<div class="cov"><span class="num"><pre> 64</pre></span><pre>        super(MPTTFilteredSelectMultiple, self).__init__(</pre></div>
<div class="cov"><span class="num"><pre> 65</pre></span><pre>            verbose_name, is_stacked, attrs, choices)</pre></div>
<div class="skip"><span class="num"><pre> 66</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 67</pre></span><pre>    def render_options(self, choices, selected_choices):</pre></div>
<div class="cov"><span class="num"><pre> 68</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 69</pre></span><pre>        This is copy'n'pasted from django.forms.widgets Select(Widget)</pre></div>
<div class="cov"><span class="num"><pre> 70</pre></span><pre>        change to the for loop and render_option so they will unpack</pre></div>
<div class="cov"><span class="num"><pre> 71</pre></span><pre>        and use our extra tuple of mptt sort fields (if you pass in</pre></div>
<div class="cov"><span class="num"><pre> 72</pre></span><pre>        some default choices for this field, make sure they have the</pre></div>
<div class="cov"><span class="num"><pre> 73</pre></span><pre>        extra tuple too!)</pre></div>
<div class="cov"><span class="num"><pre> 74</pre></span><pre>        &quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 75</pre></span><pre>        def render_option(option_value, option_label, sort_fields):</pre></div>
<div class="cov"><span class="num"><pre> 76</pre></span><pre>            &quot;&quot;&quot;Inner scope render_option&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 77</pre></span><pre>            option_value = force_unicode(option_value)</pre></div>
<div class="nocov"><span class="num"><pre> 78</pre></span><pre>            selected_html = (option_value in selected_choices) \</pre></div>
<div class="nocov"><span class="num"><pre> 79</pre></span><pre>                            and u' selected=&quot;selected&quot;' or ''</pre></div>
<div class="nocov"><span class="num"><pre> 80</pre></span><pre>            return u'&lt;option value=&quot;%s&quot; data-tree-id=&quot;%s&quot; ' \</pre></div>
<div class="nocov"><span class="num"><pre> 81</pre></span><pre>                   'data-left-value=&quot;%s&quot;%s&gt;%s&lt;/option&gt;' % (</pre></div>
<div class="nocov"><span class="num"><pre> 82</pre></span><pre>                escape(option_value),</pre></div>
<div class="nocov"><span class="num"><pre> 83</pre></span><pre>                sort_fields[0],</pre></div>
<div class="nocov"><span class="num"><pre> 84</pre></span><pre>                sort_fields[1],</pre></div>
<div class="nocov"><span class="num"><pre> 85</pre></span><pre>                selected_html,</pre></div>
<div class="nocov"><span class="num"><pre> 86</pre></span><pre>                conditional_escape(force_unicode(option_label)),</pre></div>
<div class="nocov"><span class="num"><pre> 87</pre></span><pre>                )</pre></div>
<div class="skip"><span class="num"><pre> 88</pre></span><pre>        # Normalize to strings.</pre></div>
<div class="cov"><span class="num"><pre> 89</pre></span><pre>        selected_choices = set([force_unicode(v) for v in selected_choices])</pre></div>
<div class="cov"><span class="num"><pre> 90</pre></span><pre>        output = []</pre></div>
<div class="cov"><span class="num"><pre> 91</pre></span><pre>        for option_value, option_label, sort_fields in chain(</pre></div>
<div class="cov"><span class="num"><pre> 92</pre></span><pre>            self.choices, choices):</pre></div>
<div class="nocov"><span class="num"><pre> 93</pre></span><pre>            if isinstance(option_label, (list, tuple)):</pre></div>
<div class="nocov"><span class="num"><pre> 94</pre></span><pre>                output.append(u'&lt;optgroup label=&quot;%s&quot;&gt;' % escape(</pre></div>
<div class="nocov"><span class="num"><pre> 95</pre></span><pre>                    force_unicode(option_value)))</pre></div>
<div class="nocov"><span class="num"><pre> 96</pre></span><pre>                for option in option_label:</pre></div>
<div class="nocov"><span class="num"><pre> 97</pre></span><pre>                    output.append(render_option(*option))</pre></div>
<div class="nocov"><span class="num"><pre> 98</pre></span><pre>                output.append(u'&lt;/optgroup&gt;')</pre></div>
<div class="nocov"><span class="num"><pre> 99</pre></span><pre>            else:</pre></div>
<div class="nocov"><span class="num"><pre>100</pre></span><pre>                output.append(render_option(option_value, option_label,</pre></div>
<div class="nocov"><span class="num"><pre>101</pre></span><pre>                                            sort_fields))</pre></div>
<div class="cov"><span class="num"><pre>102</pre></span><pre>        return u'\n'.join(output)</pre></div>
<div class="skip"><span class="num"><pre>103</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>104</pre></span><pre>    class Media:</pre></div>
<div class="cov"><span class="num"><pre>105</pre></span><pre>        &quot;&quot;&quot;MPTTFilteredSelectMultiple's Media&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>106</pre></span><pre>        js = (settings.ADMIN_MEDIA_PREFIX + 'js/core.js',</pre></div>
<div class="cov"><span class="num"><pre>107</pre></span><pre>              MEDIA_URL + 'js/mptt_m2m_selectbox.js',</pre></div>
<div class="cov"><span class="num"><pre>108</pre></span><pre>              settings.ADMIN_MEDIA_PREFIX + 'js/SelectFilter2.js',)</pre></div>
<div class="skip"><span class="num"><pre>109</pre></span><pre></pre></div>
</div>
</body>
</html>
