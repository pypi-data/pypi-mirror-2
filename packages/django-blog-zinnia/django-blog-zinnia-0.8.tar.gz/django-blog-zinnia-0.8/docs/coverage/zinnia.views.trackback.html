<html>
<head>
<title>zinnia.views.trackback</title>
</head>
<body>
zinnia.views.trackback
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 36 lines<br/>
Missed: 0 lines<br/>
Skipped 10 lines<br/>
Percent: 100 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre> 1</pre></span><pre>&quot;&quot;&quot;Views for Zinnia trackback&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 2</pre></span><pre>from django.shortcuts import redirect</pre></div>
<div class="cov"><span class="num"><pre> 3</pre></span><pre>from django.shortcuts import get_object_or_404</pre></div>
<div class="cov"><span class="num"><pre> 4</pre></span><pre>from django.contrib.sites.models import Site</pre></div>
<div class="cov"><span class="num"><pre> 5</pre></span><pre>from django.contrib.comments.models import Comment</pre></div>
<div class="cov"><span class="num"><pre> 6</pre></span><pre>from django.views.decorators.csrf import csrf_exempt</pre></div>
<div class="cov"><span class="num"><pre> 7</pre></span><pre>from django.contrib.contenttypes.models import ContentType</pre></div>
<div class="cov"><span class="num"><pre> 8</pre></span><pre>from django.views.generic.simple import direct_to_template</pre></div>
<div class="skip"><span class="num"><pre> 9</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>10</pre></span><pre>from zinnia.models import Entry</pre></div>
<div class="skip"><span class="num"><pre>11</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>12</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>13</pre></span><pre>@csrf_exempt</pre></div>
<div class="cov"><span class="num"><pre>14</pre></span><pre>def entry_trackback(request, slug):</pre></div>
<div class="cov"><span class="num"><pre>15</pre></span><pre>    &quot;&quot;&quot;Set a TrackBack for an Entry&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>16</pre></span><pre>    entry = get_object_or_404(Entry.published, slug=slug)</pre></div>
<div class="skip"><span class="num"><pre>17</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>18</pre></span><pre>    if request.POST.get('url'):</pre></div>
<div class="cov"><span class="num"><pre>19</pre></span><pre>        error = ''</pre></div>
<div class="cov"><span class="num"><pre>20</pre></span><pre>        url = request.POST['url']</pre></div>
<div class="cov"><span class="num"><pre>21</pre></span><pre>        site = Site.objects.get_current()</pre></div>
<div class="skip"><span class="num"><pre>22</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>23</pre></span><pre>        if not entry.pingback_enabled:</pre></div>
<div class="cov"><span class="num"><pre>24</pre></span><pre>            error = u'Trackback is not enabled for %s' % entry.title</pre></div>
<div class="skip"><span class="num"><pre>25</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>26</pre></span><pre>        title = request.POST.get('title') or url</pre></div>
<div class="cov"><span class="num"><pre>27</pre></span><pre>        excerpt = request.POST.get('excerpt') or title</pre></div>
<div class="cov"><span class="num"><pre>28</pre></span><pre>        blog_name = request.POST.get('blog_name') or title</pre></div>
<div class="skip"><span class="num"><pre>29</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>30</pre></span><pre>        if not error:</pre></div>
<div class="cov"><span class="num"><pre>31</pre></span><pre>            comment, created = Comment.objects.get_or_create(</pre></div>
<div class="cov"><span class="num"><pre>32</pre></span><pre>                content_type=ContentType.objects.get_for_model(Entry),</pre></div>
<div class="cov"><span class="num"><pre>33</pre></span><pre>                object_pk=entry.pk, site=site, user_url=url,</pre></div>
<div class="cov"><span class="num"><pre>34</pre></span><pre>                user_name=blog_name, defaults={'comment': excerpt})</pre></div>
<div class="cov"><span class="num"><pre>35</pre></span><pre>            if created:</pre></div>
<div class="cov"><span class="num"><pre>36</pre></span><pre>                user = entry.authors.all()[0]</pre></div>
<div class="cov"><span class="num"><pre>37</pre></span><pre>                comment.flags.create(user=user, flag='trackback')</pre></div>
<div class="cov"><span class="num"><pre>38</pre></span><pre>            else:</pre></div>
<div class="cov"><span class="num"><pre>39</pre></span><pre>                error = u'Trackback is already registered'</pre></div>
<div class="skip"><span class="num"><pre>40</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>41</pre></span><pre>        return direct_to_template(request, 'zinnia/entry_trackback.xml',</pre></div>
<div class="cov"><span class="num"><pre>42</pre></span><pre>                                  mimetype='text/xml',</pre></div>
<div class="cov"><span class="num"><pre>43</pre></span><pre>                                  extra_context={'error': error})</pre></div>
<div class="skip"><span class="num"><pre>44</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>45</pre></span><pre>    return redirect(entry)</pre></div>
<div class="skip"><span class="num"><pre>46</pre></span><pre></pre></div>
</div>
</body>
</html>
