<html>
<head>
<title>zinnia.comparison</title>
</head>
<body>
zinnia.comparison
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 76 lines<br/>
Missed: 0 lines<br/>
Skipped 20 lines<br/>
Percent: 100 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre> 1</pre></span><pre>&quot;&quot;&quot;Comparison tools for Zinnia</pre></div>
<div class="cov"><span class="num"><pre> 2</pre></span><pre>Based on clustered_models app&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre> 3</pre></span><pre>from math import sqrt</pre></div>
<div class="skip"><span class="num"><pre> 4</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 5</pre></span><pre>from zinnia.settings import F_MIN</pre></div>
<div class="cov"><span class="num"><pre> 6</pre></span><pre>from zinnia.settings import F_MAX</pre></div>
<div class="skip"><span class="num"><pre> 7</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 8</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 9</pre></span><pre>def pearson_score(list1, list2):</pre></div>
<div class="cov"><span class="num"><pre>10</pre></span><pre>    &quot;&quot;&quot;Compute the pearson score between 2 lists of vectors&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>11</pre></span><pre>    sum1 = sum(list1)</pre></div>
<div class="cov"><span class="num"><pre>12</pre></span><pre>    sum2 = sum(list2)</pre></div>
<div class="cov"><span class="num"><pre>13</pre></span><pre>    sum_sq1 = sum([pow(l, 2) for l in list1])</pre></div>
<div class="cov"><span class="num"><pre>14</pre></span><pre>    sum_sq2 = sum([pow(l, 2) for l in list2])</pre></div>
<div class="skip"><span class="num"><pre>15</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>16</pre></span><pre>    prod_sum = sum([list1[i] * list2[i] for i in range(len(list1))])</pre></div>
<div class="skip"><span class="num"><pre>17</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>18</pre></span><pre>    num = prod_sum - (sum1 * sum2 / len(list1))</pre></div>
<div class="cov"><span class="num"><pre>19</pre></span><pre>    den = sqrt((sum_sq1 - pow(sum1, 2) / len(list1)) *</pre></div>
<div class="cov"><span class="num"><pre>20</pre></span><pre>               (sum_sq2 - pow(sum2, 2) / len(list2)))</pre></div>
<div class="cov"><span class="num"><pre>21</pre></span><pre>    if den == 0:</pre></div>
<div class="cov"><span class="num"><pre>22</pre></span><pre>        return 0.0</pre></div>
<div class="cov"><span class="num"><pre>23</pre></span><pre>    return 1.0 - num / den</pre></div>
<div class="skip"><span class="num"><pre>24</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>25</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>26</pre></span><pre>class ClusteredModel(object):</pre></div>
<div class="cov"><span class="num"><pre>27</pre></span><pre>    &quot;&quot;&quot;Wrapper around Model class</pre></div>
<div class="cov"><span class="num"><pre>28</pre></span><pre>    building a dataset of instances&quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre>29</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>30</pre></span><pre>    def __init__(self, info_dict):</pre></div>
<div class="cov"><span class="num"><pre>31</pre></span><pre>        self.queryset = info_dict.get('queryset', [])</pre></div>
<div class="cov"><span class="num"><pre>32</pre></span><pre>        self.fields = info_dict.get('fields', ['id'])</pre></div>
<div class="skip"><span class="num"><pre>33</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>34</pre></span><pre>    def dataset(self):</pre></div>
<div class="cov"><span class="num"><pre>35</pre></span><pre>        &quot;&quot;&quot;Generate a dataset with the queryset</pre></div>
<div class="cov"><span class="num"><pre>36</pre></span><pre>        and specified fields&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>37</pre></span><pre>        dataset = {}</pre></div>
<div class="cov"><span class="num"><pre>38</pre></span><pre>        for item in self.queryset.filter():</pre></div>
<div class="cov"><span class="num"><pre>39</pre></span><pre>            dataset[item] = ' '.join([unicode(item.__dict__[field])</pre></div>
<div class="cov"><span class="num"><pre>40</pre></span><pre>                                      for field in self.fields])</pre></div>
<div class="cov"><span class="num"><pre>41</pre></span><pre>        return dataset</pre></div>
<div class="skip"><span class="num"><pre>42</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>43</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>44</pre></span><pre>class VectorBuilder(object):</pre></div>
<div class="cov"><span class="num"><pre>45</pre></span><pre>    &quot;&quot;&quot;Build a list of vectors based on datasets&quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre>46</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>47</pre></span><pre>    def __init__(self, *models_conf):</pre></div>
<div class="cov"><span class="num"><pre>48</pre></span><pre>        self.key = ''</pre></div>
<div class="cov"><span class="num"><pre>49</pre></span><pre>        self.columns = []</pre></div>
<div class="cov"><span class="num"><pre>50</pre></span><pre>        self.dataset = {}</pre></div>
<div class="cov"><span class="num"><pre>51</pre></span><pre>        self.clustered_models = [ClusteredModel(conf) for conf in models_conf]</pre></div>
<div class="cov"><span class="num"><pre>52</pre></span><pre>        self.build_dataset()</pre></div>
<div class="skip"><span class="num"><pre>53</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>54</pre></span><pre>    def build_dataset(self):</pre></div>
<div class="cov"><span class="num"><pre>55</pre></span><pre>        &quot;&quot;&quot;Generate whole dataset&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>56</pre></span><pre>        data = {}</pre></div>
<div class="cov"><span class="num"><pre>57</pre></span><pre>        words_total = {}</pre></div>
<div class="skip"><span class="num"><pre>58</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>59</pre></span><pre>        for clustered_model in self.clustered_models:</pre></div>
<div class="cov"><span class="num"><pre>60</pre></span><pre>            model_data = clustered_model.dataset()</pre></div>
<div class="cov"><span class="num"><pre>61</pre></span><pre>            for instance, words in model_data.items():</pre></div>
<div class="cov"><span class="num"><pre>62</pre></span><pre>                words_item_total = {}</pre></div>
<div class="cov"><span class="num"><pre>63</pre></span><pre>                for word in words.split():</pre></div>
<div class="cov"><span class="num"><pre>64</pre></span><pre>                    words_total.setdefault(word, 0)</pre></div>
<div class="cov"><span class="num"><pre>65</pre></span><pre>                    words_item_total.setdefault(word, 0)</pre></div>
<div class="cov"><span class="num"><pre>66</pre></span><pre>                    words_total[word] += 1</pre></div>
<div class="cov"><span class="num"><pre>67</pre></span><pre>                    words_item_total[word] += 1</pre></div>
<div class="cov"><span class="num"><pre>68</pre></span><pre>                data[instance] = words_item_total</pre></div>
<div class="skip"><span class="num"><pre>69</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>70</pre></span><pre>        top_words = []</pre></div>
<div class="cov"><span class="num"><pre>71</pre></span><pre>        for word, count in words_total.items():</pre></div>
<div class="cov"><span class="num"><pre>72</pre></span><pre>            frequency = float(count) / len(data)</pre></div>
<div class="cov"><span class="num"><pre>73</pre></span><pre>            if frequency &gt; F_MIN and frequency &lt; F_MAX:</pre></div>
<div class="cov"><span class="num"><pre>74</pre></span><pre>                top_words.append(word)</pre></div>
<div class="skip"><span class="num"><pre>75</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>76</pre></span><pre>        self.dataset = {}</pre></div>
<div class="cov"><span class="num"><pre>77</pre></span><pre>        self.columns = top_words</pre></div>
<div class="cov"><span class="num"><pre>78</pre></span><pre>        for instance in data.keys():</pre></div>
<div class="cov"><span class="num"><pre>79</pre></span><pre>            self.dataset[instance] = [data[instance].get(word, 0)</pre></div>
<div class="cov"><span class="num"><pre>80</pre></span><pre>                                      for word in top_words]</pre></div>
<div class="cov"><span class="num"><pre>81</pre></span><pre>        self.key = self.generate_key()</pre></div>
<div class="skip"><span class="num"><pre>82</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>83</pre></span><pre>    def generate_key(self):</pre></div>
<div class="cov"><span class="num"><pre>84</pre></span><pre>        &quot;&quot;&quot;Generate key for this list of vectors&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>85</pre></span><pre>        return '-'.join([str(c.queryset.filter().count())</pre></div>
<div class="cov"><span class="num"><pre>86</pre></span><pre>                         for c in self.clustered_models])</pre></div>
<div class="skip"><span class="num"><pre>87</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>88</pre></span><pre>    def flush(self):</pre></div>
<div class="cov"><span class="num"><pre>89</pre></span><pre>        &quot;&quot;&quot;Flush the dataset&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>90</pre></span><pre>        if self.key != self.generate_key():</pre></div>
<div class="cov"><span class="num"><pre>91</pre></span><pre>            self.build_dataset()</pre></div>
<div class="skip"><span class="num"><pre>92</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>93</pre></span><pre>    def __call__(self):</pre></div>
<div class="cov"><span class="num"><pre>94</pre></span><pre>        self.flush()</pre></div>
<div class="cov"><span class="num"><pre>95</pre></span><pre>        return self.columns, self.dataset</pre></div>
<div class="skip"><span class="num"><pre>96</pre></span><pre></pre></div>
</div>
</body>
</html>
