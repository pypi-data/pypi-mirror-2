<html>
<head>
<title>zinnia.ping</title>
</head>
<body>
zinnia.ping
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 80 lines<br/>
Missed: 53 lines<br/>
Skipped 28 lines<br/>
Percent: 60 %<br/>

</div>
<div class="coverage">
<div class="cov"><span class="num"><pre>  1</pre></span><pre>&quot;&quot;&quot;Pings utilities for Zinnia&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>  2</pre></span><pre>import socket</pre></div>
<div class="cov"><span class="num"><pre>  3</pre></span><pre>import xmlrpclib</pre></div>
<div class="cov"><span class="num"><pre>  4</pre></span><pre>import threading</pre></div>
<div class="cov"><span class="num"><pre>  5</pre></span><pre>from urllib2 import urlopen</pre></div>
<div class="cov"><span class="num"><pre>  6</pre></span><pre>from urlparse import urlsplit</pre></div>
<div class="cov"><span class="num"><pre>  7</pre></span><pre>from logging import getLogger</pre></div>
<div class="skip"><span class="num"><pre>  8</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>  9</pre></span><pre>from BeautifulSoup import BeautifulSoup</pre></div>
<div class="skip"><span class="num"><pre> 10</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 11</pre></span><pre>from django.contrib.sites.models import Site</pre></div>
<div class="cov"><span class="num"><pre> 12</pre></span><pre>from django.core.urlresolvers import reverse</pre></div>
<div class="skip"><span class="num"><pre> 13</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 14</pre></span><pre>from zinnia.settings import PROTOCOL</pre></div>
<div class="skip"><span class="num"><pre> 15</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 16</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 17</pre></span><pre>class URLRessources(object):</pre></div>
<div class="cov"><span class="num"><pre> 18</pre></span><pre>    &quot;&quot;&quot;Object defining the ressources of the website&quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre> 19</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 20</pre></span><pre>    def __init__(self):</pre></div>
<div class="cov"><span class="num"><pre> 21</pre></span><pre>        self.current_site = Site.objects.get_current()</pre></div>
<div class="cov"><span class="num"><pre> 22</pre></span><pre>        self.site_url = '%s://%s' % (PROTOCOL, self.current_site.domain)</pre></div>
<div class="cov"><span class="num"><pre> 23</pre></span><pre>        self.blog_url = '%s%s' % (self.site_url,</pre></div>
<div class="cov"><span class="num"><pre> 24</pre></span><pre>                                  reverse('zinnia_entry_archive_index'))</pre></div>
<div class="cov"><span class="num"><pre> 25</pre></span><pre>        self.blog_feed = '%s%s' % (self.site_url,</pre></div>
<div class="cov"><span class="num"><pre> 26</pre></span><pre>                                   reverse('zinnia_entry_latest_feed'))</pre></div>
<div class="skip"><span class="num"><pre> 27</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 28</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 29</pre></span><pre>class DirectoryPinger(threading.Thread):</pre></div>
<div class="cov"><span class="num"><pre> 30</pre></span><pre>    &quot;&quot;&quot;Threaded Directory Pinger&quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre> 31</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 32</pre></span><pre>    def __init__(self, server_name, entries, timeout=10, start_now=True):</pre></div>
<div class="nocov"><span class="num"><pre> 33</pre></span><pre>        self.results = []</pre></div>
<div class="nocov"><span class="num"><pre> 34</pre></span><pre>        self.timeout = timeout</pre></div>
<div class="nocov"><span class="num"><pre> 35</pre></span><pre>        self.entries = entries</pre></div>
<div class="nocov"><span class="num"><pre> 36</pre></span><pre>        self.server_name = server_name</pre></div>
<div class="nocov"><span class="num"><pre> 37</pre></span><pre>        self.server = xmlrpclib.ServerProxy(self.server_name)</pre></div>
<div class="nocov"><span class="num"><pre> 38</pre></span><pre>        self.ressources = URLRessources()</pre></div>
<div class="skip"><span class="num"><pre> 39</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 40</pre></span><pre>        threading.Thread.__init__(self)</pre></div>
<div class="nocov"><span class="num"><pre> 41</pre></span><pre>        if start_now:</pre></div>
<div class="nocov"><span class="num"><pre> 42</pre></span><pre>            self.start()</pre></div>
<div class="skip"><span class="num"><pre> 43</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 44</pre></span><pre>    def run(self):</pre></div>
<div class="cov"><span class="num"><pre> 45</pre></span><pre>        &quot;&quot;&quot;Ping entries to a Directory in a Thread&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 46</pre></span><pre>        logger = getLogger('zinnia.ping.directory')</pre></div>
<div class="nocov"><span class="num"><pre> 47</pre></span><pre>        socket.setdefaulttimeout(self.timeout)</pre></div>
<div class="nocov"><span class="num"><pre> 48</pre></span><pre>        for entry in self.entries:</pre></div>
<div class="nocov"><span class="num"><pre> 49</pre></span><pre>            reply = self.ping_entry(entry)</pre></div>
<div class="nocov"><span class="num"><pre> 50</pre></span><pre>            self.results.append(reply)</pre></div>
<div class="nocov"><span class="num"><pre> 51</pre></span><pre>            logger.info('%s : %s' % (self.server_name, reply['message']))</pre></div>
<div class="nocov"><span class="num"><pre> 52</pre></span><pre>        socket.setdefaulttimeout(None)</pre></div>
<div class="skip"><span class="num"><pre> 53</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 54</pre></span><pre>    def ping_entry(self, entry):</pre></div>
<div class="cov"><span class="num"><pre> 55</pre></span><pre>        &quot;&quot;&quot;Ping an entry to a Directory&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 56</pre></span><pre>        entry_url = '%s%s' % (self.ressources.site_url,</pre></div>
<div class="nocov"><span class="num"><pre> 57</pre></span><pre>                              entry.get_absolute_url())</pre></div>
<div class="nocov"><span class="num"><pre> 58</pre></span><pre>        categories = '|'.join([c.title for c in entry.categories.all()])</pre></div>
<div class="skip"><span class="num"><pre> 59</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 60</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre> 61</pre></span><pre>            reply = self.server.weblogUpdates.extendedPing(</pre></div>
<div class="nocov"><span class="num"><pre> 62</pre></span><pre>                self.ressources.current_site.name,</pre></div>
<div class="nocov"><span class="num"><pre> 63</pre></span><pre>                self.ressources.blog_url, entry_url,</pre></div>
<div class="nocov"><span class="num"><pre> 64</pre></span><pre>                self.ressources.blog_feed, categories)</pre></div>
<div class="nocov"><span class="num"><pre> 65</pre></span><pre>        except Exception:</pre></div>
<div class="nocov"><span class="num"><pre> 66</pre></span><pre>            try:</pre></div>
<div class="nocov"><span class="num"><pre> 67</pre></span><pre>                reply = self.server.weblogUpdates.ping(</pre></div>
<div class="nocov"><span class="num"><pre> 68</pre></span><pre>                    self.ressources.current_site.name,</pre></div>
<div class="nocov"><span class="num"><pre> 69</pre></span><pre>                    self.ressources.blog_url, entry_url,</pre></div>
<div class="nocov"><span class="num"><pre> 70</pre></span><pre>                    categories)</pre></div>
<div class="nocov"><span class="num"><pre> 71</pre></span><pre>            except Exception:</pre></div>
<div class="nocov"><span class="num"><pre> 72</pre></span><pre>                reply = {'message': '%s is an invalid directory.' % \</pre></div>
<div class="nocov"><span class="num"><pre> 73</pre></span><pre>                         self.server_name,</pre></div>
<div class="nocov"><span class="num"><pre> 74</pre></span><pre>                         'flerror': True}</pre></div>
<div class="nocov"><span class="num"><pre> 75</pre></span><pre>        return reply</pre></div>
<div class="skip"><span class="num"><pre> 76</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre> 77</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 78</pre></span><pre>class ExternalUrlsPinger(threading.Thread):</pre></div>
<div class="cov"><span class="num"><pre> 79</pre></span><pre>    &quot;&quot;&quot;Threaded ExternalUrls Pinger&quot;&quot;&quot;</pre></div>
<div class="skip"><span class="num"><pre> 80</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 81</pre></span><pre>    def __init__(self, entry, timeout=10, start_now=True):</pre></div>
<div class="cov"><span class="num"><pre> 82</pre></span><pre>        self.results = []</pre></div>
<div class="cov"><span class="num"><pre> 83</pre></span><pre>        self.entry = entry</pre></div>
<div class="cov"><span class="num"><pre> 84</pre></span><pre>        self.timeout = timeout</pre></div>
<div class="cov"><span class="num"><pre> 85</pre></span><pre>        self.ressources = URLRessources()</pre></div>
<div class="cov"><span class="num"><pre> 86</pre></span><pre>        self.entry_url = '%s%s' % (self.ressources.site_url,</pre></div>
<div class="cov"><span class="num"><pre> 87</pre></span><pre>                                   self.entry.get_absolute_url())</pre></div>
<div class="skip"><span class="num"><pre> 88</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 89</pre></span><pre>        threading.Thread.__init__(self)</pre></div>
<div class="cov"><span class="num"><pre> 90</pre></span><pre>        if start_now:</pre></div>
<div class="nocov"><span class="num"><pre> 91</pre></span><pre>            self.start()</pre></div>
<div class="skip"><span class="num"><pre> 92</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 93</pre></span><pre>    def run(self):</pre></div>
<div class="cov"><span class="num"><pre> 94</pre></span><pre>        &quot;&quot;&quot;Ping external URLS in a Thread&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre> 95</pre></span><pre>        logger = getLogger('zinnia.ping.external_urls')</pre></div>
<div class="nocov"><span class="num"><pre> 96</pre></span><pre>        socket.setdefaulttimeout(self.timeout)</pre></div>
<div class="skip"><span class="num"><pre> 97</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre> 98</pre></span><pre>        external_urls = self.find_external_urls(self.entry)</pre></div>
<div class="nocov"><span class="num"><pre> 99</pre></span><pre>        external_urls_pingable = self.find_pingback_urls(external_urls)</pre></div>
<div class="skip"><span class="num"><pre>100</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>101</pre></span><pre>        for url, server_name in external_urls_pingable.items():</pre></div>
<div class="nocov"><span class="num"><pre>102</pre></span><pre>            reply = self.pingback_url(server_name, url)</pre></div>
<div class="nocov"><span class="num"><pre>103</pre></span><pre>            self.results.append(reply)</pre></div>
<div class="nocov"><span class="num"><pre>104</pre></span><pre>            logger.info('%s : %s' % (url, reply))</pre></div>
<div class="skip"><span class="num"><pre>105</pre></span><pre></pre></div>
<div class="nocov"><span class="num"><pre>106</pre></span><pre>        socket.setdefaulttimeout(None)</pre></div>
<div class="skip"><span class="num"><pre>107</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>108</pre></span><pre>    def is_external_url(self, url, site_url):</pre></div>
<div class="cov"><span class="num"><pre>109</pre></span><pre>        &quot;&quot;&quot;Check of the url in an external url&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>110</pre></span><pre>        url_splitted = urlsplit(url)</pre></div>
<div class="cov"><span class="num"><pre>111</pre></span><pre>        if not url_splitted.netloc:</pre></div>
<div class="cov"><span class="num"><pre>112</pre></span><pre>            return False</pre></div>
<div class="cov"><span class="num"><pre>113</pre></span><pre>        return url_splitted.netloc != urlsplit(site_url).netloc</pre></div>
<div class="skip"><span class="num"><pre>114</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>115</pre></span><pre>    def find_external_urls(self, entry):</pre></div>
<div class="cov"><span class="num"><pre>116</pre></span><pre>        &quot;&quot;&quot;Find external urls in an entry&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>117</pre></span><pre>        soup = BeautifulSoup(entry.html_content)</pre></div>
<div class="cov"><span class="num"><pre>118</pre></span><pre>        external_urls = [a['href'] for a in soup.findAll('a')</pre></div>
<div class="cov"><span class="num"><pre>119</pre></span><pre>                         if self.is_external_url(</pre></div>
<div class="cov"><span class="num"><pre>120</pre></span><pre>                             a['href'], self.ressources.site_url)]</pre></div>
<div class="cov"><span class="num"><pre>121</pre></span><pre>        return external_urls</pre></div>
<div class="skip"><span class="num"><pre>122</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>123</pre></span><pre>    def find_pingback_href(self, content):</pre></div>
<div class="cov"><span class="num"><pre>124</pre></span><pre>        &quot;&quot;&quot;Try to find Link markup to pingback url&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>125</pre></span><pre>        soup = BeautifulSoup(content)</pre></div>
<div class="cov"><span class="num"><pre>126</pre></span><pre>        for link in soup.findAll('link'):</pre></div>
<div class="cov"><span class="num"><pre>127</pre></span><pre>            dict_attr = dict(link.attrs)</pre></div>
<div class="cov"><span class="num"><pre>128</pre></span><pre>            if 'rel' in dict_attr and 'href' in dict_attr:</pre></div>
<div class="cov"><span class="num"><pre>129</pre></span><pre>                if dict_attr['rel'].lower() == 'pingback':</pre></div>
<div class="cov"><span class="num"><pre>130</pre></span><pre>                    return dict_attr.get('href')</pre></div>
<div class="skip"><span class="num"><pre>131</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>132</pre></span><pre>    def find_pingback_urls(self, urls):</pre></div>
<div class="cov"><span class="num"><pre>133</pre></span><pre>        &quot;&quot;&quot;Find the pingback urls of each urls&quot;&quot;&quot;</pre></div>
<div class="cov"><span class="num"><pre>134</pre></span><pre>        pingback_urls = {}</pre></div>
<div class="skip"><span class="num"><pre>135</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>136</pre></span><pre>        for url in urls:</pre></div>
<div class="cov"><span class="num"><pre>137</pre></span><pre>            try:</pre></div>
<div class="cov"><span class="num"><pre>138</pre></span><pre>                page = urlopen(url)</pre></div>
<div class="cov"><span class="num"><pre>139</pre></span><pre>                server_url = page.info().get('X-Pingback') or \</pre></div>
<div class="cov"><span class="num"><pre>140</pre></span><pre>                             self.find_pingback_href(page.read())</pre></div>
<div class="cov"><span class="num"><pre>141</pre></span><pre>                if server_url:</pre></div>
<div class="cov"><span class="num"><pre>142</pre></span><pre>                    server_url_splitted = urlsplit(server_url)</pre></div>
<div class="cov"><span class="num"><pre>143</pre></span><pre>                    if not server_url_splitted.netloc:</pre></div>
<div class="cov"><span class="num"><pre>144</pre></span><pre>                        url_splitted = urlsplit(url)</pre></div>
<div class="cov"><span class="num"><pre>145</pre></span><pre>                        server_url = '%s://%s%s' % (url_splitted.scheme,</pre></div>
<div class="cov"><span class="num"><pre>146</pre></span><pre>                                                    url_splitted.netloc,</pre></div>
<div class="cov"><span class="num"><pre>147</pre></span><pre>                                                    server_url)</pre></div>
<div class="cov"><span class="num"><pre>148</pre></span><pre>                    pingback_urls[url] = server_url</pre></div>
<div class="nocov"><span class="num"><pre>149</pre></span><pre>            except IOError:</pre></div>
<div class="nocov"><span class="num"><pre>150</pre></span><pre>                pass</pre></div>
<div class="cov"><span class="num"><pre>151</pre></span><pre>        return pingback_urls</pre></div>
<div class="skip"><span class="num"><pre>152</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>153</pre></span><pre>    def pingback_url(self, server_name, target_url):</pre></div>
<div class="cov"><span class="num"><pre>154</pre></span><pre>        &quot;&quot;&quot;Do a pingback call for the target url&quot;&quot;&quot;</pre></div>
<div class="nocov"><span class="num"><pre>155</pre></span><pre>        try:</pre></div>
<div class="nocov"><span class="num"><pre>156</pre></span><pre>            server = xmlrpclib.ServerProxy(server_name)</pre></div>
<div class="nocov"><span class="num"><pre>157</pre></span><pre>            reply = server.pingback.ping(self.entry_url, target_url)</pre></div>
<div class="nocov"><span class="num"><pre>158</pre></span><pre>        except xmlrpclib.Error:</pre></div>
<div class="nocov"><span class="num"><pre>159</pre></span><pre>            reply = '%s cannot be pinged.' % target_url</pre></div>
<div class="nocov"><span class="num"><pre>160</pre></span><pre>        return reply</pre></div>
<div class="skip"><span class="num"><pre>161</pre></span><pre></pre></div>
</div>
</body>
</html>
