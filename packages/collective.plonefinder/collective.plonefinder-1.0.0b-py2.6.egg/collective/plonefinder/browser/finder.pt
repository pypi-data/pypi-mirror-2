
<metal:block use-macro="context/global_defines/macros/defines" />
<tal:headers define="request context/REQUEST">
  <tal:block define="charset site_properties/default_charset|string:utf-8;
                     dummy python:request.RESPONSE.setHeader('Content-Type', 'text/html;;charset=%s' % charset)" />
  <tal:block define="dummy python:request.RESPONSE.setHeader('Expires', 'Sat, 1 Jan 2000 00:00:00 GMT')" />
  <tal:block define="dummy python:request.RESPONSE.setHeader('Last-Modified', 'Sat, 1 Jan 2000 00:00:00 GMT')" />
  <tal:block define="dummy python:request.RESPONSE.setHeader('Cache-control', 'max-age=0,s-maxage=0,must-revalidate')" />
</tal:headers>
<metal:block tal:define="typeview view/typeview;
                         fieldName view/fieldname; 
                         sort_on view/sort_on;
                         sort_order view/sort_order;
                         sort_inverse view/sort_inverse;
                         nextQuery view/cleanQuery;                
                         SearchableText request/SearchableText | string:;
                         onlybody request/form/onlybody       | python:False;
                         b_size python:20;
                         b_size request/b_size | b_size;
                         b_start python:0;
                         b_start request/b_start | b_start;                      
                         typecss view/typecss;
                         browsed_url view/browsed_url;
                         ispopup view/ispopup;
                         portal view/portal;
                         portal_url view/portal_url;
                         browsedpath view/browsedpath;
                         portalpath view/portalpath;
                         parentpath view/parentpath;
                         findername view/findername;
                         folders view/folders;
                         results view/results;        
                         allowimagesizeselection view/allowimagesizeselection;                 
                         Batch python:modules['Products.CMFPlone'].Batch;
                         batch python:Batch(results, b_size, int(b_start), orphan=1);
                         toLocalizedTime nocall: context/@@plone/toLocalizedTime;
                         "
             i18n:domain="collective.plonefinder">
             

  <tal:block condition="onlybody">             
    <metal:block define-macro="plone_browser_body">    
          <input id="browsed_url"
                 name="browsed_url"
                 type="hidden"
                 tal:attributes="value browsed_url" />   
          <input id="finderName"
                 name="finderName"
                 type="hidden"
                 tal:attributes="value findername" />   
          <input id="start_after_upload"
                 name="start_after_upload"
                 type="hidden"
                 tal:attributes="value b_start" />  
          <input id="nextQuery"
                 name="nextQuery"
                 type="hidden"
                 tal:attributes="value nextQuery" />   
          <input id="previousSearch"
                 name="previousSearch"
                 type="hidden"
                 tal:condition="SearchableText"
                 tal:attributes="value SearchableText" />    
          <div id="plone-browser-menu">
            <a class="closeWindow"
               i18n:translate=""
               href="javascript: void(0);"
               onclick="Browser.close(); return false;">
            </a>
            <a class="maximize"
               i18n:translate=""
               href="javascript: void(0);"
               onclick="Browser.maximize(); return false;">
            </a>          
            <div id="searchBrowserBox">
              <form id="finderSearchForm">
                <input type="hidden"
                       name="searchsubmit:int"
                       value="1" />                     
                <input name="SearchableText" 
                       id="SearchableText" 
                       type="text" 
                       value="" 
                       size="25" 
                       title="Search Site"
                       tabindex="0"
                       tal:attributes="value SearchableText" /> 
                <select name="browsedpath" id="browsedpath">
                  <option tal:attributes="value portalpath"
                          i18n:translate="label_all_site">
                    all site
                  </option>          
                  <option tal:attributes="value browsedpath"
                          tal:condition="python:browsedpath!=portalpath"
                          i18n:translate="label_this_folder">
                    this folder
                  </option>
                </select>
                <input class="searchBrowserButton" 
                       type="submit" 
                       value="Search"
                       name="searchsubmit"
                       i18n:domain="plone"
                       i18n:attributes="value label_search;"
                       href="javascript: void(0);"
                       tal:attributes="onclick string:Browser.search();; return false;" />
              </form>       
            </div>          
            <div id="menuViews">
              <input type="hidden"
                     id="typeview"
                     name="typeview"
                     tal:attributes="value typeview" />
              <a href="javascript: void(0);"
                 onclick="Browser.setView('image'); return false;"
                 title="album view"
                 tal:attributes="class python:typeview=='image' and 'imageView selected' or 'imageView'"
                 i18n:attributes="title label_album_view;">
              </a>                  
              <a href="javascript: void(0);"
                 onclick="Browser.setView('file'); return false;"
                 title="file listing view"
                 tal:attributes="class python:typeview=='file' and 'fileView selected' or 'fileView'"
                 i18n:attributes="title label_file_listing_view;">
              </a>
            </div>
            <div id="menuActions">   
              <a class="uploadView"
                 tal:condition="view/allowupload"
                 title="upload"
                 href="javascript:Browser.openUploader()"
                 tal:attributes="href string:javascript:Browser.openUploader()"
                 i18n:attributes="title label_upload;">
              </a>             
              <a class="addFolderView"
                 tal:condition="view/allowaddfolder"
                 title="add new folder"
                 tal:attributes="href string:javascript:Browser.openAddFolderForm()"
                 i18n:attributes="title label_add_new_folder;">
              </a>            
            </div>
          </div>               
          
          <div metal:use-macro="context/@@finderbatchmacros/macros/navigation" />     
                 
          <div id="browser-crumbs"
               tal:condition="view/showbreadcrumbs">
              <tal:block define="breadcrumbs view/breadcrumbs;">      
                  <span i18n:translate="you_are_here" i18n:domain="plone">You are here:</span>
                  <span>
                      <a i18n:translate="tabs_home" i18n:domain="plone"
                         href="javascript: void(0);"
                         tal:attributes="onclick string:javascript:Browser.update('${portalpath}', '');; return false;">
                           Home
                      </a>
                      <span tal:condition="breadcrumbs" class="breadcrumbSeparator">
                          &rarr;
                      </span>
                      <span tal:repeat="crumb breadcrumbs"
                            dir="ltr">
                          <tal:last tal:define="is_last repeat/crumb/end">
                              <a href="javascript: void(0);"
                                 tal:omit-tag="not: crumb/path"
                                 tal:attributes="onclick string:Browser.update('${crumb/path}', '');; return false;"
                                 tal:content="crumb/title"
                                 tal:on-error="crumb">
                                  crumb
                              </a>
                              <span class="breadcrumbSeparator" tal:condition="not: is_last">
                                  &rarr;
                              </span>
                           </tal:last>
                      </span>
                  </span>
              </tal:block>
          </div>         

          <table border="0" cellpading="0" cellspacing="0" class="columns" id="browser-columns">
            <tr>
              <td class="column" id="column-1">
                <div id="plone-browser-navigation"
                     class="finder_panel"
                     tal:condition="view/browse">
                  <div class="listContainer folder"
                       tal:define="path view/browsedpath;
                                   title view/scopetitle">
                     <a tal:condition="parentpath"
                        class="folderUp"
                        href="javascript: void(0);"
                        tal:attributes="onclick string:Browser.update('${parentpath}', '');; return false;"
                        title="parent folder"
                        i18n:attributes="title">&nbsp;               
                     </a>                 
                     <div class="title scopetitle"
                          tal:condition="parentpath"
                          tal:content="title">sample Folder 1</div>                           
                     <a href="javascript: void(0);"
                        tal:condition="not:parentpath"
                        tal:attributes="onclick string:Browser.update('${path}', '');; return false;">
                        <div tal:attributes="class string:${typeview}Folder">
                          <div tal:attributes="class view/scopeiconclass">&nbsp;</div>
                        </div>
                        <div class="title scopetitle"
                             tal:content="title">sample Folder 1</div>
                     </a>                
                  </div>
                  <div class="retrait">
                    <tal:folders repeat="f folders">
                        <div class="listContainer folder">
                             <a href="javascript: void(0);"
                                tal:attributes="onclick string:Browser.update('${f/path}', '');; return false;">
                                <div tal:attributes="class string:${typeview}Folder">
                                  <div tal:attributes="class f/iconclass">&nbsp;</div>
                                </div>
                                <div class="title"
                                     tal:content="f/title"
                                     tal:attributes="class string:title ${f/state_class}">sample Folder 1</div>
                             </a>                     
                        </div> 
                    </tal:folders>   
                  </div>       
                </div>
              </td>
              <td class="column" id="column-2">
                <div id="plone-browser-body"
                     class="finder_panel">            
                  <div tal:condition="python: batch"
                       class="listContainer" id="sortheaders"
                       tal:attributes="style python: typeview=='image' and 'display:none' or nothing;
                                       class python: sort_order=='reverse' and 'listContainer reverseheaders' or 'listContainer'">
                    <div class="sorton sortontype">
                       <a href="javascript: void(0);"
                          tal:attributes="onclick string:Browser.sorton('portal_type', '$sort_inverse');; return false;
                                          class python: sort_on=='portal_type' and 'selected' or nothing"></a>            
                    </div>
                    <div class="sorton sortontitle">
                       <a href="javascript: void(0);"
                          tal:attributes="onclick string:Browser.sorton('sortable_title', '$sort_inverse');; return false;
                                          class python: sort_on=='sortable_title' and 'selected' or nothing"></a>                        
                    </div>
                    <div class="sorton sortonsize">
                       <a href="javascript: void(0);"
                          tal:attributes="onclick string:Browser.sorton('real_size', '$sort_inverse');; return false;
                                          class python: sort_on=='real_size' and 'selected' or nothing"></a>                     
                    </div>
                    <div class="sorton sortoncreated">
                       <a href="javascript: void(0);"
                          tal:attributes="onclick string:Browser.sorton('created', '$sort_inverse');; return false;
                                          class python: sort_on=='created' and 'selected' or nothing"></a>                 
                    </div>
                  </div>        
                  
                  <tal:block condition="python: not(view.sort_request or view.searchsubmit)">
                      <tal:folders repeat="f folders">
                          <div tal:attributes="class string: ${typecss}Container folder;">
                               <a href="javascript: void(0);"
                                  tal:attributes="onclick string:Browser.update('${f/path}', '');; return false;">
                                  <div tal:attributes="class string:${typeview}Folder">
                                    <div tal:attributes="class f/iconclass">&nbsp;</div>
                                  </div>
                                  <div class="title"
                                       tal:content="f/title"
                                       tal:attributes="class string:title ${f/state_class}">sample Folder 1</div>
                                  <div class="legend"></div>
                               </a>
                               
                               <div class="relContainer" 
                                    tal:condition="f/islinkable">
                                 <a href="javascript: void(0);"
                                    class="folderSelect"
                                    i18n:attributes="title"
                                    tal:attributes="onclick string:Browser.selectItem('${f/uid}', '${f/title}');; return false;
                                                    title   string:Select ${f/type};">
                                    &nbsp;
                                 </a>                   
                               </div>
                          </div> 
                      </tal:folders>
                  </tal:block>
          
                  <tal:results repeat="r batch">
                    <div tal:attributes="class string:${typecss}Container ${r/orientation_class};">
                      <a href="javascript: void(0);"
                         tal:define="blacklisted r/blacklisted;
                                     blclass python:blacklisted and ' blacklisted' or '';
                                     is_image r/is_image;
                                     selectPreviewImageString python:(is_image and allowimagesizeselection) and 'true' or 'false';"
                         tal:attributes="class   string: ${r/container_class}${blclass};
                                         title   string:select ${r/type};
                                         onclick string:Browser.selectItem('${r/uid}', '${r/title}', $selectPreviewImageString);; return false;" >
                        <img tal:condition="is_image"
                             tal:attributes="src r/thumb; style r/style" />
                        <div tal:condition="not: is_image"
                             tal:attributes="class r/iconclass">&nbsp;</div>
                        <div tal:content="r/title"
                             tal:attributes="class string:title ${r/state_class}">sample Portrait 1</div>
                        <div class="legend lsize" tal:content="r/size">54 kB</div>
                        <div class="legend lcreated" 
                             tal:define="created r/created"
                             tal:content="python:toLocalizedTime(created,long_format=1)">2010/01/01</div>
                        <div class="visualClear"><!-- --></div>
                      </a>
        
                      <div class="relContainer" tal:condition="r/is_image">
                        <a class="loupe thickbox"
                           tal:attributes="href r/preview_url;
                                           title string:${r/title} (preview);"
                           i18n:attributes="title">&nbsp;</a>                      
                      </div>
                      <div tal:define="actions_menu r/actions_menu"
                           class="actionsMenusRelContainer" tal:condition="actions_menu/items">
                        <a class="actionMenusButton"
                           href="#">&nbsp;</a>
                        <div class="finderActionMenuContainer"
                             tal:condition="actions_menu/choose_image_size|nothing">
                          <ul class="finderActionMenu imageSizeActionMenu">
                            <li class="finderActionMenuHeader"
                                tal:content="actions_menu/choose_image_size/label">
                                Choose image size
                            </li>
                            <li class="finderActionMenuItem imageSizeActionMenuItem"
                                tal:repeat="action actions_menu/choose_image_size/actions">
                                <a tal:content="python:action[3]"
                                   href="#"
                                   tal:define="thumb_size python:action[0];
                                               thumb_size_url_extension python:action[4]"
                                   tal:attributes="onclick string:Browser.selectItem('${r/uid}${thumb_size_url_extension}', '${r/title}');; return false;">
                                   Thumb : 128px*128px
                                </a>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </tal:results>                               
      
                  <tal:noresults condition="python: SearchableText and not results"
                                 i18n:domain="plone">
                      <div i18n:translate="description_no_results_found">No results were found.</div>
                  </tal:noresults>
          
                  <div style="clear: both;"></div>
                </div>  
              </td>
              <td class="column" id="column-3">
                <div id="right-panel" class="finder_panel">                
                </div> 
              </td>
            </tr>
          </table>

    </metal:block>
  
  </tal:block>


  <tal:comments replace="nothing">
     The following macro is used when plonefinder is used in an ajax window
     TODO : it's not complete, it's complex because we must fix all window methods
     as move resize etc ... try to find a jquery ui tool to do this developement
  </tal:comments>    

  <metal:block define-macro="plone_browser"
               tal:condition="python: not (onlybody or ispopup)">
    <div id="plone-browser">
      <div class="overlay"></div>
      <div class="window">
        <div class="browserRelativize">
          <metal:block define-macro="plone_browser_main">
            <div id="start-refresh"><!-- --></div>
                
            <metal:block use-macro="context/@@findermacros/macros/plone_browser_body" />      
            <div class="statusBar">
              <div id="msg-loading">
                Loading please wait...
              </div>
              <div id="msg-done">
                Done.
              </div>
            </div>                  
            <div id="plone-browser-border-bottom"></div>
            <div id="plone-browser-border-top"></div>              
            <div id="plone-browser-corner-left"></div>      
            <div id="plone-browser-corner-resize"></div>      
            <div id="plone-browser-tab">
              <div id="plone-browser-tab-menu">         
                <span tal:content="python:here.utranslate('label_browse_server_%s' % fieldName, default='Browse server %s' % fieldName, domain='collective.plonefinder')"
                      i18n:translate="">
                  Browse server images
                </span>                            
              </div>
           
            </div>    
          </metal:block>  
        </div>
      </div>
    </div>

  </metal:block>  
  
  <tal:comments replace="nothing">
     The following macro is used when plonefinder is called in classic window popup
  </tal:comments>

  <metal:block define-macro="plone_browser_popup"
               tal:condition="python: ispopup and not onlybody">
    <head>
    
      <!-- Internet Explorer fix, forces IE8 into newest possible rendering
               engine even if it's on an intranet. This has to be defined before any
               script/style tags. -->
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />

      <tal:block replace="structure provider:plone.htmlhead" />  
      
      <script type="text/javascript"
              tal:attributes="src string:$portal_url/++resource++plonefinder_static/finder.js">
      </script>
      
      <script type="text/javascript"
              tal:attributes="src string:$portal_url/++resource++plonefinder_static/thickbox_plus.js">
      </script>
      
      <script type="text/javascript"
              tal:condition="view/allowupload"
              tal:attributes="src string:$portal_url/++resource++plonefinder_static/jquery.uploadify.js">
      </script>  
      
      <script type="text/javascript"
              tal:condition="view/allowupload"
              tal:attributes="src string:$portal_url/++resource++plonefinder_static/swfobject.js">
      </script>     
      
      <script type="text/javascript"
              tal:condition="view/jsaddons"
              tal:content="structure string:${view/jsaddons}">
      </script>     
      
      <style type="text/css" media="all" 
             tal:condition="view/is_plone3"
             tal:content="string:@import url($portal_url/++resource++plonefinder_static/plone3.css);">
      </style>   
      
      <style type="text/css" media="all" 
             tal:content="string:@import url($portal_url/++resource++plonefinder_static/finder.css);">
      </style>
      
      <style type="text/css" media="all" 
             tal:content="string:@import url($portal_url/++resource++plonefinder_static/thickbox.css);">
      </style>
      
      <style type="text/css" media="all" 
             tal:condition="view/allowupload"
             tal:content="string:@import url($portal_url/++resource++plonefinder_static/uploadify.css);">
      </style>   
      
      <style type="text/css" media="all" 
             tal:condition="view/cssaddons"
             tal:content="structure string:${view/cssaddons}">
      </style> 
    
    </head>
    
    <body>      
      
      <div id="plone-browser" class="popup">
        <div class="window">
          <div class="browserStatic">
             <metal:block use-macro="context/@@findermacros/macros/plone_browser_main" />    
          </div>
        </div>
      </div>
      
    </body>

  </metal:block>    
  
  
</metal:block>  
