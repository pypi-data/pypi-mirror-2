{% extends "projects/project_menu.html" %}
{% load i18n %}
{% load cache %}
{% load pagination_tags %}
{% load txcommontags %}
{% load permissions %}
{% load txpermissions %}
{% load avatars %}
{% load addons %}
{% load statistics_resources %}

{% block extra_head %}
<script type="text/javascript">
  $(function(){
    $(".tipsy_enable").tipsy({'html':true, 'gravity':'s'});
    $(".tablesorter_resource").tablesorter({
        widgets: ['zebra'],
        headers: { 
            1: { 
                sorter: 'percent'
            }, 
        },
        textExtraction: { // Take value inside an object for the columns
            1: function(node) {
                return $(".stats_string_resource", node).text();
            },
            2: function(node) {
                return $(".origin_format", node).text();
            }
        }
    });
   })
</script>
{% endblock %}

{% block title %}{{ block.super }} | {{ project.name }}{% endblock %}

{% block breadcrumb %}{{ block.super }} &raquo; <a href="{{ project.get_absolute_url }}">{{ project.name }}</a> &raquo; 
<a href="{% url team_list team.project.slug %}">{% trans "Teams" %}</a> &raquo; {{ team.language.name }}
{% endblock %}

{% block content_main %}
{% get_permission "project_perm.submit_translations" for request.user and team as "can_submit_translations" %}
{% get_permission "project_perm.coordinate_team" for request.user and project,team.language as "is_coordinator" %}

<div class="obj_bigdetails">

<h2 class="name">
{% blocktrans with team.language.name as language_name and team.language.code as language_code %}Translation Teams - {{ language_name }} <sup class="entry_metalink">{{ language_code }}</sup>{% endblocktrans %}</h2>

{% if perms.projects.change_team or is_coordinator %}
<div class="addteam editlinks">
    <a class="i16 buttonized edit" href="{% url team_update team.project.slug team.language.code %}">{% trans "Edit" %}</a>
</div>
{% endif %}

 <div class="team_detail separate">
  <table class="definition">
    {% if team.mainlist %}
    <tr>
      <th class="i16 email">{% trans "Mainlist:" %}</th>
      <td>{{ team.mainlist|mungify:team.mainlist }} </a></td>
    </tr>
    {% endif %}
    
    {% with team.coordinators.all as coordinators %}
    {% if coordinators %}
    <tr>
      <th class="i16 coordinators">{% blocktrans count coordinators|length as counter %}Coordinator:{% plural %}Coordinators:{% endblocktrans %}</th>
      <td>
        {% for c in coordinators|slice:"0:6" %}
          <img class="border" src="{% avatar 16 c %}" style="vertical-align:middle"/>
          {% if c.first_name and c.last_name %}
            {{ c.first_name }} {{ c.last_name }} 
            (<a href="{% url profile_public c.username %}">{{ c.username }}</a>)
          {% else %}
            <a href="{% url profile_public c.username %}">{{ c.username }}</a>
          {% endif %}{% if not forloop.last %},{% endif %}
        {% endfor %}
      </td>
    </tr>
    {% endif %}
    {% endwith %}

    {% if request.user.is_authenticated and not perms.projects.submit_translations and not can_submit_translations and not user_access_request %}
    <tr>
      <th class="i16 user">{% trans "Become a translator:" %}</th>
      <td>
        <form method="post" action="{% url team_join_request team.project.slug team.language.code %}" class="microform">
            <input name="team_join" class="i16 team_join" type="submit" title="{% trans "Join this Team" %}"  value="{% trans "Join this Team" %}">
        </form>
      </td>
    </tr>
   {% endif %} 

  </table>
</div>

{% if team_access_requests %}
<div class="list separate ">
<h3>{% trans "People waiting for team membership approving:" %}</h3>
<ul>
{% for access_request in team_access_requests|dictsort:"user.username" %}
    <li>
        <img class="border" src="{% avatar 16 access_request.user %}" style="vertical-align:middle"/>
        <a href="{% url profile_public access_request.user.username %}">
            {{ access_request.user }}
        </a>
        {% if is_coordinator %}
        <form class="microform" method="post" action="{% url team_join_approve access_request.team.project.slug access_request.team.language.code access_request.user.username %}">
            <input name="team_join_approve" class="i16 submit" type="submit" value="{% trans "Approve" %}"/>
        </form>
        
        <form class="microform" method="post" action="{% url team_join_deny access_request.team.project.slug access_request.team.language.code access_request.user.username %}">
            <input name="team_join_deny" class="i16 delete" type="submit" value="{% trans "Deny" %}"/>
        </form>
        {% endif %}
        
        {% ifequal request.user.pk access_request.user.pk %}
        <form class="microform" method="post" action="{% url team_join_withdraw access_request.team.project.slug access_request.team.language.code %}">
            <input name="team_join_withdraw" class="i16 delete" type="submit" value="{% trans "Withdraw" %}"/>
        </form>
        {% endifequal %}
    </li>
{% endfor %}
</ul>
</div>
{% endif %}


<div class="list separate" style="clear:both">
  <h3>{% blocktrans count resources|length as counter %}Team Translating Resource{% plural %}Team Translating Resources:{% endblocktrans %}</h3>
 {% if statslist %}
  <table class="stat_table_font stats_table highlighted tablesorter_resource" style="clear:both;margin-top:0.5em;width:100%">
  <thead>
  <tr>
    <th><span class="i16 comment">{% trans "Resource" %}</span></th>
    <th style="width:320px"><span class="i16 stats">{% trans "Completion" %}</span></th>
    <th><span class="i16 clock">{% trans "Last Updated" %}</span></th>
   </tr>
  </thead>
  <tbody>
  {% for stat in statslist %}

  <tr id="stat_row_{{forloop.counter}}" title="{% trans 'click for translation' %}">
  {% cache 604800 team_details team.id stat.object.id LANGUAGE_CODE %}
        <td>
          <span class="clickable">{{ stat.object.name }}</span>
        </td>
        <td>
        {% with 200 as barwidth %}
            <div class="stats tipsy_enable" style='width:{{ barwidth|add:"40" }}px;' title="{% trans "Translated: " %}{{ stat.num_translated }}<br />{% trans "Untranslated: " %}{{ stat.num_untranslated }}">
                <div class="stats_string_resource" >
                    {{ stat.trans_percent }}% 
                </div> 
                {% stats_bar_simple stat barwidth %}
            </div>
        {% endwith %}
        </td>
  {% endcache %}
        <td>
        <span style="border:0">
        {% with stat.last_update as last_update %}
        {% with stat.last_committer as last_committer %}
          {% if last_update %}
              <span class="origin_format" style="display:none">{{ last_update|date:"M d,Y h:i A" }}</span>
              {{ last_update|date:"M d, h:ia" }} 
              {% if last_committer %}
              by {{ last_committer }}
              {% endif %}
          {% else %}
              {% trans "no activity yet" %}
          {% endif %}
          {% endwith %}
          {% endwith %}
        </span>
        </td>
    </tr>
    <script>
        $(".highlighted tr#stat_row_{{forloop.counter}}").click(function(){
           /* FancyBox Using custom settings */ 
           $.fancybox(
               { 
                'href': '{% url resource_actions team.project.slug stat.object.slug team.language.code %}',
                'hideOnContentClick': false,
                'onStart':function(){
                    // IE8 fix
                    if(jQuery.browser.msie) {
                      $('#fancybox-wrap').css('max-width','716px');
                      $('#fancybox-inner').css('max-width','716px');
                      $('#fancybox-outer').css('left','50%');
                    }
                },
                'onComplete':function() {
                    // IE8 fix
                    if(jQuery.browser.msie){
                        $('.fancybox-title-outside').css('max-width','716px');
                    }
                    $(".tipsy_enable").tipsy({'html':true, 'gravity':'s'});
                    $("a.language_chooser_trigger").toggle(function(){
                        $("div.language_chooser").css({'visibility':'visible'});
                    },function(){
                        $("div.language_chooser").css({'visibility':'hidden'});
                    });
                    $("div.language_chooser a").click( function(){
                        var target_lang_code = $("div.language_chooser select").val();
                        if ( target_lang_code != "" ) {
                            request_url = window.location+'l/{{ team.language.code }}/clone/'+target_lang_code+'/';
                            window.location = request_url;
                        } else {
                            alert("Please select a target language first and then click Go.");
                        }
                    });
                    if(!$("#download_for_translation").hasClass('disabled')){
                    $("#download_for_translation").click(function(){
                        $.ajax({
                            url : '{% url lock_and_download_translation project.slug stat.object.slug team.language.code %}',
                            contentType : 'application/json',
                            type : 'POST',
                            beforeSend: function(){
                            $("div#notification-container div").html('{% trans "Trying to lock resource..."|escapejs %}');
                            $("div#notification-container").fadeIn("fast");
                            },
                            complete : function(xmlhttpreq, textStatus) {
                                if (textStatus=='success'){
                                    response = JSON.parse(xmlhttpreq.responseText);
                                    if(response['status']=='FAILED'){
                                        $("#download_for_translation").siblings("div.error_notes").text(response['message']);
                                        $("#download_for_translation").siblings("div.error_notes").show();
                                    }else{
                                        if(response['redirect']){
                                            window.location = response['redirect'];
                                        }
                                    }
                                    $("div#notification-container").fadeOut("fast");
                                }
                            }
                        });
                    });
                    }
                },
                'titleShow': true,
                'titlePosition': 'outside',
                'title': '{% trans "Translation Details"|escapejs %}'
           });
        });
    </script>
  {% endfor %}
  </table>
 {% else %}
  <p>{% trans "No resources are registered for this project yet." %}</p>
 {% endif %}
</div>

{% with team.members.all as members %}
{% if members %}
<div class="list separate" style="clear:both">
<h3>{% trans "Team Members:" %}</h3>
<ul>
{% for m in members|dictsort:"username" %}
    <li>
        <img class="border" src="{% avatar 16 m %}" style="vertical-align:middle"/>
        <a href="{% url profile_public m.username %}">
            {{ m }}
        </a>
        {% ifequal request.user.pk m.pk %}
        <form class="microform" method="post" action="{% url team_leave team.project.slug team.language.code %}">
            <input name="team_leave" class="i16 user_delete" type="submit" value="{% trans "Leave" %}"/>
        </form>
        {% endifequal %}
    </li>
{% endfor %}
</ul>
</div>
{% endif %}
{% endwith %}
</div>

{% hook "team_detail.html" extra_content %}

<h3>{% trans 'History' %}</h3>
{% load tx_action_log %}
{% get_log 5 as action_log for_object team %}
{% if not action_log %}
<p>{% trans 'None available' %}</p>
{% else %}
<ul class="actionlist simple">
{% for entry in action_log %}
    <li class="i16 actionlog">
    {{ entry.message|safe }} by {{ entry.user }} {{ entry.action_time|timesince }} ago.
    </li>
{% endfor %}
</ul>
{% endif %}

{% endblock %}


{% block content_footer %}
  <div id="content_footer_center">
    {% get_permission "project_perm.maintain" for request.user and project as "is_maintainer" %}
    {% if perms.teams.delete_team or is_maintainer %}
    <div class="deletelink">
      <a class="i16 delete buttonized" href="{% url team_delete project.slug team.language.code %}">{% trans "Delete team" %}</a>
    </div>
    {% endif %}
  </div>
{% endblock %}
