
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>StarCluster Elastic Load Balancer &mdash; StarCluster v0.92rc1 documentation</title>
    <link rel="stylesheet" href="../_static/pylons.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.92rc1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="StarCluster v0.92rc1 documentation" href="../index.html" />
    <link rel="up" title="StarCluster User Manual" href="index.html" />
    <link rel="next" title="Hacking on StarCluster" href="hacking.html" />
    <link rel="prev" title="Adding and Removing Nodes from StarCluster" href="addremovenode.html" />
<link rel="stylesheet" href="../_static/nobile.css" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="../_static/neuton.css" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->
<link rel="shortcut icon" href="../_static/starcluster.ico"/>

  </head>
  <body>
<div class="header-small">
	
	<div class="logo-small">
		<a href="../index.html">
      		<img class="logo" src="../_static/logo-small.png" alt="Logo"/>
		</a>
  	</div>
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="hacking.html" title="Hacking on StarCluster"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="addremovenode.html" title="Adding and Removing Nodes from StarCluster"
             accesskey="P">previous</a> |</li>
    	<li><a href="../index.html">Home</a> &raquo;</li>
          <li><a href="../contents.html" >Master Table of Contents</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">StarCluster User Manual</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="starcluster-elastic-load-balancer">
<h1>StarCluster Elastic Load Balancer<a class="headerlink" href="#starcluster-elastic-load-balancer" title="Permalink to this headline">¶</a></h1>
<p>This load balancer grows and shrinks a Sun Grid Engine cluster according to the
length of the cluster&#8217;s job queue. When the cluster is heavily loaded and
processing a long job queue, ELB can gradually add more nodes, up to the
specified max_nodes, to distribute the work and improve throughput. When the queue
becomes empty, ELB can remove idle nodes in order to save money. The cluster
will shrink down to one node (the master), terminating all of the other nodes
as they become idle.</p>
<p><strong>Goals</strong></p>
<ul class="simple">
<li>To increase the size of the cluster up to max_nodes when there is a large queue of waiting jobs</li>
<li>To decrease the size of the cluster down to 1 when there are no jobs waiting, to save money</li>
<li>To elastically balance the cluster&#8217;s load deterministically, predictably, and slowly.</li>
</ul>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>To use the Elastic Load Balancer, you can start it from the command line:</p>
<div class="highlight-none"><div class="highlight"><pre>starcluster loadbalance cluster_tag

or

starcluster bal cluster_tag
</pre></div>
</div>
<p>This will start the load balancer in an infinite loop. It can be terminated by
pressing CTRL-C.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>At this time, all of the parameters are stored in the file
starcluster/balancer/sge/__init__.py
with the appropriate descriptions. Before release, those configuration options
will be moved to the standard starcluster configuration file.</p>
</div>
<div class="section" id="capabilities">
<h2>Capabilities<a class="headerlink" href="#capabilities" title="Permalink to this headline">¶</a></h2>
<p>There is a polling loop, default is 60 seconds, set in the configuration of the
load balancer. Every 60 seconds, the load balancer will connect to the cluster,
obtain statistics from Sun Grid Engine, and decide what to do about the
job queue. ELB deals only with the queue length and active machines.</p>
<p><em>ELB does not examine the load on any of the hosts.</em> If we had the ability to migrate jobs
from an overloaded host to an idle host, then we would spend more time looking
at individual hosts&#8217; system load. However, since job migration is out of the scope
of this project and starcluster in general, we do not look at system load.</p>
<p>This diagram illustrates the decisions that ELB will make in each loop:</p>
<img alt="../_images/balancer_decision_diagram.jpg" src="../_images/balancer_decision_diagram.jpg" />
</div>
<div class="section" id="operation">
<h2>Operation<a class="headerlink" href="#operation" title="Permalink to this headline">¶</a></h2>
<p>As mentioned before, the load balancer will loop every 60 seconds, collecting
statistics to make intelligent decisions about when to add nodes.</p>
<p><strong>Criteria for Adding a Node</strong></p>
<p>A node will be added when <em>all</em> of the following criteria have been met:</p>
<ol class="arabic">
<li><p class="first">There are jobs in the queued waiting (SGE&#8217;s moniker is &#8216;qw&#8217;) state</p>
</li>
<li><p class="first">The longest queued job has been waiting for more than 15 minutes</p>
</li>
<li><dl class="first docutils">
<dt>The number of nodes does not meet or exceed the maximum number of nodes</dt>
<dd><p class="first last">set in the configuration file.</p>
</dd>
</dl>
</li>
</ol>
<p>A user can set the number of nodes to be added per iteration. For instance, if
the user wanted to add 1 node per iteration, which is standard and a recommended
practice, they would set the <cite>add_nodes_per_iteration</cite> parameter to 1. If the user
wanted two nodes to be added per iteration, that parameter should be set to 2, and
the cluster would grow at a faster rate, consequently incurring higher charges from
Amazon.com.</p>
<p><strong>Criteria for Removing a Node</strong></p>
<p>A node will be removed when <em>all</em> of the following criteria have been met:</p>
<ol class="arabic simple">
<li>No jobs are in the queued waiting (&#8216;qw&#8217; state) state</li>
<li>The node in question is idle, meaning it is not running an SGE job</li>
<li>The node in question is not the master node</li>
<li>The node in question has been up for more than 45 minutes past the hour.</li>
</ol>
<p>Each node in the cluster will be analyzed in turn, and any and all nodes meeting
the above criteria will be terminated in that polling loop. The entire cluster
need not be idle for a node to be terminated: If Node001 is working on a job,
but Node002 is idle and there are no queued waiting jobs, Node002 is a candidate
for termination.</p>
<p><strong>The 45 Minutes Past the Hour Rule</strong></p>
<p>Since Amazon charges by the hour, we are assuming that you have already paid for
a full hour of server time. It would be wasteful to turn it off the moment
it becomes idle. By keeping that node up for 45 minutes, we allow for it to
complete the maximum workload from the queue, and use 75% of the hour you have
already paid for.</p>
<p>Leaving a node up for this amount of time also increases the stability of the
cluster. It is detrimental to the cluster and wasteful to be continuosly adding
and removing nodes.</p>
<p><strong>The Process of Adding a Node</strong></p>
<p>Adding a new node is a multi-stage process:</p>
<ol class="arabic simple">
<li>Use the cluster class to start up a new node of the same instance and AMI as the other slave nodes in the cluster.</li>
<li>Wait for that node to come up. Name it with the highest Node # available: If Node001, Node003, and Node005, are started, the next node will be Node006.</li>
<li>Set up an /etc/hosts file on each node in the cluster, mapping the new node name to its ip address.</li>
<li>Create a cluster user account and cluster group on the new node.</li>
<li>Set up the /etc/exports file, creating the NFS shares for /home and sge on the master, and then exportfs so the shares are open to the slave nodes.</li>
<li>Mount the NFS shares on the new node.</li>
<li>Configure SGE: inform the master of the new host&#8217;s address, and inform the new host of the master, and excute the sge commands to establish communications.</li>
</ol>
<p><strong>The Process of Removing a Node</strong></p>
<p>Removing a node is also a multi-stage process:</p>
<ol class="arabic simple">
<li>Remove the node from SGE, so that no jobs can be sent to the node while it is in a transition period.</li>
<li>Remove the node from the /etc/hosts file on other cluster machines.</li>
<li>Remove the master&#8217;s nfs export to this soon-to-be-killed node. Call exportfs to cut it off.</li>
<li>Terminate the node, sending a terminate command to Amazon through the Boto library.</li>
</ol>
<p>Because the node is immediately removed from SGE, and it seems like SGE takes about 15 seconds between a qsub
command and a node beginning execution of a job, this makes it very unlikely that a job will be
started on a host as it is going down. There is a very small window of time within which this could happen.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">StarCluster Elastic Load Balancer</a><ul>
<li><a class="reference internal" href="#usage">Usage</a></li>
<li><a class="reference internal" href="#configuration">Configuration</a></li>
<li><a class="reference internal" href="#capabilities">Capabilities</a></li>
<li><a class="reference internal" href="#operation">Operation</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="addremovenode.html"
                        title="previous chapter">Adding and Removing Nodes from StarCluster</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="hacking.html"
                        title="next chapter">Hacking on StarCluster</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="hacking.html" title="Hacking on StarCluster"
             >next</a> |</li>
        <li class="right" >
          <a href="addremovenode.html" title="Adding and Removing Nodes from StarCluster"
             >previous</a> |</li>
    	<li><a href="../index.html">Home</a> &raquo;</li>
          <li><a href="../contents.html" >Master Table of Contents</a> &raquo;</li>
          <li><a href="index.html" >StarCluster User Manual</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010, Software Tools for Academics and Researchers.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>