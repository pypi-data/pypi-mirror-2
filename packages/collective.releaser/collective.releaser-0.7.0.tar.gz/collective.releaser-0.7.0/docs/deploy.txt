======
Deploy
======

With buildout.cfg
-----------------

Test with default config file::

  >>> from collective.releaser.testing import clearRepository
  >>> clearRepository(test)

Deploy::

  >>> url = svn_url + '/sample-buildout/trunk'
  >>> from collective.releaser.project import deploy_release
  >>> deploy_release(url, sample_buildout, 'full')
  Using network file ...
  ...

Check tarball::

  >>> parent_dir = os.path.split(sample_buildout)[0]

  >>> ls(parent_dir)
  -  release-trunk-buildout.tgz
  d  sample-buildout

Let's unarchive the tarball to check its content::

  >>> from collective.releaser.base import TarFile
  >>> tarfile = os.path.join(parent_dir, 
  ...                        'release-trunk-buildout.tgz') 
  >>> tar = TarFile.open(tarfile, 'r:gz')
  >>> files = sorted([fileinfo.name for fileinfo in tar.getmembers()])
  >>> for file_ in files:
  ...     print file_
  MD5
  bootstrap.py
  buildout.cfg
  downloads/dist/
  ...

Noticed that we removed .svn directories, and .installed.cfg.

A deploy from an existing buildout
----------------------------------

Let's remove the tarfile::

  >>> os.remove(tarfile)

Let's checkout the buildout::

  >>> deploy_release(sample_buildout)
  Using network file buildout.cfg with url ...
  ...

Check tarball::

  >>> parent_dir = os.path.split(sample_buildout)[0]

  >>> ls(parent_dir)
  -  release-sample-buildout-buildout.tgz
  d  sample-buildout

Let's unarchive the tarball to check its content::

  >>> tarfile = join(parent_dir, 'release-sample-buildout-buildout.tgz')
  >>> tar = TarFile.open(tarfile, 'r:gz')
  >>> files = sorted([fileinfo.name for fileinfo in tar.getmembers()])
  >>> for file_ in files:
  ...     print file_
  MD5
  bootstrap.py
  buildout.cfg
  downloads/dist/
  ...

Noticed that we removed .svn directories, and .installed.cfg.


With sample.cfg
-----------------

Test with default config file::

  >>> from collective.releaser.testing import clearBuildout
  >>> clearBuildout(test)
  >>> write(sample_buildout, 'buildout.cfg','''
  ... [buildout]
  ... parts=
  ... download-cache = downloads
  ... ''')

  >>> write(sample_buildout, 'sample.cfg','''
  ... [buildout]
  ... parts=
  ... download-cache = downloads
  ... ''')

Adding a version file::

  >>> write(sample_buildout, 'version.txt', '1.2')

Deploy::

  >>> from collective.releaser.project import deploy_release
  >>> deploy_release(join(sample_buildout, 'sample.cfg'),
  ...                archiving='full')
  Using local configuration file sample.cfg
  ...
  Calling bin/buildout -v -c sample.cfg
  ...


Check tarball::

  >>> parent_dir = os.path.split(sample_buildout)[0]

  >>> ls(parent_dir)
  - release-1.2-sample.tgz
  d sample-buildout

With developer.cfg
------------------

Making sure download-cache stops the release if it 
is not there:

Test with default config file::

  >>> from collective.releaser.testing import clearBuildout
  >>> clearBuildout(test)
  >>> write(sample_buildout, 'buildout.cfg','''
  ... [buildout]
  ... parts=
  ... download-cache = downloads
  ... ''')

  >>> write(sample_buildout, 'developer.cfg','''
  ... [buildout]
  ... parts=
  ...
  ... ''')

Deploy::

  #>> from collective.releaser.project import deploy_release
  #>> deploy_release(join(sample_buildout, 'developer.cfg'),
  #...                archiving='full')
  #Traceback (most recent call last):
  #...
  #ReleaseError: You need to add 'download-cache = downloads'' in the [buildout] section

With developer.cfg
------------------

Making sure a missing download-cache stops the release.

Test with default config file::

  >>> from collective.releaser.testing import clearBuildout
  >>> clearBuildout(test)
  >>> write(sample_buildout, 'buildout.cfg','''
  ... [buildout]
  ... parts=
  ... download-cache = downloads
  ... ''')

  >>> write(sample_buildout, 'developer.cfg','''
  ... [buildout]
  ... parts=
  ...
  ... ''')

Deploy::

  #>> from collective.releaser.project import deploy_release
  #>> deploy_release(join(sample_buildout, 'developer.cfg'),
  #...                archiving='full')
  #Traceback (most recent call last):
  #...
  #ReleaseError: You need to add 'download-cache = downloads'' in the [buildout] section

Various tests
-------------

Making sure a missing download-cache stops the release.

Test with default config file::

  >>> from collective.releaser.testing import clearBuildout
  >>> clearBuildout(test)
  >>> write(sample_buildout, 'buildout.cfg','''
  ... [buildout]
  ... parts=
  ... download-cache = downloads
  ... ''')

  >>> write(sample_buildout, 'developer.cfg','''
  ... [buildout]
  ... parts=
  ... download-cache = downloads
  ... ''')

Deploy::

    >>> from collective.releaser.project import deploy_release
    >>> deploy_release(join(sample_buildout, 'developer.cfg'),
    ...                archiving=url)
    Using local configuration file developer.cfg
    ...
    Archiving /sample-buildout.
    release-developer.tgz ok.

