## This file is subject to the terms and conditions defined in
## file 'LICENSE', which is part of this source code package.
##       Copyright (c) 2009 SKR Farms (P) LTD.


## -*- coding: utf-8 -*-

<%namespace name="elements" file="/component/elements.html"/>
<%namespace name="forms" file="/component/forms.html"/>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>
    <head>
        ${self.hd_title()}
        ${self.hd_meta()}
        ${self.hd_links()}
        ${self.hd_styles()}
        ${self.hd_script()}
    </head>
    <body class="tundra">
        <% disclaimer = config['zeta.hdisclaimer'] %>
        % if disclaimer :
            <div class="fntsmall fntbold fgred bgred1 calign">${disclaimer}</div>
        % endif
        ${self.bd_metanav()}
        ${self.bd_header()}
        ${self.bd_breadcrumbs()}
        ${self.bd_body()}
        ${self.bd_footer()}
        ${self.bd_script()}
    </body>
</html>

## Title
<%def name="hd_title()" >
    <title>${c.title}</title>
</%def>

## Meta Tags and Attibutes
<%def name="hd_meta()">
    ## Fill up this function with meta tags and attributes.
</%def>

## CSS Link
<%def name="hd_links()" >
    <link href="/zdojo/release/dojo/resources/dojo.css" rel="stylesheet" type="text/css"></link>
    <link href="/zdojo/ztundra.css" rel="stylesheet" type="text/css"></link>
    <link href="/zdojo/zdojo.css" rel="stylesheet" type="text/css"></link>
</%def>

<%def name="hd_styles()">
</%def>

<%def name="hd_script()">
    <script src="/zdojo/release/dojo/dojo.js" type="text/javascript"></script>
    <script type="text/javascript">
        // TODO : This function graciously fails handler subscription. Eventually this
        //        should be removed ...
        function dojoaddOnLoad( fnstr ) {
            //try {
            //    dojo.addOnLoad( fn );
            //} catch( err ) { console.log( err )}
            fn = dojo.getObject( fnstr )
            if( typeof fn == 'function' ) {
                dojo.addOnLoad( fn );
            }
        };
    </script>
</%def>


## Meta Navigation
<%def name="bd_metanav()" >
    <div id="metanav" class="ralign fntsmall">
        ${c.authusername} |
        <% bar = ' ' %>
        % for m in c.metanavs :
            % if m.type == 'link' :
                ${bar} <a style="margin: 0;" title="${m.title}" href="${m.href}">${m.text}</a>
                <% bar = '|' %>
            % elif m.type == 'pointer' :
                ${bar} <span name="${m.text}" class="fntsmall pointer fgblue">
                            ${m.text}<span class="fntxsmall vmiddle"> &#9660;</span></span>
                <% bar = '|' %>
            % else :
                &#9830;
                <% bar = ' ' %>
            % endif
        % endfor
    </div>
</%def>

## View Header
<%def name="bd_header()" >
    ${elements.flashmessages()}
    % if config['zeta.pageheader'] :
        <div id="lthead" class="w100">
        <div class="disptable w100"></div>
        <div class="disptrow">
            <div class="disptcell vtop pr5">
                <div id="sitelogo">
                <a class="nodec fggray fntcaption" href="${h.url_site}"><img alt="logo" style="max-width: 300px; max-height: 75px;" src="${c.sitelogo}"></img></a>
                </div>
            </div>

            <div class="disptcell vtop pt5 pb5">
                ${forms.form_searchbox(
                    c.authuser, 'searchzeta', 'Search-Site', h.suburl_searchzeta 
                )}
            </div>

            <div class="disptcell vmiddle w100"></div>

            <div class="disptcell vtop pt5 pb5">
                % if c.project :
                    ${forms.form_searchbox(
                        c.authuser, 'searchproject', 'Search-project', h.suburl_search,
                        [( 'project', c.project.projectname )]
                    )}
                % endif
            </div>


            <div class="disptcell vtop pl5">
                <div id="prjlogo">
                % if c.project and getattr( h, 'url_prj', None ) :
                    <a class="nodec fggray fntcaption" href="${h.url_prj}"><img alt="logo" style="max-width: 300px; max-height: 75px;" src="${c.prjlogo}"></img></a>
                % else :
                    <div class="vmiddle fggray2 fntcaption p10 calign"></div>
                % endif
                </div>
            </div>
        </div>
        </div>
        </div>
    % endif
</%def>

<%def name="bd_breadcrumbs()">
    <%
        e  = request.environ
        bd = session.get( 'breadcrumbs', [] )
        hrefs = h.urlpathcrumbs( e['PATH_INFO'], e['HTTP_HOST'], e['SCRIPT_NAME'] )
        node = lambda text, ref : '<a class="mr10 fgred nodec" href="%s">%s</a>' % (
                                   ref, text )
    %>
    % if c.authorized :
        <div class="ralign fntsmall" style="margin : 4px;">
            % for text, ref in hrefs[:-1] :
                ${elements.iconize( node(text,ref), 'arrow_right', classes='floatl',
                                    styles="padding-left: 8px" )}
            % endfor
            % if hrefs :
                ${elements.iconize( hrefs[-1][0], 'arrow_right', classes='floatl fggray',
                                    styles="padding-left: 8px" )}
            % endif
            % for title, href in bd :
                <a class="ml10" href="${href}">${title}</a>
            % endfor
            &ensp;
        </div>
    % endif
</%def>

<%def name="bd_body()"></%def>

<%def name="bd_footer()">
    <div class="bclear" id="footer">
        <hr style="margin-bottom: 0px"></hr>
        <a class="floatl" href="${c.zetalink}"><img width="110" height="45" src="${c.zetalogo}"></img></a>
        <div class="floatl" style="font-size: 11px; height : 45px">
            <div class="ml5 calign" style="height : 22px; border-bottom : 4px solid Gainsboro">
                <span style="vertical-align : -6px;">version : </span>
                <span class="fntbold" style="vertical-align : -6px;">${c.zetaversion}</span>
            </div>
            <div class="ml5 pt2" style="height : 22px;">
                <span class="fntbold" style="color: skyblue">SKR</span>
                <span class="fntbold" style="color: black">Farms (P) Ltd</span>
            </div>
        </div>
        <div class="floatr fntbold bgblue1 brbl5 brbr5">
        <table><tr>
            <td class="p5 calign vmiddle">
                <div>Z Links</div>
            </td>
            <td class="p5" style="border-left: 1px solid gray;">
                <div><a target="_blank" class="fgcrimson"
                        title="Track Zeta development activities"
                        href="http://dev.discoverzeta.com"
                        >zeta-development</a></div>
                <div><a target="_blank" class="fgcrimson"
                        title="Discuss with us"
                        href="http://groups.google.com/group/zeta-discuss"
                        >zeta-mailinglist</a>
            </td>
            <td class="p5">
                <div><a target="_blank" class="fgcrimson"
                        title="Our commercial site"
                        href="mailto:support@discoverzeta.com"
                        >Support</a></div>
                <div><a target="_blank" class="fgcrimson"
                        title="Our commercial site"
                        href="http://discoverzeta.com/pricing"
                        >Pricing</a></div>
            </td>
        </tr></table>
        </div>
    </div>
</%def>

<%def name="bd_script()">
    <script src="/zdojo/release/dijit/dijit.js" type="text/javascript"></script>
    <script src="/zdojo/release/dojox/grid/DataGrid.js" type="text/javascript"></script>

    <script src="/zdojo/zlib.js" type="text/javascript"></script>
    <script src="/zdojo/zwidgets.js" type="text/javascript"></script>

    ## High charts library
    <script src="/jquery-1.4.2.min.js" type="text/javascript"></script>
    <script src="/highcharts/highcharts.js" type="text/javascript"></script>
    <script src="/highcharts/scripts.js" type="text/javascript"></script>
    <script src="/zhighcharts.js" type="text/javascript"></script>
    <!--[if IE]>
        <script type="text/javascript" src="/highcharts/excanvas.compiled.js"></script>
    <![endif]-->

    ## Skip the google web-analytics block for signin page since Authkit
    ## interprets the % character for text substitution.
    % if h.webanalytics and not getattr( c, 'skipga', False ) :
        ${h.webanalytics | n}
    % endif

    <script type="text/javascript">
        // Common initialization routine
        function init_zeta() {
            dojo.subscribe( 'flash', null, flashmsghandler );
        }

        // Initialize quick-links
        function qlinks_menu() {
            var qlMenu;
            var tgtnodes = dojo.query( 'div#metanav span[name=quick-links]' )[0];
            var quicklinks = ${h.json.dumps( h.quicklinks ) | n};

            if ( tgtnodes ) {
                pMenu = new zeta.Menu({
                                targetNodes   :[ tgtnodes ],
                                style: { fontSize: 'small', width: '6em', color: 'blue' }
                        });
                dojo.forEach( quicklinks,
                    function( ql ) {
                        purl = '<a href="' + ql[1] + '">' + ql[0] + '</a>'
                        pMenu.addChild( new zeta.MenuItem(
                                            { content: purl, class: 'fntbold hoverhighlight' }
                                      ));
                    }
                );
            }
        }

        // Initialize project menu
        function project_menu() {
            var pMenu;
            var tgtnodes = dojo.query( 'div#metanav span[name=myprojects]' )[0];
            var myprojects = ${h.json.dumps( h.projectlinks ) | n};

            if ( tgtnodes ) {
                pMenu = new zeta.Menu({
                                targetNodes   :[ tgtnodes ],
                                style: { fontSize: 'small',
                                         color: 'blue',
                                       }
                        });
                pMenu.addChild(
                    new zeta.MenuItem(
                        { content: '<a href="${h.url_createprj}">New-project</a>',
                          class: 'hoverhighlight' }
                    )
                );
                pMenu.addChild( new zeta.MenuItem({ content: '<hr></hr>' }));
                dojo.forEach( myprojects,
                    function( p ) {
                        purl = '<a href="' + p[1] + '">' + p[0] + '</a>'
                        pMenu.addChild( new zeta.MenuItem(
                                            { content: purl, class: 'fntbold hoverhighlight' }
                                      ));
                    }
                );
                pMenu.addChild( new zeta.MenuItem({ content: '<hr></hr>' }));
                pMenu.addChild( new zeta.MenuItem(
                                    { content: '<a href="${h.url_projindex}">List-all</a>',
                                      class: 'hoverhighlight'
                                    }
                              ));
            }
        }

        dojo.addOnLoad( init_zeta );
        dojo.addOnLoad( qlinks_menu );
        dojo.addOnLoad( project_menu );

        // Handlers for other elements in derived files.
        dojoaddOnLoad( 'pagebartooltip' );
        dojoaddOnLoad( 'contexttooltip' );

        // Handler for search box.
        dojo.addOnLoad( function() {
            dojo.forEach( dojo.query( "span[name=searchbox] input[type=text]" ),
                function( n ) {
                    dojo.toggleClass( n, 'fggray2', true );
                    dojo.connect( n, 'onfocus',
                                  function( e ) {
                                      dojo.attr( n, 'helpstr', n.value );
                                      n.value = '';
                                      dojo.toggleClass( n, 'fggray2', false );
                                  }
                                );
                    dojo.connect( n, 'onblur',
                                  function( e ) {
                                      n.value = dojo.attr( n, 'helpstr' );
                                      dojo.toggleClass( n, 'fggray2', true );
                                  }
                                );
                }
            );
        });
    </script>
</%def>
