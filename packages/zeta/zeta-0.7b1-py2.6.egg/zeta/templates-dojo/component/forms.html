## This file is subject to the terms and conditions defined in
## file 'LICENSE', which is part of this source code package.
##       Copyright (c) 2009 SKR Farms (P) LTD.

## -------------------- Form Fields -----------------------------------------

## Todo :
##     Form fields must re-size with the window.
##     Try setting the `style` attribute of the widget form fields

<%namespace name="elements" file="/component/elements.html"/>

<%!
    restrict_kwargs = lambda kwargs, allowed_keys : \
                        [ kwargs.pop( k ) for k in kwargs.keys() if k not in allowed_keys ]
    make_attrs      = lambda kwargs : ' '.join([ k + '="'+kwargs[k]+'"' for k in kwargs ])
    general_attrs     = [ 'name', 'value', 'id', 'class', 'title', 'style' ]
    inputtext_attrs   = general_attrs + [ 'disabled', 'maxlength', 'readonly', 'size' ]
    inputpass_attrs   = general_attrs + [ 'disabled', 'maxlength', 'size' ]
    inputchkbox_attrs = general_attrs + [ 'checked', 'disabled' ]
    inputradio_attrs  = general_attrs + [ 'checked', 'disabled' ]
    inputfile_attrs   = general_attrs + [ 'disabled', 'size' ]
    inputbutton_attrs = general_attrs
    inputhidden_attrs = general_attrs
    inputimage_attrs  = general_attrs + [ 'alt', 'disabled', 'src', 'value' ]
    textarea_attrs    = general_attrs + [ 'rows', 'cols', 'disabled', 'readonly', 'tatype' ]
    select_attrs      = general_attrs + [ 'multiple', 'size', 'disabled' ]
    multiselect_attrs = general_attrs + [ 'size', 'disabled' ]

    label_attrs       = [ 'for' ]

    # System tables entry fields classified into `info` or `config`
    infofields = [ 'product_name', 'product_version','database_version',
                   'envpath', 
                   'sitename', 'siteadmin', 'timezone', 'unicode_encoding'
                 ]
    cnffields  = [ 'welcomestring', 'specialtags', 'projteamtypes',
                   'tickettypes', 'ticketseverity', 'ticketstatus', 'ticketresolv', 
                   'wikitypes', 'def_wikitype', 'reviewactions', 'reviewnatures',
                   'vcstypes',  'googlemaps', 'strictauth',
                   'regrbyinvite', 'invitebyall', 'interzeta', 'userrel_types', 
                 ]
%>

<%def name="input_text( **kwargs )">
    <%
        text = kwargs.pop( 'text', '' )
        restrict_kwargs( kwargs, inputtext_attrs )
        attrs = make_attrs( kwargs )
    %>
    <input type="text" ${attrs | n}>${text}</input>
</%def>

<%def name="input_password( **kwargs )">
    <%
        restrict_kwargs( kwargs, inputpass_attrs )
        attrs = make_attrs( kwargs )
    %>
    <input type="password" ${attrs | n}></input>
</%def>

<%def name="input_checkbox( **kwargs )">
    <%
        text = kwargs.pop( 'text', '' )
        restrict_kwargs( kwargs, inputchkbox_attrs )
        attrs = make_attrs( kwargs )
    %>
    <input type="checkbox" ${attrs | n}></input>
</%def>
<%def name="input_radio( **kwargs )">
    <%
        text = kwargs.get('text', '')
        restrict_kwargs( kwargs, inputradio_attrs )
        attrs = make_attrs( kwargs )
    %>
    <input type="radio" ${attrs | n}>${text}</input>
</%def>
<%def name="input_file( **kwargs )">
    <%
        restrict_kwargs( kwargs, inputfile_attrs )
        attrs = make_attrs( kwargs )
    %>
    <input type="file" ${attrs | n}></input>
</%def>
<%def name="input_submit( **kwargs )">
    <%
        restrict_kwargs( kwargs, inputbutton_attrs )
        attrs = make_attrs( kwargs )
    %>
    <input type="submit" ${attrs | n}></input>
</%def>
<%def name="input_reset( **kwargs )">
    <%
        restrict_kwargs( kwargs, inputbutton_attrs )
        attrs = make_attrs( kwargs )
    %>
    <input type="reset" ${attrs | n}></input>
</%def>
<%def name="input_button( **kwargs )">
    <%
        restrict_kwargs( kwargs, inputbutton_attrs )
        attrs = make_attrs( kwargs )
    %>
    <input type="button" ${attrs | n}></input>
</%def>
<%def name="input_hidden( **kwargs )">
    <%
        restrict_kwargs( kwargs, inputhidden_attrs )
        attrs = make_attrs( kwargs )
    %>
    <input type="hidden" ${attrs | n}></input>
</%def>
<%def name="input_image( **kwargs )">
    <%
        restrict_kwargs( kwargs, inputimage_attrs )
        attrs = make_attrs( kwargs )
    %>
    <input type="image" ${attrs | n}></input>
</%def>

<%def name="textarea( **kwargs )">
    <%
        text  = kwargs.pop( 'text', '' )
        restrict_kwargs( kwargs, textarea_attrs )
        attrs = make_attrs( kwargs )
    %>
    <textarea ${attrs | n}>${text}</textarea>
</%def>

<%def name="select( **kwargs )">
    <%
        selected      = kwargs.get( 'opt_selected', '' )
        options       = kwargs.get( 'options', [] )
        opts_disabled = kwargs.get( 'opts_disabled', '' )
        restrict_kwargs( kwargs, select_attrs )
        attrs         = make_attrs( kwargs )
        options       = options[:]
        for i in range(len(options)) :
            if isinstance( options[i], (str,unicode) ) :
                options[i] = ( options[i], options[i] )
    %>
    <select ${attrs | n}>
        % for val, txt in options :
            <option value="${val}"
            % if selected == txt :
                selected="selected"
            % endif
            % if txt in opts_disabled :
                disabled="disabled"
            % endif
            >${txt}</option>
        % endfor
    </select>
</%def>

<%def name="multiselect( **kwargs )">
    <%
        selected      = kwargs.get( 'opt_selected', '' )
        options       = kwargs.get( 'options', [] )
        opts_disabled = kwargs.get( 'opts_disabled', '' )
        restrict_kwargs( kwargs, multiselect_attrs )
        attrs         = make_attrs( kwargs )
        options       = options[:]
        for i in range(len(options)) :
            if isinstance( options[i], (str,unicode) ) :
                options[i] = ( options[i], options[i] )
    %>
    <select multiple="multiple" ${attrs | n}>
        % for val, txt in options :
            <option value=${val}
            % if selected == txt :
                selected="selected"
            % endif
            % if txt in opts_disabled :
                disabled="disabled"
            % endif
            >${txt}</option>
        % endfor
    </select>
</%def>

<%def name="label( labelfor='', text='' )">
    <label for="${labelfor}" >${text}</label>
</%def>

<%def name="fieldhelp( help='', fhstyle= '' )">
    <span class="fhelp" style="${fhstyle}" >${help |n}</span>
</%def>

## ----------------------------- Site info form ---------------------------

<%def name="form_systeminfo( u, entries, action )">
    <%
        help       = {
            'product_name'     : '',
            'envpath'          : '<em>Can be changed ony in the .ini file</em>',
            'product_version'  : '',
            'database_version' : '',
            'sitename'         : '',
            'siteadmin'        : '',
            'timezone'         : '',
            'unicode_encoding' : '<em>-- This feature is in development --</em>',
        }
        import zwiki
    %>

    <div class="disptable w60 ml50" style="border-collapse: separate; border-spacing: 10px">
        % for field in infofields :
        <div class="disptrow">
            <div class="disptcell p3 fggray fntbold">${field}</div>
            <div class="disptcell p3 fggray">
                ${entries[field]}
                % if help[field] : 
                    - ${fieldhelp( help[field])}
                % endif
            </div>
        </div>
        % endfor
        <div class="disptrow">
            <div class="disptcell p3 fggray fntbold">zwiki_version</div>
            <div class="disptcell p3 fggray">
                ${zwiki.VERSION}
            </div>
        </div>
    </div>
</%def>

<%def name="form_systemconfig( u, entries, action )">
    <%
        if set( infofields + cnffields ) != set( entries ) :
            raise Exception( 'Mismatch in system fields' )

        help = {
            'welcomestring' :
                    """This string will be displayed on the page bar of site's
                    homepage""",
            'specialtags'   :
                    """Some tags are special, in the sense that they will be
                    interpreted by the application""",
            'projteamtypes' :
                    """Registered users can be part of a project only via a
                    team. Add team types for all the projects hosted under
                    this site, <em>non-members</em> denote registered users
                    who are not part of the project""",
            'tickettypes'   :
                    """Tickets can have type, it gives an idea about the
                    ticket""",
            'ticketseverity':
                    """Ticket severity should indicate at what priority it
                    should be addressed. Note that, sometimes important
                    ticket need not be urgent""",
            'ticketstatus'  :
                    """And this is how a ticket is tracked, typically a ticket
                    begins its life as 'new', travels through one of
                    its different states, that is defined here and finally moves on
                    to a resolved state.""",
            'ticketresolv'  :
                    """Should be a sub-set of ticket-status list, and
                    indicates that a ticket is resolved upon moving to this
                    state.""",
            'wikitypes' :
                    """Documents can also can have types, define them here""",
            'def_wikitype'  :
                    """Should be present in the list of `wikitypes`. On creating
                    a wiki page, it is always marked with the default
                    type""",
            'reviewactions' :
                    """<em>Authors</em> must take actions on review comments,
                    define the type of actions here""",
            'reviewnatures' :
                    """Nature of review comment. Sometimes, marking a comment
                    as `cosmetic` can avoid lot of debate.""",
            'vcstypes'  :
                    """Supported list of version control systems, integratable
                    with your site.""",
            'googlemaps'    :
                    """
                    <a href="http://code.google.com/apis/maps/signup.html">sign-up</a>
                    google map key for your site and copy the key here. If
                    left empty, google-maps will not be enabled.""",
            'strictauth'    :
                    """Setting this to `True` will completely restrict
                    anonymous user. This feature is still evolving""",
            'regrbyinvite'  :
                    """By default anybody can register in the site. In case
                    this is not desirable, set `regrbyinvite` to `True`""",
            'invitebyall'   :
                    """If `regrbyinvite` is set to `True`, `invitebyall`
                    defines who can invite new users. By default, only site
                    administrator can invite, if set to `True` any registered
                    user under this site can invite new users""",
        }
    %>

    <div class="w100 calign fgred">
        All the confguration fields here pertains to entire site,
        applicable to all projects created in this site
    </div>
    <div class="disptable w100">
    <div class="disptrow">
        <div class="disptcell w60">
        <form id="system" action="${action}" method="post">
        ${input_hidden( name='user_id', value=str(u.id) )}
        <div class="disptable ml50" style="border-collapse: separate; border-spacing: 10px">
            % for field in cnffields :
            <div class="disptrow">
                <div class="disptcell fntbold pb20">${field}</div>
                <div class="disptcell ftbox pb20">
                    ${input_text( name=field, style='width: 30em;', id='sys_'+field, value=entries[field] )}
                </div>
                <div class="disptcell">
                <div class="ml10">
                    ${elements.helpboard( help.get( field, '' ), styles='padding: 5px' )}
                </div>
                </div>
            </div>
            % endfor
            <div class="disptrow">
                <div class="disptcell"></div>
                <div class="disptcell">${input_submit( value='Update' )}</div>
            </div>
        </div>
        </form>
        </div>
    </div>
    </div>

    <script type="text/javascript">
        /* Initialise system form */
        function initform_system( e ) {
            new zeta.Form({ normalsub : true, formid : 'system' });
        }
    </script>
</%def>

<%def name="form_editsw( u, sw, action )">
    <form id='editsw' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='pathurl', value=sw.path )}
    <div class="w100 form">
        <div class="field ml20">
            <div class="ftarea w80" required="true">
                ${elements.captiontextarea( 'Use wiki markup to compose guest wiki page.' )}
                ${textarea( name='text', tatype="simpletextarea", id='swtext',
                            text=sw.text, cols='120', rows='30' )}
            </div>
        </div>
        <div class="field">
            <div class="fsubmit">
                ${input_submit( value='Save & Continue' )}
                ${input_reset( value='Reset' )}
                ${input_button( id='preview', value='Preview' )}
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function onpreview( x_form, e ) {
            var div_wp  = dojo.query( '.swpreview' )[0];
            var ta_wcnt = dijit.byId( 'swtext' )
            if ( e.type == 'keyup' && e.keyCode != dojo.keys.ENTER ) {
                return;
            }
            if ( div_wp && ta_wcnt ) {
                div_wp.innerHTML = ''
                xhrpost_obj( '${h.url_swpreview |n}',
                             { 'text' : ta_wcnt.attr( 'value' ) },
                             'text',
                             false,
                             null,
                             function( resp ) {
                                    dojo.toggleClass( div_wp.parentNode.parentNode, 'dispnone', false );
                                    div_wp.innerHTML = resp;
                             },
                             null
                          );
                dojo.stopEvent( e );
            }
        }
        function initform_editsw() {
            new zeta.Form({ normalsub: true, formid: 'editsw' });
            dijit.byId( 'swtext' ).focus();

            // Show preview
            var x_form = dijit.byId( 'editsw' );
            var butt_preview = dojo.query( '#preview', x_form.domNode )[0];
            dojo.connect( butt_preview, 'onclick', dojo.hitch( null, onpreview, x_form ));
            dojo.connect( butt_preview, 'onkeyup', dojo.hitch( null, onpreview, x_form ));
        }
    </script>
</%def>

## ------------------------- Permission Forms -----------------------------

<%def name="form_createpg( u, permnames, action )">
    <%
        pg_help = 'small cased, 2 to max %s characters. ' % h.LEN_NAME
    %>

    <form id="createpg" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 11em;">Permission group :</div>
            <div class="ftbox" style="width : 25em;" required="true" regExp="[a-z0-9_.]{2,32}">
                ${input_text( name='perm_group', id='cr_perm_group' )}
                <br></br>
                ${fieldhelp( pg_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 11em;">Permission names :</div>
            <div class="fselect vtop"  style="width : 25em;" required="true">
                ${multiselect( name='perm_name', id='cr_perm_name', options=permnames, \
                               size="7", style='width : 17em' )}</div>
        </div>
        <div class="field">
            <div class="label" style="width : 11em;"></div>
            <div class="fsubmit" style="width : 25em;">${input_submit( value='Create' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_createpg() {
            function createpg_onsubmit( e ) {
                submitform( form_createpg, e );
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ] );
                pgmap.store.close() ;
                pgmap.fetch({
                    onComplete : dojo.partial( pgmap_oncomplete, true ),
                    sort       : [{ attribute : 'perm_group' }]
                });
                dojo.stopEvent(e);
            }
            new zeta.Form({ onsubmit : createpg_onsubmit, formid : 'createpg' });
        } 
    </script>
</%def>

<%def name="form_updatepg( u, action_pg, action_addpn, action_delpn,
                           pgroups=[], defpg='', perms=[], x_perms=[]  )">
    <%
        pg_help = ( 'Minimum 3 characters to max %s characters.' + \
                    'With all characters in small case.' ) % h.LEN_NAME
    %>

    <div class="w100 form">
        <div class="field">
            <div class="ftbox" style="width : 20em;" required="true">
                Select group -
                ${select( name='pglist', id='pglist', options=pgroups, opt_selected=defpg )}
                <hr></hr>
            </div>
        </div>
    </div>
    <form id="updatepg" action="${action_pg}" method="post">
    <div class="w100 form">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='perm_group_id', value='' )}
        <div class="field">
            <div class="label" style="width : 11em;">Permission group :</div>
            <div class="ftbox" style="width : 20em;" required="true">
                ${input_text( name='perm_group', id='updt_perm_group' )}</div>
            <div class="fsubmit"  style="width : 5em;">${input_submit( value='Change' )}</div>
        </div>
    </div>
    </form>
    <form id="addpntopg" action="${action_addpn}" method="post">
    <div class="w100 form">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='perm_group_id', value='' )}
        <div class="field">
            <div class="label" style="width : 11em;">Add Permissions :</div>
            <div class="fselect vtop" style="width : 20em;" required="true">
                ${multiselect( name='perm_name', id='add_perm_name', options=x_perms, \
                               size="7", style='width : 17em' )}</div>
            <div class="fsubmit" style="width : 5em;">${input_submit( value='Add' )}</div>
        </div>
    </div>
    </form>
    <form id="delpnfrompg" action="${action_delpn}" method="post">
    <div class="w100 form">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='perm_group_id', value='' )}
        <div class="field">
            <div class="label" style="width : 11em;">Delete Permissions :</div>
            <div class="fselect vtop" style="width : 20em;" required="true">
                ${multiselect( name='perm_name', id='del_perm_name', options=perms, \
                               size="7", style='width : 17em' )}</div>
            <div class="fsubmit" style="width : 5em;">${input_submit( value='Delete' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_perms() {
            var select_addpn = dojo.query( 'form#addpntopg select#add_perm_name' )[0];
            new ZSelect( select_addpn, 'addpntopg', null );

            var select_delpn = dojo.query( 'form#delpnfrompg select#del_perm_name' )[0];
            new ZSelect( select_delpn, 'delpnfrompg', null );

            var select_pglist= dojo.query( 'select#pglist' )[0];
            new ZSelect( select_pglist, 'pglist', function( e ) { refresh_perms() });

            function perms_onsubmit( formid, e ) {
                submitform( dojo.getObject( 'form_'+formid, e ));
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ] );
                pgmap.store.close() ;
                pgmap.fetch({
                    onComplete : dojo.partial( pgmap_oncomplete, (formid == 'updatepg')),
                    sort       : [{ attribute : 'perm_group' }]
                });
                dojo.stopEvent(e);
            }
            new zeta.Form({ onsubmit : dojo.partial( perms_onsubmit, 'updatepg' ),
                            formid : 'updatepg' });
            new zeta.Form({ onsubmit : dojo.partial( perms_onsubmit, 'addpntopg' ),
                            formid : 'addpntopg' });
            new zeta.Form({ onsubmit : dojo.partial( perms_onsubmit, 'delpnfrompg' ),
                            formid : 'delpnfrompg' });
        } 
    </script>
</%def>

## --------------------------- User Forms ---------------------------------

<%def name="form_userreg( action, url_captcha )">
    <%
        un_help = 'All small case, between 3 characters to %s characters.' % h.LEN_NAME
        em_help = 'Your communication email id.'
        pw_help = 'Use a password of minimum 4 characters.'
    %>

    <form id="userreg" action="${action}" method="post">
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;">Username :</div>
            <div class="ftbox" style="width : 40em;" required="true" regExp="${h.RE_UNAME}">
                ${input_text( name='username', id='username' )}
                <br></br>
                ${fieldhelp( un_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Email-id :</div>
            <div class="ftbox" style="width : 40em;" required="true" regExp="${h.RE_EMAIL}">
                ${input_text( name='emailid', id='emailid')}
                <br></br>
                ${fieldhelp( em_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Password :</div>
            <div class="fpass" style="width : 40em;" required="true" regExp="${h.RE_PASSWD}">
                ${input_password( name='password', id='password')}
                <br></br>
                ${fieldhelp( pw_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Confirm password :</div>
            <div class="fpass" style="width : 40em;" required="true">
                ${input_password( name='confpass', id='confpass')}
                <br></br>
                ${fieldhelp( pw_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Timezone :</div>
            <div class="fselect" style="width : 40em;">
                ${select( name='timezone',  id='timezone', options=h.all_timezones, opt_selected='UTC' )}</div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;"></div>
            <div class="fsubmit">
                <div>
                    <a target="_blank" href="${h.url_tos}">Terms of Service</a>
                 </div>
                <div class="pt5 fgcrimson">
                    By submitting this form, it is implied that you are agreeing
                    to Terms of Service
                </div>
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Captcha :</div>
            ${elements.captcha( url_captcha )}
        </div>
        <div class="field">
            <div class="label" style="width : 10em;"></div>
            <div class="fsubmit" sytle="width : 40em;">
                ${input_submit( value='Submit' )}
                ${input_reset( value='Reset' )}
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_userreg() {
            function userreg_onsubmit( e ) {
                var rg_uname = dijit.byId('username').value;
                if ( dijit.byId('userreg').validate() ) {
                    for ( i = 0; i < usernames.length; i++ ) {
                        if ( usernames[i] == rg_uname ) {
                            dojo.publish( 'flash', [ 'error', rg_uname+' already exists', 2000 ]);
                            dojo.stopEvent( e );
                         }
                    }
                } else {
                    dojo.publish( 'flash', [ 'error', "Invalid form fields", 2000 ]);
                    dojo.stopEvent( e );
                }
            }
            new zeta.Form({ onsubmit : userreg_onsubmit, formid : 'userreg' });
            dijit.byId( 'username' ).focus();
        } 
    </script>
</%def>

<%def name="form_accountinfo( u, action )">
    <%
        uinfo     = u.userinfo
        fliparg   = lambda x : x and x or ''
        em_help   = 'Your communication email id.'
        up_help   = 'Comma separated list of user panes'
    %>

    <form id="accountinfo" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    ${input_hidden( name='username', id='username', value=u.username )}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;">Email-id :</div>
            <div class="ftbox" required="true" regExp="${h.RE_EMAIL}">
                ${input_text( name='emailid', id='emailid', value=u.emailid )}
                <br></br>
                ${fieldhelp( em_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Timezone :</div>
            <div class="fselect">
                ${select( name='timezone',  id='timezone', options=h.all_timezones, opt_selected=u.timezone )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">First Name :</div>
            <div class="ftbox">
                ${input_text( name='firstname', id='firstname', value=fliparg(uinfo.firstname) )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Middle Name :</div>
            <div class="ftbox">
                ${input_text( name='middlename', id='middlename', value=fliparg(uinfo.middlename) )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Last Name :</div>
            <div class="ftbox">
                ${input_text( name='lastname', id='lastname', value=fliparg(uinfo.lastname) )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Address line 1 :</div>
            <div class="ftbox">
                ${input_text( name='addressline1', id='addressline1', value=fliparg(uinfo.addressline1) )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Address line 2 :</div>
            <div class="ftbox">
                ${input_text( name='addressline2', id='addressline2', value=fliparg(uinfo.addressline2) )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">City :</div>
            <div class="ftbox">
                ${input_text( name='city', id='city', value=fliparg(uinfo.city) )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Pincode :</div>
            <div class="ftbox">
                ${input_text( name='pincode', id='pincode', value=fliparg(uinfo.pincode) )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">State :</div>
            <div class="ftbox">
                ${input_text( name='state', id='state', value=fliparg(uinfo.state) )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Country :</div>
            <div class="ftbox">
                ${input_text( name='country', id='country', value=fliparg(uinfo.country) )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Userpanes :</div>
            <div class="ftbox">
                ${input_text( name='userpanes', id='myuserpanes', value=fliparg(uinfo.userpanes) )}
                <br></br>
                ${fieldhelp( up_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;"></div>
            <div class="fsubmit">
                ${input_submit( value='Submit' )}
                ${input_reset( value='Reset' )}
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_accountinfo() {
            new zeta.Form({ normalsub: true, formid : 'accountinfo' });
        } 
    </script>
</%def>

<%def name="form_updtpass( u, action )">
    <%
        pw_help = 'Should be a minimum of 4 character password.'
    %>

    <form id="updtpass" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 15em;">Enter new password :</div>
            <div class="fpass" required="true" regExp="${h.RE_PASSWD}">
                ${input_password( name='password', id='password')}
                <br></br>
                ${fieldhelp( pw_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 15em;">Confirm password :</div>
            <div class="fpass" required="true">
                ${input_password( name='confpass', id='confpass')}
                <br></br>
                ${fieldhelp( pw_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 15em;"></div>
            <div class="fsubmit">
                ${input_submit( value='Submit' )}
                ${input_reset( value='Reset' )}
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_updtpass() {
            function updtpass_onsubmit( e ) {
                password = dijit.byId( 'password' ).value;
                confpass = dijit.byId( 'confpass' ).value;
                if ( password == '' ) {
                    dojo.publish( 'flash', [ 'error', "Enter password", 2000 ] );
                } else if ( password != confpass ) {
                    dojo.publish( 'flash', [ 'error', "Re-type the exact password", 2000 ]
                    );
                } else {
                    submitform( form_updtpass, e );
                }
                dijit.byId( 'password' ).value = '';
                dijit.byId( 'confpass' ).value = '';
                dojo.stopEvent( e );
            }
            new zeta.Form({ onsubmit : updtpass_onsubmit, formid : 'updtpass' });
        } 
    </script>
</%def>

<%def name="form_add_userrelations( u, reltypes, action )">
    <form id='adduserrels' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='userfrom', value=u.username )}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 7em;">
                ${elements.iconize( 'Relation :', 'relation' )}</div>
            <div class="fselect"  style="width : 20em;" required="true">
                ${select( name='userrel_type', id='userrel_type', options=reltypes,
                          style='width : 10em' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 7em;">
                ${elements.iconize( 'Users :', 'users' )}</div>
            <div class="fselect" style="width : 20em;" required="true">
                ${multiselect( name='userto', id='userto', options=[], \
                               size="4", style='width : 10em' )}</div>
            <div class="fsubmit ml10">${input_submit( value='Add' )}</div>
        </div>
    </div>
    </form>
</%def>

<%def name="form_approve_userrelations( u, action )">
    <form id="approveuserrels" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    <div class="w100 form">
        <div class="fchkbox ml10" style="width : 27em;"><div id="aurels"></div></div>
        <div class="fsubmit ml10">${input_submit( value='Approve' )}</div>
    </div>
    </form>
    <div style="margin-left : 100px;" id="nodata">None</div>
</%def>

<%def name="form_del_userrelations( u, reltypes, action )">
    <form id='deluserrels' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 7em;">
                ${elements.iconize( 'Relation :', 'relation' )}</div>
            <div class="fselect"  style="width : 20em;" required="true">
                ${select( name='userrel_type', id='userrel_type', options=reltypes,
                          style='width : 10em' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 7em;">
                ${elements.iconize( 'Users :', 'users' )}</div>
            <div class="fselect" style="width : 20em;" required="true">
                ${multiselect( name='user_relation_id', id='user_relation_id',
                               options=[], size="4", style='width : 10em' )}</div>
            <div class="fsubmit ml10">${input_submit( value='Delete' )}</div>
        </div>
    </div>
    </form>
</%def>

<%def name="form_user_enable( u, action, dusers )">

    <form id="userenb" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 7em;">
                ${elements.iconize( 'Users :', 'users' )}</div>
            <div class="fselect vtop">
                ${multiselect( name='enable_user', id='enable_user', options=dusers,
                               size='7', style='width : 15em;' )}</div>
            <div class="fsubmit" style="margin-left : 50px">${input_submit( value='Enable' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        /* Initialise userenb form */
        function initform_userenb( e ) {
            seluser_enb = dojo.query( 'select#enable_user' )[0];
            new ZSelect( seluser_enb, 'enable_user', null );
            function userenb_onsubmit( e ) {
                submitform( form_userenb, e );
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ]);
                userstatus.store.close();
                userstatus.fetch( { onComplete : userstatus_oncomplete } );
                dojo.stopEvent( e );
            }
            new zeta.Form({ onsubmit : userenb_onsubmit, formid : 'userenb' });
        }
    </script>
</%def>

<%def name="form_user_disable( u, action , eusers)">

    <form id="userdis" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 7em;">
                ${elements.iconize( 'Users :', 'users' )}</div>
            <div class="fselect vtop">
                ${multiselect( name='disable_user', id='disable_user', options=eusers,
                               size='7', style='width : 15em;' )}</div>
            <div class="fsubmit" style="margin-left : 50px">${input_submit( value='Disable' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        /* Initialise userdis form */
        function initform_userdis( e ) {
            seluser_dis = dojo.query( 'select#disable_user' )[0];
            new ZSelect( seluser_dis, 'disable_user', null );
            function userdis_onsubmit( e ) {
                submitform( form_userdis, e );
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ]);
                userstatus.store.close();
                userstatus.fetch( { onComplete : userstatus_oncomplete } );
                dojo.stopEvent( e );
            }
            new zeta.Form({ onsubmit : userdis_onsubmit, formid : 'userdis' });
        }
    </script>
</%def>

<%def name="form_project_enable( u, action, dprojects )">
    <form id="prjenb" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 7em;">
                ${elements.iconize( 'Projects :', 'projects' )}</div>
            <div class="fselect vtop" style="width : 20em;">
                ${multiselect( name='enable_project', id='enable_project', options=dprojects,
                               size='7', style='width : 10em;' )}</div>
            <div class="fsubmit ml10">${input_submit( value='Enable' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        /* Initialise prjenb form */
        function initform_prjenb() {
            selproj_enb = dojo.query( 'select#enable_project' )[0];
            new ZSelect( selproj_enb, 'enable_project', null );
            function prjenb_onsubmit( e ) {
                submitform( form_prjenb, e );
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ]);
                projectstatus.store.close();
                projectstatus.fetch( { onComplete : projectstatus_oncomplete } );
                dojo.stopEvent( e );
            }
            new zeta.Form({ onsubmit : prjenb_onsubmit, formid : 'prjenb' });
        }
    </script>
</%def>

<%def name="form_project_disable( u, action, eprojects )">
    <form id="prjdis" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 7em;">
                ${elements.iconize( 'Projects :', 'projects' )}</div>
            <div class="fselect vtop" style="width : 20em;">
                ${multiselect( name='disable_project', id='disable_project', options=eprojects,
                               size='7', style='width : 10em;' )}</div>
            <div class="fsubmit ml10">${input_submit( value='Disable' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        /* Initialise prjdis form */
        function initform_prjdis() {
            selproj_dis = dojo.query( 'select#disable_project' )[0];
            new ZSelect( selproj_dis, 'disable_project', null );
            function prjdis_onsubmit( e ) {
                submitform( form_prjdis, e );
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ]);
                projectstatus.store.close();
                projectstatus.fetch( { onComplete : projectstatus_oncomplete } );
                dojo.stopEvent( e );
            }
            new zeta.Form({ onsubmit : prjdis_onsubmit, formid : 'prjdis' });
        }
    </script>
</%def>

<%def name="form_add_userpermissions( u, usernames, action, defuser, x_pgroups )">
    <form id="adduserperms" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 7em;">
                ${elements.iconize( 'User :', 'user' )}</div>
            <div class="fselect vtop"  required="true">
                ${select( name='username', id='addtouser', options=usernames, \
                          opt_selected=defuser, style='width : 12em' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 7em;">Permissions :</div>
            <div class="fselect vtop"  required="true">
                ${multiselect( name='perm_group', id='add_perm_group', options=x_pgroups, \
                               size="7", style='width : 15em' )}</div>
            <div class="fsubmit" style="margin-left : 50px">${input_submit( value='Add' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        /* Initialise adduserperms form */
        function initform_adduserperms( e ) {
            seluser_addpg  = dojo.query( 'form#adduserperms select#addtouser' )[0];
            selpg_touser   = dojo.query( 'form#adduserperms select#add_perm_group' )[0];
            new ZSelect( seluser_addpg, null, function( e ) { refresh_userperms() } );
            new ZSelect( selpg_touser, 'adduserpg', null );

            function adduserperms_onsubmit( e ) {
                submitform( form_adduserperms, e )
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ] );
                userperms.store.close();
                userperms.fetch({
                    onComplete : userperms_oncomplete,
                    sort       : [{ attribute : 'username' }]
                });
                dojo.stopEvent( e );
            }
            new zeta.Form({ onsubmit : adduserperms_onsubmit, formid : 'adduserperms' });
        }
    </script>
</%def>

<%def name="form_del_userpermissions( u, usernames, action, defuser, pgroups )">
    <form id="deluserperms" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 7em;">
                ${elements.iconize( 'User :', 'user' )}</div>
            <div class="fselect vtop"  required="true">
                ${select( name='username', id='delfromuser', options=usernames, \
                          opt_selected=defuser, style='width : 15em' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 7em;">Permissions :</div>
            <div class="fselect vtop"  required="true">
                ${multiselect( name='perm_group', id='del_perm_group', options=pgroups, \
                               size="7", style='width : 15em' )}</div>
            <div class="fsubmit" style="margin-left : 50px">${input_submit( value='Delete' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        /* Initialise deluserperms form */
        function initform_deluserperms( e ) {
            seluser_delpg  = dojo.query( 'form#deluserperms select#delfromuser' )[0];
            selpg_fromuser = dojo.query( 'form#deluserperms select#del_perm_group' )[0];
            new ZSelect( seluser_delpg, null, function( e ) { refresh_userperms() } );
            new ZSelect( selpg_fromuser, 'deluserpg', null );

            function deluserperms_onsubmit( e ) {
                submitform( form_deluserperms, e )
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ] );
                userperms.store.close();
                userperms.fetch({
                    onComplete : userperms_oncomplete,
                    sort       : [{ attribute : 'username' }]
                });
                dojo.stopEvent( e );
            }
            new zeta.Form({ onsubmit : deluserperms_onsubmit, formid : 'deluserperms' });
        }
    </script>
</%def>

<%def name="form_inviteuser( u, action )">
    <form id="inviteuser" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    <div class="form">
        <div class="field">
            <div class="label">
                ${elements.helpboard("""
                    provide user's emailid whom you want to invite.
                """)}
            </div>
            <div class="ftbox" required="true">
                ${input_text( name='emailid',  id='emailid', size='32', style='width : 15em;' )}
            </div>
        </div>
    </div>
</%def>

<%def name="form_forgotpass( action )">
    <form id="forgotpass" action="${action}" method="post">
    <div class="form">
        <div class="field">
            <div class="label">
                ${elements.helpboard("""
                    Enter the email id that you have registered with us
                """)}
            </div>
            <div class="ftbox" required="true">
                ${input_text( name='emailid',  id='emailid', size='32', style='width : 15em;' )}
            </div>
        </div>
    </div>
</%def>

<%def name="form_resetpass( action )">
    <%
        pw_help = 'Should be a minimum of 4 character password.'
    %>

    <form id="resetpass" action="${action}" method="post">
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 15em;">Enter new password :</div>
            <div class="fpass" required="true" regExp="${h.RE_PASSWD}">
                ${input_password( name='password', id='password')}
                <br></br>
                ${fieldhelp( pw_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 15em;">Confirm password :</div>
            <div class="fpass" required="true">
                ${input_password( name='confpass', id='confpass')}
                <br></br>
                ${fieldhelp( pw_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 15em;"></div>
            <div class="fsubmit">
                ${input_submit( value='Submit' )}
                ${input_reset( value='Reset' )}
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_resetpass() {
            function resetpass_onsubmit( e ) {
                var password = dijit.byId( 'password' ).value;
                var confpass = dijit.byId( 'confpass' ).value;
                var msg  = null;
                if ( password == '' ) {
                    msg = "Enter password";
                } else if ( password != confpass ) {
                    msg = "Re-type the exact password";
                }
                if( msg ) {
                    dojo.publish( 'flash', [ 'error', msg, 2000 ] );
                    dijit.byId( 'password' ).value = '';
                    dijit.byId( 'confpass' ).value = '';
                    dojo.stopEvent( e );
                }
            }
            new zeta.Form({ onsubmit : resetpass_onsubmit, formid : 'resetpass' });
        } 
    </script>
</%def>


## ------------------------- License Forms --------------------------------

<%def name="form_licenselist( lics, default='' )">
    <% 
        lics    = [ [ '', '--Select-License--' ] ] + lics
        default = default or '--Select-License--'
    %>
    <span style="margin-left : 10px; font-weight: normal;">
        ${select( name='viewlicense', id='viewlicense', options=lics, opt_selected=default )}
    </span>
</%def>

<%def name="form_createlicense( u, action )">
    <%
        ln_help  = 'licensename must be unique'
        sm_help  = 'one line summary'
        src_help = 'license originator'
    %>

    <form id="createlic" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    <div class="form 40em">
        <div class="field pt20">
            <div class="label" style="width : 12%;">License name :</div>
            <div class="ftbox" required="true">
                ${input_text( name='licensename',  id='licensename', size='32', style='width : 15em;' )}
                <br></br>
                ${fieldhelp( ln_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12%;">Summary :</div>
            <div class="ftbox" required="true">
                ${input_text( name='summary',  id='summary', size='64', style='width : 30em;' )}
                <br></br>
                ${fieldhelp( sm_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12%;">Source :</div>
            <div class="ftbox" required="true">
                ${input_text( name='source', id='source', size='64', style='width : 30em;' )}
                <br></br>
                ${fieldhelp( src_help )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop"  style="width : 12%;">License Text :</div>
            <div class="ftarea" required="true">
                ${textarea( name='text', tatype='simpletextarea', id='text',
                            cols='80', rows='20', style='width : 100%' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12%;"></div>
            <div class="fsubmit">
                ${input_submit( value='Submit' )}
                ${input_reset( value='Reset' )}
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_liccreate() {
            function createlic_onsubmit( e ) {
                if ( dijit.byId( 'createlic' ).validate() ) {
                    var lictext = dojo.byId( 'text' ).value
                    if(! lictext ) {
                        dojo.publish(
                            'flash', [ 'error', "License text must be present", 2000 ]
                        );
                        dojo.stopEvent( e );
                    }
                } else {
                    dojo.publish( 'flash', [ 'error', "Invalid form fields", 2000 ]);
                    dojo.stopEvent( e );
                }
            }
            new zeta.Form({ onsubmit : createlic_onsubmit, formid : 'createlic' });
            dijit.byId( 'licensename' ).focus();
        }
    </script>
</%def>

<%def name="form_updatelicense_h( u, l, action )">
    <%
        ln_help  = 'licensename must be unique'
        sm_help  = 'one line summary'
        src_help = 'license originator'
    %>

    <form id="updatelic" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    ${input_hidden( name='license_id', value=str(l.id))}
    <div class="form 40em">
        <div class="field pt20">
            <div class="label" style="width : 12%;">License name :</div>
            <div class="ftbox" required="true">
                ${input_text( name='licensename',  id='licensename', 
                              value=l.licensename, size='32', style='width : 15em;' )}
                <br></br>
                ${fieldhelp( ln_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12%;">Summary :</div>
            <div class="ftbox" required="true">
                ${input_text( name='summary',  id='summary', 
                              value=l.summary, size='64', style='width : 30em;' )}
                <br></br>
                ${fieldhelp( sm_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12%;">Source :</div>
            <div class="ftbox" required="true">
                ${input_text( name='source', id='source', size='64', 
                              value=l.source, style='width : 30em;' )}
                <br></br>
                ${fieldhelp( src_help )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 12%;">License Text :</div>
            <div class="ftarea" required="true">
                ${textarea( name='text', tatype='simpletextarea', id='text',
                            cols='90', rows='20', style='width : 100%' )}
            </div>
        </div>
        ## We are not adding the license text here since it is already
        ## availabe in the view license element. Optimizing on bandwidth
        <div class="field">
            <div class="label" style="width : 12%;"></div>
            <div class="fsubmit">
                ${input_submit( value='Submit' )}
                ${input_reset( value='Reset' )}
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function updatelic_onsubmit( e ) {
            if ( dijit.byId( 'updatelic' ).validate() ) {
                var lictext = dojo.byId( 'text' ).value
                if(! lictext ) {
                    dojo.publish(
                        'flash', [ 'error', "License text must be present", 2000 ]
                    );
                    dojo.stopEvent( e );
                }
            } else {
                dojo.publish( 'flash', [ 'error', "Invalid form fields", 2000 ]);
                dojo.stopEvent( e );
            }
        }
        function initform_updatelic() {
            // Connect form-edit (update) handler
            var n_edit = dojo.query( 'div[name=editlic]' )[0];
            var n_view = dojo.query( 'div[name=viewlic]' )[0];
            var edit   = dojo.query( 'div.pbar span[name=editlic]' )[0];
            if( n_edit && edit ) {
                dojo.connect(
                    edit, 'onclick', 
                    function ( e ) {
                      var i_text = dojo.query( 'textarea#text', form_updatelic )[0];
                      edit.style.display   = 'none';
                      n_view.style.display = 'none';
                      n_edit.style.display = 'block';
                      dijit.byId( 'licensename' ).focus();
                    }
                );
            }
            // Instantiate 'updatelic'
            new zeta.Form({ onsubmit : updatelic_onsubmit, formid :  'updatelic' });

            /* Copy and process the license text */
            var re         = new RegExp( '\n', 'g' );
            var n_lictext  = dojo.query( 'div[name=text]', n_view )[0];
            dojo.query('textarea#text', form_updatelic
                      )[0].value = n_lictext.innerHTML;
            n_lictext.innerHTML = dojo.query( 'textarea#text', form_updatelic
                                            )[0].value.replace( re, '<br></br>' );
            dojo.toggleClass( n_lictext, 'dispnone', false )
        }
        dojo.addOnLoad( initform_updatelic );
    </script>
</%def>

<%def name="form_removelic_h( u , action )">

    <form id="rmlic" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    ${input_hidden( name='licensename',  id='licensename')}
    </form>

    <script type="text/javascript">
        function initform_rmlic() {
            function removelic( n_remove, n_tr, e ) {
                var i_licname = dojo.query( 'input#licensename' )[0];
                var n_table   = n_tr.parentNode;
                i_licname.value = dojo.attr( n_tr, 'licensename' );
                submitform( form_rmlic, e );
                n_table.removeChild( n_tr );
            }
            dojo.query( 'span[name=rmlic]' ).forEach(
                function( n ) {
                    dojo.connect(
                        n, 'onclick', 
                        dojo.partial( removelic, n, n.parentNode.parentNode )
                    );
              }
            );
            new zeta.Form({ onsubmit : null, formid : 'rmlic' });
        }
        dojo.addOnLoad( initform_rmlic );
    </script>
</%def>

#### --------------------------Project Forms --------------------------------

<%def name="form_createproject( u, licensenames, projectnames, action )">
    <%
        pn_help = '<b>"projectname" cannot be changed later</b>' 
        sm_help = 'one line summary'
    %>

    <form id="createprj" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='admin', value=u.username )}
    <div class="form">
        <div class="field">
            <div class="label" style="width : 15%">Project name :</div>
            <div class="ftbox" required="true" regExp="${h.RE_PNAME}">
                ${input_text( name='projectname', id='projectname' )}
                <br></br>
                ${fieldhelp( pn_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 15%;">Summary :</div>
            <div class="ftbox" required="true">
                ${input_text( name='summary', id='summary', size='64', style='width : 30em;' )}
                <br></br>
                ${fieldhelp( sm_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 15%;">Admin E-mailid :</div>
            <div class="ftbox" required="true">
                ${input_text( name='admin_email', id='admin_email', value=u.emailid )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 15%;">License :</div>
            <div class="fselect" required="true">
                ${select( name='licensename',  id='licensename', options=licensenames )}
                % if c.liceditable :
                    <a class="ml10 fntitalic" href="${h.url_crlic}"
                       title="Create a new license for this project">create-license</a>
                % else :
                    <em title="You don't have the permission" 
                        class="pointer ml10 undrln fggray">create-license</em>
                % endif
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 15%;">Description :</div>
            <div class="ftarea" required="true">
                ${elements.captiontextarea( 'Use wiki markup to compose project description.' )}
                ${textarea( name='description', tatype='simpletextarea', id='description',
                            cols='90', rows='20', style='width : 100%' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 15%;"></div>
            <div class="fsubmit">
                ${input_submit( value='Submit' )}
                ${input_reset( value='Reset' )}
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_createproject() {
            function createprj_onsubmit( e ) {
                var rg_pname  = dijit.byId('projectname').value;
                var projnames = ${h.json.dumps( projectnames ) | n};
                var stopevent = false;
                var msg       = '';
                if ( dijit.byId('createprj').validate() ) {
                    for ( i in projnames ) {
                        if ( projnames[i] == rg_pname ) {
                            stopevent = true;
                            msg       = rg_pname+ ' already exists'
                        }
                    }
                    if (! dojo.attr( dojo.byId( 'licensename' ), 'value' )) {
                        stopevent = true;
                        msg       = 'Provide the license for project !!'
                    }
                    if (! dojo.attr( dojo.byId( 'description' ), 'value' )) {
                        stopevent = true;
                        msg       = 'Project description is a must !!'
                    }
                    if (stopevent) {
                        dojo.publish( 'flash', [ 'error', msg, 2000 ]);
                        dojo.stopEvent( e );
                    }
                } else {
                    dojo.publish( 'flash', [ 'error', "Invalid form fields", 2000 ]);
                    dojo.stopEvent( e );
                }
            }
            new zeta.Form({ onsubmit : createprj_onsubmit, formid : 'createprj' });
            dijit.byId( 'projectname' ).focus();
        } 
    </script>
</%def>

<%def name="form_projectinfo( u, p, licensenames, usernames, licurl, action )">
    <%
        sm_help = 'one line summary'
        em_help = 'if left empty, your registered email-id will be used.'
        ml_help = 'project mailing-list as comma separated values'
        ir_help = 'project irc-channels as comma separated values'

        pinfo        = p.project_info
        mailinglists = ', '.join([ m.mailing_list for m in p.mailinglists ])
        ircchannels  = ', '.join([ i.ircchannel for i in p.ircchannels ])
    %>

    <form id="updateprj" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='projectname', value=str(p.projectname))}
    ## Field for 'prjexp' form
    ${input_hidden( name='expose_project', id='exposed', value=p.projectname )}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10%;">Summary :</div>
            <div class="ftbox" required="true">
                ${input_text( name='summary', id='summary', size='64',
                              style='width : 30em;', value=p.summary )}
                <br></br>
                ${fieldhelp( sm_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10%;">Admin E-mailid :</div>
            <div class="ftbox">
                ${input_text( name='admin_email', id='admin_email', value=p.admin_email )}
                <br></br>
                ${fieldhelp( em_help )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 10%;">Description :</div>
            <div class="ftarea" required="true">
                ${elements.captiontextarea( 'Use wiki markup to compose project description.' )}
                ${textarea( name='description', id='description',
                            text=p.project_info.description, style='width : 40em' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10%;">Admin :</div>
            <div class="fselect" required="true">
                ${select( name='admin',  id='admin', options=usernames,
                opt_selected=p.admin.username )}
                ${fieldhelp( 
                    'if you are changing the administrator, be sure to refresh the page',
                    fhstyle="font-style: italic; color: red"
                )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10%;">License :</div>
            <div class="fselect" required="true">
                ${select( name='licensename',  id='licensename', options=licensenames,
                          opt_selected=p.license and p.license.licensename or '' )}
                <a class="ml5" href="${licurl}">view-all-license</a>
            </div>
        </div>
        ## Field for 'prjml' form
        <div class="field">
            <div class="label" style="width : 10%;">Mailing-lists :</div>
            <div class="ftbox">
                ${input_text( name='mailinglists', id='mailinglists', size='64',
                              value= mailinglists )}
                <br></br>
                ${fieldhelp( ml_help )}
            </div>
        </div>
        ## Field for 'prjirc' form
        <div class="field">
            <div class="label" style="width : 10%;">Irc-channels :</div>
            <div class="ftbox">
                ${input_text( name='ircchannels', id='ircchannels', size='64',
                              value= ircchannels )}
                <br></br>
                ${fieldhelp( ir_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10%;"></div>
            <div class="fsubmit">
                ${input_submit( value='Submit' )}
                ${input_reset( value='Reset' )}
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function updateprj_onsubmit( e ) {
            var msg       = '';
            if ( dijit.byId('updateprj').validate() ) {
                if (! dojo.attr( dojo.byId( 'licensename' ), 'value' )) {
                    msg       = 'Provide the license for project !!'
                }
                if (! dojo.attr( dojo.byId( 'description' ), 'value' )) {
                    msg       = 'Project description is a must !!'
                }
            } else {
                msg = "Invalid form fields"
            }
            if (msg) {
                dojo.publish( 'flash', [ 'error', msg, 2000 ]);
            } else {
                submitform( form_updateprj, e );
            }
            dojo.stopEvent( e );
        }
        function initform_projectinfo() {
            new zeta.Form({ onsubmit : updateprj_onsubmit, formid : 'updateprj' });
        }
    </script>
</%def>

<%def name="form_createpcomp( u, p, pusers, action )">
    <%
        cn_help = 'Component name must be unique'
    %>

    <form id="createpcomp" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;">Component name :</div>
            <div class="ftbox" required="true">
                ${input_text( name='componentname', id='crcompname' )}
                <br></br>
                ${fieldhelp( cn_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Owner :</div>
            <div class="ftbox">
                ${select( name='owner',  id='crowner', options=pusers )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 10em;">Description : </div>
            <div class="ftarea" required="true">
                ${elements.captiontextarea( 'Use wiki markup to compose component description.' )}
                ${textarea( name='description', id='crcompdesc', rows='1', cols='50',
                            style='width : 25em' )}
                <div>${input_submit( value='Create' )}</div>
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_createpcomp() {
            var select_puser = dojo.query( 'form#createpcomp select#crowner' )[0];
            new ZSelect( select_puser, 'projusers', null );

            function createpcomp_onsubmit( e ) {
                var msg = ''
                if ( dijit.byId('createpcomp').validate() ) {
                    if (! dojo.attr( dojo.byId( 'crowner' ), 'value' )) {
                        msg = 'Provide component owner !!'
                    }
                    if (! dojo.attr( dojo.byId( 'crcompdesc' ), 'value' )) {
                        msg = 'Provide component description !!'
                    }

                    if ( msg ) {
                        dojo.publish( 'flash', [ 'error', msg, 2000 ]);
                    } else {
                        submitform( form_createpcomp, e);
                        pcomplist.store.close();
                        pcomplist.fetch({
                            onComplete : pcomplist_oncomplete,
                            sort : [ { attribute : 'componentname' } ]
                        })
                    }
                } else {
                    dojo.publish( 'flash', [ 'error', "Invalid form fields", 2000 ]);
                }
                dojo.stopEvent(e);
            }
            new zeta.Form({ onsubmit: createpcomp_onsubmit, formid : 'createpcomp' });
        }
    </script>
</%def>

<%def name="form_updatepcomp( u, p, pusers, pcomplist, action )">
    <%
        cn_help = 'component name must be unique'
    %>

    <div class="w100 mb10">
        ${select( name='updtpcomp', id='updtpcomp', options=pcomplist )}
        <hr></hr>
    </div>
    <form id="updatepcomp" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='component_id', value='' )}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;">Component name :</div>
            <div class="ftbox" required="true">
                ${input_text( name='componentname', id='updtcompname' )}
                <br></br>
                ${fieldhelp( cn_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Owner :</div>
            <div class="ftbox">
                <span class="fggray" name="ownername"></span>&ensp;&ensp;
                <span>Pick new owner :</span>
                ${select( name='owner',  id='updtowner', options=pusers )}</div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 10em;">Description : </div>
            <div class="ftarea" required="true">
                ${elements.captiontextarea( 'Use wiki markup to compose component description.' )}
                ${textarea( name='description', id='updtpcompdesc', cols='50',
                            style='width : 25em' )}
                <div>${input_submit( value='Update' )}</div>
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        /* Setup component detail update */
        function initform_updatepcomp() {
            var selpcomp_owner = dojo.query( 'form#updatepcomp select#updtowner')[0];
            new ZSelect( selpcomp_owner, 'updtpcompowners', null ); 
            function updatepcomp_onsubmit( e ) {
                var msg = ''
                if ( dijit.byId('updatepcomp').validate() ) {
                    if (! dojo.attr( dojo.byId( 'updtowner' ), 'value' )) {
                        msg = 'Provide component owner !!'
                    }
                    if (! dojo.attr( dojo.byId( 'updtpcompdesc' ), 'value' )) {
                        msg = 'Provide component description !!'
                    }

                    if ( msg ) {
                        dojo.publish( 'flash', [ 'error', msg, 2000 ]);
                    } else {
                        submitform( form_updatepcomp, e);
                        pcomplist.store.close();
                        pcomplist.fetch({
                            onComplete : pcomplist_oncomplete,
                            sort : [ { attribute : 'componentname' } ]
                        })
                    }
                } else {
                    dojo.publish( 'flash', [ 'error', "Invalid form fields", 2000 ]);
                }
                dojo.stopEvent(e);
            }
            new zeta.Form({ onsubmit: updatepcomp_onsubmit, formid : 'updatepcomp' });
        }
    </script>
</%def>

<%def name="form_rmpcomp( u, p, action )">
    <form id="rmpcomp" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;"></div>
            <div class="ftarea">
                ${multiselect( name='component_id',  id='component_id', options=[],
                               size='4', style='width : 20em;' )}
                <div>${input_submit( value='Delete' )}</div>
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_rmpcomp() {
            /* Setup component removal */
            var selpcomp_rmpcomp = dojo.query( 'form#rmpcomp select#component_id')[0];
            function rmpcomp_onsubmit( e ) {
                submitform( form_rmpcomp, e );
                pcomplist.store.close();
                pcomplist.fetch({
                    onComplete : pcomplist_oncomplete,
                    sort : [ { attribute : 'componentname' } ]
                })
                dojo.stopEvent(e);
            }
            new ZSelect( selpcomp_rmpcomp, 'rmpcomp', null )
            new zeta.Form({ onsubmit: rmpcomp_onsubmit, formid : 'rmpcomp' });
        }
    </script>
</%def>

<%def name="form_createmstn( u, p, action )">
    <%
        mn_help = 'milestone name must be unique'
    %>

    <form id="createmstn" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;">Milestone name :</div>
            <div class="ftbox" required="true"> 
                ${input_text( name='milestone_name', id='crmstnname' )}
                <br></br>
                ${fieldhelp( mn_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Due date :</div>
            <div class="fdtbox">
                ${input_text( name='due_date', id='crduedate' )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 10em;">Description : </div>
            <div class="ftarea" required="true">
                ${elements.captiontextarea( 'Use wiki markup to compose milestone description.' )}
                ${textarea( name='description', id='crmstndesc', rows='1', cols='50',
                            style='width : 25em' )}
                <br></br>
                <div>${input_submit( value='Create' )}</div>
            </div>
        </div>
    </div>
    </form>
    
    <script type="text/javascript">
        /* setup milestone creation */
        function initform_createmstn() {
            function createmstn_onsubmit( e ) {
                var msg     = ''
                if ( dijit.byId('createmstn').validate() ) {
                    if (! dojo.attr( dojo.byId( 'crmstndesc' ), 'value' )) {
                        msg = 'Provide milestone description !!'
                    }

                    if ( msg ) {
                        dojo.publish( 'flash', [ 'error', msg, 2000 ]);
                    } else {
                        submitform( form_createmstn, e);
                        mstnlist.store.close();
                        mstnlist.fetch({
                            onComplete : mstnlist_oncomplete,
                            sort : [ { attribute : 'milestone_name' } ]
                        });
                    }
                } else {
                    dojo.publish( 'flash', [ 'error', "Invalid form fields", 2000 ]);
                }
                dojo.stopEvent(e);
            }
            new zeta.Form({ onsubmit: createmstn_onsubmit, formid : 'createmstn' });
        }
    </script>
</%def>

<%def name="form_updatemstn( u, p, mstnlist, action )">
    <%
        mn_help = 'milestone name must be unique'
    %>

    <div class="w100 mb20">
        ${select( name='updtmstn', id='updtmstn', options=mstnlist )}
        <hr></hr>
    </div>
    <form id="updatemstn" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='milestone_id', value='' )}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;">Mileston name :</div>
            <div class="ftbox" required="true">
                ${input_text( name='milestone_name', id='updtmstnname' )}
                <br></br>
                ${fieldhelp( mn_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Due date :</div>
            <div class="fdtbox">
                ${input_text( name='due_date', id='updtduedate' )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 10em;">Description : </div>
            <div class="ftarea" required="true">
                ${elements.captiontextarea( 'Use wiki markup to compose milestone description.' )}
                ${textarea( name='description', id='updtmstndesc', cols='50',
                            style='width : 25em' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Mark as : </div>
            <div class="fradio">
                ${input_radio( name='status', id='mstnstatus1', value='cancelled',
                               text='cancelled' )}
                ${input_radio( name='status', id='mstnstatus2', value='completed',
                               text='completed' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 10em;">Closing remark : </div>
            <div class="ftarea">
                ${elements.captiontextarea( 'Use wiki markup to compose closing_remark.' )}
                ${textarea( name='closing_remark', id='closing_remark', rows='4', cols='50',
                style='width : 25em' )}
                <div>${input_submit( value='Update' )}</div>
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        /* setup milestone update */
        function initform_updatemstn() {
            function updatemstn_onsubmit( e ) {
                var msg = ''
                dojo.stopEvent(e);
                if ( dijit.byId('updatemstn').validate() ) {
                    if (! dojo.attr( dojo.byId( 'updtmstndesc' ), 'value' )) {
                        msg = 'Provide milestone description !!'
                    }
                    if ( dijit.byId( 'mstnstatus1' ).checked || 
                         dijit.byId( 'mstnstatus2' ).checked ) {
                        if (! dojo.attr( dojo.byId( 'closing_remark' ), 'value' )) {
                            msg = 'Provide closing remark !!'
                        }
                    }

                    if ( msg ) {
                        dojo.publish( 'flash', [ 'error', msg, 2000 ]);
                    } else {
                        submitform( form_updatemstn, e);
                        mstnlist.store.close();
                        mstnlist.fetch({
                            onComplete : mstnlist_oncomplete,
                            sort : [ { attribute : 'milestone_name' } ]
                        });
                    }
                } else {
                    dojo.publish( 'flash', [ 'error', "Invalid form fields", 2000 ]);
                }
            }
            new zeta.Form({ onsubmit: updatemstn_onsubmit, formid : 'updatemstn' });
        }
    </script>
</%def>

<%def name="form_rmmstn( u, p, action )">
    <form id="rmmstn" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;"></div>
            <div class="ftarea">
                ${multiselect( name='milestone_id',  id='milestone_id', options=[],
                               size='4', style='width : 20em;' )}
                <div>${input_submit( value='Delete' )}</div>
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        /* Setup milestone removal */
        function initform_rmmstn() {
            var selmstn_rmmstn = dojo.query( 'form#rmmstn select#milestone_id' )[0];
            new ZSelect( selmstn_rmmstn, 'rmmstn', null )
            function rmmstn_onsubmit( e ) {
                submitform( form_rmmstn, e );
                mstnlist.store.close();
                mstnlist.fetch({
                    onComplete : mstnlist_oncomplete,
                    sort : [ { attribute : 'milestone_name' } ]
                });
                dojo.stopEvent(e);
            }
            new zeta.Form({ onsubmit: rmmstn_onsubmit, formid : 'rmmstn' });
        }
    </script>
</%def>

<%def name="form_createver( u, p, action )">
    <%
        vn_help = 'version name must be unique'
    %>

    <form id="createver" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;">Version name :</div>
            <div class="ftbox" required="true">
                ${input_text( name='version_name', id='crvername' )}
                <br></br>
                ${fieldhelp( vn_help )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 10em;">Description : </div>
            <div class="ftarea" required="true">
                ${elements.captiontextarea( 'Use wiki markup to compose version description.' )}
                ${textarea( name='description', id='crverdesc', rows='1', cols='50',
                            style='width : 25em' )}
                <div>${input_submit( value='Create' )}</div>
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        /* setup version creation */
        function initform_createver() {
            function createver_onsubmit( e ) {
                var msg = ''
                if ( dijit.byId('createver').validate() ) {
                    if (! dojo.attr( dojo.byId( 'crverdesc' ), 'value' )) {
                        msg = 'Provide version description !!'
                    }

                    if ( msg ) {
                        dojo.publish( 'flash', [ 'error', msg, 2000 ]);
                    } else {
                        submitform( form_createver, e );
                        verlist.store.close();
                        verlist.fetch({
                            onComplete : verlist_oncomplete,
                            sort : [ { attribute : 'version_name' } ]
                        });
                    }
                } else {
                    dojo.publish( 'flash', [ 'error', "Invalid form fields", 2000 ]);
                }
                dojo.stopEvent(e);
            }
            new zeta.Form({ onsubmit: createver_onsubmit, formid : 'createver' });
        }
    </script>
</%def>

<%def name="form_updatever( u, p, verlist, action )">
    <%
        vn_help = 'version name must be unique'
    %>

    <div class="w100 mb10">
        ${select( name='updtver', id='updtver', options=verlist )}
        <hr></hr>
    </div>
    <form id="updatever" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='version_id', value='' )}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;">Version name :</div>
            <div class="ftbox" required="true">
                ${input_text( name='version_name', id='updtvername' )}
                <br></br>
                ${fieldhelp( vn_help )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 10em;">Description : </div>
            <div class="ftarea" required="true">
                ${elements.captiontextarea( 'Use wiki markup to compose version description.' )}
                ${textarea( name='description', id='updtverdesc', cols='50',
                            style='width : 25em' )}
                <div>${input_submit( value='Update' )}</div>
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_updatever() {
            /* Setup version detail update */
            function updatever_onsubmit( e ) {
                var msg = ''
                if ( dijit.byId('updatever').validate() ) {
                    if (! dojo.attr( dojo.byId( 'updtverdesc' ), 'value' )) {
                        msg = 'Provide version description !!'
                    }

                    if ( msg ) {
                        dojo.publish( 'flash', [ 'error', msg, 2000 ]);
                    } else {
                        submitform( form_updatever, e);
                        verlist.store.close();
                        verlist.fetch({
                            onComplete : verlist_oncomplete,
                            sort : [ { attribute : 'version_name' } ]
                        });
                    }
                } else {
                    dojo.publish( 'flash', [ 'error', "Invalid form fields", 2000 ]);
                }
                dojo.stopEvent(e);
            }
            new zeta.Form({ onsubmit: updatever_onsubmit, formid : 'updatever' });
        }
    </script>
</%def>

<%def name="form_rmver( u, p, action )">
    <form id="rmver" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id))}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;"></div>
            <div class="ftarea">
                ${multiselect( name='version_id',  id='version_id', options=[],
                               size='4', style='width : 20em;' )}
                <div>${input_submit( value='Delete' )}</div>
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        /* Setup version removal */
        function initform_rmver() {
            var selver_rmver= dojo.query( 'form#rmver select#version_id' )[0];
            new ZSelect( selver_rmver, 'rmver', null )
            function rmver_onsubmit( e ) {
                submitform( form_rmver, e );
                verlist.store.close();
                verlist.fetch({
                    onComplete : verlist_oncomplete,
                    sort : [ { attribute : 'version_name' } ]
                });
                dojo.stopEvent(e);
            }
            new zeta.Form({ onsubmit: rmver_onsubmit, formid : 'rmver' });
        }
    </script>
</%def>

<%def name="form_addprjteam( u, p, teamtypes, deftt, x_teamusers, action )">
    <form id='addprjteam' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;">
                ${elements.iconize( 'Team :', 'team' )}</div>
            <div class="fselect"  required="true">
                ${select( name='team_type', id='team_type', options=teamtypes,
                          opt_selected=deftt, style='width : 10em' )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 10em;">
                ${elements.iconize( 'Users :', 'users' )}</div>
            <div class="fselect" required="true">
                ${multiselect( name='projuser', options=x_teamusers, \
                               size="7", style='width : 10em' )}</div>
            <div class="fsubmit" style="margin-left : 50px">${input_submit( value='Submit' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        /* Setup user additions to project team */
        function initform_addprjteam() {
            var aselect_tt     = dojo.query( 'form#addprjteam select[name=team_type]' )[0];
            var select_adduser = dojo.query( 'form#addprjteam select[name=projuser]' )[0];

            new ZSelect( aselect_tt, null, function( e ) { refresh_projuser( 'toadd' ) } );
            new ZSelect( select_adduser, 'addprojuser', null );

            function addprjteam_onsubmit( e ) {
                submitform( form_addprjteam, e )
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ] );
                // Fetch and update the project team member details.
                projectteams.store.close();
                projectteams.fetch({ onComplete : projectteams_oncomplete });
                dojo.stopEvent( e );
            }
            new zeta.Form({ onsubmit: addprjteam_onsubmit, formid : 'addprjteam' });
        }
    </script>
</%def>

<%def name="form_delprjteam( u, p, teamtypes, deftt, teamusers, action )">
    <form id='delprjteam' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;">
                ${elements.iconize( 'Team :', 'team' )}</div>
            <div class="fselect"  required="true">
                ${select( name='team_type', id='team_type', options=teamtypes,
                          opt_selected=deftt, style='width : 10em' )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 10em;">
                ${elements.iconize( 'Users :', 'users' )}</div>
            <div class="fselect" required="true">
                ${multiselect( name='project_team_id', id='project_team_id',
                               options=teamusers, size="7", style='width : 10em' )}</div>
            <div class="fsubmit" style="margin-left : 50px">${input_submit( value='Submit' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_delprjteam() {
            /* Setup user removal from project team */
            var dselect_tt     = dojo.query( 'form#delprjteam select[name=team_type]' )[0];
            var select_deluser = dojo.query( 'form#delprjteam select#project_team_id' )[0];

            new ZSelect( dselect_tt, null, function( e ) { refresh_projuser( 'todel' ) } );
            new ZSelect( select_deluser, 'delprojuser', null );

            function delprjteam_onsubmit( e ) {
                submitform( form_delprjteam, e )
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ] );
                // Fetch and update the project team member details.
                projectteams.store.close();
                projectteams.fetch({ onComplete : projectteams_oncomplete });
                dojo.stopEvent( e );
            }
            new zeta.Form({ onsubmit: delprjteam_onsubmit, formid : 'delprjteam' });
        }
    </script>
</%def>

<%def name="form_addteamperms( u, p, teamtypes, deftt, x_teampgroups, action )">
    <form id='addteamperms' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;">
                ${elements.iconize( 'Team :', 'team' )}</div>
            <div class="fselect"  required="true">
                ${select( name='team_type', id='team_type', options=teamtypes,
                          opt_selected=deftt, style='width : 10em' )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 10em;">Permissions :</div>
            <div class="fselect" required="true">
                ${multiselect( name='perm_group', id='perm_group', options=x_teampgroups, \
                               size="7", style='width : 15em' )}</div>
            <div class="fsubmit" style="margin-left : 50px">${input_submit( value='Submit' )}</div>
        </div>
    </div>
    </form>
    <script type="text/javascript">
        /* Setup permission additions to project team */
        function initform_addteamperms() {
            var aselect_tt     = dojo.query( 'form#addteamperms select[name=team_type]'
                                           )[0];
            var select_addperm = dojo.query( 'form#addteamperms select[name=perm_group]'
                                           )[0];
            new ZSelect( aselect_tt, null, function( e ) { refresh_teamperms( 'toadd' ) } );
            new ZSelect( select_addperm, 'addpgtoteam', null );
            function addteamperms_onsubmit( e ) {
                submitform( form_addteamperms, e )
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ] );
                teamperms.store.close();
                teamperms.fetch({ onComplete : teamperms_oncomplete });
                dojo.stopEvent( e );
            }
            new zeta.Form({ onsubmit: addteamperms_onsubmit, formid : 'addteamperms' });
        }
    </script>
</%def>

<%def name="form_delteamperms( u, p, teamtypes, deftt, teampgroups, action )">
    <form id='delteamperms' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 10em;">
                ${elements.iconize( 'Team :', 'team' )}</div>
            <div class="fselect"  required="true">
                ${select( name='team_type', id='team_type', options=teamtypes,
                          opt_selected=deftt, style='width : 10em' )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 10em;">Permissions :</div>
            <div class="fselect" required="true">
                ${multiselect( name='projectteam_perm_id', id='projectteam_perm_id',
                               options=teampgroups, size="7", style='width : 15em' )}</div>
            <div class="fsubmit" style="margin-left : 50px">${input_submit( value='Submit' )}</div>
        </div>
    </div>
    </form>
    <script type="text/javascript">
        /* Setup permission removals to project team */
        function initform_delteamperms() {
            var dselect_tt     = dojo.query( 'form#delteamperms select[name=team_type]'
                                           )[0];
            var select_delperm = dojo.query( 'form#delteamperms select#projectteam_perm_id'
                                           )[0];
            new ZSelect( select_delperm, 'delpgfromteam', null );
            new ZSelect( dselect_tt, null, function( e ) { refresh_teamperms( 'todel' ) } );
            function delteamperms_onsubmit( e ) {
                submitform( form_delteamperms, e )
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ] );
                teamperms.store.close();
                teamperms.fetch({ onComplete : teamperms_oncomplete });
                dojo.stopEvent( e );
            }
            new zeta.Form({ onsubmit: delteamperms_onsubmit, formid : 'delteamperms' });
        }
    </script>
</%def>

<%def name="form_addprjperms( u, p, projusers, defuser, x_userpgroups, action )">
    <form id='addprjperms' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 7em;">
                ${elements.iconize( 'User :', 'user' )}</div>
            <div class="fselect"  required="true">
                ${select( name='projuser', options=projusers,
                          opt_selected=defuser, style='width : 10em' )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 7em;">Permissions :</div>
            <div class="fselect" required="true">
                ${multiselect( name='perm_group', id='perm_group', options=x_userpgroups, \
                               size="7", style='width : 15em' )}</div>
            <div class="fsubmit" style="margin-left : 50px">${input_submit( value='Submit' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        /* Setup permission additions to project user */
        function initform_addprjperms() {
            var aselect_user   = dojo.query( 'form#addprjperms select[name=projuser]'
                                           )[0];
            var select_addperm = dojo.query( 'form#addprjperms select[name=perm_group]'
                                           )[0];
            new ZSelect( select_addperm, 'addppgtouser', null );
            new ZSelect( aselect_user, 'projusers', function( e ) { refresh_prjperms() } );
            function addprjperms_onsubmit( e ) {
                submitform( form_addprjperms, e )
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ] );
                prjperms.store.close();
                prjperms.fetch({ onComplete : prjperms_oncomplete,
                                 sort       : [{ attribute : 'username' }]
                              });
                dojo.stopEvent( e );
            }
            new zeta.Form({ onsubmit: addprjperms_onsubmit, formid : 'addprjperms' });
        }
        dojo.addOnLoad( initform_addprjperms );
    </script>
</%def>

<%def name="form_delprjperms( u, p, projusers, defuser, userpgroups, action )">
    <form id='delprjperms' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 7em;">
                ${elements.iconize( 'User :', 'user' )}</div>
            <div class="fselect"  required="true">
                ${select( name='projuser', options=projusers,
                          opt_selected=defuser, style='width : 10em' )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop" style="width : 7em;">Permissions :</div>
            <div class="fselect" required="true">
                ${multiselect( name='project_perm_id', id='project_perm_id', options=userpgroups,
                               size="7", style='width : 15em' )}</div>
            <div class="fsubmit" style="margin-left : 50px">${input_submit( value='Submit' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_delprjperms() {
            /* Setup permission removals to project user */
            var dselect_user   = dojo.query( 'form#delprjperms select[name=projuser]'
                                           )[0];
            var select_delperm = dojo.query( 'form#delprjperms select#project_perm_id'
                                           )[0];
            new ZSelect( select_delperm, 'delppgfromuser', null );
            new ZSelect( dselect_user, 'projusers', function( e ) { refresh_prjperms() } );
            function delprjperms_onsubmit( e ) {
                submitform( form_delprjperms, e )
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ] );
                prjperms.store.close();
                prjperms.fetch({ onComplete : prjperms_oncomplete,
                                 sort       : [{ attribute : 'username' }]
                              });
                dojo.stopEvent( e );
            }
            new zeta.Form({ onsubmit: delprjperms_onsubmit, formid : 'delprjperms' });
        }
        dojo.addOnLoad( initform_delprjperms );
    </script>
</%def>

<%def name="form_projfav( u, p, action, name )">
    <form id='projfav' class="dispnone" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name=name, value=str(u.username))}
    </form>

    <script type="text/javascript">
        /* Setup favorite project for user */
        function initform_projfav() {
            var n_span  = dojo.query( "span[name=favproj]" )[0];
            var w_form  = new zeta.Form({ normalsub: true, formid: 'projfav' });
            var n_field = dojo.query( "input[name=${name}]", form_projfav )[0];
            if( n_span && n_field ) {
                new ZFavorite( n_span, form_projfav, n_field );
            }
        }
    </script>
</%def>

#### -------------------------- Ticket Forms --------------------------------

<%def name="form_selectticket( u, ticketlist, default='' )">
    <%
        ticketlist = [ [ '', '--Select-Ticket--' ] ] + ticketlist 
        default    = default or '--Select-Ticket--'
    %>
    <span class="ml5">
        ${select( name='selectticket', id='selectticket', options=ticketlist,
                  opt_selected=default )}
    </span>
</%def>

<%def name="form_createticket( u, p, action, tck_typenames, tck_severitynames,
                               projusers, components, milestones, versions )">
    <%
        sm_help    = 'one line summary'
        blkby_help = 'comma separated list of <b>ticket ids</b> that are blocking this ticket'
        blkng_help = 'comma separated list of <b>ticket ids</b> that are blockedby this ticket'
        pt_help    = 'parent <b>ticket id</b>'

        components = [ [ '', '--Select-Component--' ] ] + \
                        sorted( components, key=lambda x : x[1] )
        milestones = [ [ '', '--Select-Milestone--' ] ] + \
                        sorted( milestones, key=lambda x : x[1] )
        versions   = [ [ '', '--Select-Version--' ] ]   + \
                        sorted( versions, key=lambda x : x[1] )
        projusers  = sorted( projusers )
    %>

    <h3 class="ml10">Create Ticket</h3>
    <form id="createtck" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100">
      <div class="posr floatl" style="padding-left : 20px;">
      <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 15%;">Summary :</div>
            <div class="ftbox" required="true">
                ${input_text( name='summary', id='summary', size='40', style='width : 25em;' )}
                <br></br>
                ${fieldhelp( sm_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 15%;">type :</div>
            <div class="fselect" required="true">
                ${select( name='tck_typename',  id='tck_typename', options=tck_typenames )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 15%;">severity :</div>
            <div class="fselect" required="true">
                ${select( name='tck_severityname',  id='tck_severityname', 
                          options=tck_severitynames )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 20%;">prompt user :</div>
            <div class="fselect">
                ${select( name='promptuser',  id='promptuser', options=projusers,
                          opt_selected=u.username )}
            </div>
        </div>
      </div>
      </div>
      <div class="posr floatl" style="border-left : 3px solid #d6d6d6;">
      <div class="w100 form mb10">
        <div class="field w100">
          <div class="fselect">
              <div class="floatl m5">
                  ${select( name='component_id',  id='component', options=components,
                            opt_selected='--Select-Component--' )}
              </div>
              <div class="floatl m5">
                  ${select( name='milestone_id',  id='milestone', options=milestones,
                            opt_selected='--Select-Milestone--' )}
              </div>
              <div class="floatl m5">
                  ${select( name='version_id',  id='version', options=versions,
                            opt_selected='--Select-Version--' )}
              </div>
          </div>
        </div>
      </div>
      <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 20%;">blocked by :</div>
            <div class="ftbox">
                ${input_text( name='blockedby_ids', id='blockedby_ids' )}
                <br></br>
                ${fieldhelp( blkby_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 20%;">blocking :</div>
            <div class="ftbox">
                ${input_text( name='blocking_ids', id='blocking_ids' )}
                <br></br>
                ${fieldhelp( blkng_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 20%;">parent ticket:</div>
            <div class="ftbox">
                ${input_text( name='parent_id', id='parent_id' )}
                ( ${fieldhelp( pt_help )} )
            </div>
        </div>
      </div>
      </div>
      <div class="w100 form bclear" style="padding-left : 20px;">
        <div class="field">
            <div class="label vtop" style="width : 7%;">Description : </div>
            <div class="ftarea" required="true">
                ${elements.captiontextarea( 'Use wiki markup to compose ticket description.' )}
                ${textarea( name='description', tatype='simpletextarea', id='description',
                            cols='100', rows='7' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 7%;"></div>
            <div class="fsubmit">${input_submit( value='Create' )}</div>
        </div>
      </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_createtck() {
            function createtck_onsubmit( e ) {
                var stopevent = false;
                var msg       = '';
                if ( dijit.byId('createtck').validate() ) {
                    if (! dojo.attr( dojo.byId( 'tck_typename' ), 'value' )) {
                        stopevent = true;
                        msg       = 'Provide ticket type !!'
                    }
                    if (! dojo.attr( dojo.byId( 'tck_severityname' ), 'value' )) {
                        stopevent = true;
                        msg       = 'Project ticket severity !!'
                    }
                    if (stopevent) {
                        dojo.publish( 'flash', [ 'error', msg, 2000 ]);
                        dojo.stopEvent( e );
                    }
                } else {
                    dojo.publish( 'flash', [ 'error', "Invalid form fields", 2000 ]);
                    dojo.stopEvent( e );
                }
            }
            new zeta.Form({ onsubmit : createtck_onsubmit, formid: 'createtck' });
            dijit.byId( 'summary' ).focus();
        }
    </script>
</%def>

<%def name="form_edittck( u, p, t, action, tck_typenames, tck_severitynames, \
                          projusers, components, milestones, versions )">
    <%
        blkby_help = 'Enter blocking ticket ids as comma separated integer values'
        blkng_help = 'Enter blockedby ticket ids as comma separated integer values'
        pt_help    = 'Parent ticket id as integer value'
        sm_help    = 'A one line summary'
        ds_help    = 'Mininum 6 characters to max %s characters.' % h.LEN_DESCRIBE

        componentname  = t.components and t.components[0].componentname
        milestone_name = t.milestones and t.milestones[0].milestone_name
        version_name   = t.versions   and t.versions[0].version_name

        blockedby  = ', '.join([ str(tby.id) for tby in t.blockedby ])
        blocking   = ', '.join([ str(tng.id) for tng in t.blocking ])
        parent     = t.parent and str(t.parent.id) or ''
    %>
    <form id="configtck" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=str(t.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 12em;">type :</div>
            <div class="fselect">
                ${select( name='tck_typename',  id='tck_typename',
                          options=tck_typenames, opt_selected=t.type.tck_typename )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">severity :</div>
            <div class="fselect">
                ${select( name='tck_severityname',  id='tck_severityname',
                          options=tck_severitynames, opt_selected=t.severity.tck_severityname )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">prompt user :</div>
            <div class="fselect">
                ${select( name='promptuser',  id='promptuser', options=projusers,
                          opt_selected=t.promptuser.username )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">component :</div>
            <div class="fselect">
                ${select( name='component_id',  id='component', options=components,
                          opt_selected=compnentname )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">milestone :</div>
            <div class="fselect">
                ${select( name='milestone_id',  id='milestone', options=milestones,
                          opt_selected=milestone_name )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">version :</div>
            <div class="fselect">
                ${select( name='version_id',  id='version', options=versions,
                          opt_selected=version_name )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">blocked by :</div>
            <div class="ftbox">
                ${input_text( name='blockedby_ids', id='blockedby_ids', value=blockedby )}
                <br></br>
                ${fieldhelp( blkby_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">blocking :</div>
            <div class="ftbox">
                ${input_text( name='blocking_ids', id='blocking_ids', value=blocking )}
                <br></br>
                ${fieldhelp( blkng_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">parent ticket:</div>
            <div class="ftbox">
                ${input_text( name='parent_id', id='parent_id', value=parent )}
                <br></br>
                ${fieldhelp( pt_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">Summary :</div>
            <div class="ftbox">
                ${input_text( name='summary', id='summary', value=t.summary,
                              size='64', style='width : 30em;' )}
                <br></br>
                ${fieldhelp( sm_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">Description</div>
            <div class="ftarea w50">
                ${elements.captiontextarea( 'Use wiki markup to compose ticket description.' )}
                ${textarea( name='description', tatype='simpletextarea', id='description',
                            text=t.description, rows='20', style='width : 100%' )}
                <br></br>
                ${fieldhelp( ds_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;"></div>
            <div class="fsubmit">${input_submit( value='Update' )}</div>
        </div>
    </div>
    </form>
</%def>

<%def name="form_configticket( u, p, action, t=None )">
    <form id="configtck" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=(t and str(t.id) or '') )}
    ${input_hidden( name='tck_typename')}
    ${input_hidden( name='tck_severityname')}
    ${input_hidden( name='promptuser')}
    ${input_hidden( name='component_id')}
    ${input_hidden( name='milestone_id')}
    ${input_hidden( name='version_id')}
    ${input_hidden( name='summary')}
    </form>
</%def>

<%def name="form_tcktype( u, p, action, t=None )">
    <form id="tcktype" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=(t and str(t.id) or '') )}
    ${input_hidden( name='tck_typename', value=(t and t.type.tck_typename or '') )}
    </form>
</%def>

<%def name="form_tckseverity( u, p, action, t=None )">
    <form id="tckseverity" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=(t and str(t.id) or '') )}
    ${input_hidden( name='tck_severityname', value=( t and t.severity.tck_severityname or '' ) )}
    </form>
</%def>

<%def name="form_tckpromptuser( u, p, action, t=None )">
    <form id="tckpromptuser" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=(t and str(t.id) or '') )}
    ${input_hidden( name='promptuser')}
    </form>
</%def>

<%def name="form_tckcomponent( u, p, action, t=None )">
    <form id="tckcomponent" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=(t and str(t.id) or '') )}
    ${input_hidden( name='component_id')}
    </form>
</%def>

<%def name="form_tckmilestone( u, p, action, t=None )">
    <form id="tckmilestone" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=(t and str(t.id) or '') )}
    ${input_hidden( name='milestone_id')}
    </form>
</%def>

<%def name="form_tckversion( u, p, action, t=None )">
    <form id="tckversion" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=(t and str(t.id) or '') )}
    ${input_hidden( name='version_id')}
    </form>
</%def>

<%def name="form_tckparent( u, p, action, t=None )">
    <form id="tckparent" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=(t and str(t.id) or '') )}
    ${input_hidden( name='parent_id')}
    </form>
</%def>

<%def name="form_tckblockedby( u, p, action, t=None )">
    <form id="tckblockedby" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=(t and str(t.id) or '') )}
    ${input_hidden( name='blockedby_ids')}
    </form>
</%def>

<%def name="form_tckblocking( u, p, action, t=None )">
    <form id="tckblocking" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=(t and str(t.id) or '') )}
    ${input_hidden( name='blocking_ids')}
    </form>
</%def>

<%def name="form_tcksummary( u, p, action, t=None )">
    <form id="tcksummary" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=(t and str(t.id) or '') )}
    ${input_hidden( name='summary')}
    </form>
</%def>

<%def name="form_tckdescription( u, p, action, t=None )">
    <form id="tckdescription" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=(t and str(t.id) or '') )}
    ${textarea( name='description', tatype='simpletextarea', id='description',
                text=t.description, rows='10', style='width : 100%' )}
    ${input_submit( value='Update' )}
    </form>
</%def>

<%def name="form_changetckst( u, p, t, statusname, due_date, action, tck_statusnames )">
    <%
        neutral_style = "float : none; text-align : center; margin : 0px;"
    %>
    <form id="createtstat" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=str(t.id))}
    ${input_hidden( name='owner', value=str(u.id) )}
    <div style="display : table;">
    <div style="display : table-row;">
        <div class="p5" style="display : table-cell;">
            <div class="dispinln">status :</div>
        </div>
        <div class="p5" style="display : table-cell;">
            <div class="dispinln">
                ${select( name='tck_statusname',  id='tck_statusname',
                          options=tck_statusnames, opt_selected=statusname )}
            </div>
        </div>
        <div class="p5" style="display : table-cell;">
            <div class="dispinln" style="width : 12em;">due date :</div>
        </div>
        <div class="p5" style="display : table-cell;">
            <div class="fdtbox dispinln" style="${neutral_style}">
                ${input_text( name='due_date', value=due_date, id='tsduedate' )}
            </div>
        </div>
        <div class="p5" style="display : table-cell;">
            <div class="dispinln">${input_submit( value='Change' )}</div>
        </div>
    </div>
    </div>
    </form>
</%def>

<%def name="form_configtst( u, p, action, t=None, ts=None )">
    <form id="configtstat" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=( t and str(t.id) or '') )}
    ${input_hidden( name='ticket_status_id', value=( ts and str(ts.id) or '') )}
    ${input_hidden( name='owner', value=str(u.id) )}
    ${input_hidden( name='tck_statusname')}
    ${input_hidden( name='due_date')}
    </form>
</%def>

<%def name="form_createtcmt( u, p, t, action )">
    <form id='createtcmt' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=str(t.id) )}
    ${input_hidden( name='commentby', value=u.username )}
    <div class="w100 form">
        <div class="w80">
            ${elements.captiontextarea( 'Use wiki markup to compose ticket comment.' )}
            ${textarea( name='text', id='crtcmt_text' )}
        </div>
        <div>${input_submit( value='Add' )}</div>
    </div>
    </form>
</%def>

<%def name="form_replytcmt( u, p, t, action, tcmt=None )">
    <form id='replytcmt' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=str(t.id) )}
    ${input_hidden( name='commentby', value=u.username )}
    ${input_hidden( name='replytocomment_id', value=tcmt and str(tcmt.id) or '' )}
    <div class="w100 form">
        <div class="w80">
            ${elements.captiontextarea( 'Use wiki markup to compose ticket comment.' )}
            ${textarea( name='text', id='rptcmt_text' )}
        </div>
        <div>${input_submit( value='Reply' )}</div>
    </div>
    </form>
</%def>

<%def name="form_updatetcmt( u, p, t, action, tcmt=None )">
    <form id='updatetcmt' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=str(t.id) )}
    ${input_hidden( name='ticket_comment_id', value=tcmt and str(tcmt.id) or '' )}
    ${input_hidden( name='commentby', value=u.username )}
    <div class="w100 form">
        <div class="w80">
            ${elements.captiontextarea( 'Use wiki markup to compose ticket comment.' )}
            ${textarea( name='text', id='upcmt_text', text=tcmt and tcmt.text or '' )}
        </div>
        <div>${input_submit( value='Update' )}</div>
    </div>
    </form>
</%def>

<%def name="form_tckfav( u, p, t, action, name )">
    <form id='tckfav' class="dispnone" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=str(t.id))}
    ${input_hidden( name=name, value=str(u.username))}
    </form>

    <script type="text/javascript">
        /* Setup favorite ticket for user */
        function initform_tckfav() {
            var n_span  = dojo.query( "span[name=favtck]" )[0];
            var w_form  = new zeta.Form({ normalsub: true, formid: 'tckfav' });
            var n_field = dojo.query( "input[name=${name}]", form_tckfav )[0];
            if( n_span && n_field ) {
                new ZFavorite( n_span, form_tckfav, n_field );
            }
        }
    </script>
</%def>

<%def name="form_votetck( u, p, t, action, upvotes, downvotes, currvote )">
    <form id='votetck' class="dispnone" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='ticket_id', value=str(t.id))}
    ${input_hidden( name='votedas', value=(vote and vote.votedas or ''))}
    </form>

    <script type="text/javascript">
        /* Setup ticket voting form */
        function initform_votetck() {
            var n_span = dojo.query( "span[name=tckvote]" )[0];
            if( n_span ) {
                new zeta.Voting({
                    upvotes: ${upvotes},
                    downvotes: ${downvotes},
                    currvote: '${currvote}',
                    formid: 'votetck'
                }, n_span );
            }
        }
    </script>
</%def>

<%def name="form_addtckfilter( u, action )">
    <form id="addtckfilter" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( id='filterbyjson', name='filterbyjson' )}
    <div class="pt10">
        ${input_text( id='filtername', name='name',
                      style='width: 10em; color: #D6D6D6;', value='Save-This-Filter' )}
    </div>
    </form>
    <script type="text/javascript">
        function addtckfilter_onsubmit( e ) {
            var name    = dojo.attr( dojo.byId( 'filtername' ), 'value' );
            var n_fjson = dojo.byId( 'filterbyjson' );
            var valpatt = /^[a-zA-Z]+[a-zA-Z0-9]*$/;
            dojo.attr( n_fjson, 'value', dojo.toJson(customquery()) );
            if( name && n_fjson && valpatt.test( name ) ) {
                submitform( form_addtckfilter, e );
            } else {
                dojo.publish( 'flash', [ 'error', "Invalid name", 2000 ]);
            }
            dojo.stopEvent( e );
        }
        function initform_addtckfilter() {
            new zeta.Form({ onsubmit: addtckfilter_onsubmit,
                            formid: 'addtckfilter' })
            dojo.connect( dojo.byId( 'filtername' ), 'onfocus',
                function(e) {
                    dojo.attr( e.target, 'value', '' );
                    dojo.style( e.target, { color : 'black' });
                }
            );
        }
    </script>
</%def>

<%def name="form_deltckfilter( u, savfilterid, action )">
    <form id="deltckfilter" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='tf_id', value=str(savfilterid) )}
    ${input_submit( value='Delete' )}
    </form>
    <script type="text/javascript">
        function deltckfilter_onsubmit( e ) {
            submitform( form_deltckfilter, e );
            dojo.stopEvent( e );
        }
        function initform_deltckfilter() {
            new zeta.Form({ onsubmit: deltckfilter_onsubmit,
                            formid: 'deltckfilter' })
        }
    </script>
</%def>

<%def name="form_selectsavfilter( u, filterlist, default='' )">
    <% 
        filterlist = [ [ '', '--Select-Filter--' ] ] + filterlist
        default    = default or '--Select-Filter--'
    %>
    <span class="ml3">
        ${select( name='selsavfilter', id='selsavfilter',
                  options=filterlist, opt_selected=default )}
    </span>
</%def>

#### ------------------------- Review Forms ---------------------------------
<%def name="select_revwnature( naturenames )">
    <% naturenames = [ [ '', '--Select-Nature--' ] ] + naturenames %>
    ${select( name='reviewnature', options=naturenames )}
</%def>

<%def name="select_revwaction( actionnames )">
    <% actionnames = [ [ '', '--Select-Action--' ] ] + actionnames %>
    ${select( name='reviewaction', options=actionnames )}
</%def>

<%def name="form_selectrevw( u, revwlist, default='' )">
    <% 
        revwlist = [ [ '', '--Select-Review--' ] ] + revwlist
        default  = default or '--Select-Review--'
    %>
    <span class="ml5">
        ${select( name='selectrevw', id='selectrevw', options=revwlist,
                  opt_selected=default )}
    </span>
</%def>

<%def name="form_selectrset( u, rsetlist, default='' )">
    <% 
        rsetlist = [ [ '', '--Select-ReviewSet--' ] ] + rsetlist
        default  = default or '--Select-ReviewSet--'
    %>
    <span class="ml5">
        ${select( name='selectrset', id='selectrset', options=rsetlist,
                  opt_selected=default )}
    </span>
</%def>

<%def name="form_createrev( u, p, rsets, action, projusers, usernames,
                            forsrc=[], forversion=None )">
    <%
        ru_help = 'enter the resource url to be reviewed'
        rv_help = 'nth version to review'
        ra_help = 'author should take action on review comments'
        rsets   = [ [ '', '--Select-ReviewSet--' ] ] + rsets
    %>

    <form id="createrev" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='moderator', value=str(u.username))}
    <div class="form">
        <div class="field">
            <div class="label" style="width : 12em;">Review Set :</div>
            <div class="ftbox">
                ${select( name='rset_id', id='rset_id', options=rsets )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">Resource Url :</div>
            % if forsrc == [] :
                <div class="ftbox" required="true">
                    ${input_text( name='resource_url', id='resource_url' )}
                    <br></br>
                    ${fieldhelp( ru_help )}
                </div>
            % endif
            % for rurl in forsrc :
                <div>
                ${input_text( name='resource_url', value=rurl,
                              readonly='readonly', size='40' )}
                </div>
            % endfor
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">Version :</div>
            % if forversion :
                ${input_text( name='version', value=str(forversion), readonly='readonly' )}
            % else :
                <div class="ftbox" regExp="[0-9]*" required="true">
                    ${input_text( name='version', id='version' )}
                    <br></br>
                    ${fieldhelp( rv_help )}
                </div>
            % endif
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">Author :</div>
            <div class="fselect" required="true">
                ${select( name='author', id='author', options=projusers,
                          opt_selected=u.username )}
                <br></br>
                ${fieldhelp( ra_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">Participants :</div>
            <div class="fselect vtop">
                ${multiselect( name='participant', id='participant', options=usernames,
                               size="7" )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;"></div>
            <div class="fsubmit">
                ${input_submit( value='Create' )}
                ${input_reset( value='Reset' )}
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_createrev() {
            function createrev_onsubmit( e ) {
                var msg       = '';
                if ( dijit.byId('createrev').validate() ) {
                    if (! dojo.attr( dojo.byId( 'author' ), 'value' )) {
                        msg       = 'Provide review author !!'
                    }
                    if (msg) {
                        dojo.publish( 'flash', [ 'error', msg, 2000 ]);
                        dojo.stopEvent( e );
                    }
                } else {
                    dojo.publish( 'flash', [ 'error', "Invalid form fields", 2000 ]);
                    dojo.stopEvent( e );
                }
            }
            new zeta.Form({ onsubmit : createrev_onsubmit, formid: 'createrev' })

            var n_rurl = dijit.byId( 'resource_url' );
            n_rurl ? n_rurl.focus() : null;
        }
    </script>
</%def>


<%def name="form_configrev( u, p, action )">
    <form class="dispnone" id="configrev" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id) )}
    ${input_hidden( name='review_id', value='' )}
    ${input_hidden( name='resource_url', id='resource_url', value='' )}
    ${input_hidden( name='version', id='version', value='' )}
    ${input_hidden( name='author', id='author', value='' )}
    ${input_hidden( name='moderator', id='moderator', value='' )}
    </form>
</%def>

<%def name="form_revwauthor( u, p, r, action, projusers )">
    <%
        projusers = [ [ '', '--Select-Author--' ] ] + projusers
        if not r.author :
            default   = '--Select-Author--'
        elif r.author.username not in projusers :
            default   = '--Select-Author--'
        else :
            default   = r.author.username
    %>
    <form class="dispnone" id="revwauthor" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id) )}
    ${input_hidden( name='review_id', value=str(r.id) )}
    ${select( name='author', id='author', options=projusers, opt_selected=default )}
    </form>

    <script type="text/javascript">
        function initform_revwauthor() {
            new zeta.Form({ formid: 'revwauthor' });
            var n_select = dojo.query( 'select[name=author]', form_revwauthor )[0];
            // Submit the form on selecting the author
            dojo.connect( n_select, 'onchange',
                          function( e ) {
                              submitform( form_revwauthor, e );
                              dojo.stopEvent( e );
                          }
            );
        }
    </script>
</%def>

<%def name="form_revwmoderator( u, p, r, action, projusers )">
    <%
        projusers = [ [ '', '--Select-Moderator--' ] ] + projusers
        default   = r.moderator and r.moderator.username or '--Select-Moderator--'
        if not r.moderator :
            default   = '--Select-Moderator--'
        elif r.moderator.username not in projusers :
            default   = '--Select-Moderator--'
        else :
            default   = r.moderator.username
    %>
    <form class="dispnone" id="revwmoderator" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id) )}
    ${input_hidden( name='review_id', value=str(r.id) )}
    ${select( name='moderator', options=projusers, opt_selected=default )}
    </form>

    <script type="text/javascript">
        function initform_revwmoderator() {
            new zeta.Form({ formid: 'revwmoderator' });
            var n_select = dojo.query( 'select[name=moderator]', form_revwmoderator )[0];
            // Submit the form on selecting the moderator
            dojo.connect( n_select, 'onchange',
                          function( e ) {
                              submitform( form_revwmoderator, e );
                              dojo.stopEvent( e );
                          }
            );
        }
    </script>
</%def>

<%def name="form_closerev( u, p, r, action )">
    <form class="dispnone" id="closerev" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id) )}
    ${input_hidden( name='review_id', value=str(r.id) )}
    ${input_hidden( name='command', value='' )}
    % if r.closed :
        Open  : ${input_radio( name='radiocommand', value='open' )}
        Close : ${input_radio( name='radiocommand', value='close', checked='checked' )}
    % else :
        Open  : ${input_radio( name='radiocommand', value='open', checked='checked' )}
        Close : ${input_radio( name='radiocommand', value='close' )}
    % endif
    </form>

    <script type="text/javascript">
        function onchange_command( value, e ) {
            var i_command = dojo.query( 'input[name=command]', form_closerev )[0];
            dojo.attr( i_command,'value', value );
            submitform( form_closerev, e );
            dojo.stopEvent( e );
        }
        function initform_closerev() {
            new zeta.Form({ formid: 'closerev' });
            var radios = dojo.query( 'input[name=radiocommand]' );
            dojo.connect( radios[0], 'onchange', dojo.partial( onchange_command, 'open' ));
            dojo.connect( radios[1], 'onchange', dojo.partial( onchange_command, 'close' ));
        }
    </script>
</%def>

<%def name="form_addparts( u, p, r, action, usernames )">
    <%
        usernames = [ '--Add--' ] + usernames 
        default   = '--Add--'
    %>
    <form id="addparts" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id) )}
    ${input_hidden( name='review_id', value=str(r.id) )}
    ${select( name='participant', id='participant', options=usernames, opt_selected=default )}
    </form>

    <script type="text/javascript">
        function initform_addparts() {
            new zeta.Form({ formid: 'addparts' });
            var n_select = dojo.query( 'select[name=participant]', form_addparts )[0];
            // Submit the form on selecting a user.
            dojo.connect(
                n_select, 'onchange',
                function( e ) {
                    var n_select = e.currentTarget;
                    var sr_str = 'select[name=participant] option[value='+n_select.value+']';
                    var n_opt  = dojo.query( sr_str, form_addparts )[0];
                    submitform( form_addparts, e );
                    dojo.stopEvent( e );
                    dojo.publish( 'insertparticipant', [ n_select.value ] );
                    n_select.removeChild( n_opt );
                }
            );
        }
    </script>
</%def>

<%def name="form_delparts( u, p, r, action )">
    <form class="dispnone" id="delparts" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id) )}
    ${input_hidden( name='review_id', value=str(r.id) )}
    ${input_hidden( name='participant' )}
    </form>

    <script type="text/javascript">
        function initform_delparts() {
            new zeta.Form({ formid: 'delparts' });
            dojo.subscribe(
                'delparticipant', 
                function( username ) {
                    dojo.query( 'input[name=participant]', form_delparts 
                              )[0].value = username;
                    submitform( form_delparts );
                }
            );
        }
    </script>
</%def>

<%def name="form_revwfav( u, p, r, action, name )">
    <form id='revwfav' class="dispnone" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='review_id', value=str(r.id))}
    ${input_hidden( name=name, value=str(u.username))}
    </form>

    <script type="text/javascript">
        /* Setup favorite review for user */
        function initform_revwfav() {
            var n_span  = dojo.query( "span[name=favrevw]" )[0];
            var w_form  = new zeta.Form({ normalsub: true, formid: 'revwfav' });
            var n_field = dojo.query( "input[name=${name}]", form_revwfav )[0];
            if( n_span && n_field ) {
                new ZFavorite( n_span, form_revwfav, n_field );
            }
        }
        dojo.addOnLoad( initform_revwfav );
    </script>

</%def>

<%def name="form_creatercmt( u, p, r, action, naturenames )">
    <% 
        naturenames = [ '--Select-Nature--' ] + naturenames[:]
        pos_help    = 'Line number'
    %>
    <form id='creatercmt' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='review_id', value=str(r.id) )}
    ${input_hidden( name='commentby', value=u.username )}
    <div class="form w100">
        <div class="field">
            <div class="label" style="width : 15%;">Position :</div>
            <div class="ftbox" style="width : 3em;" required="true" regExp="[0-9]*">
                ${input_text( name='position', style='width: 3em;' )}
                <em>${fieldhelp( pos_help, fhstyle="color: red;" )}</em>
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 15%;">Nature :</div>
            <div class="fselect vtop"  style="width : 10em;">
                ${select( name='reviewnature', options=naturenames,
                          opt_selected='--Select-Nature--' )}
            </div>
        </div>
        <div class="field">
            <div class="label vtop"  style="width : 15%;">Comment text :</div>
            <div class="ftarea" required="true">
                ${elements.captiontextarea( 'Use wiki markup to compose review comment.' )}
                ${textarea( name='text', tatype='simpletextarea', id='crrcmt_text',
                            cols='90', rows='1', style='width : 100%' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 15%;"></div>
            <div class="fsubmit" style="width : 10em;">${input_submit( value='Create' )}</div>
        </div>
    </div>
    </form>
    <script type="text/javascript">
        // Setup review comment creation form
        function initform_creatercmt() {
            function creatercmt_onsubmit( e ) {
                var i_pos = dojo.query( 'input[name=position]', form_creatercmt )[0];
                submitform( form_creatercmt, e );
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ] );
                dojo.publish( 'refreshrcomments', [ 'creatercmt', i_pos.value ] );
                dojo.stopEvent(e);
            }
            new zeta.Form({ onsubmit: creatercmt_onsubmit, formid: 'creatercmt' });
        }
        dojo.addOnLoad( initform_creatercmt );
    </script>
</%def>

<%def name="form_replyrcmt( u, p, r, action )">
    <form id='replyrcmt' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='review_id', value=str(r.id) )}
    ${input_hidden( name='commentby', value=u.username )}
    ${input_hidden( name='replytocomment_id', value='' )}
    <div class="w100 form">
        <div class="field">
            <div class="ftarea" required="true">
                ${elements.captiontextarea( 'Use wiki markup to compose review comment.' )}
                ${textarea( name='text', tatype='simpletextarea', id='rprcmt_text',
                            cols='90', rows='1', style='width : 100%' )}
                ${input_submit( value='Reply' )}
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        // Setup review comment reply form
        function initform_replyrcmt() {
            function replyrcmt_onsubmit( e ) {
                var i_r2cmt = dojo.query( 'input[name=replytocomment_id]', form_replyrcmt )[0];
                submitform( form_replyrcmt, e );
                dojo.publish( 'flash', [ 'message', "Refreshing ..." ] );
                dojo.stopEvent(e);
                dojo.publish( 'refreshrcomments', [ 'replyrcmt', i_r2cmt.value ] );
            }
            new zeta.Form({ onsubmit: replyrcmt_onsubmit, formid: 'replyrcmt' });
        }
        dojo.addOnLoad( initform_replyrcmt );
    </script>
</%def>

<%def name="form_processrcmt( u, p, r, action )">
    <form id='processrcmt' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='review_id', value=str(r.id) )}
    ${input_hidden( name='review_comment_id', value='' )}
    ${input_hidden( name='approve', value='empty' )}
    ${input_hidden( name='reviewnature', value='empty' )}
    ${input_hidden( name='reviewaction', value='empty' )}
    </form>
</%def>

<%def name="form_createrset( u, p, action, reload )">
    <form id='createrset' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="form">
        <div class="field">
            <div class="label" style="">New ReviewSet :</div>
            <div class="ftbox" required=True>
                ${input_text( name='name', id='name' )}
            </div>
            <div class="fsubmit">
                ${input_submit( value='Create' )}
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function createrset_onsubmit(e) {
            var reloadurl = "${reload |n}";
            submitform( form_createrset, e );
            dojo.stopEvent(e);
            if( reloadurl) { window.location = reloadurl; }
        }
        function initform_createrset() {
            new zeta.Form({ onsubmit: createrset_onsubmit, 
                            formid: 'createrset' });
        }
    </script>
</%def>

<%def name="form_updaterset( u, p, rs, action, reload )">
    <form id='updaterset' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='rset_id', value=str(rs.id))}
    <div class="form">
        <div class="field">
            <div class="label" style="">Update ReviewSet :</div>
            <div class="ftbox" required=True>
                ${input_text( name='name', id='name', value=rs.name )}
            </div>
            <div class="fsubmit">
                ${input_submit( value='Update' )}
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function updaterset_onsubmit(e) {
            var reloadurl = "${reload |n}";
            submitform( form_updaterset, e );
            dojo.stopEvent(e);
            if( reloadurl ) { window.location = reloadurl; }
        }
        function initform_updaterset() {
            new zeta.Form({ onsubmit: updaterset_onsubmit, 
                            formid: 'updaterset' });
        }
    </script>
</%def>

<%def name="form_addtorset( u, p, rs, action, revwlist, reload=None )">
    <%
        revwlist = [ [ '', '--Add Review to Set--' ] ] + revwlist
    %>
    <form id='addtorset' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='rset_id', value=str(rs.id))}
    ${select( name='review_id', id='add_review_id', options=revwlist )}
    </form>

    <script type="text/javascript">
        function initform_addtorset() {
            var n_selrid = dojo.byId( 'add_review_id' );

            new zeta.Form({ formid: 'addtorset' });

            // Submit form on selecting review to add
            dojo.connect(
                n_selrid, 'onchange',
                function( e ) {
                    var reloadurl = "${reload |n}";
                    if( n_selrid.value ) { submitform( form_addtorset, e ); }
                    dojo.stopEvent( e );
                    if( reloadurl ) { window.location = reloadurl; }
                }
            );
        }
    </script>
</%def>

<%def name="form_delfromrset( u, p, rs, action, revwlist, reload=None )">
    <%
        revwlist = [ [ '', '--Remove Review from Set--' ] ] + revwlist
    %>
    <form id='delfromrset' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='rset_id', value=str(rs.id))}
    ${select( name='review_id', id='del_review_id', options=revwlist )}
    </form>

    <script type="text/javascript">
        function initform_delfromrset() {
            var n_selrid = dojo.byId( 'del_review_id' );

            new zeta.Form({ formid: 'delfromrset' });

            // Submit form on selecting review to remove
            dojo.connect(
                n_selrid, 'onchange',
                function( e ) {
                    var reloadurl = "${reload |n}";
                    if( n_selrid.value ) { submitform( form_delfromrset, e ); }
                    dojo.stopEvent( e );
                    if( reloadurl ) { window.location = reloadurl; }
                }
            );
        }
    </script>
</%def>

#### ------------------------- Vcs Forms ---------------------------------
<%def name="form_selectvcs( u, vcslist, default='' )">
    <%
        vcslist = [ [ '', '--Select-Repository--' ] ] + vcslist
        default = default or '--Select-Repository--'
    %>
    <span class="ml5">
        <span style="font-size : small;">Project VCS :</span>
        ${select( name='selectvcs', id='selectvcs', options=vcslist,
                  opt_selected=default )}
    </span>
</%def>

<%def name="form_selectfilerevision( u, revlist, default='' )">
    <span class="ml5">
        <span style="font-size : small;">File Revision :</span>
        ${select( name='selectfrev', id='selectfrev', options=revlist,
                  opt_selected=default )}
    </span>
</%def>

<%def name="form_createvcs( u, p, action, vcs_typenames )">
    <%
        nm_help = 'repository name must be unique'
    %>
    <form id="createvcs" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 12em;">Name :</div>
            <div class="ftbox" required="true">
                ${input_text( name='name', id='name' )}
                <br></br>
                ${fieldhelp( nm_help )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">Type :</div>
            <div class="fselect" required="true">
                ${select( name='vcs_typename',  id='vcs_typename', options=vcs_typenames )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">Root-url :</div>
            <div class="ftbox" required="true">
                ${input_text( name='rooturl', id='rooturl', size='64', style='width : 30em;' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;"></div>
            <div class="fsubmit">${input_submit( value='Create' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_createvcs() {
            new zeta.Form({ formid: 'createvcs' });
            dijit.byId( 'name' ).focus();
        }
    </script>
</%def>

<%def name="form_configvcs( u, p, action, v=None )">
    <form id="configvcs" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='vcs_id', value=(t and str(t.id) or '') )}
    ${input_hidden( name='name')}
    ${input_hidden( name='rooturl')}
    ${input_hidden( name='vcs_typename')}
    </form>
</%def>

<%def name="form_deletevcs( u, p, action, v=None )">
    <form id="deletevcs" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='vcs_id', value=(t and str(t.id) or '') )}
    </form>
</%def>

<%def name="form_createmount( u, vcslist, contents, action )">
    <form id="createmount" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    <div class="form">
        <div class="disptrow">
            <div class="ftbox" required="true">
                 <em>name</em>${input_text( name='name', id='name' )}
            </div>
            <div class="fselect" required="true">
                ${select( name='content',  id='content', options=contents )}
            </div>
            <div class="fselect" required="true">
                ${select( name='vcs_id',  id='vcs_id', options=vcslist )}
            </div>
            <div class="ftbox" required="true">
                <em>relative-path</em>${input_text( name='repospath', id='repospath' )}
            </div>
            <div class="pl20 fsubmit">${input_submit( value='Create' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_createmount() {
            new zeta.Form({ formid: 'createmount' });
            dijit.byId( 'name' ).focus();
        }
    </script>
</%def>

<%def name="form_updatemount( u, m, vcslist, contents, action )">
    <form id="updatemount" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='mount_id', value=str(m.id) )}
    <div class="form">
        <div class="disptrow">
            <div class="ftbox" required="true">
                 <em>name</em>${input_text( name='name', id='name', value=m.name )}
            </div>
            <div class="fselect" required="true">
                ${select( name='content',  id='content', options=contents,
                          opt_selected=m.content )}
            </div>
            <div class="fselect" required="true">
                ${select( name='vcs_id',  id='vcs_id', options=vcslist,
                          opt_selected=m.vcs.name )}
            </div>
            <div class="ftbox" required="true">
                <em>path</em>${input_text( name='repospath', value=m.repospath, )}
            </div>
            <div class="pl20 fsubmit">${input_submit( value='Update' )}</div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function initform_updatemount() {
            new zeta.Form({ formid: 'updatemount' });
            dijit.byId( 'name' ).focus();
        }
    </script>
</%def>

<%def name="form_deletemount( u, action )">
    <form id="deletemount" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='mount_id', id='del_mountid' )}
    </form>
    <script type="text/javascript">
        function initform_deletemount() {
            new zeta.Form({ formid: 'deletemount' });
        }
    </script>
</%def>

<%def name="form_createmount_e( u, v, contents, action )">
    <%
        rp_help = 'relative path to repositories root url'
    %>
    <div id="mountpopup" class="dispnone p5 bgaliceblue br4"
         style="border: 1px solid LightSteelBlue">
        <form id="createmount_e" action="${action}" method="post">
            ${input_hidden( name='user_id', value=str(u.id) )}
            ${input_hidden( name='vcs_id', value=str(v.id) )}
            ${input_hidden( name='repospath', id='repospath' )}
            ${input_text( name='name', id='name' )}
            ${select( name='content',  id='content', options=contents )}
            ${input_submit( value='Create' )}
        </form>
        <div name="close" class="fgblue pointer">close</div>
    </div>

    <script type="text/javascript">
        function cme_onsubmit( e ) {
            var i_name = dojo.byId( 'name' );
            var i_content = dojo.byId( 'content' );
            if( i_name.value && i_content.value ) {
                submitform( form_createmount_e, e );
                dojo.publish( 'mounted', [] );
            } else {
                dojo.publish( 'flash', [ 'error', 'Complete the form', 2000 ]);
            }
            dojo.stopEvent( e );
        }
        function initform_createmount_e() {
            new zeta.Form({ formid: 'createmount_e', onsubmit: cme_onsubmit });
        }
    </script>
</%def>

<%def name="form_deletemount_e( u, action )">
    <form id="deletemount_e" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='mount_id', id='mount_id' )}
    </form>

    <script type="text/javascript">
        function initform_deletemount_e() {
            new zeta.Form({ formid: 'deletemount_e' });
        }
    </script>
</%def>

#### -------------------------- Wiki Forms ----------------------------------

<%def name="form_selectwikipage( u, wikipagenames, default='' )">
    <% 
        wikipagenames = sorted( wikipagenames, key=lambda x : x[1] )
        wikipagenames = [ [ '', '--Select-Wikipage--' ] ] +  wikipagenames
        default       = default or '--Select-Wikipage--'
    %>
    <span class="ml5">
        ${select( name='selectwikipage', id='selectwikipage', options=wikipagenames,
                  opt_selected=default )}
    </span>
</%def>

<%def name="form_selectwikiversion( u, versions, default='' )">
    <span class="ml5">
        ${select( name='selectwver', id='selectwver', options=versions,
                  opt_selected=default )}
    </span>
</%def>


<%def name="form_wikitype( u, w, wikitypenames, action )">
    <form id='wikitype' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='wiki_id', value=str(w.id))}
    <div class="w100 form">
        <div class="field">
            <div class="fselect"  required="true">
                ${select( name='wiki_typename', id='wiki_typename', options=wikitypenames,
                          opt_selected=w.type.wiki_typename, style='width : 10em' )}
            </div>
        </div>
    </div>
    </form>
</%def>

<%def name="form_wikisummary( u, w, action, summary='' )">
    <form id='wikisummary' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='wiki_id', value=str(w.id))}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 7em;">'Summary :'</div>
            <div class="ftbox"  required="true">
                ${input_text( name='summary', id='summary', value=summary )}
                <br></br>
                ${fieldhelp( un_help )}
            </div>
        </div>
    </div>
    </form>
</%def>

<%def name="form_configwiki( u, action, w='', typename='', summary='' )">
    <form id='configwiki' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='wiki_id', value=str( w and w.id or '' ))}
    <div class="w100 form">
        ${input_text( name='wiki_typename', id='wiki_typename', value=typename )}
        ${input_text( name='summary', id='summary', value=summary )}
    </div>
    </form>

    <script type="text/javascript">
        function initform_configwiki() {
            new zeta.Form({ normalsub: true, formid: 'configwiki' });
        }
    </script>
</%def>

<%def name="form_wikicontent( u, w, wcnt, action, pageurl )">
    <%
        sm_help = 'Enter the page summary, max %s characters' % h.LEN_SUMMARY
    %>

    <form id='wikicont' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='wiki_id', value=str(w.id) )}
    ${input_hidden( name='author', value=u.username )}
    <div class="w100 form">
        <div class="field ml20">
            <div class="ftarea w80" required="true">
                ${elements.captiontextarea( 'Use wiki markup.' )}
                ${textarea( name='text', tatype="simpletextarea", id='wcnttext', text=wcnt and wcnt.text or '',
                            cols='120', rows='30' )}
            </div>
        </div>
        <div class="field">
            <div class="fsubmit">
                ${input_submit( value='Save & Continue' )}
                ${input_reset( value='Reset' )}
                ${input_button( id='preview', value='Preview' )}
                <a class="ml10" href="${pageurl}">Goto-Page</a>
            </div>
        </div>
    </div>
    </form>

    <script type="text/javascript">
        function onpreview( x_form, e ) {
            var div_wp  = dojo.query( '.wikipreview' )[0];
            var ta_wcnt = dijit.byId( 'wcnttext' )
            if ( e.type == 'keyup' && e.keyCode != dojo.keys.ENTER ) {
                return;
            }
            if ( div_wp && ta_wcnt ) {
                div_wp.innerHTML = ''
                xhrpost_obj( '${h.url_wikipreview |n}',
                             { 'text' : ta_wcnt.attr( 'value' ) },
                             'text',
                             false,
                             null,
                             function( resp ) {
                                 dojo.toggleClass( div_wp.parentNode.parentNode, 'dispnone', false );
                                 div_wp.innerHTML = resp;
                             },
                             null
                           );
                dojo.stopEvent( e );
            }
        }
        function initform_wikicont() {
            new zeta.Form({ normalsub: true, formid: 'wikicont' });
            dijit.byId( 'wcnttext' ).focus();

            // Setup preview
            var x_form = dijit.byId( 'wikicont' );
            var butt_preview = dojo.query( '#preview', x_form.domNode )[0];
            dojo.connect( butt_preview, 'onclick', dojo.hitch( null, onpreview, x_form ));
            dojo.connect( butt_preview, 'onkeyup', dojo.hitch( null, onpreview, x_form ));
        }
    </script>
</%def>

<%def name="form_createwcmt( u, w, action )">
    <form id='createwcmt' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='wiki_id', value=str(w.id) )}
    ${input_hidden( name='version_id', value=str(w.latest_version) )}
    ${input_hidden( name='commentby', value=u.username )}
    <div class="w100 form">
        <div class="w80">
            ${elements.captiontextarea( 'Use wiki markup to compose wiki comment.' )}
            ${textarea( name='text', id='crwcmt_text' )}
        </div>
        <div>${input_submit( value='Add' )}</div>
    </div>
    </form>
</%def>

<%def name="form_replywcmt( u, w, action, wcmt=None )">
    <form id='replywcmt' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='wiki_id', value=str(w.id) )}
    ${input_hidden( name='commentby', value=u.username )}
    ${input_hidden( name='version_id', value=str(w.latest_version) )}
    ${input_hidden( name='replytocomment_id', value=wcmt and str(wcmt.id) or '' )}
    <div class="w100 form">
        <div class="w80">
            ${elements.captiontextarea( 'Use wiki markup to compose wiki comment.' )}
            ${textarea( name='text', id='rpwcmt_text' )}
        </div>
        <div>${input_submit( value='Reply' )}</div>
    </div>
    </form>
</%def>

<%def name="form_updatewcmt( u, w, action, wcmt=None )">
    <form id='updatewcmt' action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='wiki_id', value=str(w.id) )}
    ${input_hidden( name='wiki_comment_id', value=wcmt and str(wcmt.id) or '' )}
    ${input_hidden( name='commentby', value=u.username )}
    ${input_hidden( name='version_id', value=wcmt and str(wcmt.version_id) or '' )}
    <div class="w100 form">
        <div class="w80">
            ${elements.captiontextarea( 'Use wiki markup to compose wiki comment.' )}
            ${textarea( name='text', id='upwcmt_text', text=wcmt and wcmt.text or '' )}
        </div>
        <div>${input_submit( value='Update' )}</div>
    </div>
    </form>
</%def>

<%def name="form_wikidiff( u, w, action, wikicontents )">
    <% wikicontents = wikicontents[:] ; wikicontents.reverse() %>

    <form id="wikidiff" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='wiki_id', value=str(w.id) )}
    ${input_submit( value='View changes' )}
    <table class="zwhistory">
        <thead><tr>
        <th class="zwhcmp" colspan="2">O/N</th>
        <th class="zwhver"> Version </th>
        <th class="zwhdesc"> Description </th>
        </tr></thead>
        % for wcnt in wikicontents :
        <tr>
        <td class="zwhcmp">${input_radio( name='oldver', value=str(wcnt.id))}</td>
        <td class="zwhcmp">${input_radio( name='newver', value=str(wcnt.id) )}</td>
        <td class="zwhver"> ${wcnt.id} </td>
        <td class="zwhdesc">
            Authored by <a href="${h.url_foruser(wcnt.author)}">${wcnt.author}</a>,
            on ${h.utc_2_usertz( wcnt.created_on, u.timezone ).strftime('%b %d, %Y, %r')}
        </td>
        </tr>
        % endfor
    </table>
    </form>

    <script type="text/javascript">
        function initform_wikidiff() {
            new zeta.Form({ formid: 'wikidiff' });
        }
    </script>
</%def>

<%def name="form_wikifav( u, p, w, action, name )">

    <form id='wikifav' class="dispnone" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='wiki_id', value=str(w.id))}
    ${input_hidden( name=name, value=str(u.username))}
    </form>

    <script type="text/javascript">
        /* Setup favorite wiki for user */
        function initform_wikifav() {
            var n_span  = dojo.query( "span[name=favwiki]" )[0];
            var w_form  = new zeta.Form({ normalsub: true, formid: 'wikifav' });
            var n_field = dojo.query( "input[name=${name}]", form_wikifav )[0];
            if( n_span && n_field ) {
                new ZFavorite( n_span, form_wikifav, n_field );
            }
        }
    </script>
</%def>

<%def name="form_votewiki( u, p, w, action, upvotes, downvotes, currvote )">
    <form id='votewiki' class="dispnone" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='project_id', value=str(p.id))}
    ${input_hidden( name='wiki_id', value=str(w.id))}
    ${input_hidden( name='votedas', value=(vote and vote.votedas or ''))}
    </form>

    <script type="text/javascript">
        /* Setup wiki voting form */
        function initform_votewiki() {
            var n_span = dojo.query( "span[name=wikivote]" )[0];
            if( n_span ) {
                new zeta.Voting({
                    upvotes: ${upvotes},
                    downvotes: ${downvotes},
                    currvote: '${currvote}',
                    formid: 'votewiki'
                }, n_span );
            }
        }
    </script>
</%def>

## --------------------------- Search ----------------------------

<%def name="form_searchbox( u, id, valasbg, action, faces=[] )">
    <span name="searchbox">
        <form id='${id}' class="dispinln" action="${action}" method="get">
            % for face, val in faces :
                ${input_hidden( name=face, value=val )}
            % endfor
            ${input_text( name='querystring', value=valasbg )}
        </form>
    </span>
</%def>

<%def name="form_search( querystring, u, action, allfaces, faces )">
    <%
        project = faces.get( 'project', '' )
        faces   = faces.keys() 
    %>
    <form id='searchadv' action="${action}" method="get">
        % if project :
            ${input_hidden( name='project', value=project )}
        % endif
        <div class="">
            <span class="ml20 fntbold fntitalic">Filter By : </span>
            % for face in sorted(allfaces.keys()) :
                <span class="mr10">
                    <% checked = face in faces %>
                    % if checked :
                        ${input_checkbox( name=face, value=allfaces[face],
                                          checked='checked' )} ${face.upper()}
                    % else :
                        ${input_checkbox( name=face, value=allfaces[face] )} ${face.upper()}
                    % endif 
                </span>
            % endfor
            <span class="mr10">
                <% checked = 'all' in faces %>
                % if checked :
                    ${input_checkbox( name='all', value='1', checked='checked' )} ALL
                % else :
                    ${input_checkbox( name='all', value='1' )} ALL
                % endif 
            </span>
        </div>
        <div class="mt10 ml50">
            ${input_text( id="facetedsr", name='querystring', value=querystring )}
            ${input_submit( value='Search' )}
        </div>
    </form>

    <script type="text/javascript">
        function initform_searchadv() {
            n = dojo.byId( 'facetedsr' );
            n.focus();
        }
    </script>
</%def>


## --------------------------- Attachments ----------------------------

<%def name="form_addattachs( u, action )">
    <form id="addattachs" enctype="multipart/form-data" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 12em;">File :</div>
            <div class="ffile">
                ${input_file( name='attachfile', id='attachfile', style='width: 40em;' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;">Summary :</div>
            <div class="ftbox">
                ${input_text( name='summary', id="summary", style='width: 40em;' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;"></div>
            <div class="fsubmit">${input_submit( value='Add' )}</div>
        </div>
    </div>
    </form>
</%def>

<%def name="form_attachssummary( u, action )">
    <form id="attachssummary" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='attachment_id' )}
    ${input_hidden( name='summary' )}
    </form>
</%def>

<%def name="form_attachstags( u, action )">
    <form id="attachstags" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    ${input_hidden( name='attachment_id' )}
    ${input_hidden( name='tags' )}
    </form>
</%def>

<%def name="form_sitelogo( u, action )">
    <form id="sitelogo" enctype="multipart/form-data" action="${action}" method="post">
    ${input_hidden( name='user_id', value=str(u.id) )}
    <div class="w100 form">
        <div class="field">
            <div class="label" style="width : 12em;">File :</div>
            <div class="ffile">
                ${input_file( name='sitelogofile', id='sitelogofile', style='width: 40em;' )}
            </div>
        </div>
        <div class="field">
            <div class="label" style="width : 12em;"></div>
            <div class="fsubmit">${input_submit( value='Upload' )}</div>
        </div>
    </div>
    </form>
</%def>
