## This file is subject to the terms and conditions defined in
## file 'LICENSE', which is part of this source code package.
##       Copyright (c) 2009 SKR Farms (P) LTD.

<%namespace name="forms" file="/component/forms.html"/>

<%!
    iconmap = {
        'addattach'   : '/zetaicons/add_attach.png',
        'addtag'      : '/zetaicons/tag_green_add.png',
        'attach'      : '/zetaicons/attach.png',
        'project'     : '/zetaicons/project.png',
        'projects'    : '/zetaicons/projects.png',
        'relation'    : '/zetaicons/user_link.png',
        'tag'         : '/zetaicons/tag_green.png',
        'team'        : '/zetaicons/group_link.png',
        'users'       : '/zetaicons/group.png',
        'user'        : '/zetaicons/user.png',
        'trash'       : '/zetaicons/bin.png',
        'refresh'     : '/zetaicons/arrow_refresh.png',
        'servergo'    : '/zetaicons/server_go.png',
        'plus_exp'    : '/zetaicons/plus_exp.gif',
        'arrow_right' : '/zetaicons/arrow_right.png',
        'timeline'    : '/zetaicons/time.png',
        'tooltips'    : '/zetaicons/tooltips.png',
        'barchart'    : '/zetaicons/chart_bar.png',
        'commentadd'  : '/zetaicons/comment_add.png',
    }
%>

<%def name="mainnav()" >
    <div id="mainnav" class="fnt83" >
    <table cellspacing="0" cellpadding="0" border="0">
        <tr>
        % for m in c.mainnavs :
            <th>
                <div class="curvy4 bggreen"></div>
                <div class="curvy2 bggreen">
                    <div class="${m.tab} ml2 mr2" style="height: 1px;" ></div>
                </div>
                <div class="curvy1 bggreen">
                    <div class="${m.tab} mr1 ml1" style="height: 1px;"></div>
                </div>
                <div class="bggreen">
                    <div class="${m.tab} mr1 ml1 pl10 pr10 pb2">
                        <a class="nodec bb" href="${m.href}" title="${m.title}">${m.text}</a>
                    </div>
                </div>
            </th>
            <td><div style="width: 10px;"</div></td>
        % endfor
        </tr>
    </table>
    </div>
</%def>

<%def name="favoriteicon( name )">
    <span name="${name}" title="add or delete as your favorite"
          class="favdeselected ml5 pointer fntlarge"></span>
</%def>

<%def name="iconize( spantext, iconname, span_name='', classes='', styles='', title='' )">
    <% iconfile = iconmap.get( iconname, '' ) %>
    <span name="${span_name}" class="pl18 ${classes}" title="${title}"
          style="${styles}; background : transparent url(${iconfile}) no-repeat scroll 0;">
        ${spantext | n}
    </span>
</%def>

<%def name="iconlink( link, iconname, anchor_name='', classes='', styles='', title='' )">
    <% iconfile = iconmap.get( iconname, '' ) %>
    <a name="${anchor_name}" class="${classes} hoverhighlight br2 p3" title="${title}" 
       style="${styles};" href="${link}" >
        <img src="${iconfile}" class="vmiddle"></img></a>
</%def>

<%def name="flashmessages()">
    <% 
       allflash = [ ('%s'%m) for m in h.flash.pop_messages() ]
       errors   = [ m.strip( h.ERROR_FLASH ) for m in allflash if h.ERROR_FLASH in m ]
       messages = [ m.strip( h.MESSAGE_FLASH ) for m in allflash if h.MESSAGE_FLASH in m ]
       allflash = errors + messages
       flashcls = (errors and 'bgLSalmon') or (messages and 'bgyellow') or ''
       if allflash :
           style= ""
       else :
           
           style= "display: none;"
    %>
    <div id="flashblk" class="calign m10 flashbind z100" style="${style}">
        <div class="flash curvy4 ${flashcls}"></div>
        <div class="flash curvy2 ${flashcls}"></div>
        <div class="flash curvy1 ${flashcls}"></div>
        <div id="flashmsg" class="flash fntsmall fwnormal ${flashcls}">
            % for message in allflash:
                ${message}
            % endfor
        </div>
        <div class="flash curvy1 ${flashcls}"></div>
        <div class="flash curvy2 ${flashcls}"></div>
        <div class="flash curvy4 ${flashcls}"></div>
    </div>
</%def>

<%def name="pagebar( text, spans=[], rspans=[], tooltips=[], *args )" >
    <div class="pbar fnt83 brtl5 brtr5" 
         style="border-top: 1px solid green; border-left: 1px solid green;
                border-right: 1px solid green;">
        <div class="bggrn1 pl1 pr1 pl5 pb5" style="height: 20px">
            % if tooltips :
                <div id='trgr_tooltips' title="Tips on how to use this page" 
                     class="posr floatr mr10 fntnormal fgblue pointer"
                     style="margin-top: 5px;">
                    ${iconize( '', 'tooltips', styles="height: 16px;" )}
                </div>
            % else :
                <div id='trgr_tooltips' title="Tips on how to use this page" 
                     class="posr floatr mr20 fntnormal fggray">
                </div>
            % endif
            <div class="floatr pr10" style="margin-top: 4px">
            % for span in rspans :
                ${span | n}
            % endfor
            </div>
            <div class="floatl" style="margin-top: 4px">${text}</div>
            <div class="floatl pl5">
                % for span in spans :
                    ${span | n}
                % endfor
            </div>
        </div>
        % for div_spans in args :
        <div class="bggrn1 ml1 mr1 pl5 pb2">
            % for span in div_spans :
                ${span | n}
            % endfor
        </div>
        % endfor
    </div>
    % if tooltips :
        <div id="cont_tooltips"></div>
    % endif :

    <script type="text/javascript">
        function pagebartooltip() {
            var n_cont = dojo.byId( 'cont_tooltips' );
            var n_trgr = dojo.byId( 'trgr_tooltips' );
            if( n_cont ) {
                new zeta.ToolTips({
                    n_tooltip : n_trgr,
                    tooltips: ${ h.json.dumps( tooltips ) | n }
                }, n_cont )
            }
        };
    </script>

</%def>

<%def name="contextnav( spans=[], rspans=[], tooltips=[] )">
    <div class="bggrn1 ctxtnav pl5 fnt83 brtr5" style="height: 20px;">
        % if tooltips :
            <div id='trgr_tooltips' title="Tips on how to use this page" 
                 class="posr floatr mt2 mr10 fntsmall fgblue pointer">
                ${iconize( '', 'tooltips' )}
            </div>
        % else :
            <div id='trgr_tooltips' title="Tips on how to use this page" 
                 class="posr floatr mr10 fntsmall fggray">
            </div>
        % endif

        <div class="floatr pr10">
        % for span in rspans :
            ${span | n}
        % endfor
        </div>

        % for span in spans :
            ${span | n}
        % endfor
    </div>
    % if tooltips :
        <div id="cont_tooltips"></div>
    % endif :

    <script type="text/javascript">
        function contexttooltip() {
            var n_cont = dojo.byId( 'cont_tooltips' );
            var n_trgr = dojo.byId( 'trgr_tooltips' );
            if( n_cont ) {
                new zeta.ToolTips({
                    n_tooltip : n_trgr,
                    tooltips: ${ h.json.dumps( tooltips ) | n }
                }, n_cont )
            }
        };
    </script>

</%def>

<%def name="user_panes( userpanes )">
    <table class="w100"><tr>
    <td id="collapseup" style="width : 7px;" class="pointer vmiddle inactive">
        <div style="cursor : default; width : 7px; background-color : transparent;">&#187;<div>
    </td>
    <td id="coluserpane">
        <div class="pt5 w100 pl1pc">
            <div class="fntsmall w100 ralign">
                <span id="uprefresh" class="fgblue pointer">refresh</span>
                &ensp;
                <span id="upcolexp" class="fgblue pointer">collapse</span>
            </div>

            <div style="border : thin dotted black; padding : 0px 3px 0 3px; margin : 3px 0px 3px 0;"
                 class="fntsmall 100" id="adduserpanes">
                % for up in userpanes :
                    <span class="fgblue pointer" title="${up}">${up}&ensp;</span>
                % endfor
            </div>

            <div id='userpanes' class="w100">
            % for up in userpanes :
                <div title="${up}"></div>
            % endfor
            </div>
        </div>
    </td>
    </table>
</%def>

<%def name="lictable1( license, editable )">
    <table class="w100" style="border-collapse : collapse;">
        <tr>
            <th class="calign">Id</th>
            <th class="calign">License name</th>
            <th class="calign">Projects</th>
            % if editable :
                <th></th>
            % endif
        </tr>
        % for l in license :
            <% id, licensename, licurl, editurl, rmurl = l[:5] %>
            <tr licensename="${licensename}">
                <td class="calign">${id}</td>
                <td class="calign"><a class="fntbold" href="${licurl}">${licensename}</a></td>
                <td class="calign">
                % for p, href in l[5:] :
                    <div><a href="${href}">${p}</a></div>
                % endfor
                </td>
                % if editable :
                    <td class="calign">
                        ${iconize( '', 'trash', span_name='rmlic', classes='fgblue pointer',
                                   title='Remove this license' )}
                    </td>
                % endif
            </tr>
        % endfor
    </table>
</%def>

<%def name="captiontextarea( text='' )">
    <div class="w100 mb5 fntitalic fntbold fggray">
        ${text}
        <a href="/help/zwiki/ZWiki">Zwiki reference</a>
    </div>
</%def>

<%def name="attach_spans( span_name, form_id, refreshurl )">
    <span class="m2" name="${span_name}" form_id="${form_id}" refreshurl="${refreshurl}">
    </span>
</%def>

<%def name="tag_spans( span_name, form_id, refreshurl )">
    <span class="m2" name="${span_name}" form_id="${form_id}" refreshurl="${refreshurl}">
    </span>
</%def>

<%def name="helpboard( help='', classes='', styles='' )">
    <div class="helpbrd bgblue1 p10 ${classes} br10"
         style="font-family: Helvetica, sans-serif;
                ${styles}">
        ${help |n}
    </div>
</%def>

<%def name="userdetails( user, userinfo, urlphoto )">
    <% username = user.username %>
    <div class="p5 w100">
        <h3 style="border-bottom: 2px solid gray;">
            ${'%s %s %s' % (userinfo.firstname, userinfo.middlename, userinfo.lastname) }
        </h3>
        <div class="disptable w100">
        <div class="disptrow w100">
            <div class="disptcell vtop" style="width: 30%">
                <div class="p3">
                    <div>${user.emailid}</div>
                    <div><span class="fntbold">timezone : </span>
                        ${user.timezone}
                    </div>
                </div>
                <div class="mt20 p3">
                    <span class="fntbold">Registered as :</span>
                    <a href="${h.url_foruser(username)}">${username}</a>
                </div>
                <div class="p3">
                    <span class="fntbold">Registered on :</span>
                        ${userinfo.created_on.strftime("%a, %b %d, %Y")}
                </div>
            </div>
            <div class="disptcell vtop" style="width: 30%">
                <em><b>Address : </b></em> <br></br>
                <div class="ml20 mt10">
                    ${userinfo.addressline1} <br></br>
                    ${userinfo.addressline2} <br></br>
                    ${userinfo.city} - ${userinfo.pincode} <br></br>
                    ${userinfo.state} <br></br>
                    ${userinfo.country} <br></br>
                </div>
            </div>
            <div class="disptcell vtop ralign" style="width: 30%">
                % if urlphoto :
                    <img style="max-width: 200px; max-height: 200px;" src="${urlphoto}"></img>
                % endif
            </div>
        </div>
        </div>
    </div>
</%def>

<%def name="titleindex( items, url_for )">
    <% curdir = [] %>
    <ul class="ml50">
    % for path, text in items :
        <%
            parts  = filter( None, path.split('/') )
            render = map( lambda r, p : None if r == p else p, curdir, parts )
            while render :
                if render[-1] == None :
                    render.pop(-1)
                else :
                    break
            curdir = parts
            ndirs  = render and (len(render)-1) or 0
        %>
        % for i in range(ndirs) :
            % if render[i] :
                <li class="fntbold" style="margin-left: ${i*20}px">
                    <b>${render[i]}</b>
                </li>
            % endif
        % endfor
        <li class="fntbold" style="margin-left: ${ndirs*20}px">
            <a href="${url_for( path )}">${render[-1]}</a>
        </li>
    % endfor
    </ul>
</%def>

<%def name="captcha( url )">
    <div class="ftbox">
        ${forms.input_text( name='captcha', id='captcha' )}
        <img class="vbottom ml20" src="${url}"></img>
    </div>
</%def>

## ------------------- Difference formatting ----------------------

<%def name="diff_row( col1, col2, col3, cls )">
    <tr class="${cls}">
        <td class="oldver ${cls}">${col1}</td>
        <td class="newver ${cls}">${col2}</td>
        <td class="verdiff ${cls}">${col3}</td>
    </tr>
</%def>

<%def name="equal_row( tup, flines, tlines )">
    <%
        if tup[2] - tup[1] != tup[4] - tup[3] :
            raise Exception
        len = tup[2] - tup[1]
    %>
    % for ln in range(0, len) :
        ${ diff_row( tup[1]+ln+1, tup[3]+ln+1, flines[tup[1]+ln], 'diffequal' )}
    % endfor
</%def>

<%def name="delete_row( tup, flines, tlines )">
    % for ln in range(tup[1], tup[2]) :
        ${diff_row( ln+1, '', flines[ln], 'diffdelete' )}
    % endfor
</%def>

<%def name="insert_row( tup, flines, tlines )">
    % for ln in range(tup[3], tup[4]) :
        ${diff_row( '', ln+1, tlines[ln], 'diffinsert' )}
    % endfor
</%def>

<%def name="replace_row( tup, flines, tlines )">
    % for ln in range(tup[1], tup[2]) :
        ${diff_row( ln+1, '', flines[ln], 'diffreplace' )}
    % endfor
    % for ln in range(tup[3], tup[4]) :
        ${diff_row( '', ln+1, tlines[ln], 'diffreplace' )}
    % endfor
</%def>

<%def name="difftable( oldver, newver, flines, tlines )">
    <% m = h.SequenceMatcher( None, flines, tlines ) %>
    <div class="difflegend mt10">
        <dl>
            <dt class="unmod"></dt><dd class="ml5">Un-modified</dd>
            <dt class="del"></dt><dd class="ml5">Deleted</dd>
            <dt class="ins"></dt><dd class="ml5">Inserted</dd>
            <dt class="rep"></dt><dd class="ml5">Replaced</dd>
        </dl>
    </div>
    <table class="zwdiff">
        <thead><tr>
            <th class="oldver">v${oldver}</th>
            <th class="newver">v${newver}</th>
            <th class="verdiff">Difference</th>
        </tr></thead>
        % for cluster in m.get_grouped_opcodes() :
            ${diff_row( '...', '...', '', 'skip' )}
            % for tup in cluster :
                % if tup[0] == 'equal' :
                    ${equal_row( tup, flines, tlines )}
                % elif tup[0] == 'delete' :
                    ${delete_row( tup, flines, tlines )}
                % elif tup[0] == 'insert' :
                    ${insert_row( tup, flines, tlines )}
                % elif tup[0] == 'replace' :
                    ${replace_row( tup, flines, tlines )}
                % endif
            % endfor
        % endfor
    </table>
</%def>

## -------------------- Timeline libraries --------------------------

<%def name="timeline( ondt, log )">
    <li class="tlog">
        <div class="mt5 mb5 ml3 wsnowrap w100" style="overflow: hidden;">
            <span class="hoverhighlight">
                ${iconize( ondt, 'plus_exp', span_name='interface', classes='pointer mr5',
                           title='%s'%log.created_on )}
            </span>
            <span class="ml5">By ${log.userhtml |n }</span>
            <span>in ${log.itemhtml |n }</span>
            <span name="logmsg" class="ml10 fggray">${log.log}</span>
        </div>
    </li>
</%def>

<%def name="timeline_view( logs, fromoff, tooff, links, chartid='' )">
    <%
        if logs :
            lf = '<span class="fgred">%s</span>' % logs[0].created_on.strftime("%a, %b %d, %Y")
            lt = '<span class="fgred">%s</span>' % logs[-1].created_on.strftime("%a, %b %d, %Y")
            logwindow = "Till %s from %s" % ( lf, lt )
        else :
            logwindow = "No logs"
        slices  = h.timeslice( logs )
        slicedt = sorted( slices.keys(),
                          key=lambda x : h.dt.datetime.strptime(x, '%a, %b %d %Y' ),
                          reverse=True )
    %>
    <div class="timeline ml10 mr10">
        <br/>
        <div class="pb2" style="height : 1.5em; border-bottom : 2px solid gray;">
            <div class="floatr">
                <a class="rss" href="${h.url_rssfeed}" rel="nofollow">RSS</a>

                % if links[0] :
                    <span class="fntlarge fntbold"><a href="${links[0]}">&#171;</a></span>
                % endif

                % if links[1] :
                    <span class="fntlarge fntbold ml5"><a href="${links[1]}">&#8249;</a></span>
                % endif

                <span class="ml5">${fromoff}-${tooff}</span>

                % if links[2] :
                    <span class="fntlarge fntbold ml5"><a href="${links[2]}">&#8250;</a></span>
                % endif

            </div>
            <span class="fntbold">${logwindow |n}</span>
            <span name="expand" class="ml10 fgblue pointer">Expand</span>
        </div>
        <div class="pl5 pr5">
            % if chartid :
                <div class="floatr p5 bgwhite">
                    <div class="chartcntnr">
                        <div id="${chartid}" class="chart"
                             style="width: 500px; height: 325px;">
                        </div>
                    </div>
                </div>
            % endif
            % for ondt in slicedt :
                <ul class="w100">
                % for log in slices[ondt] :
                    ${timeline(ondt, log )}
                % endfor
                </ul>
            % endfor
        </div>
        <br/>
        <div class="bclear pb2" style="height : 1.5em; border-bottom : 2px solid gray;">
            <div class="floatr" style="right : 0px;">
                % if links[0] :
                    <span class="fntlarge fntbold"><a href="${links[0]}">&#171;</a></span>
                % endif

                % if links[1] :
                    <span class="fntlarge fntbold ml5"><a href="${links[1]}">&#8249;</a></span>
                % endif

                <span class="ml5">${fromoff}-${tooff}</span>

                % if links[2] :
                    <span class="fntlarge fntbold ml5"><a href="${links[2]}">&#8250;</a></span>
                % endif
            </span>
            <span class="fntbold">&ensp;</span>
        </div>
    </div>

    <script type="text/javascript">
        function logmsg( n, what ) {
            if( what == 'expand' ) {
                dojo.toggleClass( n, 'dispblk', true );
                dojo.toggleClass( n, 'wspre', true );
                dojo.toggleClass( n, 'ml50', true );
            } else {
                dojo.toggleClass( n, 'dispblk', false );
                dojo.toggleClass( n, 'wspre', false );
                dojo.toggleClass( n, 'ml50', false );
            }
        }

        function pntr_onclick( n_logmsg, e ) {
            dojo.hasClass( n_logmsg, 'dispblk' ) ? 
                logmsg( n_logmsg, 'summary' ) : logmsg( n_logmsg, 'expand' ) ;
            dojo.stopEvent(e);
        }
        function setup_timeline() {
            dojo.setObject( 'span_expand', dojo.query( 'span[name=expand]' )[0] );
            dojo.forEach(
                dojo.query( '.tlog' ),
                function( n ) {
                    var n_pntr   = dojo.query( 'span[name=interface]', n )[0]
                    var n_logmsg = dojo.query( 'span[name=logmsg]', n )[0]
                    dojo.connect(
                        n_pntr, 'onclick',
                        dojo.partial( pntr_onclick, n_logmsg )
                    );
                }
            );
            dojo.connect(
                span_expand, 'onclick', 
                function(e) {
                    dojo.forEach(
                        dojo.query( 'span[name=logmsg]' ),
                        function( n ) {
                            if( span_expand.innerHTML == 'Summary' ) {
                                logmsg( n, 'summary' ) 
                            } else {
                                logmsg( n, 'expand') ;
                            }
                        }
                    );
                    span_expand.innerHTML = span_expand.innerHTML == 'Expand' ?
                                                'Summary' : 'Expand'
                    dojo.stopEvent(e);
                }
            );
        }
        dojo.addOnLoad( setup_timeline );
    </script>
</%def>

## --- Function used by review templates

<%def name="showpeople()">
    <%
        participants   = [ u.username for u in c.review.participants ]
        x_participants = sorted(list(
                            set( c.usernames ).difference( set( participants ))
                         ))
        'admin' in x_participants and x_participants.remove('admin')
        'anonymous' in x_participants and x_participants.remove('anonymous')
    %>
    <div id="revwinfo">
        <div class="fggray fntbold pt5 pb5 ml10"> Author </div>
        % if c.revweditable :
            <div class="ml20">
            ${forms.form_revwauthor( c.authuser, c.project, c.review,
                                     h.suburl_revwauthor, c.projusers )}
            </div>
        % else :
            <% authorname = c.review.author and c.review.author.username or '-' %>
            <div class="ml20">
            % if c.review.author :
                <a href="${h.url_foruser( authorname )}">${authorname}</a>
            % else :
                <span>${authorname}</span>
            % endif
            </div>
        % endif
        <hr></hr>
        <div class="fggray fntbold pt5 pb5 ml10"> Moderator </div>
        % if c.revweditable :
            <div class="ml20">
            ${forms.form_revwmoderator( c.authuser, c.project, c.review,
                                        h.suburl_revwmoderator, c.projusers )}
            </div>
        % else :
            <% 
                moderatorname = c.review.moderator and c.review.moderator.username \
                                or '-'
            %>
            <div class="ml20">
            % if c.review.moderator :
                <a href="${h.url_foruser( moderatorname )}">${moderatorname}</a>
            % else :
                <span>${moderatorname}</span>
            % endif
            </div>
        % endif
        % if c.authuser == c.review.moderator :
            <div id="revwclosed" class="fgblue pointer ml10 mt5 mb5">
                ${forms.form_closerev( c.authuser, c.project,
                                       c.review, h.suburl_closerev )}
            </div>
        % endif
        <hr></hr>
        <div class="fggray fntbold pt5 pb5 ml10"> Participants </div>
        % if c.revweditable :
            <div class="ml20">
                ${forms.form_addparts( c.authuser, c.project, c.review,
                                       h.suburl_addparts, x_participants )}
            </div>
        % endif
        <div id="listparts" class="ml20 p5" >
        % for username in sorted([ u.username for u in c.review.participants ]) :
        <div>
            % if c.revweditable :
            <span username="${username}"
                  class="closeparticipant mr5 fgred pointer">x</span>
            % endif
            <a href="${h.url_foruser( username )}">${username}</a>
        </div>
        % endfor
        </div>
        ${forms.form_delparts( c.authuser, c.project, c.review,
                               h.suburl_delparts )}
    </div>
    <script type="text/javascript">
        function publish_delpart( username, e ) {
            dojo.publish( 'delparticipant', [ username ] );
            dojo.destroy(
                dojo.query( 'span[username='+username+']', dojo.byId( 'listparts' ) 
                          )[0].parentNode
            );
            dojo.stopEvent(e);
        }
        function setup_participants() {

            dojoaddOnLoad( 'initform_revwauthor' );
            dojoaddOnLoad( 'initform_revwmoderator' );
            dojoaddOnLoad( 'initform_closerev' );
            dojoaddOnLoad( 'initform_addparts' );
            dojoaddOnLoad( 'initform_delparts' );

            var n_spans = dojo.query('div#revwinfo span.closeparticipant');
            dojo.forEach( n_spans,
                function( n ) {
                    dojo.connect(
                        n, 'onclick', 
                        dojo.partial( publish_delpart, dojo.attr( n, 'username' ))
                    );
                }
            );
            dojo.subscribe( 
                'insertparticipant',
                function( username ) {
                    // Create the div
                    var n_div = dojo.create( 'div', {}, dojo.byId( 'listparts' ), 'last' );
                    // interface to show and delete the participant.
                    var n_x = dojo.create( 
                                'span', { username : username, innerHTML : 'x ',
                                          class : "closeparticipant mr5 fgred pointer"
                                        },
                                n_div, 'last'
                              );
                    dojo.connect( n_x, 'onclick', 
                                  dojo.partial( publish_delpart, username ));
                    dojo.create( 
                        'a', { href : url_foruser( username ), innerHTML : username },
                        n_div, 'last'
                    );
                }
            );
        }
    </script>
</%def>

## -------------------- Attachment libraries --------------------------

<%def name="attachments( u, attachments, editable, attachassc=None, aa=None,
                         ua=None, la=None, pa=None, ta=None, ra=None, wa=None )">
    <% keys = sorted( attachments.keys() ) %>
    <div id="attachments w100" class="br4" style="border: 3px solid #B3CFB3;">
    <table class="w100">
        <tr class="bggrn2">
            <td class="p3 fntbold" style="width: 2%;">id</td>
            <td class="p3 fntbold" style="width: 20%;">filename</td>
            <td class="p3 fntbold" style="">summary</td>
            <td class="p3 fntbold" style="width: 20%;">tags</td>
            <td class="p3 fntbold" style="width: 7%;">uploader</td>
            % if attachassc :
            <td class="p3 fntbold" style="width: 10em;">attached-to</td>
            % endif
            <td class="p3 fntbold" style="width: 8%;">downloads</td>
        </tr>
        % for k in keys :
            <% count = 0 %>
            <tr class="fntitalic bggray2"><td class="p5 fntbold" colspan="7">${k}</td></tr>
            % for att in attachments[k] :
                <% 
                    createdon = att[4] and h.utc_2_usertz( att[4], u.timezone ).strftime("%a, %b %d, %Y")
                    count += 1
                    bgrnd = (count%2 == 0) and 'bggray1' or ''
                    if attachassc :
                        items = [ h.attachassc2link( item, aa, ua, la, pa, ta, ra, wa )
                                  for item in attachassc.get( att[0], [] ) ]
                    else :
                        items = []
                %>
                <tr class="${bgrnd}">
                    <td class="p5 fggray" style="width: 2%">
                        <a href="${att[7]}">${att[0]}</a>
                    </td>
                    <td class="p5 fggray" style="width: 15%">${att[1]}</td>
                    <td class="p5" style="">
                        <span name="summary" attid="${att[0]}" class="inedit">${att[2]}</span>
                    </td>
                    <td class="p5" style="width: 20%;">
                        <span name="tags" attid="${att[0]}" class="inedit">${att[6]}</span>
                    </td>
                    <td class="p5 fggray" style="width: 5%;">
                        <a href="${h.url_foruser( att[5] )}">${att[5]}</a>
                    </td>
                    % if attachassc :
                    <td class="p5 fggray" style="width: 10em;">
                        % for text, href in items :
                            <div class="pl10"><a href="${href}">${text}</a></div>
                        % endfor
                    </td>
                    % endif
                    <td class="p5 fggray" style="width: 8%;">${att[3]}</td>
                </tr>
            % endfor
        % endfor
    </table>
    </div>

    <script type="text/javascript">
        function editable_attachments() {
            // Setup forms
            new zeta.Form({ normalsub: true, formid: 'attachssummary' });
            new zeta.Form({ normalsub: true, formid: 'attachstags' });

            var inlines = dojo.query( 'span.inedit' );

            function inline_onchange( attid, formnode, field, value ) {
                dojo.query( 'input[name=' + field + ']', formnode 
                          )[0].value = value;
                dojo.query( 'input[name=attachment_id]', formnode )[0].value = attid;
                submitform( formnode );
            }
            dojo.forEach(
                inlines,
                function(item) {
                    var name  = dojo.attr( item, 'name' );
                    var attid = dojo.attr( item, 'attid' )   
                    if ( name == 'summary' ) {
                        new dijit.InlineEditBox({
                            editor: "dijit.form.TextBox",
                            onChange: dojo.partial(
                                        inline_onchange, attid, form_attachssummary, 'summary' 
                                      ),
                        }, item )        
                    } else if ( name == 'tags' ) {
                        new dijit.InlineEditBox({
                            editor: "dijit.form.TextBox",
                            onChange: dojo.partial(
                                        inline_onchange, attid, form_attachstags, 'tags'
                                      )
                        }, item )        
                    }
                }
            );

        }
        function setup_attachments() {
            var editable = ${(editable and 'true' or 'false') | n }
            if( editable ) {
                editable_attachments()
            }
        }
        dojo.addOnLoad( setup_attachments );
    </script>
</%def>

<%def name="attachdownloads( u, attachments )">
    <% 
        count = 0
        values = [];
        [ values.extend( v ) for v in attachments.values() ]
    %>
    <div id="attachments w100" class="br4" style="border: 3px solid #B3CFB3;">
    <table class="w100">
        <tr class="bggrn2">
            <td class="p3 fntbold" style="width: 21%;">filename</td>
            <td class="p3 fntbold" style="">summary</td>
            <td class="p3 fntbold" style="width: 7%;">uploader</td>
            <td class="p3 fntbold" style="width: 10em;;">created-on</td>
            <td class="p3 fntbold" style="width: 8%;">downloads</td>
        </tr>
        % for att in values :
            <%
                createdon = att[4] and h.utc_2_usertz( att[4], u.timezone ).strftime("%a, %b %d, %Y")
                count += 1
                bgrnd = (count%2 == 0) and 'bggray1' or ''
            %>
            <tr class="${bgrnd}">
                <td class="p5 fggray" style="width: 15%">
                    <a href="${h.url_for( h.r_attachdownl, id=att[0] )}">${att[1]}</a>
                </td>
                <td class="p5" style="">
                    <span name="summary" attid="${att[0]}" class="inedit">${att[2]}</span>
                </td>
                <td class="p5 fggray" style="width: 5%;">
                    <a href="${h.url_foruser( att[5] )}">${att[5]}</a>
                </td>
                <td class="p5 fggray" style="width: 10em;">${createdon}</td>
                <td class="p5 fggray" style="width: 8%;">${att[3]}</td>
            </tr>
            % if att[6] :
            <tr class="fntitalic ${bgrnd}">
                <td class="pl5 fntitalic fggreen" colspan="7">
                    <span>( ${att[6]} )</span>
                </td>
            </tr>
            % endif
        % endfor
    </table>
    </div>
</%def>

