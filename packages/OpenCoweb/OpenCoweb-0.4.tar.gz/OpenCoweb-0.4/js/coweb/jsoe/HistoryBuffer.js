define(["coweb/jsoe/factory","coweb/jsoe/Operation"],function(a,b){var c=function(){this.ops={},this.size=0};c.prototype.getState=function(){var a=[],b=0;for(var c in this.ops)this.ops.hasOwnProperty(c)&&(a[b]=this.ops[c].getState(),++b);return a},c.prototype.setState=function(b){this.size=0,this.ops={};for(var c=0;c<b.length;c++){var d=a.createOperationFromState(b[c]);this.add(d)}},c.prototype.getOpsForDifference=function(a){var b=a.getHistoryBufferKeys(),c=[];for(var d=0;d<b.length;d++){var e=b[d],f=this.ops[e];if(f===undefined)throw new Error("missing operation: i="+d+" key="+e+" keys="+b.toString());c.push(f)}c.sort(function(a,b){return a.compare(b)});return c},c.prototype.add=function(b){var c=a.createHistoryKey(b.siteId,b.seqId);this.ops[c]=b,b.immutable=!0,++this.size},c.prototype.remove=function(b){var c=a.createHistoryKey(b.siteId,b.seqId);b=this.ops[c],delete this.ops[c],b.immutable=!1,--this.size;return b},c.prototype.getCount=function(){return this.size},c.prototype.getSortedOperations=function(){var a=[];for(var b in this.ops)this.ops.hasOwnProperty(b)&&a.push(this.ops[b]);a.sort(function(a,b){return a.compare(b)});return a};return c})