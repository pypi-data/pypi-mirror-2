define(["coweb/topics","coweb/jsoe/OperationEngine","org/OpenAjax"],function(a,b,c){var d=1e4,e=1e4,f=function(){this._mutex=!1,this._engine=null,this._shouldPurge=!1,this._shouldSync=!1,this._syncTimer=null,this._purgeTimer=null,this._bridge=null,this._collab=!1,this._conns=[]},g=f.prototype;g.start=function(b,f){this._bridge=b,this._subscribeHub(f.collab);if(f.collab){this._syncTimer&&clearInterval(this._syncTimer),this._purgeTimer&&clearInterval(this._purgeTimer);var g=this;this._syncTimer=setInterval(function(){g._engineSyncOutbound()},d),this._purgeTimer=setInterval(function(){g._onPurgeEngine()},e)}var h=this._bridge.getInitialRoster(),i={username:f.username,site:this._engine.siteId,roster:h};c.hub.publish(a.READY,i)},g.stop=function(b){if(this._bridge)try{var d={connected:!b};c.hub.publish(a.END,d)}catch(e){console.warn("UnmanagedHubListener: failed end session notice "+e.message)}this._bridge=null,this._syncTimer&&(clearInterval(this._syncTimer),this._syncTimer=null),this._purgeTimer&&(clearInterval(this._purgeTimer),this._purgeTimer=null),this._unsubscribeHub()},g._subscribeHub=function(b){var d;b&&(d=c.hub.subscribe(a.SYNC+"**","_syncOutbound",this),this._conns.push(d),d=c.hub.subscribe(a.SET_STATE+"**","_stateOutbound",this),this._conns.push(d)),d=c.hub.subscribe(a.SUB_SERVICE+"**","_onSubServiceOutbound",this),this._conns.push(d),d=c.hub.subscribe(a.UNSUB_SERVICE+"**","_onUnsubServiceOutbound",this),this._conns.push(d),d=c.hub.subscribe(a.GET_SERVICE+"**","_onRequestServiceOutbound",this),this._conns.push(d)},g._unsubscribeHub=function(){for(var a=0,b=this._conns.length;a<b;a++)c.hub.unsubscribe(this._conns[a]);this._conns=[]},g.setSiteID=function(a){this._engine=new b(a),this._engine.freezeSite(0)},g.syncInbound=function(b,d,e,f){var g,h,i,j;e!==0?(g=d.value||null,h=d.type||null,i=d.position||0,j=d.context||null):(g=d,h=null,i=0,j=null);if(j!==null&&h!==null){if(b===a.ENGINE_SYNC){this._engineSyncInbound(e,j);return}var k;try{k=this._engine.push(!1,b,g,h,i,e,j)}catch(l){console.warn("UnmanagedHubListener: failed to push op into engine"+l.message);return}if(k===null)return;g=k.value,i=k.position}try{g=JSON.parse(g)}catch(m){}var n={position:i,type:h,value:g,site:e,error:f==="error"};this._mutex=!0;try{c.hub.publish(b,n)}catch(o){console.warn("UnmanagedHubListener: failed to deliver incoming event "+b+"("+o.message+")")}this._mutex=!1,j!==null&&(this._shouldPurge=!0,this._shouldSync=!0)},g._syncOutbound=function(a,b){if(!this._mutex&&this._engine){var c=b.position,d=b.type,e=b.value,f=null,g=null;if(d!==null){e=JSON.stringify(b.value);try{f=this._engine.createOp(!0,a,e,d,c),g=f.contextVector.sites}catch(h){console.warn('UnmanagedHubListener: bad type "'+d+'" on outgoing event; making null'),d=null}}var i={value:e,type:d,position:c,context:g},j,k;try{j=this._bridge.postSync(a,i)}catch(l){k=l,j=!1,console.warn("UnmanagedHubListener: failed to send hub event "+l.message)}if(j&&d!==null)this._engine.pushLocalOp(f),this._shouldPurge=!0;else if(k)throw k}},g.noticeInbound=function(b,d){var e,f={};f.site=d.siteId,f.username=d.username;if(b==="available"){e=a.SITE_JOIN;try{this._engine.thawSite(f.site)}catch(g){console.warn("UnmanagedHubListener: failed to thaw site "+f.site+" "+g.message)}}else if(b==="unavailable"){e=a.SITE_LEAVE;try{this._engine.freezeSite(f.site)}catch(h){console.warn("UnmanagedHubListener: failed to freeze site "+f.site+" "+h.message)}}this._mutex=!0;try{c.hub.publish(e,f)}catch(i){console.warn("UnmanagedHubListener: failed to deliver notice "+i.message)}this._mutex=!1},g._onSubServiceOutbound=function(a,b){try{this._bridge.postServiceSubscribe(b.service)}catch(c){console.warn("UnmanagedHubListener: failed service subscribe "+c.message)}},g._onUnsubServiceOutbound=function(a,b){try{this._bridge.postServiceUnsubscribe(b.service)}catch(c){console.warn("UnmanagedHubListener: failed service unsub "+c.message)}},g._onRequestServiceOutbound=function(a,b){try{this._bridge.postServiceRequest(b.service,b.params,b.topic)}catch(c){console.warn("UnmanagedHubListener: failed service request "+c.message)}},g.requestStateInbound=function(b){try{c.hub.publish(a.GET_STATE,b)}catch(d){console.warn("UnmanagedHubListener: failed collecting state "+d.message)}var e;try{this._engine.purge(),e=this._engine.getState()}catch(f){console.warn("UnmanagedHubListener: failed collecting engine state "+f.message)}try{this._bridge.postStateResponse(a.ENGINE_STATE,e,b)}catch(g){console.warn("UnmanagedHubListener: failed sending engine state "+g.message)}try{this._bridge.postStateResponse(a.END_STATE,null,b)}catch(h){console.warn("UnmanagedHubListener: failed sending end state "+h.message)}},g._stateOutbound=function(a,b){if(!this._mutex){var c=b.recipient,d=b.state;try{this._bridge.postStateResponse(a,d,c)}catch(e){console.warn("UnmanagedHubListener: failed to send state "+e.message)}}},g.stateInbound=function(b,d){if(b===a.ENGINE_STATE)try{this._engine.setState(d)}catch(e){console.warn("UnmanagedHubListener: failed to receive engine state "+e.message);throw e}else{this._mutex=!0;try{c.hub.publish(b,d)}catch(f){console.warn("UnmanagedHubListener: failed to initialize state "+f.message);throw f}finally{this._mutex=!1}}},g._engineSyncOutbound=function(){if(this._engine&&this._shouldSync){var b=this._engine.copyContextVector(),c={value:"",type:"update",position:0,context:b.sites};try{this._bridge.postSync(a.ENGINE_SYNC,c)}catch(d){console.warn("UnmanagedHubListener: failed to send engine sync "+d.message);return}this._shouldSync=!1}},g._engineSyncInbound=function(a,b){try{this._engine.pushSyncWithSites(a,b)}catch(c){console.warn("UnmanagedHubListener: failed to recv engine sync "+a+" "+b+" "+c.message)}this._shouldPurge=!0},g._onPurgeEngine=function(){if(this._engine){var a;if(this._shouldPurge){a=this._engine.getBufferSize();try{var b=this._engine.purge()}catch(c){console.warn("UnmanagedHubListener: failed to purge engine "+c.message)}}this._shouldPurge=!1;return a}};return f})