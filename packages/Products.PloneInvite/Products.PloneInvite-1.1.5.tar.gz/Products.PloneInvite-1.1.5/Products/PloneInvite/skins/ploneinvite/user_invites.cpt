<html xmlns="http://www.w3.org/1999/xhtml" 
    xml:lang="en"
    lang="en"
    metal:use-macro="here/prefs_main_template/macros/master"
    i18n:domain="PloneInvite">

  <metal:block 
      metal:fill-slot="top_slot"
      tal:define="dummy python:request.set('disable_border',1)" />

  <body>

    <div metal:fill-slot="prefs_configlet_content"
        tal:define="Batch python:modules['Products.CMFPlone'].Batch;
                    b_start request/b_start | python:0;
                    b_size request/b_size | python:20;
                    portal_roles here/getGlobalPortalRoles;
                    errors options/state/getErrors;">

      <div id="content" class="documentEditable"
           tal:condition="python:checkPermission('PloneInvite: Manage Member Invites', here)">
        <!-- simulating views on the groups/user pages until we have real objects. -->

        <div id="region-content">

          <a name="documentContent"></a>

          <div metal:use-macro="here/global_statusmessage/macros/portal_message">
            Portal status message
          </div>

          <div class="configlet">
            <h1 i18n:translate="heading_give_invites">Give new invites to members</h1>

            <p>
              <a href="user_invites_status"
               i18n:translate="heading_existing_invites">Manage existing invites</a>
            </p>

            <p i18n:translate="description_user_invites_help">
              Please select the portal members and number of invites you would like
              them to have. You may enforce the email address for the invites sent.
            </p>
                  
            <form action=""
                  name="add_invites"
                  method="post"
                  tal:attributes="action template/getId"
                  tal:define="portal_users python:mtool.searchForMembers();
                              batch python:Batch(portal_users, b_size, int(b_start), orphan=1)">
              <fieldset>
                <legend i18n:translate="legend_add_invites">Add member invites</legend>
                <div class="field"
                     tal:define="error errors/days | nothing;"
                     tal:condition="python: checkPermission('Manage portal', context)"
                     tal:attributes="class python:test(error, 'field error', 'field')">
                        
                  <label i18n:translate="label_expiry_days">Number of days the invitation stays active</label>
                  <div class="formHelp" i18n:translate="help_invite_codes_help">
                    Input the the number of days the invitation stays active.
                  </div>
      
                  <div tal:content="error">Validation error output</div>

                  <input
                        tal:attributes="value python:here.plone_invite.getProperty('days')"
                        style="margin:2px;"
                        type="text"
                        size="15"
                        name="days"
                        value=""/>

                </div>
                      
                <div class="field"
                     tal:define="error errors/invites | nothing;"
                     tal:attributes="class python:test(error, 'field error', 'field')">
                        
                  <label i18n:translate="label_send_invite_codes">Give invite codes to portal members</label>
                  <div class="formHelp" i18n:translate="help_send_invite_codes">
                    Input the the number of invites you would like to send.
                  </div>
      
                  <div tal:content="error">Validation error output</div>
               
                    <table class="listing" summary="User Listing">
                      <tal:block tal:condition="portal_users" >
                        <tr>
                          <th i18n:translate="listingheader_user_name">Member Name</th>
                          <th i18n:translate="listingheader_number_of_invites">Number of Invites</th>
                          <th i18n:translate="listingheader_number_of_available_invites">Number of invites user has left</th>
                          <th i18n:translate="listingheader_number_of_sent_invites">Number of Invites User has sent</th>
                          <th i18n:translate="listingheader_number_of_accepted_invites">Number of Accepted Invites</th>            
                          <th i18n:translate="listingheader_enforce_address">Enforce Email Address</th>
                        </tr>
                      </tal:block>

                      <tal:block repeat="this_user batch">
                        <tr tal:define="oddrow repeat/this_user/odd;
                                        userid this_user/getUserId;
                                        fullname python: this_user.getProperty('fullname')"
                                        tal:attributes="class python:test(oddrow,'odd','even')">
                          <td>
                             <img src="user.gif" />   
                             <a href=""
                                tal:attributes="href string:${here/portal_url}/invite_stat?user=${userid}">
                                &nbsp;
                               <span tal:replace="this_user/getUserName">username</span>
                               <span tal:condition="fullname" tal:omit-tag="">(<span tal:replace="fullname">Full Name</span>)</span>
                             </a>
                             <input type="hidden" name="users.id:records" tal:attributes="value
                             userid" />
                          </td>

                          <td>
                            <input style="margin:2px;"
                                           type="text"
                               size="15"
                               name="users.num:records"
                               value=""/>
                          </td>

                          <td tal:content="python:
                               len(here.plone_invite.getInvites(user=this_user.getUserName(), sent=0, used=0, ))">
                            Number of Invites user has
                          </td>            

                          <td tal:content="python:
                               len(here.plone_invite.getInvites(user=this_user.getUserName(), sent=1, ))">
                            Number of Invites user has sent
                          </td>            

                          <td tal:content="python:
                               len(here.plone_invite.getInvites(user=this_user.getUserName(), used=1, ))">
                            Number of Invites Accepted
                          </td>            

                          <td class="listingCheckbox">
                            <input type="checkbox"
                                   class="noborder notify"
                                   name="enforce:list"
                                   value=""
                                   tal:attributes="value userid" />
                          </td>
                        </tr>
                      </tal:block>
                      <tr tal:condition="not:batch">
                        <td i18n:translate="text_noportal_users"
                            style="text-align:center;">No portal members.
                        </td>
                      </tr>
                    </table>
                    <div metal:use-macro="here/batch_macros/macros/navigation" />
                  </div>
                            
                <input 
                   tabindex=""
                   type="submit"
                   name="form.button.Invites"
                   value="Add Invites"
                   i18n:attributes="value label_apply_changes;"
                   tal:attributes="tabindex tabindex/next;"
                   tal:condition="batch"
                />

              </fieldset>
              <input type="hidden" name="form.submitted" value="1" />
            </form>

          </div>
        </div>
      </div>
      <div id="content" class="documentEditable"
           tal:condition="python: not checkPermission('PloneInvite: Generate Portal Invites', here)">
        <tal:block replace="here/raiseUnauthorized" />
      </div>
    </div>
  </body>
</html>

