var pb={spinner:{},overlay_counter:1};jQuery.tools.overlay.conf.oneInstance=false;
jQuery(function(e){pb.spinner.show=function(){e("body").css("cursor","wait")};pb.spinner.hide=function(){e("body").css("cursor","")};e.fn.prepOverlay=function(a){return this.each(function(){var b,d,c,h,j;b=e(this);d=a.config||{};if(c=pb[a.subtype])d.onBeforeLoad=c;h=d.onLoad;d.onLoad=function(){h&&h.apply(this,arguments);pb.fi_focus(this.getOverlay())};if(!b.attr("rel")){c=b.attr("href")||b.attr("src")||b.attr("action");if(a.urlmatch)c=c.replace(new RegExp(a.urlmatch),a.urlreplace);if(a.subtype===
"inline"){c=c.replace(/^.+#/,"#");e("[id='"+c.replace("#","")+"']").addClass("overlay");b.removeAttr("href").attr("rel",c);b.overlay()}else{a.nt="pb_"+pb.overlay_counter;pb.overlay_counter+=1;a.selector=a.filter||a.selector;if(!a.selector){j=c.split(" ");c=j.shift();a.selector=j.join(" ")}a.src=c;a.config=d;b.data("pbo",a);b.attr("rel","#"+a.nt);b.addClass("link-overlay");switch(a.subtype){case "image":b.click(pb.image_click);break;case "ajax":b.click(pb.ajax_click);break;case "iframe":pb.create_content_div(a);
b.overlay(d);break;default:throw"Unsupported overlay type";}b.css("cursor","pointer")}}})};pb.create_content_div=function(a){var b;b=e('<div id="'+a.nt+'" class="overlay overlay-'+a.subtype+" "+(a.cssclass||"")+'"><div class="close"><span>Close</span></div></div>');a.width&&b.width(a.width);b.appendTo(e("body"));return b};pb.image_click=function(){var a,b,d,c;a=e(this);c=a.data("pbo");a=e(a.attr("rel"));if(!a.length){a=pb.create_content_div(c);a.overlay(c.config)}b=a.overlay();if(a.find("img").length===
0){if(c.src){pb.spinner.show();d=new Image;d.src=c.src;c=e(d);a.append(c.addClass("pb-image"));c.load(function(){pb.spinner.hide();b.load()})}}else b.load();return false};pb.fi_focus=function(a){a.find("form div.error :input:first").focus().length||a.find("form :input:visible:first").focus()};pb.ajax_error_recover=function(a,b){a=e("<div/>").append(a.replace(/<script(.|\s)*?\/script>/gi,""));return b?a.find(b):a};pb.prep_ajax_form=function(a){var b=a.closest(".pb-ajax"),d=b.closest(".overlay-ajax"),
c=d.data("formtarget"),h=d.data("closeselector"),j=d.data("beforepost"),m=d.data("afterpost"),l=d.overlay(),n=d.data("selector"),k={};k.beforeSerialize=function(){pb.spinner.show()};if(j)k.beforeSubmit=function(f,i,g){return j(i,f,g)};k.success=function(f,i){var g,p,o;o=i==="success"||i==="notmodified";if(!o)f=f.responseText;f=f.replace(/<script(.|\s)*?\/script>/gi,"");g=e("<div />").append(n?e("<div />").append(f).find(n):f);o&&m&&m(g,d);p=g.find(c);if(o&&p.length){b.empty().append(g);pb.fi_focus(b);
p.ajaxForm(k);h&&g.find(h).click(function(){l.close();return false})}else{if(o){i=d.data("noform");if(typeof i==="function")i=i(this)}else i=i;switch(i){case "close":l.close();break;case "reload":l.close();pb.spinner.show();location.replace(location.href);break;case "redirect":l.close();pb.spinner.show();g=d.data("redir_url");if(typeof g==="function")g=g(this,f);location.replace(g);break;default:g.children()?b.empty().append(g):l.close()}}pb.spinner.hide()};k.error=k.success;a.ajaxForm(k)};pb.ajax_click=
function(){var a=e(this),b,d,c,h,j,m,l;b=a.data("pbo");d=pb.create_content_div(b);c=d.overlay();a=b.src;h=b.selector;j=b.formtarget;m=b.closeselector;pb.spinner.show();e(this).find("input.submitting").removeClass("submitting");b=e('<div class="pb-ajax" />');c.getConf().fixed&&b.css("max-height",Math.floor(e(window).height()*0.75));d.append(b);l=a.indexOf("?")>=0?"&":"?";a+=l+"ajax_load="+(new Date).getTime();if(h)a+=" "+h;b.load(a,null,function(n,k){var f=e(this);if(k==="error")f.append(pb.ajax_error_recover(n,
h));else n.length||f.append(ajax_noresponse_message||"No response from server.");f.wrapInner("<div />");j&&pb.prep_ajax_form(f.find(j));m&&f.find(m).click(function(){c.close();return false});e.fn.ploneTabInit&&f.ploneTabInit();c.onClose=function(){d.remove()};pb.spinner.hide();c.load();return true});return false};pb.iframe=function(){var a,b;pb.spinner.show();a=this.getOverlay();b=this.getTrigger().data("pbo");a.find("iframe").length===0&&b.src?a.append('<iframe src="'+b.src+'" width="'+a.width()+
'" height="'+a.height()+'" onload="pb.spinner.hide()"/>'):pb.spinner.hide();return true}});
