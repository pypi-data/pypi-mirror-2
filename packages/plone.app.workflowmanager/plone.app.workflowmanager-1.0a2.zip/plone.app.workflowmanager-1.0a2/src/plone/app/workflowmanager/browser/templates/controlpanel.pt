<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone.app.workflowmanager">

    <metal:override fill-slot="column_one_slot" />
    <metal:override fill-slot="column_two_slot" />
    <metal:block fill-slot="top_slot" tal:define="dummy python:request.set('disable_border',1)" />
      
    <metal:css fill-slot="style_slot">
        <link rel="stylesheet" type="text/css" href="++resource++workflowmanager.css" media="screen" />
    </metal:css>
    <metal:javascript fill-slot="javascript_head_slot">
        <script type="text/javascript" src="++resource++workflowmanager.js"></script>
    </metal:javascript>
    
    <body>
        <div metal:fill-slot="main"
            tal:define="selected_workflow view/selected_workflow;
                        show python: selected_workflow is not None;">
  	        <div id="pb_99999" class="overlay overlay-ajax">
  	            <div class="close"><span>Close</span></div>
  	            <div class="pb-ajax"></div>
  	        </div>
	        <div id="status-messages"></div>
	    
	        <h1 class="documentFirstHeading" i18n:translate="title_manage_contentrules">Workflow Manager</h1>
	    
	        <tal:manager tal:condition="show">
    
            <p class="documentDescription">
                You are currently working on the "<tal:replace tal:replace="view/selected_workflow/title" />" workflow.
            </p>

            <a href="" class="link-parent"
                tal:attributes="href string:$portal_url/@@workflowmanager"
                i18n:translate="label_up_to_plone_setup">
                Select or create a new workflow
            </a>
    
            <div id="workflowmanager-container">
	      
	            <div id="tabs-menu">
                    <ul class="formTabs">
                        <li class="formTab firstFormTab">
                            <a id="fieldsetlegend-states" href="@@workflowmanager#fieldsetlegend-states-anchor" class="selected">
                                <span>States</span>
                            </a>
                        </li>
                        <li class="formTab lastFormTab">
                            <a id="fieldsetlegend-transitions" href="@@workflowmanager#fieldsetlegend-transitions-anchor" class="">
                                <span>Transitions</span>
                            </a>
                        </li>
            
                        <form class="inline">
                            <input type="submit" id="save-all-button" class="inline context allowMultiSubmit" value="Save" />
                            <input tal:replace="structure context/@@authenticator/authenticator"/>
                        </form>
                        <input id="selected-workflow" type="hidden" name="selected-workflow" tal:attributes="value selected_workflow/id" />
                        <form class="inline" tal:attributes="action string:${context/absolute_url}/@@workflowmanager-add-new-state" method="POST">
                            <input type="hidden" name="selected-workflow" tal:attributes="value view/selected_workflow/id" />
                            <a class="dialog-box save-first" rel="#pb_99999"
                                tal:attributes="href python: view.get_url('@@workflowmanager-add-new-state');
                                                id string:add-state-box-${view/selected_workflow/id}">
                                <input type="submit" class="context allowMultiSubmit" name="add-new-state-button" value="Add state" />
                            </a>
                        </form>
                        <form class="inline" tal:attributes="action string:${context/absolute_url}/@@workflowmanager-add-new-transition" method="POST">
                            <input type="hidden" name="selected-workflow" tal:attributes="value view/selected_workflow/id" />
                            <a class="dialog-box save-first" rel="#pb_99999"
                                tal:attributes="href python: view.get_url('@@workflowmanager-add-new-transition');">
                                <input type="submit" class="context allowMultiSubmit" name="add-new-transition-button" value="Add transition" />
                            </a>
                        </form>
                        <form class="inline tooltip" tal:attributes="action python: view.get_url('@@workflowmanager-sanity-check')" method="POST">
                            <a class="dialog-box" rel="#pb_99999"
                                tal:attributes="href python: view.get_url('@@workflowmanager-sanity-check')">
                                <input type="submit" class="context allowMultiSubmit" name="sanity-check-button" value="Sanity check" />
                            </a>
                        </form>
                        <div class="tooltip-contents">
                            <dl>
                                <dt>Sanity Check</dt>
                                <dd>Check to make sure that all your states are connected with transitions and that there isn't anything missing or left behind.</dd>
                            </dl>
                        </div>
              
                        <form class="inline tooltip" tal:attributes="action python: view.get_url('@@workflowmanager-assign')" method="POST">
                            <a class="dialog-box save-first" rel="#pb_99999"
                                tal:attributes="href python: view.get_url('@@workflowmanager-assign')">
                                <input type="submit" class="context allowMultiSubmit" name="assign-workflow" value="Assign" />
                            </a>
                        </form>
                        <div class="tooltip-contents">
                            <dl>
                                <dt>Assign</dt>
                                <dd>Assign this workflow to a content type so that your content can utilize it.</dd>
                            </dl>
                        </div>
              
                        <form class="inline tooltip advanced" tal:attributes="action python: view.get_url('@@workflowmanager-update-security-settings')" method="POST"> 
                            <a class="dialog-box save-first" rel="#pb_99999"
                                tal:attributes="href python: view.get_url('@@workflowmanager-update-security-settings')">
                                <input type="submit" class="context allowMultiSubmit" name="update-security-settings" value="Update security" />
                            </a>
                        </form>
                        <div class="tooltip-contents">
                            <dl>
                                <dt>Update Security</dt>
                                <dd>Update the security settings for all objects using this workflow in the portal.</dd>
                            </dl>
                        </div>

                        <form class="inline tooltip" tal:condition="view/has_graphviz" 
                            tal:attributes="action string:${context/absolute_url}/@@workflowmanager-view-graph" method="GET">
                            <input type="hidden" name="selected-workflow" tal:attributes="value view/selected_workflow/id" />
                            <a rel="#pb_99999" class="dialog-box" tal:attributes="href python: view.get_url('@@workflowmanager-view-graph')">
                                <input type="submit" class="standalone allowMultiSubmit" name="view-graph" value="Diagram" />
                            </a>
                        </form>
                        <div class="tooltip-contents" tal:condition="view/has_graphviz">
                            <dl>
                                <dt>Diagram</dt>
                                <dd>Get a visual representation of your the workflow you've designed.</dd>
                            </dl>
                        </div>

                        <form class="inline" tal:attributes="action string:${context/absolute_url}/@@workflowmanager-delete-workflow" method="POST">
                            <input type="hidden" name="selected-workflow" tal:attributes="value view/selected_workflow/id" />
                            <a class="dialog-box" rel="#pb_99999"
                                tal:attributes="href python: view.get_url('@@workflowmanager-delete-workflow')">
                                <input type="submit" class="standalone allowMultiSubmit" name="delete-workflow-button" value="Delete" />
                            </a>
                        </form>

                        <p class="discreet inline hidden" id="unsaved-warning">| <b>unsaved changes</b></p>
                    </ul>
                </div>
        
                <tal:replace tal:replace="structure view/render_content_template" />
            </div>
        </tal:manager>
      
        <tal:select-workflow tal:condition="not: show">

            <a href="" class="link-parent"
                tal:attributes="href string:$portal_url/plone_control_panel"
                i18n:translate="label_up_to_plone_setup">
                Up to Site Setup
            </a>
            <div id="workflow-selection">
                <br />
                <p class="documentDescription">
                    Please select your workflow.
                </p>
                <ul>
                    <tal:workflows tal:repeat="workflow view/available_workflows">
                        <li>
                            <a tal:attributes="href python: view.get_url('@@workflowmanager', workflow);" tal:content="workflow/title"></a>
                        </li>
                    </tal:workflows>
                </ul>
                <form id="create-new-workflow" class="inline" tal:attributes="action python: view.get_url('@@workflowmanager-add-new-workflow')">
                    <a class="dialog-box" rel="#pb_99999" tal:attributes="href python: view.get_url('@@workflowmanager-add-new-workflow')">
                        <input type="submit" class="standalone allowMultiSubmit" value="Create new workflow" />
                    </a>
                </form>
            </div>
        </tal:select-workflow>
        </div>
    </body>
</html>

